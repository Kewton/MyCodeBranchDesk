{"body":"## 概要\n\n開発環境と本番環境の双方でデータ収集機能を強化する。\n本番環境では、ユーザーがバグIssueにログを貼り付けるだけで原因調査が可能になるよう、ワークツリー詳細画面にログエクスポート機能を追加する。\n開発環境では、全APIリクエスト/レスポンスの詳細ログを記録し、問題特定を効率化する。\n\n## 背景・課題\n\n- ユーザーからのバグ報告に十分なログ情報が含まれておらず、原因調査に時間がかかっている\n- バグ発生時にどのようなログ情報を取得すればよいかユーザーに分かりにくい\n- 開発環境でのAPI通信の詳細が記録されておらず、デバッグ時にリクエスト/レスポンスの内容確認が困難\n- ログをそのままIssueに貼り付けると、ルートディレクトリなどのローカル環境情報が外部に漏洩するリスクがある\n\n## 提案する解決策\n\n### 1. ログエクスポート機能（本番環境向け）\n\nワークツリー詳細画面にエクスポートボタンを設置し、エラーログをMarkdown形式でクリップボードにコピーできるようにする。\n\n- ボタン押下でエラーレベルのログを抽出\n- Markdown形式に整形し、GitHub Issueにそのまま貼り付け可能\n- 既存の`clipboard-utils.ts`を活用\n\n### 2. エクスポート時の機密情報サニタイズ\n\nログエクスポート時に、外部公開したくないローカル環境情報を自動的に除去・マスキングする。\n\n**サニタイズ対象**:\n- ルートディレクトリ・ホームディレクトリのパス（例: `/Users/username/...` → `~/...` または `[HOME]/...`）\n- ワークツリーの絶対パス（相対パスまたはマスク済みパスに置換）\n- ホスト名・ユーザー名が含まれるパス情報\n- その他環境固有の情報（DB絶対パス等）\n\n**方針**:\n- 既存の`logger.ts`のサニタイズ機構（`SENSITIVE_PATTERNS` / `sanitize()`）はパスワード・トークン等の認証情報が対象\n- エクスポート用には、上記に加えてファイルパス・環境情報のサニタイズレイヤーを新設する\n- 原因調査に必要な相対パス・ファイル名は保持し、調査に支障が出ないようにする\n\n### 3. APIリクエスト/レスポンスログ（開発環境向け）\n\n開発環境（`NODE_ENV=development`）でのみ、全APIリクエスト/レスポンスの詳細ログを記録する。\n\n- 既存の構造化ログシステム（`logger.ts`）を活用\n- リクエスト: メソッド、URL、パラメータ\n- レスポンス: ステータスコード、レスポンス時間、エラー内容\n\n### 主要な変更点\n\n- ワークツリー詳細画面にログエクスポートボタンを追加\n- エラーログ抽出・Markdown整形ユーティリティの作成\n- エクスポート専用パスサニタイズ機能の実装\n- APIミドルウェアまたは各route.tsにリクエスト/レスポンスログ追加\n\n## 実装タスク\n\n- [ ] エラーログ抽出・Markdown整形ユーティリティの実装\n- [ ] エクスポート用パス・環境情報サニタイズ機能の実装\n- [ ] ワークツリー詳細画面にエクスポートボタンUIの追加\n- [ ] クリップボードコピー機能の実装（clipboard-utils.ts活用）\n- [ ] 開発環境用APIリクエスト/レスポンスロギングの実装\n- [ ] ユニットテストの追加（サニタイズ処理のテスト含む）\n\n## 受入条件\n\n- [ ] ワークツリー詳細画面のエクスポートボタンからエラーログをクリップボードにコピーできること\n- [ ] コピーされたログがMarkdown形式で、GitHub Issueにそのまま貼り付け可能であること\n- [ ] エクスポートされたログにルートディレクトリ・ホームディレクトリの絶対パスが含まれないこと\n- [ ] エクスポートされたログにホスト名・ユーザー名等の環境固有情報が含まれないこと\n- [ ] サニタイズ後もエラーの原因調査に必要な情報（相対パス・ファイル名・エラーメッセージ）が保持されていること\n- [ ] 開発環境でAPIリクエスト/レスポンスの詳細ログが記録されること\n- [ ] 本番環境ではAPIリクエスト/レスポンスの詳細ログが出力されないこと\n\n## 影響範囲\n\n### 変更対象ファイル\n\n| ファイル | 変更内容 |\n|---------|---------|\n| `src/components/worktree/WorktreeDetail.tsx` | エクスポートボタンUIの追加 |\n| `src/lib/clipboard-utils.ts` | ログ用コピー機能の拡張（必要に応じて） |\n| `src/lib/logger.ts` | APIログ出力機能の追加 |\n| `src/lib/log-manager.ts` | エラーログ抽出機能の追加 |\n| 新規: `src/lib/log-sanitizer.ts` | エクスポート用パス・環境情報サニタイズ |\n| `src/app/api/` (各route.ts) | リクエスト/レスポンスログ出力の追加 |\n\n### 関連コンポーネント\n\n- `src/lib/logger.ts` - 既存の構造化ログシステム（既存の`sanitize()`は認証情報対象、パスサニタイズは別レイヤー）\n- `src/lib/clipboard-utils.ts` - 既存のクリップボードユーティリティ\n- `src/lib/errors.ts` - AppErrorクラス（エラー情報の参照）\n- `src/lib/conversation-logger.ts` - 会話ログ（参考実装）\n- `src/lib/env.ts` - 環境変数（ホームディレクトリ・DBパス等の取得元）","number":11,"state":"OPEN","title":"操作性改善およびバグ原因調査目的のデータ収集機能強化"}
