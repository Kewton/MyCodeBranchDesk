# アーキテクチャレビュー: Issue #35 動的ポーリング間隔

**レビュー日**: 2026-01-11
**対象**: `dev-reports/design/issue-35-dynamic-polling-design-policy.md`
**レビュアー**: Claude Opus 4.5

---

## 1. 設計原則の遵守確認

### SOLID原則チェック

| 原則 | 評価 | 詳細 |
|------|------|------|
| **S** Single Responsibility | :white_check_mark: 適合 | `getPollingInterval`関数は間隔決定のみを担当。ポーリング実行とステータス判定が適切に分離されている |
| **O** Open/Closed | :white_check_mark: 適合 | `POLLING_INTERVALS`定数を変更することで間隔調整が可能。判定ロジックの拡張も容易 |
| **L** Liskov Substitution | N/A | 継承関係なし |
| **I** Interface Segregation | :white_check_mark: 適合 | 既存の`Worktree`型を活用し、不要なインターフェース追加なし |
| **D** Dependency Inversion | :white_check_mark: 適合 | `worktreeApi`を通じた抽象化を維持 |

### その他の原則

| 原則 | 評価 | 詳細 |
|------|------|------|
| KISS原則 | :white_check_mark: 適合 | 3段階のシンプルな間隔設定。過度な複雑性なし |
| YAGNI原則 | :white_check_mark: 適合 | WebSocket等の将来機能を含まず、必要最小限の実装 |
| DRY原則 | :white_check_mark: 適合 | `WorktreeDetail.tsx`の既存パターンを踏襲 |

---

## 2. アーキテクチャ評価

### 構造的品質

| 評価項目 | スコア | コメント |
|---------|--------|----------|
| モジュール性 | 5/5 | 既存のContext構造を維持しつつ、関数を追加するのみ |
| 結合度 | 5/5 | 低結合を維持。`worktreeApi`への依存のみ |
| 凝集度 | 5/5 | ポーリング関連ロジックが適切に集約 |
| 拡張性 | 4/5 | 間隔追加は容易だが、判定ロジックの拡張には関数修正が必要 |
| 保守性 | 5/5 | テスト設計が明確で、変更影響範囲が限定的 |

### パフォーマンス観点

| 項目 | 評価 |
|------|------|
| レスポンスタイム | 変化なし（ポーリング間隔のみ変更） |
| スループット | **大幅改善**（アイドル時80%削減） |
| リソース使用効率 | **改善**（tmux captureの実行回数削減） |
| スケーラビリティ | 変化なし（クライアント側の変更のみ） |

---

## 3. セキュリティレビュー

### OWASP Top 10 チェック

| 項目 | 評価 | 備考 |
|------|------|------|
| インジェクション対策 | N/A | 入力処理なし |
| 認証の破綻対策 | N/A | 認証ロジック変更なし |
| 機微データの露出対策 | N/A | 新規データ処理なし |
| XXE対策 | N/A | XML処理なし |
| アクセス制御の不備対策 | N/A | アクセス制御変更なし |
| セキュリティ設定ミス対策 | :white_check_mark: | 既存設定を維持 |
| XSS対策 | N/A | 新規レンダリングなし |
| 安全でないデシリアライゼーション対策 | N/A | デシリアライズ処理なし |
| 既知の脆弱性対策 | :white_check_mark: | 新規依存なし |
| ログとモニタリング不足対策 | :white_check_mark: | 既存のエラーログを維持 |

**セキュリティリスク**: なし

---

## 4. 既存システムとの整合性

### 統合ポイント

| 項目 | 評価 | 詳細 |
|------|------|------|
| API互換性 | :white_check_mark: | `/api/worktrees`のレスポンス形式変更なし |
| データモデル整合性 | :white_check_mark: | 既存の`Worktree`型をそのまま使用 |
| 認証/認可の一貫性 | :white_check_mark: | `worktreeApi`経由で既存認証を維持 |
| ログ/監視の統合 | :white_check_mark: | 既存のconsole.errorパターンを維持 |

### 技術スタックの適合性

| 項目 | 評価 |
|------|------|
| 既存技術との親和性 | :white_check_mark: React Hooks（useEffect, useReducer）を適切に活用 |
| チームのスキルセット | :white_check_mark: 既存パターン（WorktreeDetail.tsx）の踏襲で学習コスト最小 |
| 運用負荷への影響 | :white_check_mark: 負荷軽減方向の変更 |

---

## 5. リスク評価

| リスク種別 | 内容 | 影響度 | 発生確率 | 対策優先度 |
|-----------|------|-------|---------|-----------|
| 技術的リスク | 初回ポーリング重複（useEffect + poll()即時実行） | 低 | 低 | P3 |
| 技術的リスク | ステータス変化の検知遅延（最大10秒） | 中 | 中 | P2 |
| 運用リスク | なし | - | - | - |
| セキュリティリスク | なし | - | - | - |
| ビジネスリスク | UX低下の懸念（アイドル→処理中の遷移検知遅延） | 低 | 低 | P3 |

### リスク詳細

#### R1: ステータス変化の検知遅延（P2）

**問題**: アイドル状態（10秒間隔）から処理開始した場合、最大10秒間スピナーが表示されない可能性

**影響**: ユーザーが操作を開始したことの視覚的フィードバックが遅れる

**対策案**:
1. **推奨**: 現状維持（許容範囲内）
   - 処理開始はユーザーが能動的に行うため、認知している
   - 次回ポーリングで検知され、その後は2秒間隔になる
2. **代替**: セッション開始APIフックでポーリング即時実行
   - 実装コスト増、スコープ外

---

## 6. 改善提案

### 必須改善項目（Must Fix）

**なし** - 設計上の重大な問題は見つかりませんでした

### 推奨改善項目（Should Fix）

#### S1: `isWaitingForResponse`の判定追加

**現状の設計書コード（セクション3）**:
```typescript
const hasProcessing = worktrees.some(wt => wt.isProcessing);
```

**推奨**:
```typescript
const hasActiveProcessing = worktrees.some(wt =>
  wt.isProcessing || wt.isWaitingForResponse
);
```

**理由**: 設計書のセクション5.3では`isWaitingForResponse`を含めているが、セクション3のコード例では含まれていない。一貫性のため統一すべき。

> **補足**: 設計書内で既にセクション5.3にて修正版が記載されているため、実装時にセクション5.3の実装を採用すれば問題なし。

#### S2: デバッグログの追加検討

**提案**: 間隔変更時のログ出力（開発時のみ）

```typescript
if (process.env.NODE_ENV === 'development') {
  console.debug(`[WorktreeSelectionContext] Polling interval: ${nextInterval}ms`);
}
```

**理由**: 動的間隔の動作確認・デバッグが容易になる

### 検討事項（Consider）

#### C1: 指数バックオフの導入

**現状**: エラー時は固定5秒間隔で再試行

**検討案**: 連続エラー時は間隔を段階的に延長
```typescript
const errorCount = useRef(0);
// エラー時: 5秒 → 10秒 → 20秒 → 30秒（上限）
const errorInterval = Math.min(5000 * Math.pow(2, errorCount.current), 30000);
```

**判断**: 現状で十分（エラーは一時的なケースが多い）

#### C2: ブラウザタブの可視性対応

**検討案**: タブが非アクティブ時はポーリング停止/超低頻度化
```typescript
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    // ポーリング停止または60秒間隔
  }
});
```

**判断**: 将来的な改善として検討（現スコープ外）

---

## 7. ベストプラクティスとの比較

### 業界標準との差異

| パターン | 本設計 | 業界標準 | 評価 |
|---------|--------|----------|------|
| ポーリング戦略 | 状態ベース動的間隔 | 固定間隔 or WebSocket | :white_check_mark: 適切なバランス |
| エラーハンドリング | 固定間隔で再試行 | 指数バックオフ | :yellow_circle: 許容範囲 |
| クリーンアップ | isMountedフラグ | AbortController | :yellow_circle: 既存パターン踏襲 |

### 代替アーキテクチャ案

設計書で既に検討済み。評価は妥当:

1. **サーバー側間隔指定**: 不採用（変更範囲大）→ 妥当
2. **WebSocket**: 不採用（スコープ外）→ 妥当
3. **5段階間隔**: 不採用（過度な複雑性）→ 妥当

---

## 8. 総合評価

### レビューサマリ

| 項目 | 評価 |
|------|------|
| **全体評価** | :star::star::star::star::star: **5/5** |
| **強み** | シンプルで効果的な設計、既存パターンの踏襲、明確なテスト計画 |
| **弱み** | 特になし（軽微な改善点のみ） |

### 総評

本設計は、パフォーマンス改善という目的に対して**最小限の変更で最大の効果**を得られる優れた設計です。

**評価ポイント**:
1. **変更範囲の最小化**: 1ファイル + テストのみ
2. **既存パターンの活用**: `WorktreeDetail.tsx`の実績あるパターンを踏襲
3. **明確な効果**: アイドル時80%、セッション時60%のAPI呼び出し削減
4. **リスクの低さ**: 機能的な変更なし、UI/UXへの影響最小
5. **テスト設計**: 具体的なテストケースが設計書に含まれている

### 承認判定

:white_check_mark: **承認（Approved）**

設計書の内容で実装を進めて問題ありません。

### 次のステップ

1. **実装着手**: 設計書のセクション10「実装チェックリスト」に従って実装
2. **テスト追加**: セクション8のテストケースを実装
3. **動作確認**: 各ステータスでのポーリング間隔変更を確認
4. **PR作成**: 実装完了後、本レビュー結果を参照してPR作成

---

## 付録: レビューチェックリスト

- [x] 設計原則（SOLID, KISS, YAGNI, DRY）の確認
- [x] アーキテクチャ評価（モジュール性、結合度、凝集度）
- [x] セキュリティレビュー（OWASP Top 10）
- [x] 既存システムとの整合性確認
- [x] リスク評価と対策
- [x] 改善提案の整理
- [x] 業界標準との比較
- [x] 総合評価と承認判定
