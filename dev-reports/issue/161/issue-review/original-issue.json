{"body":"## 概要\n\nAuto-Yesモード有効時、選択肢のないプロンプト状態でも「1」が誤送信されることがある。\n\n## 再現手順\n\n1. CommandMateでワークツリーを選択\n2. Claude CLIセッションを開始\n3. Auto-Yesモードを有効化\n4. Claude CLIに何らかのタスクを依頼\n5. Claude CLIの応答中または応答完了後、意図せず「1」が送信される\n\n## 期待する動作\n\n- Auto-Yesは「(y/n)」や選択肢（❯ 1. Yes / 2. No形式）プロンプトにのみ自動応答すべき\n- 通常の出力テキストに番号付きリストが含まれていても誤検出しない\n\n## 実際の動作\n\n- Claude CLIの通常出力が誤ってmultiple_choiceプロンプトとして検出される\n- 「1」（デフォルト選択肢番号）が送信される\n\n## 根本原因の仮説\n\n`prompt-detector.ts`の`detectMultipleChoicePrompt`関数での誤検出：\n\n1. **パターンマッチの問題**:\n   ```typescript\n   const optionPattern = /^\\s*([❯ ]\\s*)?(\\d+)\\.\\s*(.+)$/;\n   ```\n   このパターンは「1. xxx」形式の通常テキスト（番号付きリスト）にもマッチする\n\n2. **検出条件の不足**:\n   - 現在の条件: 2つ以上のオプション + ❯インジケーター\n   - 問題: Claude CLIの出力で番号付きリストが使われ、かつ❯文字（または類似文字）が含まれると誤検出\n\n3. **ANSIエスケープシーケンスの処理**:\n   - `stripAnsi`で制御文字を除去後も、特定のパターンで誤検出する可能性\n\n## 影響範囲\n\n- Auto-Yesモード使用時の全ユーザー\n- Claude CLIが番号付きリストを出力するタスク（例：複数ステップの説明、オプション列挙など）\n- サーバー側ポーリング（`auto-yes-manager.ts`）とクライアント側フック（`useAutoYes.ts`）の両方\n\n## 関連コンポーネント\n\n| ファイル | 説明 |\n|---------|------|\n| `src/lib/prompt-detector.ts` | プロンプト検出ロジック（`detectMultipleChoicePrompt`） |\n| `src/lib/auto-yes-resolver.ts` | 自動応答決定ロジック |\n| `src/lib/auto-yes-manager.ts` | サーバー側ポーリング（Issue #138） |\n| `src/hooks/useAutoYes.ts` | クライアント側フック |\n| `src/lib/cli-patterns.ts` | ANSIストリッピング |\n\n## 対策案\n\n### 案1: 厳格なプロンプト検出\n\n選択肢プロンプトの検出条件を強化：\n- 選択肢の直前に質問文が必要\n- 選択肢が連続した行に配置されている\n- ❯の位置が行頭または先頭空白直後に限定\n\n### 案2: コンテキスト判定\n\n- Claude CLIが「thinking」状態でないことを確認\n- 最後のプロンプト送信から一定時間経過後のみ検出\n\n### 案3: 選択肢パターンの厳密化\n\n- 選択肢が正確に連番（1, 2, 3...）であることを検証\n- 選択肢の形式が一貫している（全て同じインデント、同じ書式）\n\n## 環境\n\n- OS: macOS / Linux\n- Node.js: v18+\n- ブラウザ: Chrome / Safari\n- CLI ツール: Claude Code\n\n## スクリーンショット\n\n<img width=\"1920\" height=\"1080\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/13438bbc-0dad-4129-b2ca-0cca5753fbf9\" />\n","title":"auto yes 実行時、それなりの頻度で\"1\"が送信される"}
