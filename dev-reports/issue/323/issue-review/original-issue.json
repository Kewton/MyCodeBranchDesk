{"body":"## 概要\n\n`src/lib/auto-yes-manager.ts`（706行）の複雑度を下げるリファクタリング。特に `pollAutoYes()` 関数（139行、条件分岐14個、責務7つ）を責務別に分割し、テスタビリティを向上させる。\n\n## 背景・動機\n\n- `pollAutoYes()` 関数が139行・7責務を担っており、単体テストが困難\n  - タイマー停止確認、auto-yes有効性チェック、tmux出力キャプチャ、ANSI処理、thinking状態検出、停止条件チェック、プロンプト検出・自動応答の7責務が1関数に集中\n- 外部依存が6つ（captureSessionOutput, detectThinking, detectPrompt, resolveAutoAnswer, sendPromptAnswer, CLIToolManager）あり、全てモック必須\n- `stopCheckBaselineLength` の初期値 `-1` と3パターン分岐（> = <）のデルタベース判定が不明瞭\n- pollerState の存在確認が複数箇所で重複（L457, L606, L680等）\n- グローバルstate（`globalThis`）依存でテスト時の状態リセットが困難\n\n## リファクタリング方針\n\n`pollAutoYes()` を責務別に分割し、各関数を個別にテスト可能にする。\n\n### 主要な変更点\n\n1. **`pollAutoYes()` の責務分割**（139行 → 4-5関数）\n   - `validatePollingContext()` - ポーリング前提条件チェック\n   - `captureAndCleanOutput()` - tmux出力取得・ANSIクリーニング\n   - `checkStopCondition()` - 停止条件のデルタベース判定\n   - `detectAndRespondToPrompt()` - プロンプト検出・自動応答\n\n2. **StopConditionChecker の導入**\n   - `stopCheckBaselineLength` の `-1` 初期化・3パターン分岐をクラスで隠蔽\n   - `setBaseline()`, `shouldCheck()`, `getDelta()` で意図を明確化\n\n3. **pollerState 存在確認の共通化**\n   - 重複する存在確認パターンをヘルパー関数に抽出\n\n### Before / After\n\n**Before**:\n- `pollAutoYes()`: 139行、責務7つ、条件分岐14個\n- テスト時に6つの外部依存を全てモック必要\n- stopCheckBaselineLength の判定ロジックが不透明\n\n**After**:\n- 各関数が単一責務（20-40行）\n- 分割された各関数を個別にテスト可能\n- StopConditionChecker で停止条件ロジックが自己文書化\n\n## 影響範囲\n\n### 変更対象ファイル\n\n| ファイル | 変更内容 |\n|---------|---------|\n| `src/lib/auto-yes-manager.ts` | pollAutoYes() の責務分割、StopConditionChecker 導入 |\n| `tests/unit/lib/auto-yes-manager.test.ts` | 既存テストの維持（リファクタ後も全テストパス） |\n\n### 関連コンポーネント（変更なし）\n\n- `src/lib/auto-yes-resolver.ts` - 依存先（変更不要）\n- `src/hooks/useAutoYes.ts` - クライアント側（変更不要）\n- `src/app/api/worktrees/[id]/auto-yes/route.ts` - API（変更不要）\n\n## 受入条件\n\n- [ ] 既存テスト（`tests/unit/lib/auto-yes-manager.test.ts`）が全てパスすること\n- [ ] `pollAutoYes()` が4-5個の単一責務関数に分割されていること\n- [ ] 停止条件チェックロジックがクラスまたは専用関数に抽出されていること\n- [ ] pollerState 存在確認の重複が解消されていること\n- [ ] 機能変更がないこと（外部インターフェースは維持）","title":"リファクタリング"}
