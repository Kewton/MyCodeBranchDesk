{"body":"## 概要\n\n`commandmate init` で対話形式のセットアップを実装する。現在は対話形式が実装されておらず、デフォルト値のみで `.env` が作成される。\n\n## 現状の問題\n\n### 1. 対話形式が未実装\n\nドキュメント（`docs/user-guide/cli-setup-guide.md`）には以下の記載があるが、実装されていない：\n\n```\n### 対話形式（推奨）\ncommandmate init\n\n対話形式で以下を設定できます：\n- ワークツリーのルートディレクトリ\n- サーバーポート（デフォルト: 3000）\n- 外部アクセスの許可\n```\n\n### 2. 現在のコードの動作\n\n`src/cli/commands/init.ts` (66-68行目):\n\n```typescript\nCM_ROOT_DIR: options.defaults\n  ? join(homedir(), 'repos')\n  : sanitizePath(process.env.CM_ROOT_DIR || join(homedir(), 'repos')),\n```\n\n| オプション | CM_ROOT_DIR の値 |\n|-----------|-----------------|\n| `--defaults` | `~/repos` (固定) |\n| オプションなし | 環境変数 `CM_ROOT_DIR` または `~/repos` |\n| `--force` | 上記と同じ（上書きのみ制御） |\n\n**ユーザーに入力を求めるプロンプトは存在しない。**\n\n### 3. ユーザー影響\n\n- `CM_ROOT_DIR` が `~/repos` に固定されるが、このディレクトリが存在しないことが多い\n- リポジトリ登録時に「Invalid or unsafe repository path」エラーが発生\n- ユーザーは `.env` を手動編集する必要がある\n\n## 期待する動作\n\n```bash\n$ commandmate init\n====================\n  CommandMate Init  \n====================\n\n[INFO] Checking system dependencies...\n[✓] All required dependencies found\n\n? Enter the root directory for your worktrees: ~/work/git\n? Enter the server port [3000]: 3000\n? Enable external access (for mobile)? [y/N]: N\n\n[INFO] Creating .env file...\n[✓] .env file created with your settings\n\n[✓] CommandMate initialized successfully!\n```\n\n## 要件\n\n### 機能要件\n\n1. **対話形式プロンプト**\n   - `CM_ROOT_DIR`: ワークツリーのルートディレクトリ（必須）\n   - `CM_PORT`: サーバーポート（デフォルト: 3000）\n   - 外部アクセス有効化（Y/N）\n     - Y の場合: `CM_BIND=0.0.0.0` と `CM_AUTH_TOKEN` を自動生成\n\n2. **オプション動作**\n   - `commandmate init`: 対話形式（デフォルト）\n   - `commandmate init --defaults`: 非対話形式（デフォルト値使用）\n   - `commandmate init --force`: 既存ファイル上書き許可\n   - `commandmate init --force --defaults`: 非対話で上書き\n\n3. **入力バリデーション**\n   - パスの存在確認（警告表示、作成確認）\n   - ポート番号の範囲チェック（1-65535）\n   - パストラバーサル防止\n\n### 非機能要件\n\n- Node.js 標準の `readline` モジュールを使用（追加依存なし）\n- TTY でない場合（CI/CD等）は `--defaults` を自動適用\n\n## 実装方針\n\n### 1. 対話ユーティリティの追加\n\n```typescript\n// src/cli/utils/prompt.ts\nimport * as readline from 'readline';\n\nexport async function prompt(question: string, defaultValue?: string): Promise<string>;\nexport async function confirm(question: string, defaultValue?: boolean): Promise<boolean>;\n```\n\n### 2. init コマンドの修正\n\n```typescript\n// src/cli/commands/init.ts\nexport async function initCommand(options: InitOptions): Promise<void> {\n  // ...preflight checks...\n\n  let config: EnvConfig;\n  \n  if (options.defaults || !process.stdin.isTTY) {\n    // Non-interactive mode\n    config = createDefaultConfig();\n  } else {\n    // Interactive mode\n    config = await promptForConfig();\n  }\n\n  // ...rest of initialization...\n}\n```\n\n## 受け入れ条件\n\n- [ ] `commandmate init` で対話形式プロンプトが表示される\n- [ ] `CM_ROOT_DIR` を対話で設定できる\n- [ ] `CM_PORT` を対話で設定できる\n- [ ] 外部アクセス有効化で `CM_AUTH_TOKEN` が自動生成される\n- [ ] `--defaults` で非対話形式が動作する\n- [ ] `--force` で既存ファイルを上書きできる\n- [ ] TTY でない環境では自動的に `--defaults` 相当の動作になる\n- [ ] ドキュメントと実装が一致する\n\n## 関連ファイル\n\n- `src/cli/commands/init.ts` - init コマンド本体\n- `src/cli/utils/env-setup.ts` - 環境設定ユーティリティ\n- `src/cli/utils/prompt.ts` - 新規作成（対話ユーティリティ）\n- `docs/user-guide/cli-setup-guide.md` - ドキュメント\n\n## テストケース\n\n1. 対話形式で全項目を設定\n2. 対話形式でデフォルト値を使用（Enter連打）\n3. `--defaults` で非対話形式\n4. `--force` で既存ファイル上書き\n5. TTY でない環境での動作\n6. 無効な入力（存在しないパス、範囲外ポート）の処理\n\n## 環境\n\n- commandmate v0.1.6\n- Node.js v20+\n- macOS / Linux\n\n## 参考\n\n- [Node.js readline](https://nodejs.org/api/readline.html)\n- `scripts/setup-env.sh` - シェルスクリプト版の対話実装","labels":[{"id":"LA_kwDOQWxIB88AAAACP5eHgg","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"title":"commandmate init: 対話形式セットアップの実装"}
