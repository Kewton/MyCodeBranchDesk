{
  "stage": 4,
  "focus_area": "セキュリティ",
  "review_date": "2026-01-31",
  "design_doc_path": "dev-reports/design/issue-100-mermaid-diagram-design-policy.md",
  "findings": {
    "must_fix": [],
    "should_fix": [
      {
        "id": "SEC-SF-001",
        "category": "A03:2021 - Injection",
        "title": "dangerouslySetInnerHTML使用時のセキュリティ保証の明確化",
        "description": "設計書5.2節でmermaidが生成するSVGをdangerouslySetInnerHTMLで描画することが記載されているが、mermaidのsecurityLevel='strict'がどのようにXSSを防止するかの詳細な説明が不足している。また、既存のIssue #49設計書ではMarkdownEditorでdangerouslySetInnerHTML禁止が明記されているが、本設計ではその例外として扱う根拠が弱い。",
        "location": "設計書 5.2節「rehype-sanitizeとの互換性」",
        "recommendation": "1. mermaid securityLevel='strict'の具体的なXSS防止メカニズムを文書化（DOMPurify使用、scriptタグ除去、イベントハンドラ無効化等）\n2. mermaid内部でDOMPurifyを使用している事実を明記し、dangerouslySetInnerHTML使用の安全性根拠を強化\n3. 既存のdangerouslySetInnerHTML禁止ポリシーとの整合性を説明"
      },
      {
        "id": "SEC-SF-002",
        "category": "A06:2021 - Vulnerable and Outdated Components",
        "title": "mermaidパッケージのバージョン固定戦略の見直し",
        "description": "設計書10.3節で^11.12.0（マイナーバージョン固定）としているが、npm registryでは11.12.2が最新。セキュリティパッチを即時取得できるセマンティックバージョニング（^11.12.x）は適切だが、mermaidのような大規模ライブラリでは予期しない破壊的変更のリスクがある。",
        "location": "設計書 10.1節、10.3節",
        "recommendation": "1. 初期導入時は最新安定版11.12.2を使用\n2. package-lock.jsonでの正確なバージョン管理を徹底\n3. Dependabotまたはrenovateによる定期的なセキュリティアップデート監視を推奨\n4. CIでnpm auditを実行し、脆弱性を早期検出"
      },
      {
        "id": "SEC-SF-003",
        "category": "A05:2021 - Security Misconfiguration",
        "title": "mermaid設定の検証とフェイルセーフ機構",
        "description": "設計書5.1節でMERMAID_CONFIGにsecurityLevel='strict'を定義しているが、設定が誤って変更された場合や、mermaid.initialize()が呼ばれなかった場合のフェイルセーフが考慮されていない。",
        "location": "設計書 5.1節「mermaid設定の一元管理」",
        "recommendation": "1. MermaidDiagram初期化時にsecurityLevelが'strict'であることをアサーション\n2. テストケースでsecurityLevel設定の検証を追加\n3. 将来の設定変更時にsecurityLevel以外への変更を防ぐコードコメント追加"
      },
      {
        "id": "SEC-SF-004",
        "category": "A03:2021 - Injection",
        "title": "Issue #95 SVG XSS対策との整合性確認",
        "description": "Issue #95のimage-extensions.tsでは独自のSVG XSS検証（validateSvgContent）を実装しているが、mermaid生成SVGには適用されない。mermaidのsecurityLevel='strict'とIssue #95のSVG検証は同等の保護レベルを提供するか確認が必要。",
        "location": "設計書全体、src/config/image-extensions.ts",
        "recommendation": "1. mermaidのsecurityLevel='strict'がIssue #95の5項目（script, event handlers, javascript:/data:/vbscript:, foreignObject, XML declaration）すべてをカバーすることを確認・文書化\n2. 設計書にIssue #95との整合性確認結果を追記"
      }
    ],
    "nice_to_have": [
      {
        "id": "SEC-NTH-001",
        "category": "CSP Compatibility",
        "title": "Content Security Policy互換性の明記",
        "description": "設計書5.3節で「外部リソース読み込みはCSPヘッダーで制限」と記載があるが、mermaid SVGがインラインスタイルやインラインSVGを使用するため、厳格なCSP（style-src 'self'、svg-src等）との互換性確認が推奨される。",
        "location": "設計書 5.3節「セキュリティチェックリスト」",
        "recommendation": "mermaid生成SVGで使用されるインラインスタイル、インラインスクリプト（securityLevel='strict'で無効化済み）がCSPポリシーと競合しないことを確認"
      },
      {
        "id": "SEC-NTH-002",
        "category": "Error Information Disclosure",
        "title": "エラーメッセージの情報漏洩リスク",
        "description": "設計書7.2節のエラーUI設計で、mermaid構文エラー時のerrorMessageをそのまま表示している。mermaidライブラリのエラーメッセージに内部情報（パス、バージョン等）が含まれる可能性がある。",
        "location": "設計書 7.2節「エラー表示UI」",
        "recommendation": "本番環境ではエラーメッセージをサニタイズまたは汎用化し、詳細ログはコンソールのみに出力することを検討"
      },
      {
        "id": "SEC-NTH-003",
        "category": "Supply Chain Security",
        "title": "mermaid依存関係の継続的監視",
        "description": "mermaidは20の直接依存を持つ大規模ライブラリ。dompurify（XSS対策）、d3、cytoscapeなど、各依存ライブラリのセキュリティ状態を定期監視することが推奨される。",
        "location": "設計書 10.2節「mermaidパッケージの詳細情報」",
        "recommendation": "GitHub Dependabot alertsまたはSnykの導入を検討し、依存関係の脆弱性を自動監視"
      }
    ]
  },
  "owasp_compliance": {
    "a03_injection": {
      "status": "warning",
      "notes": "mermaid securityLevel='strict'によりXSSスクリプト実行は防止される設計。ただし、dangerouslySetInnerHTML使用の安全性根拠を設計書で明確化する必要がある。8.4節のXSS回帰テストケースは適切に設計されている。"
    },
    "a05_security_misconfiguration": {
      "status": "pass",
      "notes": "securityLevel='strict'、startOnLoad=false、設定の一元管理（src/config/mermaid-config.ts）が適切に設計されている。設定検証のフェイルセーフ追加を推奨（SEC-SF-003）。"
    },
    "a06_vulnerable_components": {
      "status": "pass",
      "notes": "mermaid 11.12.0は現時点で既知の脆弱性なし（npm audit結果）。セマンティックバージョニング（^11.12.0）によりパッチ適用可能。継続的な監視を推奨（SEC-NTH-003）。"
    },
    "a08_integrity_failures": {
      "status": "pass",
      "notes": "dynamic importはNext.jsの標準機能を使用。mermaidはnpm registryから取得され、package-lock.jsonでハッシュ検証される。サプライチェーンリスクは通常のnpmワークフローで管理される。"
    }
  },
  "security_recommendations": [
    {
      "priority": "high",
      "recommendation": "設計書5.2節にmermaid securityLevel='strict'の具体的なXSS防止メカニズム（DOMPurify使用、script無効化、イベントハンドラ除去）を追記し、dangerouslySetInnerHTML使用の安全性根拠を強化する",
      "related_finding": "SEC-SF-001"
    },
    {
      "priority": "medium",
      "recommendation": "MermaidDiagram.tsxの実装時に、mermaid.initialize()後にsecurityLevelが'strict'であることを検証するアサーションを追加する",
      "related_finding": "SEC-SF-003"
    },
    {
      "priority": "medium",
      "recommendation": "8.4節のXSS回帰テストを実装する際、Issue #95のvalidateSvgContent()が検証する5項目（script, event handlers, dangerous URIs, foreignObject）すべてがmermaid出力でも防止されることを確認するテストを追加する",
      "related_finding": "SEC-SF-004"
    },
    {
      "priority": "low",
      "recommendation": "CI/CDパイプラインでnpm auditを定期実行し、mermaid依存関係の脆弱性を早期検出する",
      "related_finding": "SEC-SF-002, SEC-NTH-003"
    }
  ],
  "existing_security_patterns_consistency": {
    "issue_95_svg_xss": {
      "status": "consistent",
      "notes": "Issue #95のSVG XSS対策（validateSvgContent）は静的SVGファイルアップロード用。mermaidは動的生成でありsecurityLevel='strict'による内部サニタイズに依存。異なるアプローチだが、同等のセキュリティレベルを達成。テストで検証を推奨。"
    },
    "issue_49_rehype_sanitize": {
      "status": "consistent",
      "notes": "Issue #49で導入したrehype-sanitizeは非mermaidマークダウンコンテンツに適用。mermaidコードブロックはMermaidDiagramコンポーネントに委譲されるため、rehype-sanitizeは適用されない。mermaid内部のDOMPurifyが代替として機能。"
    },
    "dangerously_set_inner_html_policy": {
      "status": "exception_justified",
      "notes": "Issue #49設計書ではdangerouslySetInnerHTML禁止が明記されているが、mermaidは外部ライブラリが生成するサニタイズ済みSVGを描画する必要があるため、例外として妥当。ただし設計書で例外理由を明記する必要あり。"
    }
  },
  "summary": "Issue #100 Mermaid Diagram設計書のセキュリティ面は概ね適切に設計されている。securityLevel='strict'によるXSS防止、設定の一元管理、XSS回帰テストの計画が含まれている。OWASP Top 10の主要項目（A03 Injection、A05 Security Misconfiguration、A06 Vulnerable Components、A08 Integrity Failures）に対応している。\n\nMust Fix項目はなく、4件のShould Fix項目はいずれも設計書の明確化・強化に関するものである。特にdangerouslySetInnerHTML使用の安全性根拠とIssue #95 SVG XSS対策との整合性確認を推奨する。\n\n全体として、セキュリティ設計は承認可能なレベルにあり、指摘事項を設計書に反映することでさらに堅牢な設計となる。"
}
