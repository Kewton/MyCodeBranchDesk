# Issue #187 仮説検証レポート

## 検証日時
- 2026-02-08

## 検証結果サマリー

| # | 仮説/主張 | 判定 | 根拠 |
|---|----------|------|------|
| 1 | `sendMessageToClaude()` でプロンプト検出後の安定化待機がない | **Confirmed** | L374-391で `waitForPrompt()` 後に `CLAUDE_POST_PROMPT_DELAY` が適用されていない |
| 2 | `startClaudeSession()` のセパレータ早期検出 | **Confirmed** | L325で `CLAUDE_SEPARATOR_PATTERN` がOR条件で含まれている |
| 3 | タイムアウト時の送信強行 | **Confirmed** | L381-386で catch ブロックが warn のみで送信を続行 |
| 4 | 入力エリアのクリアなしでのメッセージ送信 | **Confirmed** | L390-391にクリア処理なし |
| 5 | `stripAnsi` の不完全なエスケープシーケンス除去 | **Partially Confirmed** | DEC Private Mode未対応だが、実際の影響は限定的 |

## 詳細検証

### 仮説 1: `sendMessageToClaude()` でプロンプト検出後の安定化待機がない

**Issue内の記述**:
> `startClaudeSession()` ではプロンプト検出後に `CLAUDE_POST_PROMPT_DELAY`（500ms）の安定化待機を行っているが、`sendMessageToClaude()` 内の `waitForPrompt()` 復帰後には安定化待機がない。

**検証手順**:
1. `src/lib/claude-session.ts` L326-327: `startClaudeSession()` では `CLAUDE_POST_PROMPT_DELAY` あり
2. `src/lib/claude-session.ts` L374-391: `sendMessageToClaude()` では `waitForPrompt()` 後に即 `sendKeys` 実行

**判定**: **Confirmed**

**根拠**:
- `startClaudeSession()` L327: `await new Promise((resolve) => setTimeout(resolve, CLAUDE_POST_PROMPT_DELAY));`
- `sendMessageToClaude()` L378-391: `waitForPrompt()` 後に安定化待機なしで L390 `sendKeys` を直接呼び出し
- また、L378の即時プロンプト検出時（ifブロックに入らない場合）も安定化待機なしでL390に到達

**Issueへの影響**: 正確。P0対策の根拠として有効。

---

### 仮説 2: `startClaudeSession()` のセパレータ早期検出

**Issue内の記述**:
> `CLAUDE_SEPARATOR_PATTERN`（`^─{10,}$`）がプロンプトより先に出現する場合、プロンプト未出現のまま `startClaudeSession()` が復帰する。

**検証手順**:
1. `src/lib/claude-session.ts` L325: 条件式確認
2. `src/lib/cli-patterns.ts` L52: `CLAUDE_SEPARATOR_PATTERN = /^─{10,}$/m`

**判定**: **Confirmed**

**根拠**:
- L325: `if (CLAUDE_PROMPT_PATTERN.test(cleanOutput) || CLAUDE_SEPARATOR_PATTERN.test(cleanOutput))`
- セパレータのみ出現しプロンプト未出現の場合でも `initialized = true` となり復帰
- ただし L327 で安定化待機（500ms）はある

**Issueへの影響**: 正確。P1対策の根拠として有効。ただし安定化待機がある点も記載すべき。

---

### 仮説 3: タイムアウト時の送信強行

**Issue内の記述**:
> 10秒のタイムアウト後、プロンプト未検出でもメッセージを強制送信する。

**検証手順**:
1. `src/lib/claude-session.ts` L380-386

**判定**: **Confirmed**

**根拠**:
- L381: `await waitForPrompt(sessionName, 10000);` （Issueは10秒と記載しているが、実コードでは10000ms = 10秒で一致）
- L383-385: catch ブロックで `console.warn` のみ、送信は L390-391 で続行
- ただし、`CLAUDE_PROMPT_WAIT_TIMEOUT` 定数（L83: 5000ms）ではなく、ハードコードの10000msが使用されている点は軽微な不整合

**Issueへの影響**: 正確。`waitForPrompt` のデフォルトタイムアウトは5000ms（L83）だが、ここでは10000msに上書きされている。

---

### 仮説 4: 入力エリアのクリアなしでのメッセージ送信

**Issue内の記述**:
> 送信前に入力エリアの既存テキストをクリアする処理がない。Claude CLIがサジェスト（例: `❯ /help`）を表示中の場合、メッセージが結合される可能性がある。

**検証手順**:
1. `src/lib/claude-session.ts` L389-391: 送信前処理確認

**判定**: **Confirmed**

**根拠**:
- L390-391では `sendKeys(sessionName, message, false)` → `sendKeys(sessionName, '', true)` のみ
- `Ctrl+U`（行頭までの削除）や `Ctrl+A` + `Ctrl+K`（行全体削除）等のクリア処理なし
- Claude CLIのプロンプトに `/help` 等のサジェストが表示されている場合、メッセージが結合されるリスクあり

**Issueへの影響**: 正確。P2対策の根拠として有効。

---

### 仮説 5: `stripAnsi` の不完全なエスケープシーケンス除去

**Issue内の記述**:
> DEC Private Mode（`\x1b[?25h` 等）に未対応。残存したシーケンスがプロンプトパターンの `^` アンカーとの一致を妨げる可能性がある（影響は限定的）。

**検証手順**:
1. `src/lib/cli-patterns.ts` L167: ANSI_PATTERNの確認

**判定**: **Partially Confirmed**

**根拠**:
- L167: `const ANSI_PATTERN = /\x1b\[[0-9;]*[a-zA-Z]|\x1b\][^\x07]*\x07|\[[0-9;]*m/g;`
- DEC Private Mode `\x1b[?25h`（カーソル表示）: `\x1b\[` の後に `?` があるが、パターンは `[0-9;]*` なので `?` がマッチしない → **未対応確認**
- ただし、Issue記載の通り「影響は限定的」で、tmuxの `capture-pane` は通常ANSIシーケンスを除去して出力する（`-p` オプション使用時）
- 実際にプロンプト検出に影響するケースは稀

**Issueへの影響**: 分析は正確。DEC Private Mode未対応は事実だが、実影響は限定的という評価も妥当。

---

## Stage 1レビューへの申し送り事項

- 全5仮説が確認済み（4 Confirmed, 1 Partially Confirmed）。Issueの原因分析は高精度。
- 仮説2について補足: セパレータ早期検出時にも `CLAUDE_POST_PROMPT_DELAY`（500ms）の安定化待機は行われる（L327）。ただし、`sendMessageToClaude()` 側では `startClaudeSession()` がセパレータで復帰した場合にプロンプト検出を初めて行い、検出後の安定化待機がないため、問題は依然として存在。
- 仮説3の10000msハードコードは `CLAUDE_PROMPT_WAIT_TIMEOUT`（5000ms）との不整合がある。改善案で定数使用を検討すべき。
- 改善案の優先度（P0/P1/P2）は妥当と判断。

---

*Generated by hypothesis-verification phase*
