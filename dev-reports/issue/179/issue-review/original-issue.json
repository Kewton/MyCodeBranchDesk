{"body":"## 概要\n\n現在の`CM_AUTH_TOKEN`による認証機能を削除し、外部公開時はリバースプロキシでの認証を推奨する方針に変更する。\n\n関連: #174\n\n## 背景\n\n### 現在の認証方式の問題\n\n現在の実装では`NEXT_PUBLIC_CM_AUTH_TOKEN`がクライアントJSに埋め込まれるため、**セキュリティとして機能していない**。\n\n```\n┌─────────────────┐     ┌──────────────────┐     ┌─────────────┐\n│  .env           │     │  ブラウザJS      │     │  サーバー   │\n│  CM_AUTH_TOKEN  │ ──> │  (NEXT_PUBLIC_*) │ ──> │  検証       │\n│  = \"secret123\"  │     │  = \"secret123\"   │     │             │\n└─────────────────┘     └──────────────────┘     └─────────────┘\n                               ↑\n                        DevToolsで丸見え\n```\n\n| 攻撃者の行動 | 結果 |\n|-------------|------|\n| DevTools → Network → リクエストヘッダー確認 | トークン取得可能 |\n| JSファイルを検索 | トークン取得可能 |\n| ビルド済み.nextフォルダを確認 | トークン取得可能 |\n\n**結論**: 現在のトークン方式は「セキュリティシアター」であり、悪意のある攻撃者には無力。\n\n## 解決策\n\n### 1. 認証機能を削除\n\n- `src/middleware.ts`の認証ロジックを削除\n- `CM_AUTH_TOKEN`/`NEXT_PUBLIC_CM_AUTH_TOKEN`環境変数を非推奨化\n- `api-client.ts`のAuthorizationヘッダー送信を削除\n\n### 2. リバースプロキシ認証を推奨\n\n外部公開が必要な場合は、以下の方法をドキュメントで推奨：\n\n#### Nginx + Basic認証の例\n\n```nginx\nserver {\n    listen 443 ssl;\n    server_name commandmate.example.com;\n\n    # Basic認証\n    auth_basic \"CommandMate\";\n    auth_basic_user_file /etc/nginx/.htpasswd;\n\n    location / {\n        proxy_pass http://127.0.0.1:3000;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host $host;\n        proxy_cache_bypass $http_upgrade;\n    }\n}\n```\n\n#### Cloudflare Access / Tailscale\n\n- Cloudflare Access: ゼロトラストアクセス\n- Tailscale: VPNメッシュネットワーク\n\n### 3. commandmate init での警告メッセージ\n\n`commandmate init`で外部公開設定（`CM_BIND=0.0.0.0`）を選択した場合、以下の警告メッセージを出力する：\n\n```\n⚠️  外部公開設定が有効です\n\nCommandMateを外部ネットワークに公開する場合は、\nリバースプロキシでの認証設定を強く推奨します。\n\n推奨される認証方法:\n  • Nginx + Basic認証\n  • Cloudflare Access\n  • Tailscale\n\n詳細: https://github.com/Kewton/CommandMate/docs/security-guide.md\n```\n\n## 実装タスク\n\n- [ ] `src/middleware.ts`から認証ロジックを削除\n- [ ] `src/lib/api-client.ts`からAuthorizationヘッダー送信を削除\n- [ ] `src/lib/env.ts`から`CM_AUTH_TOKEN`関連を削除（または非推奨化）\n- [ ] `.env.example`から`CM_AUTH_TOKEN`を削除\n- [ ] `commandmate init`から認証トークン設定を削除\n- [ ] `commandmate init`で`CM_BIND=0.0.0.0`選択時に警告メッセージを出力\n- [ ] ドキュメント更新（外部公開時のセキュリティガイド追加）\n- [ ] CHANGELOG更新（破壊的変更として記載）\n\n## 受け入れ条件\n\n- [ ] `CM_BIND=0.0.0.0`設定時も認証なしでAPIアクセス可能\n- [ ] 既存の`CM_AUTH_TOKEN`設定があっても動作に影響なし（無視される）\n- [ ] `commandmate init`で外部公開設定時にリバースプロキシ認証推奨メッセージが表示される\n- [ ] 外部公開時のセキュリティガイドがドキュメントに追加されている\n\n## 破壊的変更\n\n- `CM_AUTH_TOKEN`/`NEXT_PUBLIC_CM_AUTH_TOKEN`は無視されるようになる\n- 認証が必要な場合はリバースプロキシでの設定が必要\n\n## セキュリティ考慮\n\n- CommandMateは「信頼できるネットワーク内での使用」を前提とする\n- 外部公開時はリバースプロキシでの認証を必須とする\n- ドキュメントで明確に警告を記載\n","title":"refactor: CM_AUTH_TOKEN認証機能を削除し、リバースプロキシ認証を推奨"}
