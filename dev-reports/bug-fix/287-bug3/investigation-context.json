{
  "issue_description": "prompt-detector.ts が Claude の過去の会話テキスト内の番号付きリスト（例: 1. Issue #286のコメントに... 2. /issue-enhance...）を active な multiple_choice プロンプトとして誤検出する。セッションがアイドル状態（❯）でも isPromptWaiting: true になり、UIに偽のプロンプトダイアログが表示される。",
  "error_logs": [],
  "affected_files": [
    "src/lib/prompt-detector.ts"
  ],
  "reproduction_steps": [
    "1. Claude Code セッションで対話を行い、番号付きリスト（1. Option A, 2. Option B）を含む回答をClaudeが生成",
    "2. ユーザーが ❯ プロンプトで「1」と入力して応答",
    "3. Claude がコマンドを実行し、レスポンスを返す",
    "4. セッションがアイドル（❯）に戻る",
    "5. CommandMate の current-output API が isPromptWaiting: true を返し、過去の番号付きリストを multiple_choice プロンプトとして誤検出する"
  ],
  "environment": {
    "os": "macOS Darwin 25.2.0",
    "node_version": "18.x",
    "browser": "Chrome (Mobile)"
  },
  "severity_hint": "high",
  "prior_analysis": {
    "root_cause": "prompt-detector.ts の detectMultipleChoicePrompt() (L607-749) の Pass 2 逆方向スキャン (L651-701) で、collectedOptions.length === 0 の場合に非オプション行が完全にスキップされるため、ユーザー入力プロンプト行（❯ 1 等）や アイドルプロンプト行（❯）を通過して、50行ウィンドウ内の古い番号付きリストまでスキャンが到達する。Claude 向け requireDefaultIndicator=false の場合、Pass 1 ❯ゲートが無効化されているため、Layer 2 による防御も効かない。",
    "affected_flow": "detectMultipleChoicePrompt() → Pass 2 backward scan → NORMAL_OPTION_PATTERN マッチ → Layer 3-5 通過 → false positive",
    "proposed_fix": "Pass 2 ループ内に「ユーザー入力プロンプトバリア」を追加。collectedOptions.length === 0 かつ行が ❯ (U+276F) で始まる（DEFAULT_OPTION_PATTERN に非マッチ）場合、スキャンを停止して noPromptResult を返す。これにより、❯ より上の過去の会話テキストへのスキャンを防止する。"
  }
}
