{
  "stage": 4,
  "stage_name": "セキュリティレビュー",
  "focus_area": "セキュリティ",
  "security_score": "7/10",
  "review_date": "2026-01-30",
  "reviewer": "architecture-review-agent",
  "findings": {
    "must_fix": [
      {
        "id": "SEC-MF-001",
        "category": "SVG XSS Attack Vector",
        "severity": "high",
        "title": "SVG検証が不十分 - イベントハンドラによるXSS攻撃の可能性",
        "description": "validateSvgContent()関数は<script>タグのみを検出するが、SVGにはonload, onclick, onmouseover等のイベントハンドラ属性でJavaScriptを実行できる。これらはXSS攻撃ベクトルとなる。",
        "current_design": "if (/<script[\\s>]/i.test(content)) { return { valid: false, error: 'SVG contains script tags' }; }",
        "attack_example": "<svg onload=\"alert('XSS')\"><circle cx=\"50\" cy=\"50\" r=\"40\"/></svg>",
        "recommendation": "以下のイベントハンドラ属性も検出して拒否すること: onload, onclick, onmouseover, onerror, onfocus, onblur, その他on*属性。正規表現例: /\\s+on\\w+\\s*=/i",
        "owasp_ref": "A03:2021 - Injection"
      },
      {
        "id": "SEC-MF-002",
        "category": "SVG XSS Attack Vector",
        "severity": "high",
        "title": "SVG内のhref属性によるJavaScript実行",
        "description": "SVGのa要素やuse要素のxlink:href、href属性にjavascript:スキームを使用することでスクリプトを実行可能。",
        "attack_example": "<svg><a xlink:href=\"javascript:alert('XSS')\"><text>Click</text></a></svg>",
        "recommendation": "javascript:、data:、vbscript:スキームを含むhref属性を検出して拒否すること。正規表現例: /(?:xlink:)?href\\s*=\\s*[\"']?\\s*(?:javascript|data|vbscript):/i",
        "owasp_ref": "A03:2021 - Injection"
      },
      {
        "id": "SEC-MF-003",
        "category": "SVG XSS Attack Vector",
        "severity": "medium",
        "title": "SVG内のforeignObject要素によるHTML挿入",
        "description": "SVGのforeignObject要素内にHTMLを埋め込み、scriptタグを含めることでXSS攻撃が可能。",
        "attack_example": "<svg><foreignObject><body><script>alert('XSS')</script></body></foreignObject></svg>",
        "recommendation": "<foreignObject>タグを検出して拒否するか、内部のHTMLコンテンツをサニタイズすること。",
        "owasp_ref": "A03:2021 - Injection"
      }
    ],
    "should_fix": [
      {
        "id": "SEC-SF-001",
        "category": "Magic Bytes Validation Bypass",
        "severity": "medium",
        "title": "マジックバイト検証のポリグロットファイル対策",
        "description": "マジックバイト検証は有効なセキュリティ対策だが、ポリグロットファイル（複数形式として解釈可能なファイル）によるバイパスが理論的に可能。特にGIF形式は'GIF89a'のASCIIで始まるためテキストと画像の境界が曖昧。",
        "current_design": "マジックバイト検証はファイル先頭のみをチェック",
        "recommendation": "以下の追加対策を検討: (1) Content-Type応答ヘッダーでnosniffを設定（X-Content-Type-Options: nosniff）、(2) 画像表示時にCSPヘッダーでscript-src制限",
        "note": "現時点のBase64 data URI表示では直接的な脆弱性にならないが、将来の拡張に備えた防御層として推奨"
      },
      {
        "id": "SEC-SF-002",
        "category": "Error Information Disclosure",
        "severity": "low",
        "title": "エラーメッセージからの情報漏洩防止の確認",
        "description": "設計書にはエラーメッセージの詳細が明記されているが、実装時に内部パスや詳細なエラー情報がクライアントに漏洩しないよう注意が必要。",
        "current_design": "既存のcreateErrorResult()関数がエラーメッセージを抽象化している",
        "recommendation": "GET API拡張時も既存のcreateErrorResult()パターンを使用し、'Invalid image magic bytes'等の抽象的なメッセージを返すこと。ファイルパスや詳細なバッファ情報を含めないこと。",
        "owasp_ref": "A01:2021 - Broken Access Control"
      },
      {
        "id": "SEC-SF-003",
        "category": "Denial of Service",
        "severity": "medium",
        "title": "Base64エンコード時のメモリ使用量",
        "description": "5MBの画像ファイルをBase64エンコードすると約6.7MBとなり、JSONレスポンスに含めるとさらにメモリを消費。大量の同時リクエストでメモリ枯渇の可能性。",
        "current_design": "IMAGE_MAX_SIZE_BYTES = 5 * 1024 * 1024 (5MB)",
        "recommendation": "以下の対策を検討: (1) レート制限の導入、(2) 同時処理数の制限、(3) より厳しいサイズ制限（2-3MB推奨）、(4) ストリーミング配信の将来検討"
      },
      {
        "id": "SEC-SF-004",
        "category": "Image Processing Security",
        "severity": "low",
        "title": "WebP形式のマジックバイト検証の不完全性",
        "description": "WebPのマジックバイト[0x52, 0x49, 0x46, 0x46]は'RIFF'であり、WAVやAVI等の他のRIFFコンテナ形式と共通。完全なWebP検証には追加チェックが必要。",
        "current_design": "{ extension: '.webp', mimeType: 'image/webp', magicBytes: [0x52, 0x49, 0x46, 0x46] }",
        "recommendation": "オフセット8-11に'WEBP'が存在するか追加検証すること。magicBytesOffsetを活用するか、検証ロジックを拡張。",
        "note": "リスクは低いが、形式の厳密な検証として推奨"
      }
    ],
    "nice_to_have": [
      {
        "id": "SEC-NTH-001",
        "category": "Defense in Depth",
        "title": "Content Security Policy (CSP) ヘッダーの追加",
        "description": "画像表示ページにCSPヘッダーを追加し、万が一の XSS 攻撃を緩和。",
        "recommendation": "レスポンスヘッダーに Content-Security-Policy: default-src 'self'; img-src 'self' data:; script-src 'self' を追加"
      },
      {
        "id": "SEC-NTH-002",
        "category": "Input Validation",
        "title": "SVGサニタイゼーションライブラリの採用検討",
        "description": "現在の正規表現ベースのSVG検証は保守性が低い。将来的にはDOMPurify等の専用ライブラリ採用を検討。",
        "recommendation": "DOMPurifyやsanitize-svgなどの成熟したライブラリの採用を将来の拡張時に検討",
        "note": "YAGNI原則により現時点では不要だが、SVG対応の拡張時に検討"
      },
      {
        "id": "SEC-NTH-003",
        "category": "Logging and Monitoring",
        "title": "セキュリティイベントのログ記録",
        "description": "マジックバイト検証失敗やSVGスクリプト検出等のセキュリティイベントをログに記録し、攻撃検知に活用。",
        "recommendation": "セキュリティ関連のエラー（INVALID_MAGIC_BYTES等）発生時にログレベルwarnでIPアドレスと対象ファイルパスを記録"
      },
      {
        "id": "SEC-NTH-004",
        "category": "Future Consideration",
        "title": "アップロード機能との連携時のセキュリティ",
        "description": "依存Issue #94（ファイルアップロード機能）との連携時、アップロード時とビューワー表示時の両方でセキュリティチェックが必要。",
        "recommendation": "アップロード時にもマジックバイト検証とSVGサニタイゼーションを実施し、二重防御とすること"
      }
    ]
  },
  "owasp_top10_coverage": {
    "A01_Broken_Access_Control": {
      "status": "covered",
      "details": "isPathSafe()によるパストラバーサル防止が実装済み"
    },
    "A02_Cryptographic_Failures": {
      "status": "not_applicable",
      "details": "画像表示機能では暗号化要件なし"
    },
    "A03_Injection": {
      "status": "partial",
      "details": "SVG XSS対策が不十分。scriptタグのみ検出だがイベントハンドラ未対応"
    },
    "A04_Insecure_Design": {
      "status": "covered",
      "details": "拡張子ホワイトリスト、ファイルサイズ制限、マジックバイト検証が設計済み"
    },
    "A05_Security_Misconfiguration": {
      "status": "partial",
      "details": "CSPヘッダーの設定が未検討"
    },
    "A06_Vulnerable_Components": {
      "status": "covered",
      "details": "外部ライブラリ依存を最小化（YAGNI原則）"
    },
    "A07_Auth_Failures": {
      "status": "not_applicable",
      "details": "既存の認証機構に依存"
    },
    "A08_Data_Integrity_Failures": {
      "status": "covered",
      "details": "マジックバイト検証によるファイル形式の整合性確認"
    },
    "A09_Logging_Failures": {
      "status": "partial",
      "details": "セキュリティイベントのログ記録が未設計"
    },
    "A10_SSRF": {
      "status": "not_applicable",
      "details": "外部URL取得機能なし"
    }
  },
  "security_checklist": {
    "path_traversal_prevention": {
      "status": "pass",
      "details": "既存のisPathSafe()関数を活用"
    },
    "extension_whitelist": {
      "status": "pass",
      "details": "IMAGE_EXTENSIONSでホワイトリスト管理"
    },
    "file_size_limit": {
      "status": "pass",
      "details": "5MB制限で DoS 対策"
    },
    "magic_bytes_validation": {
      "status": "partial",
      "details": "基本的な検証は実装されているがWebP形式の検証が不完全"
    },
    "svg_xss_prevention": {
      "status": "fail",
      "details": "scriptタグのみ検出。イベントハンドラ、href属性、foreignObject未対応"
    },
    "error_message_sanitization": {
      "status": "pass",
      "details": "既存パターン（createErrorResult）を踏襲"
    },
    "base64_encoding_safety": {
      "status": "pass",
      "details": "data URIでの表示は直接的なセキュリティリスクなし"
    }
  },
  "summary": "Issue #95 画像ファイルビューワの設計方針書は基本的なセキュリティ対策（パストラバーサル防止、拡張子ホワイトリスト、ファイルサイズ制限、マジックバイト検証）が適切に設計されている。しかし、SVG形式のXSS対策が不十分であり、scriptタグの検出のみでは不十分。イベントハンドラ属性（onload, onclick等）、javascript: スキームのhref属性、foreignObject要素によるHTML挿入への対策が必要（must_fix: SEC-MF-001, SEC-MF-002, SEC-MF-003）。これらの対策を実装前に追加することで、セキュリティスコアを7/10から9/10に向上可能。"
}
