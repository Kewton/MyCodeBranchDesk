{
  "issue_number": 162,
  "focus_area": "影響範囲",
  "stage": 3,
  "stage_name": "影響分析レビュー",
  "status": "conditionally_approved",
  "score": 4,
  "findings": {
    "must_fix": [
      {
        "id": "MF-S3-001",
        "category": "ripple-effect",
        "title": "renameFileOrDirectory() リファクタリングが既存テストに影響する",
        "description": "設計書 MF-001 により renameFileOrDirectory() が validateFileOperation() を使用するようリファクタリングされるが、既存の tests/unit/lib/file-operations.test.ts に renameFileOrDirectory() のテストケースが存在する。リファクタリング後にこれらの既存テストが引き続きパスすることを確認する回帰テスト戦略が設計書に明記されていない。",
        "affected_files": [
          "src/lib/file-operations.ts",
          "tests/unit/lib/file-operations.test.ts"
        ],
        "risk": "medium",
        "recommendation": "設計書のテスト戦略（Section 6）に、renameFileOrDirectory() の既存テストケースが validateFileOperation() 導入後も全てパスすることを確認する回帰テスト要件を追加すること。"
      },
      {
        "id": "MF-S3-002",
        "category": "api-contract",
        "title": "PATCH API の action パラメータ 'move' 追加時の destination バリデーション欠如",
        "description": "PATCH route.ts で action:'move' を追加する際、リクエストボディの 'destination' パラメータに対する型チェック・存在チェック（typeof destination !== 'string' や空文字チェック）が設計書に明示されていない。既存の 'rename' アクションでは newName に対して '!newName || typeof newName !== \"string\"' チェックが行われている。同等のバリデーションが 'move' アクションにも必要。",
        "affected_files": [
          "src/app/api/worktrees/[id]/files/[...path]/route.ts"
        ],
        "risk": "medium",
        "recommendation": "設計書 Section 3-1-2 に、destination パラメータの存在チェックと型チェック（!destination || typeof destination !== 'string'）を明記すること。"
      }
    ],
    "should_fix": [
      {
        "id": "SF-S3-001",
        "category": "backward-compatibility",
        "title": "useFileSearch フックの TreeItem 依存への影響確認",
        "description": "useFileSearch.ts が TreeItem 型を import して filterByName 関数で使用している（items: TreeItem[] => TreeItem[]）。TreeItem に birthtime?: string を追加しても型の後方互換性は保たれるが（オプショナルフィールド）、useFileSearch のフィルタリングロジックが新フィールドに影響されないことの確認が必要。",
        "affected_files": [
          "src/hooks/useFileSearch.ts",
          "src/types/models.ts"
        ],
        "risk": "low",
        "recommendation": "useFileSearch.ts は name/type フィールドのみ参照しているため実質的な影響はないが、設計書の影響範囲ファイル一覧（Section 9）に useFileSearch.ts を間接影響ファイルとして記載すべき。"
      },
      {
        "id": "SF-S3-002",
        "category": "ripple-effect",
        "title": "FileTreeView の TreeNodeProps に onMove callback を追加する影響",
        "description": "設計書 Section 2-1 では FileTreeView に onMove コールバックを追加するとあるが、TreeNodeProps にも onMove を伝播する必要がある。TreeNode は再帰的にレンダリングされるため、新しい props の追加が memo 化された TreeNode コンポーネントの再レンダリングに影響する可能性がある。設計書に TreeNodeProps の変更が明示されていない。",
        "affected_files": [
          "src/components/worktree/FileTreeView.tsx"
        ],
        "risk": "low",
        "recommendation": "onMove は ContextMenu 経由で処理されるため、TreeNodeProps への追加は不要の可能性がある。FileTreeView レベルで ContextMenu の onMove prop に渡すだけで良いか、TreeNode にまで伝播する必要があるかを設計書で明確にすること。現状の ContextMenu パターンでは FileTreeView が直接 ContextMenu に onMove を渡しているため（onUpload と同じパターン）、TreeNodeProps への追加は不要と考えられる。"
      },
      {
        "id": "SF-S3-003",
        "category": "performance",
        "title": "MoveDialog のディレクトリツリー取得が大規模リポジトリで遅延する可能性",
        "description": "MoveDialog は既存の tree API を呼び出して全エントリ取得後にクライアント側でディレクトリのみフィルタリングする設計。readDirectory() は LIMITS.MAX_ITEMS_PER_DIR = 500 の制限があるが、ネストされたディレクトリを全て展開するには複数回の API 呼び出しが必要になる。ユーザが深い階層のディレクトリを選択する場合のレイテンシが考慮されていない。",
        "affected_files": [
          "src/components/worktree/MoveDialog.tsx",
          "src/app/api/worktrees/[id]/tree/route.ts",
          "src/app/api/worktrees/[id]/tree/[...path]/route.ts"
        ],
        "risk": "low",
        "recommendation": "設計書 SF-002 でサーバー側フィルタリングへの将来的な移行が言及されているが、初期実装でも 'ディレクトリ展開時のローディングインジケーター表示' を MoveDialog の仕様に含めて UX 劣化を防ぐこと。"
      },
      {
        "id": "SF-S3-004",
        "category": "testing-coverage",
        "title": "useFileOperations フックのテスト戦略が未定義",
        "description": "新規作成される useFileOperations.ts カスタムフックに対するテスト戦略が設計書 Section 6 に記載されていない。Section 6-2 では 'フロントエンドコンポーネントはユニットテストの対象外' とあるが、カスタムフックはコンポーネントとは異なりロジックを含むため、テスト対象として検討すべき。特に handleMoveConfirm() の API 呼び出しロジックとエラーハンドリングは重要。",
        "affected_files": [
          "src/hooks/useFileOperations.ts"
        ],
        "risk": "low",
        "recommendation": "useFileOperations.ts のユニットテストを tests/unit/hooks/ に追加するか、または既存パターンに合わせてテスト対象外とする場合はその理由を設計書に明記すること。"
      },
      {
        "id": "SF-S3-005",
        "category": "api-contract",
        "title": "move 操作のレスポンスに path フィールドの内容が不明確",
        "description": "設計書 Section 3-1-2 のレスポンス例では path: 'path/to/target/directory/filename' とあるが、これが移動後の新しい相対パスなのか、移動先ディレクトリのパスなのかが不明確。既存の rename レスポンスでは renameResult.path が新しいファイルの相対パスを返している。一貫性のため move レスポンスも移動後のファイルの完全相対パスを返すべきだが、moveFileOrDirectory() の実装がそのパスを返す仕様が設計書で明確でない。",
        "affected_files": [
          "src/lib/file-operations.ts",
          "src/app/api/worktrees/[id]/files/[...path]/route.ts"
        ],
        "risk": "low",
        "recommendation": "moveFileOrDirectory() の返り値 FileOperationResult.path に、移動後のファイルの相対パス（例: 'dest/dir/filename.ts'）を設定することを設計書に明記すること。"
      }
    ],
    "consider": [
      {
        "id": "CO-S3-001",
        "category": "backward-compatibility",
        "title": "TreeResponse の API レスポンスサイズ増加",
        "description": "birthtime フィールドの追加により、各ファイルエントリに約 24 バイトの ISO 8601 文字列が追加される。500 ファイルのディレクトリでは約 12KB の増加。設計書 Section 7 で言及済みだが、モバイルネットワーク環境での影響は軽微と判断される。",
        "affected_files": [
          "src/lib/file-tree.ts",
          "src/types/models.ts"
        ],
        "risk": "low",
        "recommendation": "現時点では対応不要。パフォーマンス問題が報告された場合のみ検討。"
      },
      {
        "id": "CO-S3-002",
        "category": "ripple-effect",
        "title": "WorktreeCard.tsx の inline formatDistanceToNow と date-utils.ts の formatRelativeTime の重複",
        "description": "WorktreeCard.tsx が formatDistanceToNow を直接呼び出しており、新規作成される date-utils.ts の formatRelativeTime() と類似機能が重複する。設計書 CO-S2-003 で将来の DRY 改善として文書化済み。",
        "affected_files": [
          "src/components/worktree/WorktreeCard.tsx",
          "src/lib/date-utils.ts"
        ],
        "risk": "low",
        "recommendation": "本 Issue のスコープ外。将来のリファクタリング Issue で WorktreeCard.tsx も formatRelativeTime() を使用するよう統一することを検討。"
      },
      {
        "id": "CO-S3-003",
        "category": "database-migration",
        "title": "データベーススキーマへの影響なし",
        "description": "本 Issue はファイルシステム操作と UI 変更のみであり、SQLite データベーススキーマへの変更は不要。TreeItem は API レスポンスの型であり、DB テーブルとは独立している。マイグレーション不要を確認。",
        "affected_files": [],
        "risk": "none",
        "recommendation": "対応不要。"
      },
      {
        "id": "CO-S3-004",
        "category": "edge-case",
        "title": "fs.rename() のクロスデバイス移動制限",
        "description": "設計書 Section 8 で fs.rename() の異なるファイルシステム間での移動が非対応であることが言及されている。Worktree 内移動のみのため通常は問題ないが、Docker ボリュームマウントやシンボリックリンクが介在する環境では EXDEV エラーが発生する可能性がある。",
        "affected_files": [
          "src/lib/file-operations.ts"
        ],
        "risk": "low",
        "recommendation": "moveFileOrDirectory() で EXDEV エラーをキャッチし、ユーザーにわかりやすいエラーメッセージを返すことを検討。'Cross-device move is not supported' 等。"
      },
      {
        "id": "CO-S3-005",
        "category": "edge-case",
        "title": "macOS/Linux での birthtime の信頼性",
        "description": "Linux の一部ファイルシステム（ext4 カーネル 4.11 未満、XFS、一部 NFS マウント）では birthtime が正確に取得できない場合がある（ctime が返される可能性）。macOS の APFS/HFS+ では正確に取得可能。設計書ではオプショナルフィールドとしているため、取得失敗時は undefined のまま残せる。",
        "affected_files": [
          "src/lib/file-tree.ts"
        ],
        "risk": "low",
        "recommendation": "readDirectory() で birthtime の値が epoch (0) や ctime と同一の場合にフォールバック処理を検討するか、そのまま表示しても実用上問題ないため現状維持で可。"
      }
    ],
    "compliant": [
      {
        "id": "CP-S3-001",
        "category": "backward-compatibility",
        "title": "TreeItem の birthtime オプショナル追加は後方互換",
        "description": "TreeItem に birthtime?: string を追加しても、既存コード（FileTreeView, useFileSearch, useContextMenu, file-tree.ts）は新フィールドを参照しないため動作に影響しない。"
      },
      {
        "id": "CP-S3-002",
        "category": "api-contract",
        "title": "PATCH API の action 拡張は後方互換",
        "description": "既存の action:'rename' のリクエスト/レスポンス契約は変更されず、新しい action:'move' が追加されるだけ。クライアントが未知のアクションを送信した場合のエラーメッセージが更新される（SF-S2-002）が、これは既存クライアントの動作に影響しない。"
      },
      {
        "id": "CP-S3-003",
        "category": "api-contract",
        "title": "tree API のレスポンス構造は後方互換",
        "description": "TreeResponse.items 配列内の TreeItem にオプショナルフィールドが追加されるのみ。既存の JSON パーサーは未知のフィールドを無視するため、既存クライアントに影響なし。"
      },
      {
        "id": "CP-S3-004",
        "category": "backward-compatibility",
        "title": "ContextMenu の onMove prop はオプショナル",
        "description": "ContextMenuProps に onMove?: callback を追加する設計。既存の ContextMenu 利用箇所（FileTreeView 内）で onMove を渡さなくても動作する。"
      },
      {
        "id": "CP-S3-005",
        "category": "backward-compatibility",
        "title": "FileViewer のコピーボタンは UI 追加のみ",
        "description": "FileViewer にコピーボタンを追加する変更は、既存の表示機能に干渉しない独立した UI 追加。既存の clipboard-utils.ts の copyToClipboard() を再利用しており、新たな依存関係は発生しない。"
      },
      {
        "id": "CP-S3-006",
        "category": "backward-compatibility",
        "title": "i18n キー追加は既存キーに影響なし",
        "description": "worktree.json に fileTree セクションを追加し、error.json の fileOps に failedToMove を追加する変更は、既存のキーを変更・削除しないため後方互換。"
      },
      {
        "id": "CP-S3-007",
        "category": "backward-compatibility",
        "title": "FileOperationErrorCode の型拡張は後方互換",
        "description": "MOVE_SAME_PATH と MOVE_INTO_SELF をユニオン型に追加するのみ。既存のエラーコードは変更されず、既存のハンドリングロジックに影響しない。"
      },
      {
        "id": "CP-S3-008",
        "category": "backward-compatibility",
        "title": "ERROR_CODE_TO_HTTP_STATUS マップ拡張は後方互換",
        "description": "新しいエラーコードのマッピングを追加するのみ。既存のマッピングは変更されない。"
      },
      {
        "id": "CP-S3-009",
        "category": "backward-compatibility",
        "title": "FileTreeViewProps への onMove 追加はオプショナル",
        "description": "FileTreeViewProps に onMove?: callback を追加する設計。WorktreeDetailRefactored 以外の FileTreeView 利用箇所がある場合でも、onMove は省略可能なため影響なし。"
      },
      {
        "id": "CP-S3-010",
        "category": "dependency",
        "title": "date-fns と next-intl の依存関係は既存",
        "description": "date-fns (^4.1.0) と next-intl (^4.8.2) は既に package.json に含まれており、新たな外部依存は発生しない。"
      }
    ]
  },
  "impact_analysis": {
    "direct_changes": [
      {
        "file": "src/types/models.ts",
        "change": "TreeItem に birthtime?: string フィールド追加",
        "risk": "low"
      },
      {
        "file": "src/lib/file-operations.ts",
        "change": "validateFileOperation() ヘルパー追加、moveFileOrDirectory() 追加、FileOperationErrorCode 拡張、renameFileOrDirectory() リファクタリング",
        "risk": "medium"
      },
      {
        "file": "src/lib/file-tree.ts",
        "change": "readDirectory() で birthtime 取得・格納",
        "risk": "low"
      },
      {
        "file": "src/lib/date-utils.ts",
        "change": "新規ファイル: formatRelativeTime() ユーティリティ",
        "risk": "low"
      },
      {
        "file": "src/hooks/useFileOperations.ts",
        "change": "新規ファイル: ファイル操作ハンドラー集約フック",
        "risk": "low"
      },
      {
        "file": "src/app/api/worktrees/[id]/files/[...path]/route.ts",
        "change": "PATCH に action:'move' 追加、ERROR_CODE_TO_HTTP_STATUS 拡張",
        "risk": "medium"
      },
      {
        "file": "src/components/worktree/ContextMenu.tsx",
        "change": "onMove コールバックと Move メニュー項目追加",
        "risk": "low"
      },
      {
        "file": "src/components/worktree/FileTreeView.tsx",
        "change": "birthtime 表示追加、onMove prop 追加、useLocale() インポート",
        "risk": "medium"
      },
      {
        "file": "src/components/worktree/FileViewer.tsx",
        "change": "コピーボタン追加",
        "risk": "low"
      },
      {
        "file": "src/components/worktree/MoveDialog.tsx",
        "change": "新規ファイル: 移動先ディレクトリ選択ダイアログ",
        "risk": "low"
      },
      {
        "file": "src/components/worktree/WorktreeDetailRefactored.tsx",
        "change": "useFileOperations() フック統合、MoveDialog レンダリング",
        "risk": "medium"
      },
      {
        "file": "locales/en/worktree.json",
        "change": "fileTree セクション追加",
        "risk": "low"
      },
      {
        "file": "locales/ja/worktree.json",
        "change": "fileTree セクション追加",
        "risk": "low"
      },
      {
        "file": "locales/en/error.json",
        "change": "fileOps.failedToMove 追加",
        "risk": "low"
      },
      {
        "file": "locales/ja/error.json",
        "change": "fileOps.failedToMove 追加",
        "risk": "low"
      }
    ],
    "indirect_impact": [
      {
        "file": "src/hooks/useFileSearch.ts",
        "impact": "TreeItem 型変更の間接影響（オプショナルフィールド追加のため実質的な影響なし）",
        "risk": "low"
      },
      {
        "file": "src/hooks/useContextMenu.ts",
        "impact": "ContextMenuState 型を使用しているが変更なし",
        "risk": "none"
      },
      {
        "file": "src/app/api/worktrees/[id]/tree/route.ts",
        "impact": "readDirectory() の戻り値に birthtime が含まれるようになるが、JSON.stringify で自動シリアライズされるため変更不要",
        "risk": "none"
      },
      {
        "file": "src/app/api/worktrees/[id]/tree/[...path]/route.ts",
        "impact": "同上",
        "risk": "none"
      },
      {
        "file": "src/components/worktree/WorktreeCard.tsx",
        "impact": "formatDistanceToNow の類似機能が date-utils.ts に追加されるが、直接的な影響なし",
        "risk": "none"
      },
      {
        "file": "tests/unit/lib/file-operations.test.ts",
        "impact": "renameFileOrDirectory() リファクタリングにより既存テストケースへの回帰影響",
        "risk": "medium"
      }
    ],
    "no_impact": [
      "src/lib/db-instance.ts",
      "src/lib/db.ts",
      "src/lib/db-repository.ts",
      "src/lib/claude-session.ts",
      "src/lib/response-poller.ts",
      "src/lib/auto-yes-manager.ts",
      "src/lib/clone-manager.ts",
      "src/cli/**"
    ]
  },
  "risk_assessment": {
    "technical": "medium",
    "security": "low",
    "operational": "low"
  },
  "backward_compatibility": {
    "api_breaking_changes": false,
    "type_breaking_changes": false,
    "database_migration_required": false,
    "notes": "全ての変更はオプショナルフィールドの追加またはアクションの拡張であり、既存のインターフェース契約を破壊しない。"
  },
  "reviewed_files": [
    "src/types/models.ts",
    "src/lib/file-operations.ts",
    "src/lib/file-tree.ts",
    "src/lib/path-validator.ts",
    "src/lib/clipboard-utils.ts",
    "src/lib/date-locale.ts",
    "src/config/file-operations.ts",
    "src/hooks/useContextMenu.ts",
    "src/hooks/useFileSearch.ts",
    "src/components/worktree/ContextMenu.tsx",
    "src/components/worktree/FileTreeView.tsx",
    "src/components/worktree/FileViewer.tsx",
    "src/components/worktree/WorktreeDetailRefactored.tsx",
    "src/app/api/worktrees/[id]/files/[...path]/route.ts",
    "src/app/api/worktrees/[id]/tree/route.ts",
    "src/app/api/worktrees/[id]/tree/[...path]/route.ts",
    "locales/en/worktree.json",
    "locales/ja/worktree.json",
    "locales/en/error.json",
    "locales/ja/error.json",
    "locales/en/common.json",
    "tests/unit/lib/file-operations.test.ts"
  ],
  "timestamp": "2026-02-15T12:00:00Z"
}
