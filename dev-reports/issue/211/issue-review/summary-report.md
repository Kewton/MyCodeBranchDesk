# Issue #211 マルチステージレビュー完了報告

## レビュー日時
- 開始: 2026-02-10
- 完了: 2026-02-10

## 仮説検証結果（Phase 0.5）

| # | 仮説/主張 | 判定 |
|---|----------|------|
| - | なし | スキップ（新機能追加Issue） |

## ステージ別結果

| Stage | レビュー種別 | 指摘数 | 対応数 | ステータス |
|-------|------------|-------|-------|----------|
| 1 | 通常レビュー（1回目） | 8件 (MF:1, SF:4, NTH:3) | - | ✅ |
| 2 | 指摘事項反映（1回目） | - | 8件 | ✅ |
| 3 | 影響範囲レビュー（1回目） | 7件 (MF:1, SF:3, NTH:3) | - | ✅ |
| 4 | 指摘事項反映（1回目） | - | 7件 | ✅ |
| 5 | 通常レビュー（2回目） | 4件 (MF:0, SF:2, NTH:2) | - | ✅ |
| 6 | 指摘事項反映（2回目） | - | 4件 | ✅ |
| 7 | 影響範囲レビュー（2回目） | 4件 (MF:1, SF:1, NTH:2) | - | ✅ |
| 8 | 指摘事項反映（2回目） | - | 4件 | ✅ |

## 統計

- **総指摘数**: 23件
- **対応完了**: 23件
- **スキップ**: 0件

## 主な改善点

### Phase 0.5: 仮説検証
- 新機能追加Issueのため仮説検証はスキップ

### 1回目イテレーション（Stage 1-4）
1. **Toast通知の統合設計を追加** (MF-1): WorktreeDetailRefactoredからHistoryPane経由でConversationPairCardにshowToastを伝搬する方針を明確化
2. **用語の統一** (SF-1): "メッセージバブル"を"メッセージセクション（ConversationPairCard）"と"メッセージバブル（MessageList）"に区別
3. **コピー内容仕様の明確化** (SF-2): message.contentの生テキストをコピー、ANSI除去処理の方針を明記
4. **影響範囲の正確化** (SF-3): HistoryPane、WorktreeDetailRefactoredを変更対象に追加
5. **テスト要件の追加** (SF-4): 単体テストと既存テスト修正の受入条件を追加
6. **デュアル呼び出し箇所への対応** (MF-1 影響範囲): WorktreeDetailRefactoredのモバイル・デスクトップ両レイアウトに対応
7. **Memoization対応** (SF-1 影響範囲): useCallbackによるコールバック参照安定化を明記
8. **Props設計方針** (SF-3 影響範囲): 新規propsをoptionalとして破壊的変更を回避

### 2回目イテレーション（Stage 5-8）
9. **showToast型シグネチャの明示** (SF-1 2回目通常): Toast.tsxのshowToast型とデータフロー図を追加
10. **コピーボタン配置の区別** (SF-2 2回目通常): UserMessageSection（展開ボタンなし）とAssistantMessagesSection（展開ボタンあり）の配置を区別
11. **ANSI除去方式の明確化** (NTH-1 2回目通常): 正規表現ベースのアプローチを明記
12. **段階的実装指針** (NTH-2 2回目通常): 受入条件をPhase 1（ConversationPairCard）とPhase 2（MessageList）に分割
13. **既存stripAnsi関数の再利用** (MF-1 2回目影響範囲): cli-patterns.tsの既存stripAnsi()を再利用する方針に変更（重複実装回避）
14. **テストファイル漏れの補完** (SF-1 2回目影響範囲): tests/integration/conversation-pair-card.test.tsxを追加
15. **React.memo比較関数の説明** (NTH-1 2回目影響範囲): onCopyは比較対象外で問題ない旨を明記
16. **useCallback安定性の確認** (NTH-2 2回目影響範囲): showToastの参照安定性が保証されている旨を注記

## Issue差分サマリー

### 追加されたセクション
- **Toast通知の統合方針**: 3つのオプション比較とOption C（props伝搬）の推奨
- **コピー内容の仕様**: message.content生テキスト、ANSI除去（stripAnsi再利用）、Markdownソース
- **Props設計方針**: 新規propsはoptional、showToastなしでも動作
- **showToast型シグネチャとデータフロー**: 型定義、データフロー図、コード例
- **コールバック参照安定化（Memoization考慮）**: useCallbackによる最適化ガイドライン
- **MessageList.tsxのReact.memoカスタム比較関数について**: 変更不要の根拠説明
- **コピーボタンの配置仕様**: UserMessageSection vs AssistantMessagesSectionの違い
- **ANSIコード除去のアプローチ**: cli-patterns.tsのstripAnsi再利用方針
- **既存テストの修正確認が必要なファイル**: 5件のテストファイルリスト

### 修正されたセクション
- **提案する解決策**: 用語統一（"メッセージセクション"と"メッセージバブル"の区別）
- **実装タスク**: Toast統合、Props型変更、useCallback化、既存stripAnsi利用、テスト関連タスク追加
- **受入条件**: テスト要件追加、Phase 1/2への分割、コピーボタン非重複確認
- **影響範囲 / 変更対象ファイル**: WorktreeDetailRefactored、HistoryPane、ConversationPairCardの変更内容詳細化
- **影響範囲 / 関連コンポーネント**: cli-patterns.ts追加（stripAnsi依存）

## 次のアクション

- [x] Issueの最終確認
- [ ] 設計方針書の確認・作成（Phase 2）
- [ ] マルチステージ設計レビュー（Phase 3）
- [ ] 作業計画立案（Phase 4）
- [ ] TDD自動開発（Phase 5）

## 関連ファイル

- 元のIssue: `dev-reports/issue/211/issue-review/original-issue.json`
- 仮説検証: `dev-reports/issue/211/issue-review/hypothesis-verification.md`
- Stage 1 レビュー結果: `dev-reports/issue/211/issue-review/stage1-review-result.json`
- Stage 2 反映結果: `dev-reports/issue/211/issue-review/stage2-apply-result.json`
- Stage 3 レビュー結果: `dev-reports/issue/211/issue-review/stage3-review-result.json`
- Stage 4 反映結果: `dev-reports/issue/211/issue-review/stage4-apply-result.json`
- Stage 5 レビュー結果: `dev-reports/issue/211/issue-review/stage5-review-result.json`
- Stage 6 反映結果: `dev-reports/issue/211/issue-review/stage6-apply-result.json`
- Stage 7 レビュー結果: `dev-reports/issue/211/issue-review/stage7-review-result.json`
- Stage 8 反映結果: `dev-reports/issue/211/issue-review/stage8-apply-result.json`

---

*Generated by multi-stage-issue-review command*
