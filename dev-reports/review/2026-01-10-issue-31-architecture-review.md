# アーキテクチャレビュー報告書

**対象**: Issue #31 サイドバーUX改善 設計方針書
**レビュー日**: 2026-01-10
**レビュアー**: Claude Code (Architecture Review)

---

## 1. 設計原則の遵守確認

### 1.1 SOLID原則チェック

| 原則 | 評価 | コメント |
|------|------|---------|
| **S**ingle Responsibility | ✅ 準拠 | SortSelector、BranchListItem、sidebar-utilsが各々単一責任を持つ |
| **O**pen/Closed | ✅ 準拠 | ソートキーの追加はSortKey型とstatusConfigの拡張で対応可能 |
| **L**iskov Substitution | ✅ 準拠 | 継承を使用していないため該当なし |
| **I**nterface Segregation | ✅ 準拠 | SortSelectorPropsは必要最小限のプロパティ |
| **D**ependency Inversion | ⚠️ 部分的 | Context直接参照のため抽象化の余地あり |

### 1.2 その他の原則

| 原則 | 評価 | コメント |
|------|------|---------|
| KISS | ✅ 準拠 | 既存構造への最小限の変更 |
| YAGNI | ✅ 準拠 | 将来のVirtualization対応は「検討」に留め、過剰実装を回避 |
| DRY | ✅ 準拠 | ソートロジックを`sidebar-utils.ts`に集約 |

---

## 2. アーキテクチャ評価

### 2.1 構造的品質

| 評価項目 | スコア | コメント |
|---------|--------|----------|
| モジュール性 | ⭐⭐⭐⭐☆ (4/5) | SortSelector分離は良好。BranchDetailsを別コンポーネントにすることでさらに向上 |
| 結合度 | ⭐⭐⭐⭐☆ (4/5) | Context経由の疎結合設計。ただしSidebarContext肥大化の懸念 |
| 凝集度 | ⭐⭐⭐⭐⭐ (5/5) | sidebar-utils.tsにソート関連を集約し高凝集 |
| 拡張性 | ⭐⭐⭐⭐☆ (4/5) | 新ソートキー追加が容易。ただし複合ソートは未対応 |
| 保守性 | ⭐⭐⭐⭐⭐ (5/5) | 既存コードへの影響最小限、テスト計画も明確 |

### 2.2 パフォーマンス観点

| 観点 | 評価 | コメント |
|------|------|---------|
| レスポンスタイム | ✅ 良好 | クライアントサイドソートで即座に反映 |
| スループット | ✅ 良好 | API呼び出し増加なし |
| リソース使用効率 | ✅ 良好 | useMemoによる再計算防止 |
| スケーラビリティ | ⚠️ 要監視 | 100件超でパフォーマンス懸念。Virtualization検討を推奨 |

---

## 3. セキュリティレビュー

### 3.1 OWASP Top 10 チェック

| 項目 | 評価 | コメント |
|------|------|---------|
| インジェクション対策 | ✅ | 該当なし（フロントエンド処理のみ） |
| 認証の破綻対策 | N/A | 認証変更なし |
| 機微データの露出対策 | ✅ | memoはユーザー自身の入力データ |
| XXE対策 | N/A | XML処理なし |
| アクセス制御の不備対策 | N/A | 権限変更なし |
| セキュリティ設定ミス対策 | ✅ | 設定変更なし |
| XSS対策 | ✅ | React自動エスケープ使用、dangerouslySetInnerHTML不使用 |
| 安全でないデシリアライゼーション | ✅ | ソートキーはenum制限 |
| 既知の脆弱性対策 | N/A | 新規ライブラリ導入なし |
| ログとモニタリング不足 | N/A | 変更なし |

**総評**: セキュリティリスクは低い。フロントエンドのUI改善が主体のため。

---

## 4. 既存システムとの整合性

### 4.1 統合ポイント

| 項目 | 評価 | コメント |
|------|------|---------|
| API互換性 | ✅ 完全互換 | バックエンド変更なし |
| データモデル整合性 | ✅ 完全互換 | Worktreeモデル変更なし |
| 認証/認可の一貫性 | N/A | 該当なし |
| ログ/監視の統合 | N/A | 該当なし |

### 4.2 技術スタックの適合性

| 項目 | 評価 | コメント |
|------|------|---------|
| 既存技術との親和性 | ✅ | Next.js 14 / TypeScript / Tailwind CSS準拠 |
| チームのスキルセット | ✅ | 既存コードパターンを踏襲 |
| 運用負荷への影響 | ✅ | 追加運用タスクなし |

---

## 5. リスク評価

| リスク種別 | 内容 | 影響度 | 発生確率 | 対策優先度 |
|-----------|------|--------|---------|-----------|
| 技術的リスク | SidebarContext肥大化 | 中 | 中 | 中 |
| 技術的リスク | 大量ブランチでのパフォーマンス劣化 | 中 | 低 | 低 |
| 運用リスク | localStorage破損による設定消失 | 低 | 低 | 低 |
| UXリスク | ソートUI発見困難 | 中 | 中 | 高 |

---

## 6. 改善提案

### 6.1 必須改善項目（Must Fix）

なし。設計は実装可能な品質に達している。

### 6.2 推奨改善項目（Should Fix）

#### SF-1: SidebarContext分離の検討

**問題**: SidebarContextにソート状態を追加することでContext肥大化のリスク

**提案**: ソート専用Context（SortContext）を別途作成することを検討

```typescript
// 代替案: src/contexts/SortContext.tsx
interface SortState {
  sortKey: SortKey;
  sortDirection: 'asc' | 'desc';
}
```

**判定**: 現段階では過剰設計。ソート以外の機能追加時に再検討。

---

#### SF-2: ソートUIのアフォーダンス強化

**問題**: ドロップダウンの存在がユーザーに伝わりにくい可能性

**提案**:
- ヘッダー「Branches」の横にソートアイコン（↕️）を常時表示
- 初回表示時にツールチップでソート機能を案内

```
┌─────────────────────────────────┐
│ Branches            ↕️ [現在のソート] │
├─────────────────────────────────┤
```

---

#### ~~SF-3: generating状態の判定ロジック明確化~~ ✅ 解決済み

**決定（2026-01-10）**: `generating`ステータスは使用しない

- `running`に統合（処理中 + AI応答生成中）
- 理由: ユーザー視点では区別不要、実装工数削減
- 既存ロジックで要件を満たすため、変更不要

---

### 6.3 検討事項（Consider）

#### C-1: 複合ソート対応

**内容**: 「リポジトリ名 → ブランチ名」のような複数キーでのソート

**判定**: 現時点では不要。ユーザーフィードバック後に検討。

---

#### C-2: ソート設定のURL永続化

**内容**: ソート設定をURLパラメータに含め、共有可能にする

**例**: `/worktrees?sort=repositoryName&dir=asc`

**判定**: 現時点では不要。チーム共有ニーズが発生した場合に検討。

---

#### C-3: フィルタ機能の拡張

**内容**: ステータスによるフィルタリング（waitingのみ表示等）

**判定**: Issue #31の範囲外。別Issueとして提案可能。

---

## 7. ベストプラクティスとの比較

### 7.1 業界標準との差異

| 観点 | 業界標準 | 本設計 | 評価 |
|------|---------|--------|------|
| ソートUI | テーブルヘッダークリック or ドロップダウン | ドロップダウン | ✅ 適切 |
| 状態永続化 | localStorage / URL | localStorage | ✅ 適切 |
| リスト仮想化 | 50件超でreact-window等 | 100件超で対応検討 | ⚠️ 閾値を50件に下げることを推奨 |

### 7.2 代替アーキテクチャ案

#### 代替案1: Zustand導入

**概要**: React Contextの代わりにZustandで状態管理

**メリット**:
- Context肥大化問題の解消
- セレクタによる再レンダリング最適化
- DevToolsによるデバッグ容易性

**デメリット**:
- 新規ライブラリ導入
- 学習コスト
- 既存Contextとの整合性

**判定**: 現段階では導入コストが高い。全体的な状態管理リファクタリング時に検討。

---

#### 代替案2: サーバーサイドソート（API変更）

**概要**: ソートパラメータをAPIに追加

```
GET /api/worktrees?sort=repositoryName&order=asc
```

**メリット**:
- 大量データ対応
- ページネーション連携

**デメリット**:
- API変更必要
- ソート切り替え時のレイテンシ
- 現データ量では過剰

**判定**: 現データ量（10-50件）では不採用。100件超の場合に再検討。

---

## 8. 総合評価

### 8.1 レビューサマリ

| 項目 | 評価 |
|------|------|
| **全体評価** | ⭐⭐⭐⭐☆（4/5） |
| **強み** | 既存構造への最小限の変更、クライアントサイドソートによる即時反映、テスト計画の明確さ |
| **弱み** | Context肥大化の長期的リスク |
| **総評** | 堅実な設計。要件を満たしつつ技術的負債を最小化。実装着手可能。 |

### 8.2 承認判定

**✅ 承認（Approved）** ※2026-01-10 更新

~~以下の条件を満たすことで実装着手可能:~~
~~1. **SF-3**: generating状態の判定ロジックを明確化~~ → ✅ 解決済み（runningに統合）

実装着手時の考慮事項:
- **SF-2**: ソートUIのアフォーダンスについて実装時に考慮

### 8.3 次のステップ

1. ✅ 設計書の軽微な修正（generating判定の補足） → 完了
2. ⏳ Phase 1（ソート機能）の実装着手
3. ⏸️ Phase 2-3は Phase 1完了後に着手
4. ⏸️ ユーザーフィードバック収集後、検討事項（C-1〜C-3）を評価

---

## 9. レビュー署名

| 役割 | 担当 | 日付 |
|------|------|------|
| レビュアー | Claude Code | 2026-01-10 |

---

## 付録: チェックリスト

### 実装前確認事項

- [x] generating状態の判定方法を決定 → runningに統合（2026-01-10決定）
- [ ] ソートアイコンのデザイン決定
- [ ] localStorage キー名の命名規則確認（既存との整合性）

### 実装後確認事項

- [ ] 単体テスト（sidebar-utils.test.ts）のカバレッジ確認
- [ ] E2Eテスト（sidebar-sort.spec.ts）の実行
- [ ] モバイル表示の確認
- [ ] アクセシビリティ（キーボード操作、スクリーンリーダー）の確認
