# マルチステージ設計レビュー完了報告

## Issue #163: 複数行メッセージのバッファ送信方式

---

## ステージ別結果

| Stage | レビュー種別 | スコア | Must Fix | Should Fix | Consider | ステータス |
|-------|------------|--------|----------|------------|----------|-----------|
| 1 | 通常レビュー（設計原則） | 4/5 | 1 | 3 | 3 | ✅ 対応済み |
| 2 | 整合性レビュー | 4/5 | 1 | 1 | 0 | ✅ 対応済み |
| 3 | 影響分析レビュー | 4/5 | 1 | 2 | 2 | ✅ 対応済み |
| 4 | セキュリティレビュー | 4/5 | 1 | 3 | 3 | ✅ 対応済み |
| **合計** | | **4/5** | **4** | **9** | **8** | **全Stage完了** |

---

## 指摘事項一覧

### Must Fix（4件）- 全件対応済み

| ID | Stage | カテゴリ | タイトル | 対応内容 |
|----|-------|---------|---------|---------|
| MF-001 | 1 | DRY | sendKeys 2段階送信パターンの重複 | 将来課題セクション(11.1項)に`sendKeysWithEnter()`ヘルパー関数の導入を記載 |
| CONS-001 | 2 | 整合性 | codex.test.tsにsendMessage()テスト不存在 | 8.3.2項を「新規テスト追加」に修正 |
| IMP-001 | 3 | 影響範囲 | killSession()内のexecAsync tmux直接呼び出し | SF-002対象をsendMessage()のみに限定、将来課題(11.4項)に追加 |
| SEC-MF-001 | 4 | セキュリティ | %文字のエスケープ不要理由の未記載 | SEC-001に`printf '%s'`引数の安全性説明を追記 |

### Should Fix（9件）- 全件対応済み

| ID | Stage | カテゴリ | タイトル | 対応内容 |
|----|-------|---------|---------|---------|
| SF-001 | 1 | KISS | execFile()方式への改善可能性 | 4.3項に実装注記を追加 |
| SF-002 | 1 | SRP | codex.ts execAsync直接呼び出し | 4.2.3項に改善ポイントを明記 |
| SF-003 | 1 | OCP | 既存テスト修正の具体的内容不足 | 8.3項にテスト修正詳細を追記 |
| CONS-002 | 2 | 整合性 | テストアサーション記載の不一致 | 8.3.1項をリテラル値に修正 |
| IMP-002 | 3 | 影響範囲 | tsconfig.server.jsonのビルド確認 | 9項に受け入れ条件を追加 |
| IMP-003 | 3 | 影響範囲 | prompt未検出時の動作確認 | 8.1項にテストケースを追加 |
| SEC-SF-001 | 4 | セキュリティ | 制御文字フィルタリングポリシー未記載 | SEC-005として新設 |
| SEC-SF-002 | 4 | セキュリティ | セッション名の安全性前提未記載 | SEC-001に前提条件を追記 |
| SEC-SF-003 | 4 | セキュリティ | クラッシュ時バッファ残留シナリオ | SEC-003に追記 |

### Consider（8件）- 記録済み

| ID | Stage | タイトル | 判断 |
|----|-------|---------|------|
| CS-001 | 1 | sendEnterパラメータの必要性 | 既存API対称性の観点で許容 |
| CS-002 | 1 | respond/route.ts等のバッファ送信対応 | 将来課題(11.3項)に記録 |
| CS-003 | 1 | バッファ名の一意性保証 | 将来課題(11.2項)に記録 |
| IMP-004 | 3 | terminal/route.tsのnamespace import | 現時点では対応不要 |
| IMP-005 | 3 | terminal-websocket.tsのspawn方式 | 本Issue範囲外 |
| SEC-CS-001 | 4 | シングルクォート内%文字 | 安全であることを確認済み |
| SEC-CS-002 | 4 | tmuxバッファサイズ制限 | 実運用で問題なし |
| SEC-CS-003 | 4 | バッファ名衝突（並行送信時） | CS-003と重複、将来課題に記録済み |

---

## 設計方針書の主要改善点

### レビューで追加されたセクション
1. **4.3項**: execFile()方式への改善可能性（注記）
2. **SEC-005**: 制御文字フィルタリングポリシー
3. **10項**: レビュー指摘事項サマリー（全Stage分）
4. **11項**: 将来課題（4件: sendKeysWithEnter, バッファ名一意性, respond等のバッファ対応, killSession()のsendSpecialKey()移行）

### レビューで修正されたセクション
- **4.2.3項**: SF-002対象範囲をsendMessage()のみに限定
- **6項 SEC-001**: %文字の安全性説明、セッション名安全性前提を追加
- **6項 SEC-003**: クラッシュ時バッファ残留シナリオを追加
- **8.3.1項**: テストアサーション記載をリテラル値に修正
- **8.3.2項**: 「既存テスト修正」→「新規テスト追加」に修正
- **9項**: 各Stage対応の受け入れ条件チェックリスト追加

---

## リスク評価

| カテゴリ | リスク | 根拠 |
|---------|--------|------|
| 技術 | Low | 新規関数追加のみ、既存関数に変更なし |
| セキュリティ | Low | エスケープ処理の完全性を検証済み、既存sendKeys()と同等以上 |
| 運用 | Low | 後方互換性維持、API変更なし |

---

## 更新ファイル

- `dev-reports/design/issue-163-multiline-message-buffer-design-policy.md` - 設計方針書（4Stage分の指摘反映済み）

## レビューレポート

- `dev-reports/review/2026-02-06-issue163-architecture-review.md` - Stage 1
- `dev-reports/review/2026-02-06-issue163-consistency-review.md` - Stage 2
- `dev-reports/review/2026-02-06-issue163-impact-analysis-review.md` - Stage 3
- `dev-reports/review/2026-02-06-issue163-security-review.md` - Stage 4

---

## 次のアクション

- [ ] 設計方針書の最終確認
- [ ] `/tdd-impl` または `/pm-auto-dev` で実装を開始
- [ ] 実装完了後に `/create-pr` でPR作成
