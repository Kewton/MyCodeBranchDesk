# Issue #151 レビューレポート

**レビュー日**: 2026-02-04
**フォーカス**: 通常レビュー（Consistency and Correctness）
**イテレーション**: 1回目
**ステージ**: 1

---

## サマリー

| カテゴリ | 件数 |
|---------|------|
| Must Fix | 1 |
| Should Fix | 4 |
| Nice to Have | 3 |

**総合評価**: Good

Issue #151は明確な問題定義と具体的な改善案を含む良質なバグ報告です。主要な指摘点として、Issue番号検証範囲が既存コードと不一致があり、整合性の観点から修正が必要です。全体として技術的な提案は妥当であり、軽微な修正で実装可能なIssueです。

---

## Must Fix（必須対応）

### MF-001: Issue番号検証範囲がドキュメントと既存コードで不一致

**カテゴリ**: 整合性
**場所**: セキュリティ考慮事項セクション - SEC-001

**問題**:
Issue本文では「SEC-001: Issue番号検証 - 正の整数、1-999999範囲」と記載されていますが、既存の実装コード（`src/cli/utils/input-validators.ts`）では`MAX_ISSUE_NO = 2147483647`（2^31-1）と定義されています。

**証拠**:
- Issue記載: `1-999999範囲（コマンドインジェクション防止）`
- 既存コード（input-validators.ts L15-16）:
  ```typescript
  export const MAX_ISSUE_NO = 2147483647;
  ```

**推奨対応**:
以下のいずれかで対応してください:
1. 既存コードのMAX_ISSUE_NO値と整合するよう、Issue記載を「1-2147483647」に修正
2. スキルでの検証範囲として「1-999999」を採用する場合、その理由（例: 6桁以下でポート番号との組み合わせが容易）を明示

---

## Should Fix（推奨対応）

### SF-001: ポート検出の3{issueNo}形式は桁数制限が必要だが説明が不十分

**カテゴリ**: 完全性
**場所**: 検出対象ポートセクション

**問題**:
推奨コード例では`if [ ${#ISSUE_NO} -le 3 ]`でIssue番号が3桁以下の場合のみIssue専用ポートを検出対象としていますが、この制限の理由がIssue本文に明記されていません。

**証拠**:
```bash
# Issue専用ポート（例: Issue #123 -> 3123）
if [ ${#ISSUE_NO} -le 3 ]; then
  PORTS_TO_CHECK+=("3${ISSUE_NO}")
fi
```

**推奨対応**:
以下の説明を検出対象ポートセクションに追加:
- Issue番号が4桁以上の場合、3{issueNo}形式は5桁以上のポート番号となり、有効なポート範囲（1-65535）を超える可能性がある
- 例: Issue #12345 -> ポート312345（無効）

---

### SF-002: lsofコマンド不在時の対応が不完全

**カテゴリ**: 技術的妥当性
**場所**: エッジケースセクションおよび推奨される改善策

**問題**:
エッジケース表では「lsofがインストールされていない場合は警告を表示し、手動停止を促す」と記載されていますが、推奨コード例にはlsofの存在チェックが含まれていません。

**証拠**:
- エッジケース表: `| ポート検出でlsofがインストールされていない | 警告を表示し、手動停止を促す |`
- 推奨コード: `lsof -ti:$PORT 2>/dev/null`（存在チェックなし）

**推奨対応**:
コード例の冒頭に以下を追加:
```bash
# lsof存在チェック
if ! command -v lsof >/dev/null 2>&1; then
  echo "WARNING: lsof not found. Cannot detect servers by port."
  echo "Please manually stop any running servers before cleanup."
fi
```

---

### SF-003: worktree-cleanup.mdとの統合方法が不明確

**カテゴリ**: 整合性
**場所**: 推奨される改善策セクション

**問題**:
既存の`.claude/commands/worktree-cleanup.md`のPhase 2はPIDファイル確認のみを行います。Issueではポートベース検出を追加提案していますが、既存スキルのどのPhaseを置き換え/拡張するかが明確でありません。

**証拠**:
- 既存worktree-cleanup.md Phase 2: PIDファイル確認のみ
- Issue提案: ポートベース検出を追加

**推奨対応**:
以下のいずれかを明記:
- Phase 2を拡張し、PIDファイル確認後にポートベース検出を追加
- 新しいPhase 2.5として「ポートベースサーバー検出」を挿入
- Phase 2を全面改訂し、PIDファイル確認とポート検出を統合

---

### SF-004: 自動割り当てポート（3001-3100）の検出方法が未定義

**カテゴリ**: 明確性
**場所**: 検出対象ポートセクション

**問題**:
検出対象ポート表に「3001-3100（自動割り当て）」が含まれていますが、推奨コードでは3000とIssue専用ポート(3{issueNo})のみをチェックしており、100個のポートを全スキャンする実装は含まれていません。

**証拠**:
```bash
PORTS_TO_CHECK=(3000)
if [ ${#ISSUE_NO} -le 3 ]; then
  PORTS_TO_CHECK+=("3${ISSUE_NO}")
fi
```

**推奨対応**:
以下のいずれかを明記:
1. 自動割り当てポートの検出は今回のスコープ外とし、将来課題として記載
2. cwdベースでWorktreeプロセスを特定し、使用ポートを逆引きする方法を追加

---

## Nice to Have（あれば良い）

### NTH-001: 関連IssueへのリンクがIssue本文にない

**カテゴリ**: 完全性
**場所**: Issue本文全体

**問題**:
Issue #136（Git Worktree並列開発環境の整備）への参照がなく、Worktree機能の文脈把握が困難です。

**推奨対応**:
Issue本文の末尾に以下を追加:
```markdown
## 関連Issue
- #136 - Git Worktree並列開発環境の整備
```

---

### NTH-002: 優先度・重要度の明示がない

**カテゴリ**: 明確性
**場所**: Issue本文

**問題**:
バグの深刻度やリリースへの影響度が記載されていません。

**推奨対応**:
GitHubラベル（bug, priority:high等）を追加するか、概要セクションに重要度を記載。

---

### NTH-003: SIGTERM失敗時の待機時間が異なる記載がある

**カテゴリ**: 技術的妥当性
**場所**: 推奨コード例とエッジケース表

**問題**:
待機時間が場所によって異なります（既存Phase 2: 2秒、新規提案: 3秒）。

**証拠**:
- 既存worktree-cleanup.md Phase 2: `sleep 2`
- 推奨コード: `sleep 3`

**推奨対応**:
待機時間を統一（推奨: 3秒）するか、使い分けの基準を明記。

---

## 参照ファイル

### コード
| ファイル | 関連性 |
|---------|--------|
| `src/cli/utils/input-validators.ts` | Issue番号検証ロジック（MAX_ISSUE_NO定数） |
| `src/cli/utils/pid-manager.ts` | PIDファイル管理（既存実装との整合性確認） |
| `src/cli/utils/daemon.ts` | デーモンプロセス管理（サーバー起動/停止） |
| `src/cli/utils/resource-resolvers.ts` | リソースパス解決（PID、DB、ログパス） |
| `.claude/commands/worktree-cleanup.md` | 改善対象のスキル定義 |
| `.claude/commands/worktree-setup.md` | 関連スキル（Worktree作成） |

### ドキュメント
| ファイル | 関連性 |
|---------|--------|
| `CLAUDE.md` | プロジェクト全体のドキュメント（Issue #136の機能説明） |

---

## 次のステップ

1. **MF-001の対応**: Issue番号検証範囲を既存コードと整合させる
2. **SF-001〜SF-004の検討**: 各推奨事項について対応方針を決定
3. 影響範囲レビュー（Stage 2）の実施
