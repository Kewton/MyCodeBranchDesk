{
  "issue_number": 332,
  "issue_title": "アクセス元 IP の制限オプション",
  "design_policy_path": "dev-reports/design/issue-332-ip-restriction-design-policy.md",
  "work_plan_path": "dev-reports/issue/332/work-plan.md",
  "acceptance_criteria": [
    "環境変数 CM_ALLOWED_IPS でIPアドレス/CIDRレンジを指定できる（カンマ区切り複数指定）",
    "許可リスト外のIPからのHTTPリクエストが403で拒否される",
    "WebSocket接続にもIP制限が適用される（ws-server.tsで直接request.socket.remoteAddressを使用）",
    "CM_ALLOWED_IPS 未設定時はIP制限なしで動作する（後方互換性）",
    "既存のトークン認証（CM_AUTH_TOKEN_HASH）と併用できる",
    "CM_TRUST_PROXY=true の場合、X-Forwarded-For のIPを使用する",
    "CM_TRUST_PROXY=false の場合、server.ts が req.socket.remoteAddress を X-Real-IP として注入し偽ヘッダーを防ぐ",
    "IPv4-mapped IPv6アドレス（::ffff:x.x.x.x）が正しく処理される",
    "Edge Runtime環境で動作する（Node.js固有モジュール不使用）",
    "拒否時に 403 Forbidden を返す",
    "セキュリティログに拒否イベントが記録される",
    "--allowed-ips / --trust-proxy CLIオプションで設定できる",
    "src/cli/utils/daemon.ts の authEnvKeys に CM_ALLOWED_IPS/CM_TRUST_PROXY が追加されdaemonモードで動作する",
    "CM_ALLOWED_IPS 設定時は REVERSE_PROXY_WARNING が表示されない",
    "IPv4 CIDRマッチング（例: 192.168.1.0/24）のユニットテストが追加されている",
    "IPv4-mapped IPv6（::ffff:x.x.x.x）正規化のユニットテストが追加されている",
    "不正CIDR形式入力時のfail-fast（起動エラー）テストが追加されている",
    "複数CIDR指定時のOR判定テストが追加されている",
    "結合テスト（middleware）が追加されている",
    "DoS防止: MAX_ALLOWED_IP_ENTRIES=256、MAX_CIDR_ENTRY_LENGTH=18 の入力バリデーション実装"
  ],
  "implementation_tasks": [
    "Task 1.1: src/lib/ip-restriction.ts 新規作成（Edge Runtime互換）",
    "Task 2.1: server.ts - X-Real-IPヘッダー注入",
    "Task 2.2: src/middleware.ts - IP制限チェック挿入（Step 1、WebSocket upgrade前）",
    "Task 2.3: src/lib/ws-server.ts - WebSocket IP制限追加",
    "Task 3.1: src/lib/env.ts - EnvインターフェースにCM_ALLOWED_IPS/CM_TRUST_PROXY追加",
    "Task 3.2: src/cli/utils/daemon.ts - authEnvKeysにCM_ALLOWED_IPS/CM_TRUST_PROXY追加",
    "Task 4.1: src/cli/types/index.ts - StartOptionsにallowedIps/trustProxy追加",
    "Task 4.2: src/cli/index.ts - --allowed-ips/--trust-proxyコマンドオプション定義",
    "Task 4.3: src/cli/commands/start.ts - 環境変数転送・REVERSE_PROXY_WARNING抑制",
    "Task 4.4: src/cli/commands/init.ts - 対話フローでIP制限設定追加",
    "Task 4.5: src/cli/commands/status.ts - IP制限状態表示",
    "Task 4.6: src/cli/config/security-messages.ts - 警告メッセージ更新",
    "Task 5.1: tests/unit/ip-restriction.test.ts 新規作成",
    "Task 5.2: tests/integration/auth-middleware.test.ts - IP制限テスト追加",
    "Task 6.1: tsconfig.server.json - src/lib/ip-restriction.ts をincludeに追加"
  ],
  "key_design_decisions": {
    "module_cache": "モジュールスコープでCM_ALLOWED_IPSを一度だけ読み取りキャッシュ（auth.tsのstoredTokenHashパターン）",
    "getAllowedRanges": "middleware.ts/ws-server.ts両方がgetAllowedRanges()を呼び出し、DRYなキャッシュ戦略を実現",
    "edge_runtime": "Node.js固有モジュール（net, dns等）は一切使用しない",
    "fail_fast": "不正CIDR設定時はErrorをスローしサーバー起動を中断",
    "dos_protection": "MAX_ALLOWED_IP_ENTRIES=256（エントリ数上限）、MAX_CIDR_ENTRY_LENGTH=18（エントリ長上限）",
    "log_injection": "ログ出力前にnormalizeIp()適用、substring(0, 45)で切り詰め",
    "test_pattern": "vi.resetModules()パターンでモジュールスコープ変数を再初期化"
  },
  "files_to_create": [
    "src/lib/ip-restriction.ts",
    "tests/unit/ip-restriction.test.ts"
  ],
  "files_to_modify": [
    "server.ts",
    "src/middleware.ts",
    "src/lib/ws-server.ts",
    "src/lib/env.ts",
    "src/cli/utils/daemon.ts",
    "src/cli/types/index.ts",
    "src/cli/index.ts",
    "src/cli/commands/start.ts",
    "src/cli/commands/init.ts",
    "src/cli/commands/status.ts",
    "src/cli/config/security-messages.ts",
    "tests/integration/auth-middleware.test.ts",
    "tsconfig.server.json"
  ],
  "target_coverage": 80
}
