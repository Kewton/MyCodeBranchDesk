{"body":"## 概要\n\n`response-poller.ts`の`extractResponse()`関数で、インタラクティブプロンプト（選択肢形式の質問など）が検出された場合、`lastCapturedLine`を無視してtmuxバッファ全体をレスポンスとして返している。これにより、前の会話の内容がAssistantメッセージに混入し、History画面で正しいメッセージが表示されない。\n\n## 再現手順\n\n1. worktreeのClaude CLIセッションで複数の会話を実行する\n2. tmuxバッファに前の会話の出力が蓄積された状態で新しいコマンド（例: `/issue-enhance #323`）を送信する\n3. Claudeがインタラクティブプロンプト（選択肢形式の質問）を表示する\n4. History画面でAssistantの応答メッセージを確認する\n\n## 期待される動作\n\nHistory画面のAssistantメッセージには、現在の会話（`/issue-enhance #323`）の応答内容（Phase 1-3の出力）のみが表示される。\n\n## 実際の動作\n\nHistory画面のAssistantメッセージに前の会話の内容（例: publish.ymlの修正内容）が表示され、現在の会話の応答が正しく表示されない。\n\n## 原因\n\n`src/lib/response-poller.ts`の`extractResponse()`関数に2か所の問題がある:\n\n### 箇所1: 行326-341（Claude早期プロンプト検出）\n\n```typescript\nif (cliToolId === 'claude') {\n    const fullOutput = lines.join('\\n');  // ← tmuxバッファ全体\n    const promptDetection = detectPromptWithOptions(fullOutput, cliToolId);\n    if (promptDetection.isPrompt) {\n      return {\n        response: stripAnsi(fullOutput),  // ← バッファ全体を返している\n        isComplete: true,\n        lineCount: totalLines,\n      };\n    }\n}\n```\n\n### 箇所2: 行487-499（フォールバックプロンプト検出）\n\n```typescript\nconst fullOutput = lines.join('\\n');  // ← tmuxバッファ全体\nconst promptDetection = detectPromptWithOptions(fullOutput, cliToolId);\nif (promptDetection.isPrompt) {\n    return {\n      response: fullOutput,  // ← バッファ全体を返している\n      isComplete: true,\n      lineCount: totalLines,\n    };\n}\n```\n\n### 通常レスポンスとの違い\n\n通常のレスポンス抽出（行360-414）では`lastCapturedLine`を起点として新しい行のみを抽出しているが、プロンプト検出時のみこのロジックが適用されず、バッファ全体が使われている。\n\n## 修正方針\n\n`extractResponse()`のプロンプト検出部分で、通常レスポンスと同様に`lastCapturedLine`以降の行のみをレスポンスとして返すよう修正する。プロンプト検出自体はバッファ全体で行い（検出精度を維持）、返却するcontent部分のみ`lastCapturedLine`以降に限定する。\n\n## 影響範囲\n\n- `src/lib/response-poller.ts` - `extractResponse()`関数の2か所\n- History画面のAssistantメッセージ表示\n- Claudeが選択肢形式の質問を表示するすべてのケース\n\n## ラベル\n\n- bug","title":"fix: インタラクティブプロンプト検出時にtmuxバッファ全体がレスポンスとして保存される"}
