# Issue #181 レビューレポート

**レビュー日**: 2026-02-07
**フォーカス**: 通常レビュー（Consistency & Correctness）
**イテレーション**: 1回目
**ステージ**: Stage 1

---

## サマリー

| カテゴリ | 件数 |
|---------|------|
| Must Fix | 1 |
| Should Fix | 3 |
| Nice to Have | 3 |
| **合計** | **7** |

**全体評価**: Issue #181 は根本原因の特定と修正方針の提示が概ね正確である。実際のソースコード `src/lib/prompt-detector.ts` の `detectMultipleChoicePrompt()` 関数を確認したところ、継続行検出ロジック（226-228行目）の不足という問題分析は正しい。ただし、行番号の誤り、実在しない関数名の使用、中間行の説明欠落、修正案のリスク分析不足、受け入れ条件の欠如といった改善点がある。

---

## Must Fix（必須対応）

### S1-F007: 根本原因分析で中間行の扱いが未説明

**カテゴリ**: 正確性
**場所**: 根本原因 > 検出アルゴリズムの問題 セクション

**問題**:
Issueの根本原因分析では逆順スキャンの結果を以下の3ステップで説明している:

1. `  3. No` がオプション3として検出される
2. `ndmate-issue-161` が継続行として認識されない
3. スキャン中断

しかし、`ndmate-issue-161` の前（上方向）にはさらに2行が存在する:
- `/Users/maenokota/share/work/github_kewton/comma`
- `  2. Yes, and don't ask again for curl and python3 commands in`

仮に `ndmate-issue-161` が継続行として修正されても、次の `/Users/...` 行でも同じ問題が発生する。修正はこれらの**複数の連続継続行**を全て処理する必要がある。

**証拠**:
実際のコード（`src/lib/prompt-detector.ts` 222-239行目）のスキャンループでは、継続行と認識されなかった時点で `break` が実行される。つまり `ndmate-issue-161` だけでなく、その上にある `/Users/...` 行も同じ条件をパスする必要がある。

**推奨対応**:
根本原因分析を拡充し、全ての折り返し行について逆順スキャンの挙動を説明する。提案された修正案の `isPathContinuation` が `/Users/...` 行もカバーしていることを明示する（`/^[\/~]/.test(line)` で `/` 始まりの行がマッチ）。

---

## Should Fix（推奨対応）

### S1-F001: 継続行検出コードの行番号が不正確

**カテゴリ**: 正確性
**場所**: 根本原因 > 継続行検出の制限（line 293-295）セクション

**問題**:
Issueでは継続行検出ロジックの位置を「line 293-295」と記載しているが、実際のファイルでは:

| 記載の行番号 | 実際の行番号 | 内容 |
|-------------|-------------|------|
| line 293 | line 226 | `const hasLeadingSpaces = ...` |
| line 294 | line 227 | `const isShortFragment = ...` |
| line 295 | line 228 | `const isContinuationLine = ...` |

実際の293-295行目は `getAnswerInput` 関数の JSDoc コメント（`@param answer`, `@param promptType`）である。

**推奨対応**:
「line 293-295」を「line 226-228」に修正する。または行番号の記載を削除し、関数名とコードスニペットのみで参照する方が保守性が高い。

---

### S1-F002: isConsecutiveFromOne は実在しない関数

**カテゴリ**: 正確性
**場所**: 根本原因 > 結果 セクション

**問題**:
Issue内の以下の疑似コードで参照されている `isConsecutiveFromOne` はプロジェクト内に存在しない:

```typescript
// Issueの記載
options = [{number: 3, label: "No", isDefault: false}]
isConsecutiveFromOne([3]) -> false  // 1から始まっていない
-> isPrompt: false
```

実際の検証ロジックは `src/lib/prompt-detector.ts` 243行目:

```typescript
if (options.length < 2 || !hasDefaultIndicator) {
  return { isPrompt: false, ... };
}
```

最終的に `isPrompt: false` になるという結論は正しいが、理由が異なる。実際には「オプション数が2未満（1 < 2 = true）」で非検出になる。

**推奨対応**:
実際のコードに基づいた説明に修正する:
```
options = [{number: 3, label: "No", isDefault: false}]
options.length < 2 -> true (1 < 2)
-> isPrompt: false
```

---

### S1-F004: 修正案の偽陽性リスク考察が不足

**カテゴリ**: 完全性
**場所**: 修正案 セクション

**問題**:
提案された修正案の `/^[a-zA-Z0-9_-]+$/.test(line)` は、英数字とハイフン・アンダースコアのみで構成される任意の文字列にマッチする。例えば以下のような文字列も継続行と誤判定される可能性がある:
- `Proceed`（質問文の一部）
- `Cancel`（別のオプションラベルの一部）
- `test-file`（単独の単語）

この条件は `options.length > 0` のガード内でのみ評価されるため影響範囲は限定的だが、偽陽性が発生した場合の影響（質問文が正しく抽出されない、またはオプションラベルが連結される）についての分析が記載されていない。

**推奨対応**:
修正案にリスク分析を追加する:
1. このチェックが実行される条件（既にオプションが1つ以上検出済み）を明記
2. 偽陽性が発生した場合の影響と許容可能性を説明
3. 代替案「オプション番号パターンに一致しない行は全て継続行」アプローチとの具体的なトレードオフを記載

---

## Nice to Have（あれば良い）

### S1-F003: ターミナル出力例のタイプミスの可能性

**カテゴリ**: 正確性
**場所**: スクリーンショット セクション

**問題**:
ターミナル出力例で `commandmate-issue-161` が `comma\nndmate-issue-161` と改行されている。ターミナル幅による折り返しの場合、文字単位で切断されるため `comman\ndmate-issue-161` が正しい可能性がある（`n` の重複がないはず）。

**推奨対応**:
実際のターミナル出力を再確認する。可能であれば実際の画面キャプチャを添付する。

---

### S1-F005: テスト要件の記載がない

**カテゴリ**: 完全性
**場所**: Issue全体

**問題**:
既存のテストファイル `tests/unit/prompt-detector.test.ts` には multiple choice プロンプトのテストケースが1件も存在しない。修正に伴い追加すべきテストケースについて言及がない。

**推奨対応**:
テスト要件セクションを追加し、以下のテストケースを明記する:
1. 長いパスを含む複数行オプションの検出（今回の再現ケース）
2. パス以外の継続行パターンの検出
3. 偽陽性防止テスト（質問文の単語が継続行として誤認されないこと）
4. 既存プロンプト検出の回帰テスト
5. Auto-Yes統合テスト（検出されたプロンプトでAuto-Yesが正しく動作すること）

---

### S1-F006: 受け入れ条件が明示されていない

**カテゴリ**: 完全性
**場所**: Issue全体

**問題**:
「期待される動作」の記載はあるが、具体的な受け入れ条件（Acceptance Criteria）が存在しない。

**推奨対応**:
受け入れ条件セクションを追加する:
- [ ] 複数行にまたがるオプションテキストを含む multiple choice プロンプトが正しく検出されること
- [ ] 検出されたプロンプトのオプション数が正しいこと（3つ）
- [ ] Auto-Yes が当該プロンプトで正しく動作すること
- [ ] UI にプロンプトメッセージとボタンが表示されること
- [ ] 既存のプロンプト検出パターン（y/n, Y/n, yes/no, Approve?, 通常のmultiple choice）が退行しないこと
- [ ] 単体テストが追加されていること

---

## 参照ファイル

### コード

| ファイル | 行番号 | 関連性 |
|---------|--------|--------|
| `src/lib/prompt-detector.ts` | 226-228 | 継続行検出ロジック（修正対象） |
| `src/lib/prompt-detector.ts` | 222-239 | 逆順スキャンの else if ブランチ全体 |
| `src/lib/prompt-detector.ts` | 241-248 | オプション数・デフォルトインジケータ検証 |
| `src/lib/auto-yes-resolver.ts` | - | Auto-Yes 機能（プロンプト検出に依存） |
| `tests/unit/prompt-detector.test.ts` | - | 既存テスト（multiple choice テストなし） |

### ドキュメント

| ファイル | 関連性 |
|---------|--------|
| `CLAUDE.md` | prompt-detector.ts のモジュール説明 |
