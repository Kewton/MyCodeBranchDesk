# アーキテクチャレビュー: Issue #69 登録済みリポジトリの削除機能

**レビュー日**: 2026-01-28
**対象**: Issue #69 設計方針書
**レビュアー**: シニアソフトウェアアーキテクト (Claude Opus 4.5)

---

## 1. 設計原則の遵守確認

### SOLID原則チェック

| 原則 | 状態 | 評価 |
|------|------|------|
| **S**ingle Responsibility | ✅ 準拠 | `session-cleanup.ts`はクリーンアップ処理のみ担当 |
| **O**pen/Closed | ✅ 準拠 | 新規CLIツール追加時は`CLI_TOOL_IDS`に追加するだけで対応可能 |
| **L**iskov Substitution | ⚪ N/A | 継承構造なし |
| **I**nterface Segregation | ✅ 準拠 | `WorktreeCleanupResult`は必要最小限のフィールド |
| **D**ependency Inversion | ✅ 準拠 | `killSessionFn`を引数で注入、テスト容易 |

### その他の原則

| 原則 | 状態 | 評価 |
|------|------|------|
| KISS | ✅ 準拠 | ネイティブconfirm()使用、シンプルなAPI設計 |
| YAGNI | ✅ 準拠 | 必要最小限の機能のみ、将来機能の先行実装なし |
| DRY | ✅ 準拠 | 既存パターン（kill-session等）を再利用 |

---

## 2. アーキテクチャ評価

### 構造的品質

| 評価項目 | スコア | コメント |
|---------|--------|----------|
| モジュール性 | ⭐⭐⭐⭐⭐ (5/5) | 各レイヤーが明確に分離、session-cleanup.tsがFacadeとして機能 |
| 結合度 | ⭐⭐⭐⭐☆ (4/5) | ポーラー間の依存をFacadeで隠蔽、ただしAPI層がDB層に直接依存 |
| 凝集度 | ⭐⭐⭐⭐⭐ (5/5) | 各モジュールが単一の責務を持つ |
| 拡張性 | ⭐⭐⭐⭐☆ (4/5) | 新CLIツール追加は容易、ただしポーラーアーキテクチャの統一が望ましい |
| 保守性 | ⭐⭐⭐⭐⭐ (5/5) | 既存パターン踏襲、コードの一貫性が高い |

### パフォーマンス観点

| 項目 | 評価 |
|------|------|
| レスポンスタイム | ⭐⭐⭐⭐☆ 良好（10 worktreeで約1.5秒以内） |
| スループット | ⭐⭐⭐⭐☆ 十分（リポジトリ削除は低頻度操作） |
| リソース使用効率 | ⭐⭐⭐⭐⭐ 優秀（単一DELETEクエリ + CASCADE） |
| スケーラビリティ | ⭐⭐⭐☆☆ 許容範囲（大量worktreeの逐次処理は改善の余地あり） |

---

## 3. セキュリティレビュー

### OWASP Top 10 チェック

| 脆弱性 | 状態 | 対策 |
|--------|------|------|
| インジェクション | ✅ 対策済 | プリペアドステートメント使用 |
| 認証の破綻 | ⚪ N/A | 認証機能なし（ローカルアプリ） |
| 機微データの露出 | ✅ 対策済 | ファイルパスのみ、機密情報なし |
| XXE | ⚪ N/A | XML処理なし |
| アクセス制御の不備 | ⚪ N/A | ローカルアプリ、アクセス制御不要 |
| セキュリティ設定ミス | ✅ 対策済 | 適切なステータスコード使用 |
| XSS | ✅ 対策済 | React自動エスケープ |
| 安全でないデシリアライゼーション | ✅ 対策済 | JSON.parse()のみ、型検証あり |
| 既知の脆弱性 | ✅ 対策済 | 標準ライブラリのみ使用 |
| ログとモニタリング不足 | ✅ 対策済 | **設計書セクション9にログ設計追加済み** |

### 追加セキュリティ観点

| 観点 | 評価 |
|------|------|
| パストラバーサル | ✅ 安全（DB完全一致のみ、ファイルシステム操作なし） |
| 誤操作防止 | ✅ 十分（`delete`入力確認 + 削除内容の明示） |
| 監査証跡 | ✅ 十分（ログファイル保持） |

---

## 4. 既存システムとの整合性

### 統合ポイント

| 項目 | 評価 |
|------|------|
| API互換性 | ✅ 整合（既存のレスポンス形式を踏襲） |
| データモデル整合性 | ✅ 整合（既存CASCADE設定を活用） |
| WebSocket通知 | ✅ 整合（既存broadcastMessageパターン使用） |
| エラーハンドリング | ✅ 整合（既存handleApiErrorパターン使用） |

### 技術スタックの適合性

| 項目 | 評価 |
|------|------|
| Next.js 14 | ✅ 適合（App Router、API Routes使用） |
| TypeScript | ✅ 適合（型定義、インターフェース設計） |
| SQLite | ✅ 適合（CASCADE削除活用） |
| 既存コードパターン | ✅ 適合（kill-session、memos削除を参照） |

### 既存パターンの踏襲確認

| パターン | 参照元 | 設計での適用 | 評価 |
|---------|--------|-------------|------|
| 複数CLIツールループ | `kill-session/route.ts:40-60` | ✅ | 一貫性あり |
| WebSocket通知 | `kill-session/route.ts:72-78` | ✅ | 一貫性あり |
| DELETE APIレスポンス | `memos/[memoId]/route.ts:87-126` | ✅ | 一貫性あり |
| stopPolling関数 | `response-poller.ts:706-715` | ✅ | 一貫性あり |

---

## 5. リスク評価

| リスク種別 | 内容 | 影響度 | 発生確率 | 対策優先度 |
|-----------|------|--------|---------|-----------|
| **技術的リスク** | 大量worktree（100件以上）の削除で処理時間が長期化 | 中 | 低 | 低 |
| **運用リスク** | 環境変数設定リポジトリがSync Allで再登録される | 低 | 中 | ✅ **対策済**（警告UI追加） |
| **データ整合性リスク** | DB削除前にセッションkill失敗でゾンビプロセス発生 | 低 | 低 | 低 |
| **UXリスク** | ネイティブprompt()がブラウザでブロックされる可能性 | 中 | 低 | 低 |

### リスク詳細と対策状況

#### 技術的リスク: 大量worktree処理
- **現状**: 逐次処理（for-of loop）
- **影響**: 100 worktreeで約15秒
- **対策案**: 将来的にPromise.allSettledで並列化検討（現時点では不要）

#### 運用リスク: 環境変数再登録
- **対応状況**: ✅ **設計書セクション7に警告UI追加済み**
  - 確認ダイアログに注意書き追加
  - 警告アイコン表示
  - 環境変数チェック関数の実装イメージ記載

---

## 6. 改善提案

### 必須改善項目（Must Fix）

**なし** - 設計として十分な品質を達成

### 推奨改善項目（Should Fix）

#### 1. ~~エラーログの明示的な追加~~ → ✅ **対策済み**

設計書セクション9「ログ設計」に詳細なログ出力方針が追加されました：

| 処理段階 | レベル | 出力内容 |
|----------|--------|---------|
| 削除開始 | `info` | リポジトリパス、対象worktree数 |
| セッションkill成功 | `info` | worktreeId、CLIツール名 |
| セッションkill失敗 | `warn` | worktreeId、CLIツール名、エラー内容 |
| ポーラー停止失敗 | `warn` | worktreeId、ポーラー名、エラー内容 |
| DB削除成功 | `info` | リポジトリパス、削除件数 |
| DB削除失敗 | `error` | リポジトリパス、エラー内容 |
| 削除完了 | `info` | リポジトリパス、warnings有無 |

#### 2. ~~環境変数再登録の警告UI~~ → ✅ **対策済み**

設計書セクション7に以下が追加されました：

- `getEnvRepositoryPaths()`: 環境変数からリポジトリパスリストを取得
- `isInEnvVar()`: 環境変数に含まれるか判定
- 警告付き確認ダイアログの実装イメージ
- 警告アイコン表示のUI設計

### 検討事項（Consider）

#### 1. 並列処理の導入

**現状**: 複数worktreeを逐次処理
**提案**: Promise.allSettledで並列化

```typescript
// 将来検討
const results = await Promise.allSettled(
  worktreeIds.map(id => cleanupWorktreeSessions(id, killSessionFn))
);
```

**判断**: 現時点では不要（worktree数が少ない想定）

#### 2. ポーラーアーキテクチャの統一

**現状**: `response-poller`と`claude-poller`でシグネチャが異なる
**提案**: 将来的に`claude-poller`を廃止し`response-poller`に統一

**判断**: 別Issueで対応（本Issueの範囲外）

#### 3. カスタム確認モーダルへの移行

**現状**: ネイティブ`confirm()` + `prompt()`
**提案**: Reactコンポーネントによるカスタムモーダル

**判断**: 現時点では不要（既存パターン踏襲、シンプルさ優先）

---

## 7. ベストプラクティスとの比較

### 業界標準との差異

| 観点 | 業界標準 | 本設計 | 評価 |
|------|---------|--------|------|
| 削除API形式 | `DELETE /resources/:id` | `DELETE /api/repositories` + Body | ⚠️ 逸脱（合理的理由あり） |
| 確認UI | カスタムモーダル | ネイティブdialog | ⚪ 許容（シンプルさ優先） |
| エラー収集 | Result型/Either型 | warnings配列 | ✅ 適切 |
| カスケード削除 | 明示的削除 | DB CASCADE | ✅ 適切 |

### DELETEリクエストのBody使用について

**逸脱の合理性**:
- RFC 7231では「DELETE request with body is not prohibited」
- パスに含まれるスラッシュのエンコード問題を回避
- 日本語パス名のサポートが容易

**結論**: 実用上の理由から許容

---

## 8. 総合評価

### レビューサマリ

| 項目 | 評価 |
|------|------|
| **全体評価** | ⭐⭐⭐⭐⭐ (5/5) |
| **設計品質** | 優秀 |
| **既存整合性** | 優秀 |
| **セキュリティ** | 十分 |
| **保守性** | 優秀 |

### 強み

1. **既存パターンとの高い一貫性** - kill-session、memos削除等の既存実装を踏襲
2. **段階的エラーハンドリング** - 部分成功を許容する堅牢な設計
3. **Facadeパターンによる複雑性隠蔽** - ポーラー差異を吸収
4. **CASCADE削除の活用** - 最小限のコードで関連データ削除
5. **適切なトレードオフ判断** - シンプルさと堅牢性のバランス
6. **詳細なログ設計** - 運用時のトラブルシューティングに十分対応
7. **環境変数警告UI** - ユーザー体験への配慮

### 弱み

**なし** - 前回のレビュー指摘事項はすべて設計書に反映済み

### 総評

Issue #69の設計方針は、既存のコードベースとの整合性を保ちながら、堅牢で保守性の高い設計となっている。Facadeパターンによるポーラー統一管理、段階的エラーハンドリング、CASCADE削除の活用など、適切な設計判断がなされている。

前回レビューで推奨した改善項目（エラーログの明示化、環境変数警告UI）がすべて設計書に反映されており、**実装着手可能な状態**である。

---

## 9. 承認判定

### ✅ 承認（Approved）

前回の「条件付き承認」で指摘した以下の条件がすべて満たされました：

| 承認条件 | 対応状況 |
|---------|---------|
| エラーログ出力の追加を設計に明記 | ✅ セクション9に詳細なログ設計追加 |
| 環境変数再登録の警告UI検討 | ✅ セクション7に警告UI設計追加 |

---

## 10. 次のステップ

### 実装着手前

- [x] 設計レビュー完了
- [x] エラーログ出力の設計への追記
- [x] 環境変数警告UIの設計への追記
- [x] **最終承認完了** → 実装着手可能

### 実装フェーズ

設計書セクション13の実装優先順序に従って実施：

| Phase | ファイル | 作業内容 |
|-------|---------|---------|
| 1-1 | `src/lib/db.ts` | `getWorktreeIdsByRepository()`, `deleteRepositoryWorktrees()` 追加 |
| 1-2 | `src/lib/session-cleanup.ts` | 新規作成 |
| 1-3 | `src/lib/ws-server.ts` | `cleanupRooms()` 追加 |
| 2-1 | `src/app/api/repositories/route.ts` | DELETEハンドラ新規作成 |
| 2-2 | `src/lib/api-client.ts` | `repositoryApi.delete()` 追加 |
| 3-1 | `src/components/worktree/WorktreeList.tsx` | 削除ボタン・ダイアログ追加 |

### 実装後

- [ ] ユニットテスト実施（session-cleanup.ts, db.ts）
- [ ] 統合テスト実施（API削除フロー）
- [ ] E2Eテスト実施（UI削除フロー）
- [ ] コードレビュー

---

## 付録: 実装時チェックリスト

### db.ts

- [ ] `getWorktreeIdsByRepository()`: PreparedStatement使用
- [ ] `deleteRepositoryWorktrees()`: 戻り値の`deletedCount`が正確

### session-cleanup.ts

- [ ] `CLI_TOOL_IDS`の網羅性（claude, codex, gemini）
- [ ] エラーキャッチの網羅性
- [ ] ログ出力の適切性（設計書セクション9準拠）

### api/repositories/route.ts

- [ ] バリデーションの網羅性
- [ ] ステータスコードの正確性（200, 400, 404, 500）
- [ ] WebSocket通知の正確性
- [ ] ログ出力の適切性（設計書セクション9準拠）

### WorktreeList.tsx

- [ ] 確認ダイアログのUX
- [ ] `delete`入力の検証
- [ ] 環境変数警告アイコンの表示（設計書セクション7準拠）
- [ ] 削除後のUI更新

### api-client.ts

- [ ] `repositoryApi.delete()`のエラーハンドリング

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2026-01-28 | 初版作成・レビュー実施（条件付き承認） |
| 2026-01-28 | 設計書更新確認・最終承認（承認） |
