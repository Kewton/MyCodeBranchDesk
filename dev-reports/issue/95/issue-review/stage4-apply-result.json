{
  "issue_number": 95,
  "iteration": 1,
  "stage": 4,
  "stage_name": "指摘事項反映（1回目）",
  "apply_date": "2026-01-30",
  "applied_findings": {
    "must_fix": [
      {
        "id": "MF-001",
        "status": "applied",
        "change_summary": "APIレスポンス形式の既存互換性確保 - Base64 data URIプレフィックス形式を採用し、既存 `content: string` との後方互換性を維持。オプショナルフィールド（isImage?, mimeType?）として追加することで破壊的変更を回避。"
      }
    ],
    "should_fix": [
      {
        "id": "SF-001",
        "status": "applied",
        "change_summary": "ファイルサイズ上限を10MBから5MBに変更。Base64エンコードによる約1.33倍のメモリ使用量増加を考慮し、保守的な上限を設定。根拠を明記。"
      },
      {
        "id": "SF-002",
        "status": "applied",
        "change_summary": "`isImageFile()` ユーティリティ関数を `src/lib/file-operations.ts` に追加する方針を記載。handleFileSelect関数の複雑化対策として判定ロジックを一元化。"
      },
      {
        "id": "SF-003",
        "status": "applied",
        "change_summary": "E2Eテストの具体的なテストシナリオを受け入れ条件に追加: (1) 画像ファイル選択時にビューワー表示、(2) 5MB超えファイル選択時にエラー表示、(3) 非対応形式で従来動作、(4) モーダル拡大表示（オプション機能）"
      },
      {
        "id": "SF-004",
        "status": "applied",
        "change_summary": "MIMEタイプ検証の実装方法を明記。マジックバイト（ファイルヘッダ）による検証を自作し、外部ライブラリは使用しない方針（YAGNI原則に従う）。対応形式のマジックバイトパターンを具体的に記載。"
      }
    ],
    "nice_to_have": [
      {
        "id": "NTH-001",
        "status": "skipped",
        "reason": "実装完了後に対応すべき事項のため、Issue更新時点ではスキップ"
      },
      {
        "id": "NTH-002",
        "status": "applied",
        "change_summary": "対象外事項にキャッシュ機能が「将来のパフォーマンス改善ポイントとして認識」と追記"
      },
      {
        "id": "NTH-003",
        "status": "skipped",
        "reason": "設計詳細は実装フェーズで検討するため、Issue段階ではスキップ"
      }
    ]
  },
  "summary": {
    "total_findings": 8,
    "applied": 6,
    "skipped": 2
  },
  "additional_changes": [
    {
      "section": "影響ファイル一覧",
      "description": "主要変更ファイル、新規作成ファイル、軽微な変更の表形式一覧を追加。レビュー結果のimpact_analysisを反映。"
    },
    {
      "section": "レビュー履歴",
      "description": "イテレーション1の対応済み指摘事項をレビュー履歴セクションとして追加"
    },
    {
      "section": "型定義の更新",
      "description": "src/types/models.tsへのFileContent interface拡張について明記"
    }
  ],
  "github_update": {
    "status": "success",
    "issue_url": "https://github.com/Kewton/CommandMate/issues/95",
    "updated_at": "2026-01-30"
  },
  "new_body": "## 概要\n\nFilesにて画像ファイルを視認したい\n\n## 背景・課題\n\nClaude Codeと視覚的なコミュニケーションがとれるようになる。\n\n### 具体的なユースケース\n- スクリーンショットを確認しながらUIの問題を議論\n- 生成された図表やダイアグラムの確認\n- デザインモックアップのレビュー\n- エラー画面のスクリーンショット確認\n\n## 提案する解決策\n\n画像ファイルの場合ビューワで確認可能とする。\n\n### 技術的な実装方針\n\n#### 1. 対応する画像形式\n- PNG (.png)\n- JPEG (.jpg, .jpeg)\n- GIF (.gif)\n- WebP (.webp)\n- SVG (.svg)\n\n#### 2. 画像表示方法\n既存の `FileViewer.tsx` を拡張し、画像ファイル判定時に画像表示コンポーネントを表示する。\n\n**関連コンポーネント**:\n- `src/components/worktree/FileViewer.tsx` - 拡張対象のファイルビューワー\n- `src/components/worktree/FileTreeView.tsx` - ファイル選択処理\n- `src/components/worktree/WorktreeDetailRefactored.tsx` - 表示切替処理\n\n**コード複雑化対策**:\n- `handleFileSelect` 関数の条件分岐増加に対応するため、`isImageFile()` ユーティリティ関数を `src/lib/file-operations.ts` に追加\n- 既存の `isEditableFile()` と同様のパターンで判定ロジックを一元化\n\n#### 3. 画像データ取得方法\n`GET /api/worktrees/:id/files/:path` APIを拡張し、画像ファイルの場合はBase64エンコードで返却する。\n\n**API拡張方針**:\n- 既存の `content: string` フィールドは維持（既存FileViewer.tsxとの互換性確保）\n- 画像ファイルの場合、`content` フィールドに **Base64 data URIプレフィックス形式** で格納（例: `data:image/png;base64,xxxxx`）\n- オプショナルフィールドとして `isImage?: boolean` と `mimeType?: string` を追加\n- これにより既存の `FileContent` interface（`content: string`）との後方互換性を維持\n- 参考: `src/app/api/worktrees/[id]/files/[...path]/route.ts`\n\n**型定義の更新**:\n- `src/types/models.ts` に `FileContent` interfaceを拡張（`isImage?`, `mimeType?` をオプショナルプロパティとして追加）\n\n#### 4. 画像拡張子設定\n`src/config/editable-extensions.ts` と同様のパターンで、`src/config/image-extensions.ts` を新規作成し、対応画像拡張子をホワイトリストで管理する。\n\n### セキュリティ考慮事項\n\n1. **対応拡張子のホワイトリスト**: `IMAGE_EXTENSIONS` 設定で対応拡張子を制限\n2. **画像ファイルサイズ上限**: **5MB** を上限として設定\n   - 根拠: Base64エンコードは元データの約1.33倍のサイズになるため、5MBの画像は約6.7MBのBase64文字列になる\n   - Issue #49（マークダウンエディタ）の1MB上限と比較し、画像ファイル特性を考慮しつつ保守的な値を設定\n   - 必要に応じて `IMAGE_MAX_SIZE_MB` 設定として設定ファイルで管理可能に\n3. **MIMEタイプ検証**: 拡張子だけでなくファイルのMIMEタイプも検証\n   - **実装方法**: マジックバイト（ファイルヘッダ）による検証を自作\n   - Issue #49の設計方針（外部依存追加を最小限に抑えるYAGNI原則）に従い、外部ライブラリ（file-type, mime-types等）は使用しない\n   - 対応形式のマジックバイトパターン:\n     - PNG: `89 50 4E 47`\n     - JPEG: `FF D8 FF`\n     - GIF: `47 49 46 38`\n     - WebP: `52 49 46 46 ... 57 45 42 50`\n     - SVG: XMLヘッダまたは `<svg` タグで判定\n4. **パストラバーサル防止**: 既存の `isPathSafe()` 関数を活用\n\n## 受け入れ条件\n\n- [ ] PNG, JPG, GIF, WEBP, SVG形式の画像ファイルがFileTreeViewで選択可能\n- [ ] 選択した画像ファイルがビューワ領域に表示される\n- [ ] 画像は最大幅100%、最大高さ500pxで表示される\n- [ ] 画像クリック時にモーダルで拡大表示（オプション）\n- [ ] 5MB以上の画像ファイルはエラーメッセージを表示\n- [ ] 対応外のファイル形式は従来通りの動作（テキスト表示 or エラー）\n- [ ] 単体テストが追加されている\n  - `src/lib/__tests__/file-operations.test.ts` に `isImageFile()` 関数のテスト追加\n- [ ] E2Eテストが追加されている（`tests/e2e/image-viewer.spec.ts`）\n  - 画像ファイル選択時にビューワー表示されること\n  - 5MB超えファイル選択時にエラーメッセージが表示されること\n  - 非対応形式ファイル選択時に従来動作すること\n  - （オプション機能実装時）モーダル拡大表示が動作すること\n\n## 対象外事項（スコープ外）\n\n- 画像のアップロード機能\n- 画像の編集・加工機能\n- 動画ファイルの再生\n- 画像のサムネイル生成\n- 画像のキャッシュ機能（将来のパフォーマンス改善ポイントとして認識）\n\n## 関連Issue\n\n- #49 マークダウンエディタとビューワー（設計パターンの参考）\n\n## 影響ファイル一覧\n\n### 主要変更ファイル\n| ファイル | 変更内容 | リスク |\n|---------|---------|-------|\n| `src/app/api/worktrees/[id]/files/[...path]/route.ts` | GET handlerの拡張（画像判定、Base64エンコード、MIMEタイプ返却） | 高（既存互換性維持必須） |\n| `src/components/worktree/FileViewer.tsx` | 画像ファイル表示コンポーネントの追加 | 中 |\n| `src/components/worktree/WorktreeDetailRefactored.tsx` | handleFileSelect関数への画像判定分岐追加 | 低 |\n\n### 新規作成ファイル\n| ファイル | 説明 | 推定行数 |\n|---------|------|--------|\n| `src/config/image-extensions.ts` | 対応画像拡張子のホワイトリスト管理 | 約50行 |\n| `src/components/worktree/ImageViewer.tsx` | 画像表示コンポーネント（オプション: FileViewer内統合も可） | 約150行 |\n| `tests/e2e/image-viewer.spec.ts` | E2Eテスト | 約100行 |\n\n### 軽微な変更\n| ファイル | 変更内容 |\n|---------|--------|\n| `src/lib/file-operations.ts` | `isImageFile()` 関数追加 |\n| `src/types/models.ts` | `FileContent` interfaceの拡張（`isImage?`, `mimeType?` 追加） |\n\n## 参考資料\n\n- 設計参考: `dev-reports/design/issue-49-markdown-editor-design-policy.md`\n- アーキテクチャ: `docs/architecture.md`\n\n---\n\n## レビュー履歴\n\n### イテレーション 1 (2026-01-30) - 影響範囲レビュー\n\n**対応済み指摘事項**:\n- **MF-001**: APIレスポンス形式の既存互換性確保 - Base64 data URIプレフィックス形式を採用し、既存 `content: string` との互換性を維持\n- **SF-001**: ファイルサイズ上限を10MBから5MBに変更、Base64エンコードによるメモリ使用量の根拠を明記\n- **SF-002**: `isImageFile()` ユーティリティ関数追加による判定ロジック一元化を記載\n- **SF-003**: E2Eテストの具体的なテストシナリオを受け入れ条件に追加\n- **SF-004**: MIMEタイプ検証の実装方法（マジックバイト検証、外部ライブラリ不使用）を明記\n\n**詳細**: `dev-reports/issue/95/issue-review/`"
}
