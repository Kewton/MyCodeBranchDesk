# Issue #135 影響範囲レビュー（2回目）レポート

**レビュー日**: 2026-02-03
**フォーカス**: 影響範囲レビュー
**イテレーション**: 2回目（Stage 7）

---

## サマリー

| カテゴリ | 件数 |
|---------|------|
| Must Fix | 0 |
| Should Fix | 4 |
| Nice to Have | 2 |

**影響範囲カバレッジ**: 90%
**リスクレベル**: 低

---

## 前回指摘事項（Stage 3）の対応状況

### 必須項目（全て対応済み）

| ID | 状況 | 概要 |
|----|------|------|
| M1 | 対応済み | APIルートファイルへの影響が正確な数値（30ファイル、66箇所）で詳細化 |
| M2 | 対応済み | 統合テストファイルへの影響と具体的な環境変数設定方法（vi.stubEnv）が追加 |
| M3 | 対応済み | DATABASE_PATH廃止時のフォールバック機構とdeprecation警告が追加 |

### 推奨項目（全て対応済み）

| ID | 状況 | 概要 |
|----|------|------|
| S1 | 対応済み | server.tsへの間接的影響が明記 |
| S2 | 対応済み | init.tsでの絶対パス生成がENV_DEFAULTSの修正として含まれる |
| S3 | 対応済み | env.test.tsとenv-setup.test.tsの更新必要性が明記 |
| S4 | 対応済み | ドキュメント更新対象が網羅的にリストアップ |

### オプション項目（全て対応済み）

| ID | 状況 | 概要 |
|----|------|------|
| N1 | 対応済み | スクリプトがその他の影響ファイルとして明記 |
| N2 | 対応済み | CI/CD影響セクションが追加 |

---

## 新規発見事項

### Should Fix（推奨対応）

#### S1: シェルスクリプトのDB_PATHフォールバック未対応

**カテゴリ**: ドキュメント影響
**場所**: `scripts/health-check.sh:44`, `scripts/status.sh:58-59`

**問題**:
シェルスクリプトでDATABASE_PATHがフォールバックなしで使用されており、CM_DB_PATHを参照していない。また、デフォルト値がdb.sqlite（cm.dbではない）となっている。

**現状のコード**:
```bash
# health-check.sh:44
DB_PATH="${DATABASE_PATH:-./data/db.sqlite}"

# status.sh:58-59
if [ -f "${DATABASE_PATH:-./data/db.sqlite}" ]; then
  DB_PATH="${DATABASE_PATH:-./data/db.sqlite}"
```

**推奨対応**:
CM_PORTの対応（既に実装済み）と同様に、フォールバック構文を使用する:
```bash
DB_PATH="${CM_DB_PATH:-${DATABASE_PATH:-./data/cm.db}}"
```

---

#### S2: docs/architecture.mdの旧名称参照

**カテゴリ**: ドキュメント整合性
**場所**: `docs/architecture.md:399, 453`

**問題**:
以下の古い参照が残っている:
- Line 399: `保存場所の例: ~/.mycodebranchdesk/db.sqlite`
- Line 453: `MCBD_DB_PATH（db.sqlite の保存先）`

**推奨対応**:
- `~/.mycodebranchdesk/db.sqlite` -> `~/.commandmate/data/cm.db`
- `MCBD_DB_PATH` -> `CM_DB_PATH`

---

#### S3: .env.exampleのデフォルト値不整合

**カテゴリ**: ドキュメント整合性
**場所**: `.env.example:36`

**問題**:
CM_DB_PATHのデフォルト値が`db.sqlite`となっているが、Issue #77で`cm.db`に統一されている。

**現状**:
```
CM_DB_PATH=./data/db.sqlite
```

**推奨対応**:
```
CM_DB_PATH=./data/cm.db
```

---

#### S4: E2Eテストの具体的手順不足

**カテゴリ**: テスト網羅性
**場所**: テスト計画 > E2Eテスト

**問題**:
バージョンアップシナリオのローカルシミュレーションテストについて、「旧形式のDBファイルを手動で配置し、マイグレーション動作を検証する」とあるが、具体的な手順が不明。

**推奨対応**:
以下の詳細を追加:
1. 旧形式DBファイルの配置パス（例: `./data/db.sqlite`）
2. マイグレーション実行コマンド
3. 検証項目チェックリスト（データ件数、スキーマバージョン等）

---

### Nice to Have（あれば良い）

#### N1: 内部ドキュメントのdb.sqlite参照

**カテゴリ**: ドキュメント整合性
**場所**: `docs/internal/*.md`

**問題**:
以下の内部ドキュメントでdb.sqlite参照が残っている:
- `swe-agents.md:43, 107`
- `TESTING_GUIDE.md:349, 419`
- `PRODUCTION_CHECKLIST.md:91, 174`
- `requirements-design.md:197`

**推奨対応**:
内部ドキュメントも一貫性のためcm.dbに更新することを推奨。ただし開発者向けドキュメントのため優先度は低い。

---

#### N2: マイグレーション時の複数DB優先順位

**カテゴリ**: 影響範囲完全性
**場所**: 修正方針 > マイグレーションロジック追加

**問題**:
検出対象（`./data/db.sqlite`, `./data/cm.db`, `~/.commandmate/data/db.sqlite`）が記載されているが、複数のDBファイルが存在する場合の優先順位が未定義。

**推奨対応**:
優先順位を明記（例: 最新のmodified timeを持つファイルを優先、または特定の順序で検索）。

---

## 影響範囲評価

### カバレッジ完全性: 90%

Issue本文の影響範囲セクションは以下をカバーしている:
- 直接的な影響（5ファイル）
- 間接的な影響（APIルート30ファイル66箇所、その他5ファイル）
- 後方互換性の考慮
- テスト影響（20+統合テストファイル）
- ドキュメント影響（8ファイル）
- CI/CD影響

### 残存ギャップ

1. シェルスクリプト（health-check.sh, status.sh）のDATABASE_PATH直接参照
2. .env.exampleのCM_DB_PATHデフォルト値（db.sqlite -> cm.db）
3. docs/architecture.mdの旧名称参照
4. E2Eバージョンアップテストの具体的手順

### リスクレベル: 低

- 全ての必須対応項目（Stage 3のM1-M3）が解決済み
- 残存課題はドキュメント整合性に関するものが主
- 実装を阻害する技術的リスクは特定されていない

---

## 総評

Stage 3で指摘した全ての影響範囲に関する必須項目は適切に対処されており、Issueの影響範囲セクションは大幅に改善されている。特に以下の点が評価できる:

1. **数値の正確化**: APIルートファイル数が「56以上」から「30ファイル、66箇所」に正確化
2. **テスト方針の具体化**: vi.stubEnvを使用した環境変数設定方法が追加
3. **後方互換性対応**: DATABASE_PATH廃止時のフォールバック機構と警告が明記
4. **ドキュメント影響の網羅**: 更新対象ファイルリストが詳細化

残存する課題（S1-S4, N1-N2）はShould Fix/Nice to Haveレベルであり、Issueの実装を阻害するものではない。これらは実装フェーズまたはPRレビュー時に対応可能である。

**結論**: 影響範囲分析は十分な網羅性を持っており、実装に進める状態である。

---

## 参照ファイル

### コード
- `/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/lib/db-instance.ts`: DBパス解決ロジック（修正対象）
- `/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/lib/env.ts`: 環境変数フォールバック機構
- `/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/cli/utils/env-setup.ts`: CLIデフォルト値

### ドキュメント
- `/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/.env.example`: CM_DB_PATHデフォルト値要更新
- `/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/docs/architecture.md`: 旧名称参照要更新
- `/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/docs/migration-to-commandmate.md`: DATABASE_PATH廃止記載追加予定

### スクリプト
- `/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/scripts/health-check.sh`: DATABASE_PATHフォールバック要対応
- `/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/scripts/status.sh`: DATABASE_PATHフォールバック要対応

---

*Generated by Issue Review Agent - Stage 7*
