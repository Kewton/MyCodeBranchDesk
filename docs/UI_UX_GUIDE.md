# CommandMate UI/UX ガイド

本ドキュメントは、CommandMate の現在の UI/UX 実装について説明します。

## 目次

1. [概要](#概要)
2. [レスポンシブデザイン](#レスポンシブデザイン)
3. [デスクトップ UI](#デスクトップ-ui)
4. [モバイル UI](#モバイル-ui)
5. [共通機能](#共通機能)
6. [コンポーネント構成](#コンポーネント構成)

---

## 概要

CommandMate は、デスクトップとモバイルの両方に最適化されたレスポンシブ UI を提供します。

| 画面 | レイアウト | 特徴 |
|------|-----------|------|
| **デスクトップ** | 2カラム分割 | リサイズ可能なペイン |
| **モバイル** | タブベース | ボトムナビゲーション |

---

## レスポンシブデザイン

### 自動検出

`useIsMobile` フックにより、画面サイズに応じて自動的にレイアウトが切り替わります。

- **デスクトップ**: 768px 以上
- **モバイル**: 768px 未満

```
┌─────────────────────────────────────────┐
│  768px 以上 → デスクトップレイアウト     │
│  768px 未満 → モバイルレイアウト         │
└─────────────────────────────────────────┘
```

---

## デスクトップ UI

### レイアウト構成

```
┌─────────────────────────────────────────────────────┐
│  [←Back]  worktree-name                      [Info] │  ← ヘッダー
├──────────────────────┬──────────────────────────────┤
│                      │                              │
│   History Pane       │     Terminal Pane            │
│   (メッセージ履歴)    │     (ターミナル出力)          │
│                      │                              │
│                      │                              │
├──────────────────────┼──────────────────────────────┤
│                      │  [メッセージ入力]      [送信] │
│                      │                              │
└──────────────────────┴──────────────────────────────┘
                       ↑
                   リサイズハンドル
```

### 機能詳細

#### 1. ヘッダー
- **Back ボタン**: トップページ（Worktree 一覧）へ戻る
- **Worktree 名**: 現在のブランチ/worktree 名を表示
- **Info ボタン**: Worktree 情報モーダルを開く

#### 2. History Pane（左ペイン）
- 過去のメッセージ履歴を時系列で表示
- ユーザーメッセージと AI 応答を区別表示
- スクロール可能

#### 3. Terminal Pane（右ペイン）
- CLI ツールのリアルタイム出力を表示
- 自動スクロール（新しい出力に追従）
- メッセージ入力欄と送信ボタン

#### 4. リサイズ機能
- 左右ペイン間のリサイザーをドラッグして幅を調整
- 最小幅 20%、最大幅 80%
- ドラッグ中は視覚的フィードバック

#### 5. Info モーダル
- Worktree の詳細情報を表示
  - パス
  - ブランチ名
  - CLI ツール
  - 作成日時
- **メモ編集機能**: ブランチごとにメモを保存可能

#### 6. プロンプトパネル
- CLI ツールからの確認プロンプトをオーバーレイ表示
- Yes/No 選択または複数選択に対応
- アニメーション付きの表示/非表示

---

## モバイル UI

### レイアウト構成

```
┌─────────────────────────────┐
│ [←] worktree-name    [状態] │  ← ヘッダー
├─────────────────────────────┤
│                             │
│                             │
│     コンテンツエリア          │
│     (選択したタブに応じて)    │
│                             │
│                             │
├─────────────────────────────┤
│ Terminal│History│Logs│Info  │  ← タブバー
└─────────────────────────────┘
```

### タブ構成

| タブ | アイコン | 内容 |
|------|---------|------|
| **Terminal** | 💻 | リアルタイムターミナル出力 + 入力欄 |
| **History** | 🕐 | メッセージ履歴 |
| **Logs** | 📄 | Markdown ログファイル一覧 |
| **Info** | ℹ️ | Worktree 情報 + メモ編集 |

### 機能詳細

#### 1. ヘッダー
- **Back ボタン**: トップページへ戻る
- **Worktree 名**: 現在のブランチ名（省略表示）
- **状態インジケーター**:
  - 🟢 Running（実行中）
  - 🟡 Waiting（プロンプト待ち）
  - ⚪ Idle（待機中）
  - 🔴 Error（エラー）

#### 2. タブバー
- 画面下部に固定表示
- Safe Area 対応（iPhone のノッチ/ホームバー）
- 通知バッジ:
  - 🟢 新しい出力あり
  - 🟡 プロンプト待ち

#### 3. プロンプトシート
- CLI プロンプト検出時にボトムシートで表示
- スワイプダウンで閉じる
- オーバーレイタップで閉じる
- Yes/No または複数選択に対応

#### 4. 仮想キーボード対応
- キーボード表示時にレイアウト自動調整
- 入力欄が常に見える位置を維持

---

## 共通機能

### 1. リアルタイムポーリング

```
アクティブ時:  2秒間隔でポーリング
アイドル時:    5秒間隔でポーリング
```

- CLI ツールの出力を定期的に取得
- プロンプト検出（Yes/No、複数選択）
- 思考中（Thinking）状態の検出

### 2. プロンプト検出・応答

CLI ツールが確認を求めた場合:

```
┌─────────────────────────────────┐
│  Claudeからの確認                │
│                                 │
│  Do you want to proceed?        │
│                                 │
│  [Yes]  [No]                    │
└─────────────────────────────────┘
```

- 自動的に UI に表示
- 選択した回答を CLI に送信

### 3. メモ機能

各 Worktree にメモを保存可能:
- デスクトップ: Info モーダル内
- モバイル: Info タブ内

### 4. エラーバウンダリー

各コンポーネントは ErrorBoundary でラップ:
- 一部のエラーが全体に影響しない
- エラー発生時はフォールバック UI を表示

---

## コンポーネント構成

### ディレクトリ構造

```
src/components/
├── mobile/
│   ├── MobileHeader.tsx      # モバイル用ヘッダー
│   ├── MobileTabBar.tsx      # ボトムタブバー
│   └── MobilePromptSheet.tsx # プロンプト用ボトムシート
├── worktree/
│   ├── WorktreeDetailRefactored.tsx  # メインコンポーネント
│   ├── WorktreeDesktopLayout.tsx     # デスクトップ2カラム
│   ├── TerminalDisplay.tsx           # ターミナル表示
│   ├── HistoryPane.tsx               # 履歴ペイン
│   ├── PromptPanel.tsx               # デスクトップ用プロンプト
│   ├── PaneResizer.tsx               # ペインリサイザー
│   └── MessageInput.tsx              # メッセージ入力
├── error/
│   └── ErrorBoundary.tsx     # エラーバウンダリー
└── ui/
    └── Modal.tsx             # モーダルコンポーネント
```

### カスタムフック

```
src/hooks/
├── useIsMobile.ts          # モバイル判定
├── useWorktreeUIState.ts   # UI状態管理（useReducer）
├── usePromptAnimation.ts   # プロンプトアニメーション
├── useSwipeGesture.ts      # スワイプジェスチャー
├── useTerminalScroll.ts    # ターミナル自動スクロール
└── useVirtualKeyboard.ts   # 仮想キーボード対応
```

---

## 画面遷移フロー

```
┌─────────────────┐
│  トップページ    │
│  (Worktree一覧)  │
└────────┬────────┘
         │ タップ
         ▼
┌─────────────────┐
│  Worktree詳細    │◄──────────────┐
│  (チャット画面)   │               │
└────────┬────────┘               │
         │                        │
    ┌────┴────┐                   │
    ▼         ▼                   │
┌───────┐ ┌───────┐               │
│ Logs  │ │ Info  │               │
│ 画面  │ │ Modal │               │
└───────┘ └───────┘               │
                                  │
         [Back]───────────────────┘
```

---

## 技術的な特徴

### パフォーマンス最適化
- `memo` によるコンポーネントメモ化
- `useMemo` / `useCallback` による再計算防止
- 条件付きレンダリングで不要な DOM 生成を回避

### アクセシビリティ
- ARIA 属性の適切な設定
- キーボードナビゲーション対応
- スクリーンリーダー対応のラベル

### エラーハンドリング
- 各ペイン/コンポーネントに ErrorBoundary
- フォールバック UI の提供
- エラーログの出力

---

## 関連ドキュメント

- [README.md](../README.md) - プロジェクト概要
- [Webアプリ操作ガイド](./user-guide/webapp-guide.md) - 初めてのユーザー向け操作手順書
- [DEPLOYMENT.md](./DEPLOYMENT.md) - デプロイメントガイド
- [architecture.md](./architecture.md) - アーキテクチャ詳細
