{"body":"## 概要\n\nAuto-Yesモード有効時、Claude CLIの「Do you want to proceed?」プロンプトに対して自動応答（yes）が送信されないケースがある。\n\n## 再現手順\n\n1. CommandMateでClaude CLIセッションを開始\n2. Auto-Yesモードを有効化\n3. Claude CLIに長いタスク（例: `/multi-stage-issue-review`）を実行させる\n4. Claude CLIがBashコマンド実行の許可を求める「Do you want to proceed?」プロンプトを表示\n5. Auto-Yesが応答せず、プロンプトが放置される\n\n## 根本原因\n\n`auto-yes-manager.ts`の`pollAutoYes()`関数内で、`detectThinking()`が`detectPrompt()`より先に実行される（行281-287）。`detectThinking()`は`captureSessionOutput()`で取得した**5000行のバッファ全体**に対してパターンマッチを行うため、バッファ内に残存する**過去のClaude CLI出力**がthinkingパターンにマッチしてしまう。\n\n### マッチしてしまう残存出力の例\n\n| 残存行 | マッチ理由 |\n|--------|-----------|\n| `· Simmering… (4m 16s · ↓ 8.0k tokens · thought for 53s)` | `·`(スピナー文字) + `\\s+` + `.+` + `…`（ellipsis） |\n| `⏺ Bash(ls ../foo/.env 2>/dev/null && echo \"EXISTS\" || (cp …)` | `⏺`(スピナー文字) + テキスト + `…)` |\n\nこれらは**応答完了後のサマリー行**やClaude CLIの出力表示であり、実際のthinking状態ではない。\n\n### 発生メカニズム\n\n```\n1. Claude CLIが処理完了後にサマリー行を出力:\n   \"· Simmering… (4m 16s · ↓ 8.0k tokens · thought for 53s)\"\n2. 次のアクションとして \"Do you want to proceed?\" プロンプトを表示\n3. Auto-Yesポーラーが5000行バッファをキャプチャ\n4. detectThinking() がバッファ全体を検索 → 古いサマリー行にマッチ → true\n5. pollAutoYes() 行284-286: プロンプト検出を完全スキップ\n6. 2秒後に再ポーリング → 同じサマリー行がまだバッファにある → 再度スキップ\n7. サマリー行がスクロールアウトするまで永久にスキップが継続\n```\n\n### 問題の非対称性\n\n| 関数 | 検索範囲 | 備考 |\n|------|---------|------|\n| `detectThinking()` | バッファ全体（5000行） | 古い出力にもマッチ |\n| `detectPrompt()` | 末尾10〜50行のみ | 最新の状態のみ検索 |\n\nこの検索範囲の非対称性が問題の本質。\n\n## 検証済みの事実\n\n### 棄却した仮説\n\n- **`>` vs `❯` 問題**: 過去のサーバーログで`multipleChoice`プロンプトが正常に検出・応答されている実績があり、Claude CLIは`❯`（U+276F）を使用していることを確認済み\n- **`· · · Thinking`のthinkingマッチ**: `· · · Thinking`は末尾に`…`（ellipsis）がないため`CLAUDE_THINKING_PATTERN`にマッチしない（テスト検証済み）\n\n### 確認した事実\n\n- `CLAUDE_THINKING_PATTERN`は `[スピナー文字]\\s+.+…|to interrupt)` のパターン\n- `· Simmering…`（応答完了サマリー行）はこのパターンにマッチする（テスト検証済み）\n- `⏺ Bash(...…)`形式のClaude CLI出力もマッチする（テスト検証済み）\n- 実際のtmuxバッファ（5000行）をキャプチャしたところ、複数のマッチ行が存在することを確認\n\n## 修正方針の候補\n\n### 案1: detectThinking()の検索範囲を末尾N行に限定（推奨）\n\n`detectPrompt()`と同様に、バッファ末尾の限定的な範囲のみを検索対象とする。\n\n```typescript\n// Before: バッファ全体を検索\nif (detectThinking(cliToolId, cleanOutput)) {\n\n// After: 末尾N行のみを検索\nconst recentLines = cleanOutput.split('\\n').slice(-20).join('\\n');\nif (detectThinking(cliToolId, recentLines)) {\n```\n\n### 案2: thinking検出よりプロンプト検出を優先\n\nthinking状態であっても、プロンプトが検出された場合はプロンプト検出を優先する。\n\n```typescript\n// Before: thinking → スキップ\nif (detectThinking(cliToolId, cleanOutput)) {\n  scheduleNextPoll(worktreeId, cliToolId);\n  return;\n}\n\n// After: プロンプトを先にチェック、またはthinkingでもプロンプト検出を実行\nconst promptDetection = detectPrompt(cleanOutput);\nif (promptDetection.isPrompt) {\n  // プロンプト検出を優先（thinking中でもプロンプトが表示されている場合は応答）\n}\n```\n\n### 案3: 応答完了サマリー行をthinkingパターンから除外\n\n`detectThinking()`内で応答完了を示すサマリー行（`Brewed for`、`Simmered for`等を含む行）を除外する。\n\n## 影響ファイル\n\n| ファイル | 行 | 変更内容 |\n|---------|-----|---------|\n| `src/lib/auto-yes-manager.ts` | 281-287 | thinking検出ロジックの修正 |\n| `src/lib/cli-patterns.ts` | 73-95 | `detectThinking()`の検索範囲またはパターン修正 |\n\n## 受け入れ条件\n\n- [ ] バッファに過去のthinkingサマリー行が残存していても、プロンプトが正常に検出される\n- [ ] 実際のthinking状態（Claude CLIが処理中）ではプロンプト検出がスキップされる（Issue #161の防御は維持）\n- [ ] 既存のAuto-Yesテストがすべてパスする\n- [ ] `npm run test:unit` が通ること\n- [ ] `npm run lint` と `npx tsc --noEmit` が通ること\n\n## 関連\n\n- Issue #161: Auto-Yes誤検出修正（番号付きリストの誤検出防止）— `detectThinking()`のLayer 1防御を導入\n- Issue #138: サーバー側Auto-Yesポーリング\n- Issue #153: Auto-Yes UIとバックグラウンドの状態不整合修正\n\n## スクリーンショット\n\n![Auto-Yes未応答](workspace/スクリーンショット 2026-02-08 1.07.22.png)","title":"fix: Auto-Yes が古いthinkingサマリー行によりプロンプト検出をスキップする"}
