{"body":"## 概要\n長いメッセージ（特に改行を含む複数行テキスト）を送信した場合、Claude CLI側で「[Pasted text #1 +XX lines]」と表示され、処理が開始されない。\n\n## 再現手順\n1. CommandMateを起動\n2. Worktreeを選択\n3. 以下のような複数行のメッセージを送信：\n```\n引き続き下記コンソールエラーが出力されています。\n---\nuse-websocket.js:42 WebSocket connection to 'ws://localhost:3004/_next/webpack-hmr' failed: Invalid frame header\neval\t@\tuse-websocket.js:42\ncommitHookEffectListMount\t@\treact-dom.development.js:21102\n（以下省略... 約46行）\n```\n\n## 期待される動作\n- メッセージがClaude CLIに送信され、処理が開始される\n\n## 実際の動作\n- メッセージ送信後、Claude CLI画面に「[Pasted text #1 +46 lines]」と表示されるのみ\n- Claude側で処理が開始されない（プロンプト入力待ち状態のまま）\n\n![Image](https://github.com/user-attachments/assets/4c60274c-17f8-4e92-a584-76da8ea365d5)\n\n---\n\n## 原因分析\n\n### 根本原因\nClaude CLIは、**tmux経由で複数行の改行を含むテキストを受け取る際に、その全体を「ペースト操作」として認識し、内容を自動的に折りたたむ挙動**を持っている。\n\n### 発生条件\n- **複数行を含むメッセージ**: 改行（`\\n`）を含むテキスト\n- **tmux send-keys経由での送信**: 単一の文字列に複数の改行を含む場合\n\n### CommandMateの現在の実装\n\n**Claude CLI** (`src/lib/claude-session.ts` - `sendMessageToClaude()`):\n```typescript\n// Send message using sendKeys consistently\nawait sendKeys(sessionName, message, false);  // メッセージを Enter なしで送信\nawait sendKeys(sessionName, '', true);        // Enter キーを別途送信\n```\n\n**Codex CLI** (`src/lib/cli-tools/codex.ts` - `sendMessage()`):\n```typescript\n// Send message to Codex (without Enter)\nawait sendKeys(sessionName, message, false);\n// Send Enter key separately\nawait execAsync(`tmux send-keys -t \"${sessionName}\" C-m`);\n```\n\n**共通tmux関数** (`src/lib/tmux.ts` - `sendKeys()`):\n```typescript\nexport async function sendKeys(\n  sessionName: string,\n  keys: string,\n  sendEnter: boolean = true\n): Promise<void> {\n  const escapedKeys = keys.replace(/'/g, \"'\\\\''\");\n  const command = sendEnter\n    ? `tmux send-keys -t \"${sessionName}\" '${escapedKeys}' C-m`\n    : `tmux send-keys -t \"${sessionName}\" '${escapedKeys}'`;\n  await execAsync(command, { timeout: DEFAULT_TIMEOUT });\n}\n```\n\n**問題点**:\n- 複数行メッセージを単一の`send-keys`コマンドで送信\n- Claude CLIがこれを「ペースト操作」として認識\n- ペースト操作の場合、追加の確認（Enterキー）を待っている可能性\n- **Codex CLIも同じ`sendKeys()`を使用しており、同様の問題が発生する可能性あり**\n\n### Claude Code側の挙動\n[anthropics/claude-code #3412](https://github.com/anthropics/claude-code/issues/3412)によると:\n- ペーストされたテキストは`[Pasted text #N +XX lines]`として自動折りたたみ\n- セキュリティ機構の一部（大量テキストの一括実行防止）\n- 現在、展開・確認する方法がない制限あり\n\n---\n\n## 解決策の提案\n\n### 方式1: load-buffer/paste-buffer への移行（推奨）\n\n**tmuxレベルの操作**であり、CLIツールに依存しないため、**Claude/Codex/Gemini全てに対応可能**。\n\n```\n┌─────────────────────────────────────────────────────────┐\n│ CommandMate                                             │\n│   └─ tmux load-buffer/paste-buffer                      │\n│         └─ tmux session                                 │\n│               ├─ Claude CLI  ← 同じ方式で送信可能       │\n│               ├─ Codex CLI   ← 同じ方式で送信可能       │\n│               └─ Gemini CLI  ← 同じ方式で送信可能       │\n└─────────────────────────────────────────────────────────┘\n```\n\n**実装案** (`src/lib/tmux.ts`に共通関数を追加):\n```typescript\n/**\n * 複数行テキストをバッファ経由で送信（ペースト検出回避）\n */\nexport async function sendTextViaBuffer(\n  sessionName: string,\n  text: string,\n  sendEnter: boolean = true\n): Promise<void> {\n  const bufferName = `cm-${sessionName}`;\n  \n  // 1. テキストをバッファにロード\n  await execAsync(`printf '%s' \"${escapedText}\" | tmux load-buffer -b ${bufferName} -`);\n  \n  // 2. バッファをペースト（-p: 末尾改行なし）\n  await execAsync(`tmux paste-buffer -t \"${sessionName}\" -b ${bufferName} -p`);\n  \n  // 3. バッファ削除（クリーンアップ）\n  await execAsync(`tmux delete-buffer -b ${bufferName}`);\n  \n  // 4. 必要ならEnterキー送信\n  if (sendEnter) {\n    await execAsync(`tmux send-keys -t \"${sessionName}\" C-m`);\n  }\n}\n```\n\n**メリット**:\n- 複数行テキストの送信に最適化\n- 改行を含むテキストでも安定した送信が可能\n- **全CLIツール（Claude/Codex/Gemini）で共通利用可能**\n\n**使用箇所**:\n- `src/lib/claude-session.ts` - `sendMessageToClaude()`\n- `src/lib/cli-tools/codex.ts` - `CodexTool.sendMessage()`\n- `src/lib/cli-tools/gemini.ts` - `GeminiTool.sendMessage()`\n\n### 方式2: 追加のEnterキー送信（暫定対応）\nペースト検出後に追加のEnterキーを送信：\n```typescript\nawait sendKeys(sessionName, message, false);\nawait sendKeys(sessionName, '', true);  // 1回目のEnter\n// ペースト確認用に追加のEnter\nawait new Promise(resolve => setTimeout(resolve, 100));\nawait sendKeys(sessionName, '', true);  // 2回目のEnter\n```\n\n### 方式3: メッセージ分割送信\n複数行メッセージを1行ずつ送信（パフォーマンス低下の懸念あり）\n\n---\n\n## 影響範囲\n- 複数行のエラーメッセージやログをCLIツールに送信する全てのユーザー\n- 特に開発者がスタックトレースやコード片を送信するケース\n- **Claude CLI / Codex CLI 両方に影響**\n\n## 関連ファイル\n| ファイル | 役割 |\n|----------|------|\n| `src/lib/tmux.ts` | 共通tmux操作（`sendKeys()` → `sendTextViaBuffer()`追加予定） |\n| `src/lib/claude-session.ts` | Claude CLI セッション管理 |\n| `src/lib/cli-tools/codex.ts` | Codex CLI セッション管理 |\n| `src/lib/cli-tools/gemini.ts` | Gemini CLI セッション管理 |\n\n## 参考資料\n- [Claude Code Issue #3412: Pasted text blocks](https://github.com/anthropics/claude-code/issues/3412)\n- [tmux Discussion #4098: paste-buffer改行問題](https://github.com/orgs/tmux/discussions/4098)\n- [tmux(1) man page](https://man7.org/linux/man-pages/man1/tmux.1.html)","title":"長いメッセージ（\"/\"が含まれる場合？）の場合、メッセージを送信してもclaude 側で処理が開始されない"}
