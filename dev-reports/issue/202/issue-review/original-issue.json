{"body":"## 概要\n\nUIでリポジトリを削除後、ビルド＆再起動すると削除したリポジトリが復活する。\n\n関連: #190（Sync All復活防止は対策済みだが、サーバー起動時の初期化処理が未対策）\n\n## 再現手順\n\n1. トップ画面でリポジトリを削除\n2. `npm run build && npm run start`（またはサーバー再起動）\n3. トップ画面に削除済みリポジトリが再表示される\n\n## 根本原因\n\n`server.ts` の `initializeWorktrees()` で、環境変数 `CM_ROOT_DIR` から取得したリポジトリパスを `filterExcludedPaths()` でフィルタリングせずに `scanMultipleRepositories()` → `syncWorktreesToDB()` に渡している。\n\n### API Sync との比較\n\n| 処理 | `filterExcludedPaths()` | 結果 |\n|------|------------------------|------|\n| API Sync All (`sync/route.ts`) | ✅ あり | 復活しない |\n| サーバー起動時 (`server.ts`) | ❌ **なし** | **復活する** |\n\n## 修正方針\n\n`server.ts` の `initializeWorktrees()` を `sync/route.ts` と同じロジックに修正：\n\n1. `ensureEnvRepositoriesRegistered(db, repositoryPaths)` を追加\n2. `filterExcludedPaths(db, repositoryPaths)` でフィルタリング\n3. フィルタ済みパスのみ `scanMultipleRepositories()` に渡す\n\n## 影響範囲\n\n| ファイル | 変更内容 |\n|---------|---------|\n| `server.ts` | `initializeWorktrees()` に除外フィルタリング追加 |\n\n## 受け入れ条件\n\n- [ ] サーバー再起動後、削除済みリポジトリが復活しないこと\n- [ ] API Sync All と同じ除外ロジックが適用されていること\n- [ ] 既存のテストがパスすること","title":"fix: サーバー再起動時に削除済みリポジトリが復活する"}
