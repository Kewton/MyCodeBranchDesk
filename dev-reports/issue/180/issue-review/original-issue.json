{"body":"## 問題概要\n\nモバイル表示時、CLIが実際にはidle状態（`❯`プロンプト表示）であるにも関わらず、UIが「running」（スピナー）や「waiting」（黄色）ステータスを表示する問題。\n\n## 再現手順\n\n1. モバイルデバイスでCommandMateにアクセス\n2. Claude CLIセッションを開始し、何らかの操作を行う\n3. CLIが`❯`プロンプトを表示している（idle/ready状態）にも関わらず、ヘッダーのステータスインジケーターがスピナーや黄色ドットを表示\n\n## 期待される動作\n\n- `❯`プロンプトが表示されている場合 → 緑ドット（ready）または灰色ドット（idle）\n- thinking中（`✻ Processing...`等）の場合 → 青スピナー（running）\n- yes/noプロンプト表示中の場合 → 黄色ドット（waiting）\n\n## 実際の動作\n\n- `❯`プロンプトが表示されていても、スピナー（running）や黄色（waiting）が表示される\n\n## 根本原因\n\n`/api/worktrees/route.ts`のステータス検出ロジックに欠陥がある：\n\n### 問題1: 過去のプロンプト誤検出\n- `detectPrompt()`が最後10-50行を検索\n- 過去の`(y/n)`や選択肢プロンプトがスクロールバックに残っていると、現在アクティブなプロンプトとして誤検出\n- 結果: `isWaitingForResponse = true`（誤り）\n\n### 問題2: 末尾検証の欠如\n- 検出されたパターンが出力の「末尾」にあるかを確認していない\n- `❯`入力プロンプトが出力の最後にあれば「ready」のはず\n\n### 問題3: thinking検出の範囲が広すぎる\n- `detectThinking()`が最後15行を検索\n- 過去の出力にスピナー文字（`✻`等）があると誤検出の可能性\n\n## 修正案\n\n```typescript\n// 現在のロジック（問題あり）\nconst promptDetection = detectPrompt(cleanOutput);\nif (promptDetection.isPrompt) {\n  isWaitingForResponse = true;\n} else {\n  const nonEmptyLines = cleanOutput.split('\\n').filter(line => line.trim() !== '');\n  const lastLines = nonEmptyLines.slice(-15).join('\\n');\n  if (detectThinking(cliToolId, lastLines)) {\n    isProcessing = true;\n  } else {\n    const hasInputPrompt = promptPattern.test(lastLines);\n    if (!hasInputPrompt) {\n      isProcessing = true;\n    }\n  }\n}\n\n// 改善案\n// 1. まず最後2-3行で入力プロンプト(❯)をチェック → ready\n// 2. 次に最後2-3行でインタラクティブプロンプトをチェック → waiting  \n// 3. 最後に最後2-3行でthinkingをチェック → running\n// 4. いずれにも該当しない場合のみ → processing\n```\n\n## 影響範囲\n\n- `src/app/api/worktrees/route.ts` - ステータス検出ロジック\n- `src/lib/prompt-detector.ts` - プロンプト検出関数\n\n## スクリーンショット\n\n調査時に確認した問題：\n- feature/161-worktree: `❯`プロンプト表示なのに青スピナー（running）\n- develop: `❯ Issue #177 を対応して`表示なのに黄色（waiting）\n\n## 関連\n\n- Issue #4 (CLIツールサポート)\n- Issue #31 (サイドバーUX改善)","title":"fix: モバイルステータス表示の不整合 - CLIがidle状態でもrunning/waitingと誤表示"}
