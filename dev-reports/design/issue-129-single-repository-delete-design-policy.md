# Issue #129: リポジトリが1つしか存在しない場合削除出来ない - 設計方針書

## 1. 概要

### 1.1 Issue概要
リポジトリを1つ追加して削除しようとしたが、トップページにリポジトリ名が表示されず削除できない。リポジトリが1つの場合、フィルタUI全体（削除ボタン含む）が非表示になるため、削除操作にアクセスできない。

### 1.2 根本原因
`WorktreeList.tsx`のリポジトリフィルタUIの表示条件が`repositories.length > 1`となっているため、リポジトリが1つだけの場合にフィルタUI全体が非表示になる。

### 1.3 修正方針
**案1を採用**: リポジトリフィルタUIの表示条件を`repositories.length > 0`に変更し、リポジトリが1つでも削除UIを表示する。

## 2. 設計原則

### 2.1 SOLID原則への準拠

| 原則 | 適用状況 |
|------|---------|
| SRP (単一責任) | WorktreeListコンポーネントはワークツリー一覧表示を担当。フィルタ表示条件の変更のみで責務は変わらない |
| OCP (開放閉鎖) | 条件式の変更のみで既存機能に影響しない |
| LSP (リスコフ置換) | N/A（継承関係なし） |
| ISP (インターフェース分離) | N/A（インターフェース変更なし） |
| DIP (依存性逆転) | N/A（依存関係変更なし） |

### 2.2 KISS原則
- 最小限の変更（1行の条件式変更）で問題を解決
- 新規コンポーネントや複雑なロジックの追加は不要

### 2.3 YAGNI原則
- 必要最小限の修正に留める
- 将来の拡張性を考慮した過剰な設計は行わない

### 2.4 DRY原則
- 既存のコード構造を維持
- 重複コードの発生なし

## 3. 技術設計

### 3.1 変更対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/components/worktree/WorktreeList.tsx` | リポジトリフィルタ表示条件を修正 |

### 3.2 コード変更箇所

> **注意**: 以下の行番号は参考情報です。コードの変更により行番号がずれる可能性があります。実装時は該当するコードパターンを検索して特定してください。

#### 3.2.1 リポジトリフィルタ表示条件（299行目付近）

**変更前**:
```tsx
{repositories.length > 1 && (
```

**変更後**:
```tsx
{repositories.length > 0 && (
```

#### 3.2.2 リポジトリヘッダー表示条件（451行目付近）

リポジトリヘッダーの表示条件は、フィルタUIとの一貫性を考慮して以下のように検討:

**現行**:
```tsx
{(repositories.length > 1 || !selectedRepository) && (
```

**検討事項**:
- リポジトリが1つの場合: `selectedRepository`が`null`ならヘッダー表示
- リポジトリが1つでフィルタで選択した場合: ヘッダーが非表示になる可能性

**結論**: 現行の条件を維持。ヘッダー表示は「複数リポジトリがある場合」または「フィルタ未選択時」に表示するという既存の設計意図を尊重する。

**UI整合性の補足（レビュー指摘S1対応）**:
- フィルタUIの表示条件（299行目）: `repositories.length > 0`（今回変更）
- ヘッダー表示条件（451行目）: `repositories.length > 1 || !selectedRepository`（現行維持）
- **想定動作**: リポジトリが1件でフィルタ選択した場合、フィルタUIは表示されるがヘッダーは非表示になる。これはUIの冗長性を避ける既存の設計意図であり、ユーザビリティに問題はない。手動テストケース#6で動作を確認する。

### 3.3 UI設計

#### 3.3.1 リポジトリが1つの場合の表示

修正後のUI構成:
```
┌─────────────────────────────────────────────────┐
│ [All (n)] [リポジトリ名 (n) x]                   │  ← フィルタUI表示
├─────────────────────────────────────────────────┤
│ リポジトリ名                               [n]   │  ← ヘッダー（条件付き）
├─────────────────────────────────────────────────┤
│ ワークツリーカード群                            │
└─────────────────────────────────────────────────┘
```

#### 3.3.2 UI整合性の考慮

- **一貫性優先**: リポジトリが1つでもAllボタンを含むフィルタUI全体を表示
- **理由**: フィルタとして機能しなくても、削除ボタンへのアクセス手段として必要

### 3.4 エッジケース

| ケース | 期待動作 |
|--------|---------|
| リポジトリ0件 | フィルタUI非表示（`> 0`の条件で自動的に非表示） |
| リポジトリ1件 | フィルタUI表示、削除ボタンアクセス可能 |
| リポジトリ複数 | フィルタUI表示（既存動作維持） |
| 最後の1件削除 | 削除後、リポジトリ0件となりフィルタUI非表示 |

## 4. テスト計画

### 4.1 手動テストケース

| # | テストケース | 期待結果 |
|---|-------------|---------|
| 1 | リポジトリを1つ登録 | フィルタUIが表示され、削除ボタンが見える |
| 2 | リポジトリ1つの状態で削除ボタンをクリック | 確認ダイアログが表示される |
| 3 | 確認ダイアログで削除を実行 | リポジトリが削除され、0件状態になる |
| 4 | リポジトリ0件の状態 | フィルタUIが非表示 |
| 5 | 複数リポジトリの状態でフィルタ操作 | 既存動作と同じ |
| 6 | リポジトリ1つの状態でフィルタボタンをクリック | フィルタUIは表示されたまま、リポジトリヘッダーは非表示（UIの冗長性回避）【S1対応】 |

### 4.2 将来的なテスト追加推奨

`WorktreeList`コンポーネントの単体テストが存在しないため、以下のテストケース追加を推奨:

- リポジトリが1つの場合にフィルタUIが表示されることのテスト
- リポジトリが0件の場合にフィルタUIが非表示になることのテスト
- 削除操作後のUI状態テスト

### 4.3 E2Eテスト追加推奨（Stage3レビュー S1対応）

現在のE2Eテスト（`tests/e2e/worktree-list.spec.ts`）にはリポジトリフィルタUIのテストケースが存在しない。今回の変更（`repositories.length > 1` から `> 0` への変更）によりUIの表示条件が変わるため、以下のE2Eテストの追加を推奨する:

| # | テストケース | 期待結果 |
|---|-------------|---------|
| E1 | リポジトリ1件時のフィルタUI表示確認 | フィルタUIが表示され、削除ボタンが見える |
| E2 | リポジトリ1件時の削除ボタン動作確認 | 削除ボタンクリックで確認ダイアログが表示される |

**優先度**: 中（今回の修正のブロッカーではないが、将来的なリグレッション検出のために推奨）

## 5. 影響範囲

### 5.1 影響ファイル

| ファイル | 影響度 | 説明 |
|---------|-------|------|
| `src/components/worktree/WorktreeList.tsx` | 低 | 条件式1行の変更 |

### 5.2 非影響ファイル

| ファイル | 理由 |
|---------|------|
| `src/app/api/repositories/route.ts` | API層は変更なし |
| `src/lib/api-client.ts` | クライアント層は変更なし |
| データベース層 | スキーマ変更なし |

### 5.3 副作用リスク

| リスク | 影響度 | 軽減策 |
|--------|-------|-------|
| フィルタUIの見た目変更 | 低 | 手動テストで確認 |
| Allボタンの冗長表示 | 低 | UI一貫性を優先 |

## 6. セキュリティ考慮

### 6.1 変更によるセキュリティ影響

- **なし**: UI表示条件の変更のみ
- 削除処理自体は既存のAPIを使用（パストラバーサル対策済み）
- 確認ダイアログによる誤操作防止は維持

### 6.2 既存のセキュリティ対策

Issue #69で実装済みの対策:
- `delete`入力による確認ダイアログ
- セッションクリーンアップのFacadeパターン
- 段階的エラーハンドリング

## 7. 受け入れ条件

- [ ] リポジトリが1つの場合でも削除UIにアクセスできる
- [ ] 最後の1つのリポジトリを削除できる
- [ ] 削除後にリポジトリ一覧が0件になった場合の表示が適切である
- [ ] 既存の複数リポジトリがある場合の動作に影響がない

## 8. 将来的な改善候補

以下はレビューで指摘されたNice to Have項目であり、将来的なリファクタリング候補として記録する。

### 8.1 削除機能のコンポーネント分離（N1）

- **対象**: `handleDeleteRepository`関数（216-261行目、約45行）
- **内容**: 確認ダイアログ表示、API呼び出し、状態更新を含む処理
- **推奨**: 将来的に削除ロジックが複雑化した場合、`useRepositoryDelete`カスタムフックへの抽出を検討
- **現状**: 現時点では許容範囲のため、対応不要

### 8.2 リポジトリ表示条件の定数化（N2）

- **対象**: `repositories.length > 0`、`repositories.length > 1`の条件
- **内容**: 条件が複数箇所に分散している
- **推奨**: `shouldShowFilterUI`、`shouldShowRepositoryHeader`などの名前付き変数に抽出すると意図が明確になる
- **現状**: 将来的なリファクタリング候補として記録

### 8.3 Issue #69設計書への補足追加（Stage3レビュー N1）

- **対象**: `dev-reports/design/issue-69-repository-delete-design-policy.md` 7章「UI設計」
- **内容**: リポジトリが1件の場合のフィルタUI表示仕様について明記されていない
- **推奨**: 「リポジトリが1件の場合でもフィルタUIを表示する（削除機能へのアクセス手段として）」旨の補足を追加
- **現状**: 対応任意。今回の変更後も既存設計書の記載内容との矛盾はない

### 8.4 アーキテクチャドキュメントへの影響（Stage3レビュー N2）

- **対象**: `docs/architecture.md`
- **評価結果**: 影響なし
- **理由**: アーキテクチャドキュメントはシステム全体のアーキテクチャを記述しており、UIコンポーネントの表示条件詳細は記載されていない。今回の変更はアーキテクチャレベルの変更ではないため、更新不要。

## 9. 関連ドキュメント

- Issue #129: https://github.com/Kewton/CommandMate/issues/129
- Issue #69 設計書: `dev-reports/design/issue-69-repository-delete-design-policy.md`

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2026-02-02 | 1.0 | 初版作成 |
| 2026-02-02 | 1.1 | Stage1レビュー指摘事項対応（S1: ヘッダー表示条件の明確化とテストケース追加、N1/N2: 将来改善候補として記録） |
| 2026-02-02 | 1.2 | Stage2レビュー指摘事項対応（N1: 行番号が参考情報である旨の注意書き追加） |
| 2026-02-02 | 1.3 | Stage3影響分析レビュー指摘事項対応（S1: E2Eテスト追加推奨を4.3項に追加、N1/N2: 将来改善候補として8.3/8.4項に記録） |
