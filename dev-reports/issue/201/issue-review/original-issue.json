{"body":"## 概要\n\nClaude CLI v2.x で初回アクセスのワークスペースに対して表示される「Quick safety check」ダイアログに、`startClaudeSession()` が自動応答する仕組みを追加する。\n\n## 事象\n\nCommandMateのUI上で新規ワークスペースのClaude Codeセッションを開始し、メッセージを送信すると以下のエラーが発生する：\n\n```\nFailed to send message to Claude Code: Prompt detection timeout (10000ms)\n```\n\n## 原因\n\nClaude CLIが初回アクセスのワークスペースで「信頼性確認ダイアログ」を表示し、ユーザーの応答待ちで停止する。tmux経由でClaude CLIを起動するCommandMateでは、この対話型ダイアログにユーザーが直接応答できない。\n\n```\n Quick safety check: Is this a project you created or one you trust?\n\n ❯ 1. Yes, I trust this folder\n   2. No, exit\n\n Enter to confirm · Esc to cancel\n```\n\n- `❯` が行頭ではなくスペース後に出現するため、`CLAUDE_PROMPT_PATTERN`（`/^[>❯]/m`）にマッチしない\n- `startClaudeSession()` がプロンプトを検出できずタイムアウト、または `sendMessageToClaude()` でタイムアウト\n\n## 対応方針\n\n**案A: startClaudeSession() でダイアログ検出時に自動で Enter 送信**\n\nCommandMateでセッション開始する時点で、ユーザーはUIでworktreeを明示的に選択しており、そのワークスペースを対象に作業する意図がある。デフォルトで「Yes, I trust this folder」が選択済みのため、Enter送信は安全。\n\n### 実装タスク\n\n1. `src/lib/cli-patterns.ts` に `CLAUDE_TRUST_DIALOG_PATTERN` を追加\n   ```typescript\n   export const CLAUDE_TRUST_DIALOG_PATTERN = /Yes, I trust this folder/m;\n   ```\n\n2. `src/lib/claude-session.ts` の `startClaudeSession()` 初期化ポーリングループ内にダイアログ検出・自動応答ロジックを追加\n   ```\n   capturePane → cleanOutput 取得\n   ├─ CLAUDE_PROMPT_PATTERN マッチ → 初期化完了（既存動作）\n   ├─ CLAUDE_TRUST_DIALOG_PATTERN マッチ → Enter送信 → ポーリング継続\n   └─ どちらにもマッチしない → 次のポーリングへ\n   ```\n\n3. `tests/unit/lib/claude-session.test.ts` にテスト追加\n   - 信頼性ダイアログ検出時にEnterが送信されること\n   - Enter送信後にプロンプト検出で初期化完了すること\n\n## 受入条件\n\n- [ ] 新規ワークスペースで信頼性確認ダイアログが表示された場合、自動でEnterが送信されること\n- [ ] 自動応答後にClaude CLIが正常にプロンプト状態になること\n- [ ] 自動応答時にコンソールログが出力されること\n- [ ] 既存のセッション初期化フロー（ダイアログなし）に回帰がないこと\n- [ ] `claude-session.test.ts` の全テストがパスすること\n\n## 技術要件\n\n### 変更ファイル\n- `src/lib/cli-patterns.ts` - `CLAUDE_TRUST_DIALOG_PATTERN` 追加\n- `src/lib/claude-session.ts` - `startClaudeSession()` ポーリングループ内にダイアログ検出・自動応答\n- `tests/unit/lib/claude-session.test.ts` - テスト追加\n\n### サイズ\nS（小）- 3ファイル、約20行の追加\n\n## 関連Issue\n- #187 セッション初回メッセージが送信されないケースが多発する（P1-1のセパレータパターン除外により顕在化）\n- #198 epic: CLI操作の信頼性改善バッチ","title":"fix: 新規ワークスペースの信頼性確認ダイアログを自動応答する"}
