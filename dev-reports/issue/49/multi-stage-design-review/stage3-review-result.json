{
  "stage": 3,
  "stage_name": "影響分析レビュー",
  "issue_number": 49,
  "review_date": "2026-01-30",
  "design_doc": "dev-reports/design/issue-49-markdown-editor-design-policy.md",
  "findings": {
    "must_fix": [
      {
        "id": "MF-001",
        "category": "Breaking Change Risk",
        "title": "既存route.tsのパス検証ロジック変更による互換性リスク",
        "description": "既存のroute.ts（34-39行目）では`normalizedPath.includes('..') || normalizedPath.startsWith('/')`による独自検証を行っているが、isPathSafe()への統一により、検証ロジックが変更される。isPathSafe()はURLデコード、null byte検出を追加で行うため、エッジケースで挙動が変わる可能性がある。",
        "affected_files": [
          "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/app/api/worktrees/[id]/files/[...path]/route.ts"
        ],
        "recommendation": "設計書Section 12.2で定義されているパス検証互換性テストを必ず実装し、既存の正当なリクエストが拒否されないことを確認すること。特にURLエンコードされたパス（例: `docs%2Freadme.md`）の挙動をテストすること。"
      }
    ],
    "should_fix": [
      {
        "id": "SF-001",
        "category": "Performance Impact",
        "title": "FileTreeView.tsxへの右クリックメニュー追加によるレンダリング影響",
        "description": "FileTreeView.tsx（465行）にContextMenuコンポーネントを統合することで、ツリーノードの再レンダリング時にコンテキストメニュー状態も更新される可能性がある。既存のメモ化（React.memo）との整合性を確認する必要がある。",
        "affected_files": [
          "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/components/worktree/FileTreeView.tsx"
        ],
        "recommendation": "ContextMenu.tsxとしてコンポーネント分離が設計済み（Stage 2 SF-003対応）だが、FileTreeViewからContextMenuへのprops渡しが最小限になるよう、コンテキストメニュー状態をカスタムフック（useContextMenu）として分離することを検討すること。"
      },
      {
        "id": "SF-002",
        "category": "Dependencies Impact",
        "title": "新規ディレクトリ・ファイル構造の影響",
        "description": "本設計では7つの新規ファイルと1つの新規ディレクトリ（src/components/common/）を作成する。特にsrc/components/common/はプロジェクトで初めて作成されるディレクトリであり、今後の共通コンポーネント配置の前例となる。",
        "affected_directories": [
          "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/components/common/",
          "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/config/",
          "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/lib/",
          "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/types/"
        ],
        "recommendation": "CLAUDE.mdのファイル構成セクションに`src/components/common/`ディレクトリの説明を追加し、将来の開発者が共通コンポーネントの配置場所を理解できるようにすること。"
      },
      {
        "id": "SF-003",
        "category": "Test Coverage Impact",
        "title": "テストファイル追加による継続的インテグレーション時間への影響",
        "description": "設計書では複数のテストファイル追加を計画している（api-file-operations.test.ts, MarkdownEditor.test.tsx, utils.test.ts, path-validation-compatibility.test.ts）。これによりCI/CDパイプラインの実行時間が増加する可能性がある。",
        "affected_files": [
          "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/tests/integration/",
          "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/tests/unit/"
        ],
        "recommendation": "テスト実行時間を計測し、必要に応じてテストの並列化や分割を検討すること。特にE2Eテスト（Phase 5）はPlaywrightで実行されるため、独立したジョブとして分離することを推奨。"
      },
      {
        "id": "SF-004",
        "category": "Module Coupling",
        "title": "WorktreeDetailRefactored.tsxへの変更による既存機能への波及",
        "description": "WorktreeDetailRefactored.tsx（1311行）のhandleFileSelect関数（L895-897）を変更してMarkdownEditor表示を追加する。この変更により、FileViewerモーダルの表示ロジックとの競合が発生する可能性がある。",
        "affected_files": [
          "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/components/worktree/WorktreeDetailRefactored.tsx",
          "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/components/worktree/FileViewer.tsx"
        ],
        "recommendation": "mdファイル選択時はFileViewerの代わりにMarkdownEditorを表示するように、handleFileSelect関数内で拡張子判定を行い、fileViewerPath状態とは別にeditorFilePath状態を追加することを検討すること。"
      }
    ],
    "nice_to_have": [
      {
        "id": "NTH-001",
        "category": "Future Extensibility",
        "title": "編集可能拡張子の将来的な拡張への影響",
        "description": "src/config/editable-extensions.tsに編集可能拡張子を外部化する設計だが、将来的にtxt, json, yaml等を追加する際のバリデーションルール拡張方法が明確でない。",
        "recommendation": "ExtensionValidator interfaceが定義されているが、実際に使用されていない。将来の拡張時にバリデーションロジックを追加しやすいよう、validateContent(extension, content)のような関数を準備しておくことを検討。"
      },
      {
        "id": "NTH-002",
        "category": "Documentation",
        "title": "APIドキュメントの更新必要性",
        "description": "PUT/POST/DELETE/PATCHエンドポイントの追加により、既存のGETエンドポイントのみを記載しているドキュメント（存在する場合）が古くなる。",
        "recommendation": "OpenAPI/Swagger形式でAPIドキュメントを生成する仕組みの導入を将来的に検討すること。"
      },
      {
        "id": "NTH-003",
        "category": "User Experience",
        "title": "モバイルレイアウトでのMarkdownEditor表示方法",
        "description": "設計書ではデスクトップレイアウトでのMarkdownEditor表示は明確だが、モバイルレイアウト（MobileContent）での表示方法が明示されていない。WorktreeDetailRefactored.tsxのMobileContentコンポーネントへの影響を考慮する必要がある。",
        "recommendation": "モバイル環境ではMarkdownEditorをフルスクリーンモーダルとして表示するか、既存のFileViewerと同様のモーダル表示にするかを明確にすること。"
      }
    ]
  },
  "impact_analysis": {
    "affected_files": [
      {
        "path": "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/app/api/worktrees/[id]/files/[...path]/route.ts",
        "type": "major_modification",
        "current_lines": 95,
        "estimated_lines": 150,
        "change_description": "PUT/POST/DELETE/PATCHメソッド追加、パス検証統一、file-operations.tsへの委譲",
        "risk_level": "high"
      },
      {
        "path": "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/components/worktree/FileTreeView.tsx",
        "type": "major_modification",
        "current_lines": 465,
        "estimated_lines": 520,
        "change_description": "右クリックメニュー統合、ContextMenu.tsxへの分離",
        "risk_level": "medium"
      },
      {
        "path": "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/components/worktree/WorktreeDetailRefactored.tsx",
        "type": "minor_modification",
        "current_lines": 1311,
        "estimated_lines": 1340,
        "change_description": "handleFileSelectにmd拡張子判定追加、MarkdownEditorコンポーネント統合",
        "risk_level": "low"
      },
      {
        "path": "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/lib/file-tree.ts",
        "type": "minor_modification",
        "current_lines": 296,
        "estimated_lines": 340,
        "change_description": "書き込み/削除関数追加",
        "risk_level": "low"
      },
      {
        "path": "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/lib/path-validator.ts",
        "type": "no_change",
        "current_lines": 118,
        "change_description": "既存関数を再利用（変更なし）",
        "risk_level": "none"
      },
      {
        "path": "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/components/worktree/MessageList.tsx",
        "type": "no_change",
        "current_lines": 654,
        "change_description": "react-markdownの使用パターンを参照（変更なし）",
        "risk_level": "none"
      }
    ],
    "new_files": [
      {
        "path": "src/components/worktree/MarkdownEditor.tsx",
        "estimated_lines": 300,
        "description": "マークダウンエディタ本体"
      },
      {
        "path": "src/components/worktree/ContextMenu.tsx",
        "estimated_lines": 100,
        "description": "右クリックメニューコンポーネント"
      },
      {
        "path": "src/components/common/Toast.tsx",
        "estimated_lines": 80,
        "description": "トースト通知コンポーネント"
      },
      {
        "path": "src/types/markdown-editor.ts",
        "estimated_lines": 50,
        "description": "マークダウンエディタ型定義"
      },
      {
        "path": "src/lib/file-operations.ts",
        "estimated_lines": 150,
        "description": "ファイル操作ビジネスロジック"
      },
      {
        "path": "src/lib/utils.ts",
        "estimated_lines": 30,
        "description": "debounce等ユーティリティ関数"
      },
      {
        "path": "src/config/editable-extensions.ts",
        "estimated_lines": 30,
        "description": "編集可能拡張子設定"
      }
    ],
    "new_directories": [
      {
        "path": "src/components/common/",
        "description": "再利用可能な共通UIコンポーネントの配置場所"
      }
    ],
    "breaking_changes": [
      {
        "id": "BC-001",
        "type": "API",
        "description": "route.tsのパス検証ロジックがisPathSafe()に統一されることで、URLエンコードされたパスの処理が変更される可能性がある",
        "mitigation": "互換性テストで既存動作を確認",
        "severity": "low"
      }
    ],
    "performance_impact": {
      "bundle_size": {
        "change": "minimal",
        "reason": "react-markdown, remark-gfm, rehype-highlightは既存依存として存在（package.json確認済み）。新規依存の追加なし。",
        "estimated_increase_kb": 0
      },
      "runtime": {
        "concern": "プレビューのデバウンス処理によるレンダリング遅延",
        "mitigation": "300msのデバウンス設定で入力遅延を最小化",
        "risk_level": "low"
      },
      "api_latency": {
        "concern": "ファイル操作（PUT/POST/DELETE/PATCH）追加による追加のファイルシステムI/O",
        "mitigation": "非同期処理とエラーハンドリングの適切な実装",
        "risk_level": "low"
      }
    },
    "risk_assessment": {
      "overall_risk": "medium",
      "risk_factors": [
        {
          "factor": "route.tsの大幅変更",
          "risk": "high",
          "mitigation": "file-operations.tsへのビジネスロジック分離により、route.tsは薄いController層として維持"
        },
        {
          "factor": "FileTreeView.tsxの拡張",
          "risk": "medium",
          "mitigation": "ContextMenu.tsxへの分離により、既存コードへの影響を最小化"
        },
        {
          "factor": "新規ディレクトリ構造",
          "risk": "low",
          "mitigation": "common/ディレクトリは将来の拡張性を考慮した設計"
        },
        {
          "factor": "セキュリティ（パストラバーサル）",
          "risk": "medium",
          "mitigation": "既存のisPathSafe()を一貫して使用、互換性テストで確認"
        }
      ],
      "confidence_level": "high",
      "review_completeness": "設計書は詳細で、Stage 1・Stage 2のレビュー指摘が反映されている"
    }
  },
  "dependency_analysis": {
    "existing_dependencies_used": [
      {
        "package": "react-markdown",
        "version": "^10.1.0",
        "usage": "マークダウンプレビューレンダリング（MessageList.tsxで実績あり）"
      },
      {
        "package": "remark-gfm",
        "version": "^4.0.1",
        "usage": "GitHub Flavored Markdownサポート"
      },
      {
        "package": "rehype-highlight",
        "version": "^7.0.2",
        "usage": "コードブロックのシンタックスハイライト"
      },
      {
        "package": "lucide-react",
        "version": "^0.554.0",
        "usage": "アイコン（既存依存）"
      }
    ],
    "new_dependencies_required": [],
    "dependency_conflicts": []
  },
  "test_impact": {
    "new_test_files": [
      "tests/integration/api-file-operations.test.ts",
      "tests/integration/path-validation-compatibility.test.ts",
      "tests/unit/components/MarkdownEditor.test.tsx",
      "tests/unit/lib/utils.test.ts"
    ],
    "modified_test_files": [],
    "test_coverage_goal": {
      "api": "90%",
      "components": "80%",
      "e2e": "main flows"
    }
  },
  "summary": "Issue #49のマークダウンエディタ設計は、影響範囲が明確に定義されており、適切なリスク軽減策が講じられています。主な影響は(1)route.tsのAPIエンドポイント拡張、(2)FileTreeView.tsxへの右クリックメニュー追加、(3)WorktreeDetailRefactored.tsxへのエディタ統合です。最大のリスクはパス検証ロジックの統一による互換性問題ですが、設計書で定義された互換性テストにより軽減可能です。新規依存の追加がなく、既存のreact-markdown等を再利用する点はバンドルサイズへの影響を最小化しています。5フェーズの段階的実装計画により、各段階でのリスク評価が可能です。",
  "recommendations": [
    "【必須】パス検証互換性テスト（path-validation-compatibility.test.ts）を優先的に実装し、既存動作との互換性を確認すること",
    "【推奨】Phase 1（API拡張）完了後に統合テストを実行し、既存機能への影響がないことを確認すること",
    "【推奨】ContextMenu.tsxの状態管理をカスタムフックとして分離し、FileTreeViewへの影響を最小化すること",
    "【推奨】WorktreeDetailRefactored.tsxの変更はfileViewerPath状態とは別にeditorFilePath状態を追加して管理すること",
    "【検討】CLAUDE.mdにsrc/components/common/ディレクトリの説明を追加すること",
    "【検討】モバイルレイアウトでのMarkdownEditor表示方法を明確化すること"
  ]
}
