{
  "issue_number": 314,
  "title": "feat: Auto-Yesにターミナル出力のStop条件（正規表現）を追加",
  "acceptance_criteria": [
    "Auto-Yes確認ダイアログにStop条件入力フィールドが表示される",
    "Stop条件が空の場合は従来通りの動作（時間ベースのみで停止）",
    "Stop条件に正規表現を入力でき、ターミナル出力がマッチした場合にAuto-Yesが自動停止する",
    "Auto-Yesが停止した際にユーザーに通知される（stopReasonフィールドによるトースト通知。停止理由が「Stop条件マッチ」であることを明示。トースト重複表示防止済み）",
    "不正な正規表現パターン入力時にバリデーションエラーが表示される（クライアント: インラインエラー+ボタン無効化、サーバー: 400レスポンス）",
    "正規表現のReDoS対策が施されている（safe-regex2ライブラリ + MAX_STOP_PATTERN_LENGTHによる最大長制限 + executeRegexWithTimeoutによる100msタイムアウト保護）",
    "既存のAuto-Yes機能（時間ベース停止、プロンプト自動応答）に影響しない",
    "既存テストがすべてパスする（AutoYesConfirmDialog/AutoYesToggleの既存テストはonConfirm/onToggleシグネチャ変更に合わせて修正済み）"
  ],
  "implementation_tasks": [
    "Task 1.1: npm install safe-regex2 でパッケージ追加",
    "Task 1.2: src/config/auto-yes-config.ts にMAX_STOP_PATTERN_LENGTH=500とvalidateStopPattern()を追加（safe-regex2使用、エラーメッセージは固定文字列のみ）",
    "Task 1.3: src/lib/auto-yes-manager.ts のAutoYesStateインターフェースにstopPattern?: stringとstopReason?: 'expired' | 'stop_pattern_matched'を追加",
    "Task 1.4: src/lib/auto-yes-manager.ts にdisableAutoYes(worktreeId: string, reason?: 'expired' | 'stop_pattern_matched'): AutoYesState 関数を新規追加（全フィールドを明示的に設定）",
    "Task 1.5: src/lib/auto-yes-manager.ts のsetAutoYesEnabled()をenableパスにstopPattern引数追加、disableパスをdisableAutoYes()に委譲",
    "Task 1.6: src/lib/auto-yes-manager.ts のgetAutoYesState()期限切れ処理をdisableAutoYes(id, 'expired')に委譲",
    "Task 1.7: src/lib/auto-yes-manager.ts にexecuteRegexWithTimeout(regex, text, timeoutMs): boolean | null を追加（vm.runInNewContextで100msタイムアウト保護）",
    "Task 1.8: src/lib/auto-yes-manager.ts にcheckStopCondition(worktreeId: string, cleanOutput: string): boolean を追加（@internal export）",
    "Task 1.9: src/lib/auto-yes-manager.ts のpollAutoYes()にcheckStopCondition()をthinking check後、プロンプト検出前に挿入",
    "Task 2.1: src/app/api/worktrees/[id]/auto-yes/route.ts にstopPattern受け渡し・サーバーサイドバリデーション追加（duration検証直後に挿入）",
    "Task 2.2: src/app/api/worktrees/[id]/current-output/route.ts にisValidWorktreeId()チェック追加、stopReason返却追加",
    "Task 3.1: src/components/worktree/AutoYesConfirmDialog.tsx にstopPattern入力フィールド追加（アトミック実装: Task 3.1+3.2+3.3は同時コミット）",
    "Task 3.2: src/components/worktree/AutoYesToggle.tsx にAutoYesToggleParamsインターフェース追加、onToggleをオブジェクト引数パターンに変更",
    "Task 3.3: src/components/worktree/WorktreeDetailRefactored.tsx のCurrentOutputResponse型にstopReason追加、handleAutoYesToggleシグネチャ変更、トースト通知ロジック追加",
    "Task 4.1: locales/ja/autoYes.json と locales/en/autoYes.json に6翻訳キー追加",
    "Task 5.1: tests/unit/config/auto-yes-config.test.ts にvalidateStopPattern()テスト追加（ReDoSパターン含む）",
    "Task 5.2: tests/unit/lib/auto-yes-manager.test.ts にdisableAutoYes/checkStopCondition/executeRegexWithTimeoutテスト追加（12-15個）",
    "Task 5.3: tests/unit/components/worktree/AutoYesConfirmDialog.test.tsx にstopPattern関連テスト追加、既存テスト維持",
    "Task 5.4: tests/unit/components/worktree/AutoYesToggle.test.tsx の破壊的変更対応（L17/L45/L59/L81のシグネチャ変更）と新規テスト追加"
  ],
  "key_files": {
    "config": "src/config/auto-yes-config.ts",
    "manager": "src/lib/auto-yes-manager.ts",
    "auto_yes_route": "src/app/api/worktrees/[id]/auto-yes/route.ts",
    "current_output_route": "src/app/api/worktrees/[id]/current-output/route.ts",
    "confirm_dialog": "src/components/worktree/AutoYesConfirmDialog.tsx",
    "toggle": "src/components/worktree/AutoYesToggle.tsx",
    "worktree_detail": "src/components/worktree/WorktreeDetailRefactored.tsx",
    "i18n_ja": "locales/ja/autoYes.json",
    "i18n_en": "locales/en/autoYes.json",
    "design_policy": "dev-reports/design/issue-314-auto-yes-stop-condition-design-policy.md",
    "work_plan": "dev-reports/issue/314/work-plan.md"
  },
  "critical_security_requirements": {
    "redos_protection": "safe-regex2ライブラリでカタストロフィックバックトラッキングパターンを拒否",
    "timeout_protection": "executeRegexWithTimeout()でregex.test()実行を100msでタイムアウト",
    "xss_prevention": "validateStopPattern()はerror.messageを返却しない（固定文字列のみ）",
    "input_validation": "worktreeIdはisValidWorktreeId()でフォーマット検証",
    "structured_logging": "console.warn('[Auto-Yes] message', { worktreeId })形式を使用"
  },
  "atomic_implementation_groups": {
    "group_a": ["Task 3.1", "Task 3.2", "Task 3.3"],
    "note": "AutoYesConfirmDialog.onConfirmとAutoYesToggle.handleConfirmは同時変更が必要"
  },
  "target_coverage": 80,
  "implementation_order": [
    "Task 1.1 (safe-regex2)",
    "Task 1.2 (auto-yes-config.ts)",
    "Task 1.3-1.9 (auto-yes-manager.ts)",
    "Task 2.1-2.2 (API routes)",
    "Task 4.1 (i18n)",
    "Task 3.1-3.3 (UI components - atomic)",
    "Task 5.1-5.4 (tests)"
  ]
}
