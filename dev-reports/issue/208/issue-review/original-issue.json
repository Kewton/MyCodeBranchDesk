{"body":"## 概要\n\nAuto-Yesモード有効時、Claude CLIの通常出力（サブエージェント完了後等）に含まれる番号付きリスト（例：「1. ファイルを作成」「2. テストを実行」）が `multiple_choice` プロンプトとして誤検出され、\"1\"が定期的に自動送信される。\n\n## 再現手順\n\n1. CommandMateでClaude CLIセッションを開始\n2. Auto-Yesモードを有効化\n3. `multi-stage-issue-review` 等のサブエージェントを含むタスクを実行\n4. サブエージェント完了後、tmuxバッファに番号付きリストが残る\n5. サーバー側ポーリング（2秒間隔）が番号付きリストをプロンプトとして誤検出\n6. \"1\"がtmuxに自動送信される\n\n## 期待される動作\n\n通常出力の番号付きリストはプロンプトとして検出されず、Auto-Yesの自動応答は発生しない。\n\n## 実際の動作\n\n番号付きリストが `multiple_choice` プロンプトとして誤検出され、\"1\"が自動送信される。\n\n## 根本原因分析\n\n### 発生メカニズム\n\n```\npollAutoYes() [auto-yes-manager.ts:273]\n  │\n  ├─ 1. captureSessionOutput() → tmuxバッファ取得\n  │     サブエージェント完了後の出力に番号付きリストを含む\n  │\n  ├─ 2. detectThinking() → false（thinking状態でないため通過）\n  │\n  ├─ 3. detectPrompt(cleanOutput, { requireDefaultIndicator: false })\n  │     │\n  │     └─ detectMultipleChoicePrompt()\n  │         ├─ Pass 1: requireDefault=false → 完全スキップ\n  │         ├─ Pass 2: 番号付きリストを選択肢として収集\n  │         ├─ Layer 3: 連番検証 → 通過（通常リストも連番）\n  │         ├─ Layer 4: 2+選択肢チェック → 通過\n  │         └─ Layer 5: question行チェック → 通過（リスト上部にテキスト行あり）\n  │\n  ├─ 4. resolveAutoAnswer() → \"1\"（最初の選択肢番号）\n  │\n  └─ 5. sendKeys(\"1\") → tmuxに\"1\"を誤送信\n```\n\n### 核心的問題\n\n`cli-patterns.ts:207-209` の `buildDetectPromptOptions('claude')` が `{ requireDefaultIndicator: false }` を返す。\n\nこれにより `prompt-detector.ts` の2パス検出方式（Issue #161）における **Pass 1（❯インジケーター存在チェック）が完全にスキップ** され、番号付きリストを含むあらゆる通常出力が `multiple_choice` プロンプトとして誤検出される。\n\n### 各防御層の分析\n\n| 層 | 防御機能 | この場合の効果 | 理由 |\n|---|---|---|---|\n| **Layer 1** | thinking検出 | 無効 | サブエージェント完了後はthinking状態でない |\n| **Pass 1** (Layer 2) | ❯インジケーター存在チェック | **完全スキップ** | `requireDefaultIndicator: false`で無効化 |\n| **Layer 3** | 連番検証 | 無効 | 通常の番号付きリストも1始まり連番 |\n| **Layer 4** | 選択肢数+❯チェック | 無効 | `requireDefault=false`で❯不要 |\n| **Layer 5** | question行存在チェック | 無効 | 番号リスト上部にテキスト行が存在する |\n\n### 背景\n\n- Issue #193でClaude Codeの選択肢プロンプト（❯なし形式）に対応するため `requireDefaultIndicator: false` が導入された\n- しかし、この設定により Issue #161 の主要防御（Pass 1ゲート）が無効化され、通常の番号付きリストとプロンプトの区別ができなくなった\n\n## 影響範囲\n\n- **影響を受けるCLIツール**: `claude` のみ（`codex`/`gemini` は `requireDefault=true` で正常）\n- **発生条件**: Auto-Yesモード有効 + Claude CLIが番号付きリストを含む出力を生成\n- **特に発生しやすいシーン**: サブエージェント完了直後、タスクリスト表示、ステップ説明\n\n## 関連コード\n\n| ファイル | 行 | 内容 |\n|---------|-----|------|\n| `src/lib/cli-patterns.ts` | 207-209 | `requireDefaultIndicator: false`を返す |\n| `src/lib/prompt-detector.ts` | 313-329 | Pass 1ゲートが`requireDefault`でスキップ |\n| `src/lib/prompt-detector.ts` | 338-373 | Pass 2で無条件に番号パターン収集 |\n| `src/lib/auto-yes-manager.ts` | 317-318 | `buildDetectPromptOptions`経由でオプション取得 |\n| `src/lib/auto-yes-resolver.ts` | 23-36 | `multiple_choice`に対して\"1\"を返す |\n\n## 関連Issue\n\n- Issue #161: Auto-Yes誤検出修正（番号付きリストの誤検出防止）- 2パス検出方式の導入元\n- Issue #193: Claude Codeからの複数選択肢に対し、回答を送信出来ない - `requireDefaultIndicator: false` の導入元\n- Issue #138: サーバー側Auto-Yesポーリング\n- Issue #198: epic: CLI操作の信頼性改善バッチ（親Issue）\n\n## 優先度\n\nP1 - Auto-Yes使用時にCLI操作を妨害するが、Auto-Yesを無効にすれば回避可能","title":"Auto-Yes: Claude CLIで番号付きリストがmultiple_choiceプロンプトとして誤検出され「1」が自動送信される"}
