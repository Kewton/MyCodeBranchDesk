{
  "issue_number": 212,
  "acceptance_criteria": [
    "3-10行の複数行メッセージが正常に送信・処理されること",
    "50行以上の複数行メッセージが正常に送信・処理されること",
    "単一行メッセージの既存動作に影響がないこと",
    "[Pasted text] 検知時にEnterが自動送信されること",
    "特殊文字を含むメッセージが正しく処理されること",
    "PASTED_TEXT_PATTERN のユニットテストが存在し、既知のClaude CLI出力フォーマットに対して正しく検知すること",
    "Pasted text検知後のEnter再送がリトライ上限（MAX_PASTED_TEXT_RETRIES=3）回に達しても解消しない場合、警告ログが出力されること",
    "codex.ts の sendMessage() に対してもPasted text検知ロジックが適用されていること（sendKeysパス・execAsyncパス両方）",
    "codex.ts の sendMessage() において、検知の capturePane() 呼び出しが execAsync(C-m) によるEnter送信後に行われることがテストで検証されていること",
    "[Pasted text #N +XX lines] の表示がレスポンスメッセージに含まれないこと（cleanClaudeResponse + extractResponse 両方で除外）",
    "codex.test.ts に sendMessage() のモックベースのユニットテスト基盤が構築されていること",
    "既存の統合テスト（api-send-cli-tool.test.ts）がPasted text検知ロジック追加後も正常にパスすること",
    "単体テストカバレッジ80%以上"
  ],
  "implementation_tasks": [
    "cli-patterns.ts: PASTED_TEXT_PATTERN定数追加、getCliToolPatterns('claude')のskipPatternsに追加",
    "pasted-text-helper.ts: detectAndResendIfPastedText()共通ヘルパー新規作成",
    "claude-session.ts: message.includes('\\n')ガード条件追加、detectAndResendIfPastedText()呼び出し追加",
    "codex.ts: import追加、message.includes('\\n')ガード条件追加、detectAndResendIfPastedText()呼び出し追加",
    "response-poller.ts: cleanClaudeResponse()のskipPatternsにPASTED_TEXT_PATTERN追加",
    "cli-patterns.test.ts: PASTED_TEXT_PATTERNのユニットテスト追加、getCliToolPatterns('claude')のskipPatterns検証テスト追加",
    "pasted-text-helper.test.ts: 新規作成、detectAndResendIfPastedText()の5つのテストケース実装",
    "claude-session.test.ts: 単一行メッセージ時のスキップテスト、複数行メッセージ時の呼び出しテスト追加",
    "response-poller.test.ts: 新規作成、cleanClaudeResponse()のskipPatternsフィルタテスト追加",
    "codex.test.ts: sendMessage()のモック基盤構築、検知タイミング順序検証テスト追加"
  ],
  "target_coverage": 80,
  "design_policy_path": "dev-reports/design/issue-212-pasted-text-detection-design-policy.md",
  "work_plan_path": "dev-reports/issue/212/work-plan.md",
  "key_design_decisions": [
    "単一行メッセージ最適化: message.includes('\\n')ガードで不要な遅延を排除（+0ms）",
    "共通ヘルパー化: detectAndResendIfPastedText()を新規作成し、code duplicationを排除",
    "定数一元管理: PASTED_TEXT_PATTERNをcli-patterns.tsに集約",
    "パフォーマンス: 単一行+0ms、複数行最大+1500ms（通常+500ms）",
    "リトライ戦略: 最大3回、各500ms間隔、全リトライ失敗時は警告ログ出力",
    "検知タイミング: codex.tsではexecAsync(C-m)送信後にcapturePane呼び出し"
  ]
}
