{
  "stage": 1,
  "focus_area": "通常",
  "review_date": "2026-01-30",
  "issue_number": 100,
  "issue_title": "feat: マークダウンプレビューでmermaidダイアグラムを描画できるようにする",
  "findings": {
    "must_fix": [
      {
        "id": "MF-001",
        "category": "consistency",
        "title": "背景情報の誤り: Issue #99はマークダウンエディタ本体ではなく表示改善機能",
        "description": "Issueの背景に「Issue #99 でマークダウンエディタを実装」と記載されているが、実際にはマークダウンエディタ本体はIssue #49で実装されており、Issue #99は「マークダウンエディタ表示機能改善」（最大化、リサイズ等）である。",
        "impact": "関連Issueの誤認識により、作業範囲の理解に混乱が生じる可能性がある",
        "recommendation": "背景を「Issue #49でマークダウンエディタを実装、Issue #99で表示機能を改善」に修正する"
      }
    ],
    "should_fix": [
      {
        "id": "SF-001",
        "category": "clarity",
        "title": "rehype-sanitizeとの互換性に関する技術検討が不足",
        "description": "現在のMarkdownEditor.tsxではrehype-sanitizeによるXSS対策が実装されている（[SEC-MF-001]）。mermaid導入時にrehype-sanitizeとの互換性が考慮されていない。mermaidが生成するSVGやスクリプトがサニタイズでブロックされる可能性がある。",
        "impact": "実装時にmermaidダイアグラムが表示されない、またはセキュリティ上の問題が発生する可能性",
        "recommendation": "技術検討事項に「rehype-sanitizeとの互換性確認」を追加し、各アプローチでのサニタイズ設定調整方法を記載する"
      },
      {
        "id": "SF-002",
        "category": "clarity",
        "title": "SSR/CSR対応の技術的制約が不明確",
        "description": "非機能要件に「SSR/CSR両方で正常動作」と記載されているが、mermaidはクライアントサイドでのDOM操作を必要とするため、SSRでの描画は技術的に困難。現在のMarkdownEditorは'use client'ディレクティブでクライアントコンポーネントとして実装されている。",
        "impact": "実現不可能な要件が含まれる可能性",
        "recommendation": "「SSR環境でのハイドレーション後に正常動作すること」に要件を明確化するか、SSR時はプレースホルダー表示とする方針を記載する"
      },
      {
        "id": "SF-003",
        "category": "completeness",
        "title": "セキュリティ考慮事項が未記載",
        "description": "mermaidダイアグラムはSVGを生成するが、SVGにはXSSリスクがある。Issue #95の画像ビューワ機能ではSVG XSS対策として5項目（scriptタグ、イベントハンドラ、javascript:スキーム等の拒否）を実装している。",
        "impact": "セキュリティ対策の漏れが発生する可能性",
        "recommendation": "セキュリティ考慮事項セクションを追加し、mermaid生成SVGのサニタイズ方針を記載する。mermaidライブラリのsecurityLevel設定（'strict', 'loose', 'antiscript'等）についても検討を記載する"
      },
      {
        "id": "SF-004",
        "category": "correctness",
        "title": "アプローチBの参照パッケージ名が不正確",
        "description": "@tntd/react-markdown-mermaidはnpmで確認できない。正しいパッケージ名は異なる可能性がある。一般的な選択肢としてはrehype-mermaid、remark-mermaidjs等がある。",
        "impact": "存在しないパッケージへの依存を前提とした計画になる",
        "recommendation": "実在するパッケージ（rehype-mermaid, remark-mermaidjs, mermaid等）を調査し、正確なパッケージ名と特徴を記載する"
      },
      {
        "id": "SF-005",
        "category": "completeness",
        "title": "影響ファイルにスタイル関連ファイルが含まれていない",
        "description": "mermaidダイアグラムのスタイリングにはCSSの追加が必要になる可能性がある。現在のMarkdownEditor.tsxでは'highlight.js/styles/github-dark.css'をインポートしている。mermaid用のスタイル調整が必要かどうかの検討がない。",
        "impact": "実装時にスタイル調整の追加作業が発生する",
        "recommendation": "影響ファイルにスタイル関連の検討を追加する"
      }
    ],
    "nice_to_have": [
      {
        "id": "NTH-001",
        "category": "completeness",
        "title": "バンドルサイズへの影響評価が未記載",
        "description": "mermaidライブラリはサイズが大きい（約500KB以上）。パフォーマンス要件は記載されているが、バンドルサイズへの影響評価がない。Issue #49の設計書ではエディタ選定時にバンドルサイズを考慮している。",
        "impact": "初期ロード時間の増加",
        "recommendation": "技術検討事項にバンドルサイズ影響評価を追加し、dynamic import等の軽減策を検討する"
      },
      {
        "id": "NTH-002",
        "category": "documentation",
        "title": "テスト戦略の詳細が未記載",
        "description": "AC-04で「単体テストが追加されている」とあるが、具体的なテストケース（構文エラー時の挙動、各ダイアグラムタイプの描画確認等）が記載されていない。",
        "impact": "テスト漏れが発生する可能性",
        "recommendation": "テストケースの例を記載する（正常系: flowchart描画、異常系: 構文エラー表示等）"
      },
      {
        "id": "NTH-003",
        "category": "clarity",
        "title": "モバイル対応の考慮が未記載",
        "description": "Issue #99でモバイル対応（タブ切替UI、スワイプ等）が実装されている。mermaidダイアグラムのモバイル表示（スクロール、ズーム等）についての考慮がない。",
        "impact": "モバイルでの使用体験が低下する可能性",
        "recommendation": "モバイル表示時の考慮事項を追加する"
      },
      {
        "id": "NTH-004",
        "category": "documentation",
        "title": "関連IssueにIssue #49が含まれていない",
        "description": "マークダウンエディタ本体を実装したIssue #49への参照がない。Issue #99のみが関連Issueとして記載されている。",
        "impact": "実装時に参照すべき設計書への導線が不足",
        "recommendation": "関連IssueにIssue #49を追加する"
      }
    ]
  },
  "checklist_results": {
    "consistency_with_existing_code": {
      "status": "partial",
      "notes": "MarkdownEditor.tsxの構造は把握されているが、rehype-sanitize等のセキュリティ機構との互換性考慮が不足"
    },
    "consistency_with_documentation": {
      "status": "partial",
      "notes": "関連Issueの参照に誤りあり（#99と#49の混同）"
    },
    "correctness_of_content": {
      "status": "partial",
      "notes": "アプローチBの参照パッケージが存在しない可能性。SSR対応の技術的実現可能性が不明確"
    },
    "clarity_of_requirements": {
      "status": "good",
      "notes": "機能要件（対応ダイアグラム種別）は明確に定義されている"
    },
    "validity_of_acceptance_criteria": {
      "status": "good",
      "notes": "AC-01からAC-04は妥当。ただしテスト詳細の具体化が望ましい"
    }
  },
  "summary": "Issue #100は、既存のマークダウンエディタにmermaidダイアグラム描画機能を追加する機能拡張である。要件の大枠は明確だが、以下の点で改善が必要: (1) 背景情報でIssue #99とIssue #49の役割が混同されている、(2) 現在のセキュリティ機構（rehype-sanitize）との互換性が考慮されていない、(3) SSR/CSR対応の技術的制約が不明確、(4) 参照パッケージ名に誤りがある可能性がある。これらの点を修正することで、より実装しやすい明確なIssueとなる。",
  "recommendation": "should_fix指摘事項を反映後、設計フェーズに進むことを推奨。特にセキュリティ考慮事項（SF-003）とrehype-sanitize互換性（SF-001）は設計段階で重要な検討項目となる。"
}
