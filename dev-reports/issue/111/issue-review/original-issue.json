{"body":"## 概要\n\n作業ブランチを可視化する。セッション中にブランチが切り替わった場合、ユーザーに明示的に通知する。\n\n## 背景・課題\n\n意図せずClaude Codeが作業ブランチを切り替えているケースが多々ある。想定と異なるブランチでの作業は不具合を生じやすい。\n\n### 具体的な問題\n\n1. **ブランチ不一致の検出不能**: developブランチでセッションを開始し、途中でブランチを切り替えた場合でも、アプリの表示上はdevelopブランチのままとなる\n2. **意図しないコミット**: 誤ったブランチでコードを修正・コミットしてしまうリスクがある\n3. **作業状況の把握困難**: 複数のワークツリーを並行作業している場合、どのブランチで作業しているか混乱する\n\n### 現状の仕組み\n\n- アプリはワークツリー（git worktree）単位で管理\n- ワークツリー名 = セッション開始時のブランチ名として表示\n- セッション中のブランチ変更は追跡されていない\n\n## 提案する解決策\n\n### 1. リアルタイムブランチ監視\n\nClaude Codeからの回答完了時（またはポーリング時）に、実際の作業ブランチを取得してアプリに表示する。\n\n### 2. ブランチ不一致アラート\n\nセッション起動時のブランチと現在のブランチが異なる場合、以下の方法でユーザーに通知：\n- ヘッダー部分に警告アイコン/バッジを表示\n- ブランチ名を強調表示（例：赤色、点滅）\n- オプション：通知トーストを表示\n\n### 3. UI表示案\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│ [Repository名] / [ワークツリー名]                            │\n│ 🔀 現在のブランチ: feature/new-feature ⚠️ (開始時: develop)  │\n└─────────────────────────────────────────────────────────────┘\n```\n\n## 技術要件\n\n### API拡張\n\n新規または既存APIの拡張：\n\n```typescript\n// GET /api/worktrees/:id/git-status\ninterface GitStatusResponse {\n  currentBranch: string;      // 現在のgitブランチ名\n  initialBranch: string;      // セッション開始時のブランチ名\n  isBranchMismatch: boolean;  // ブランチ不一致フラグ\n  commitHash: string;         // 現在のコミットハッシュ（短縮形）\n  isDirty: boolean;           // 未コミット変更の有無\n  aheadBehind?: {             // オプション\n    ahead: number;\n    behind: number;\n  };\n}\n```\n\n### フロントエンド\n\n- `WorktreeDetailRefactored.tsx`のヘッダーにブランチ情報を追加\n- `MobileHeader.tsx`にもブランチ情報を追加\n- ブランチ不一致時の警告表示コンポーネント作成\n\n### バックエンド\n\n- ワークツリーディレクトリで`git rev-parse --abbrev-ref HEAD`を実行\n- セッション開始時のブランチ名をDBまたはメモリに保存\n- ポーリング時にブランチ情報を取得・比較\n\n## 影響範囲\n\n| ファイル | 変更内容 |\n|---------|---------|\n| `src/types/models.ts` | Worktree型にgitStatus関連フィールド追加 |\n| `src/lib/db.ts` | 初期ブランチ名の保存カラム追加（任意） |\n| `src/app/api/worktrees/[id]/route.ts` | git status情報の取得・返却 |\n| `src/components/worktree/WorktreeDetailRefactored.tsx` | ブランチ表示UI追加 |\n| `src/components/mobile/MobileHeader.tsx` | モバイル用ブランチ表示追加 |\n| `src/components/worktree/BranchMismatchAlert.tsx` | 新規：不一致警告コンポーネント |\n\n## 受け入れ条件\n\n- [ ] ワークツリー詳細画面のヘッダーに現在のgitブランチ名が表示される\n- [ ] セッション開始時のブランチと現在のブランチが異なる場合、視覚的に警告が表示される\n- [ ] モバイル表示でもブランチ情報が確認できる\n- [ ] ブランチ情報は定期的に更新される（ポーリング間隔に合わせて）\n- [ ] パフォーマンスへの影響が最小限である（git コマンド実行のオーバーヘッド）\n\n## 実装タスク\n\n1. **Task 1**: API拡張 - git status情報の取得エンドポイント追加\n2. **Task 2**: 型定義 - Worktree型にgitStatus関連フィールド追加\n3. **Task 3**: UIコンポーネント - ブランチ表示・警告コンポーネント作成\n4. **Task 4**: 統合 - ヘッダーへのブランチ情報表示統合\n5. **Task 5**: テスト - ユニットテスト・結合テスト追加\n\n## 優先度\n\n**Medium** - 作業効率とミス防止に貢献するが、緊急ではない\n\n## 備考\n\n- ターミナルプロンプトからブランチ名を抽出する方法も検討可能（ただし信頼性が低い）\n- 将来的には「ブランチ切り替えを検出したら自動でワークツリーを切り替える」機能も検討可能","title":"現在の作業ブランチを可視化して欲しい"}
