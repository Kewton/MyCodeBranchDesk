{"body":"## 概要\n\nAuto-Yesモードに「Stop条件」機能を追加する。ユーザーが正規表現パターンを指定し、ターミナル出力がそのパターンにマッチした場合にAuto-Yesを自動停止する。これにより、意図しない操作（例: ファイル削除確認、危険なコマンド実行）への自動応答を防止できる。\n\n## 背景・課題\n\n- 現在のAuto-Yesは時間ベースの期限（1h/3h/8h）でのみ自動停止する\n- ターミナル出力内容に応じた条件付き停止ができないため、危険な操作への自動応答リスクがある\n- 例: `rm -rf`、`DROP TABLE`、`force push` などの危険な操作がCLIから提案された場合にも自動でYesしてしまう\n- ユーザーが安心してAuto-Yesを利用するためには、出力内容ベースのセーフガードが必要\n\n## 提案する解決策\n\n### UX\n\nAuto-Yes有効化時の確認ダイアログ（`AutoYesConfirmDialog`）に**Stop条件入力フィールド**を追加する。\n\n1. ユーザーがAuto-Yesトグルをクリック\n2. 確認ダイアログが表示される（既存）\n3. **時間の選択**（既存: 1h/3h/8h）\n4. **Stop条件の入力**（新規: テキストフィールド、正規表現、任意入力）\n   - プレースホルダー例: `rm -rf|DROP TABLE|force push`\n   - 空欄の場合はStop条件なし（従来通りの動作）\n5. 「同意して有効化」ボタンで確定\n\n### サーバーサイド\n\n`auto-yes-manager.ts`の`pollAutoYes()`内で、プロンプト検出前にターミナル出力をStop条件パターンと照合する。マッチした場合はAuto-Yesを自動停止する。\n\n### 判定タイミング\n\nポーリングの各サイクル（`pollAutoYes()`）内で以下の順序で処理:\n\n1. ターミナル出力をキャプチャ（既存）\n2. ANSIコード除去（既存）\n3. thinking状態チェック（既存）\n4. **Stop条件チェック（新規）** — マッチ時はAuto-Yesを停止し、ポーリングを終了\n5. プロンプト検出（既存）\n6. 自動応答（既存）\n\n## 実装タスク\n\n- [ ] `AutoYesState`インターフェースに`stopPattern?: string`フィールドを追加（`auto-yes-manager.ts`）\n- [ ] `setAutoYesEnabled()`にstopPatternパラメータを追加\n- [ ] `pollAutoYes()`内にStop条件チェックロジックを追加（thinking状態チェック後、プロンプト検出前）\n- [ ] `AutoYesConfirmDialog`にStop条件入力フィールドを追加（テキストフィールド、プレースホルダー付き）\n- [ ] `AutoYesConfirmDialog`の`onConfirm`コールバックにstopPatternを追加\n- [ ] `AutoYesToggle`の`onToggle`コールバックにstopPatternを追加\n- [ ] `/api/worktrees/[id]/auto-yes` APIルートでstopPatternの受け渡しを追加\n- [ ] 正規表現バリデーション（不正なパターン入力時のエラーハンドリング）\n- [ ] Stop条件でAuto-Yesが停止した際のログ出力とUI通知\n- [ ] i18n対応（ja/en: ラベル、プレースホルダー、通知メッセージ）\n- [ ] ユニットテスト追加（Stop条件マッチ/不マッチ、無効な正規表現、空パターン）\n\n## 受入条件\n\n- [ ] Auto-Yes確認ダイアログにStop条件入力フィールドが表示される\n- [ ] Stop条件が空の場合は従来通りの動作（時間ベースのみで停止）\n- [ ] Stop条件に正規表現を入力でき、ターミナル出力がマッチした場合にAuto-Yesが自動停止する\n- [ ] Auto-Yesが停止した際にユーザーに通知される（トースト or AutoYesToggle上の通知）\n- [ ] 不正な正規表現パターン入力時にバリデーションエラーが表示される\n- [ ] 正規表現のReDoS（Regular Expression Denial of Service）対策が施されている\n- [ ] 既存のAuto-Yes機能（時間ベース停止、プロンプト自動応答）に影響しない\n- [ ] 既存テストがすべてパスする\n\n## 影響範囲\n\n### 変更対象ファイル\n\n| ファイル | 変更内容 |\n|---------|---------|\n| `src/lib/auto-yes-manager.ts` | `AutoYesState`にstopPatternフィールド追加、`pollAutoYes()`にStop条件チェック追加 |\n| `src/lib/auto-yes-resolver.ts` | 変更なし（自動応答ロジックは変わらない） |\n| `src/components/worktree/AutoYesConfirmDialog.tsx` | Stop条件入力フィールド追加、onConfirmにstopPattern引数追加 |\n| `src/components/worktree/AutoYesToggle.tsx` | onToggleにstopPattern引数追加 |\n| `src/app/api/worktrees/[id]/auto-yes/route.ts` | stopPatternパラメータの受け渡し追加 |\n| `src/hooks/useAutoYes.ts` | stopPatternの状態管理追加 |\n| `src/components/worktree/WorktreeDetailRefactored.tsx` | stopPatternの受け渡し追加 |\n\n### 関連コンポーネント\n\n- `src/config/auto-yes-config.ts` — 設定定数（変更不要）\n- `src/lib/prompt-detector.ts` — プロンプト検出（変更不要、Stop条件はその前段で判定）\n- `src/lib/cli-patterns.ts` — stripAnsi, detectThinking（変更不要）\n\n## セキュリティ考慮\n\n- **ReDoS対策**: ユーザー入力の正規表現にタイムアウト付き実行またはパターン複雑度チェックを適用する\n- **入力サニタイズ**: stopPatternの最大長を制限する（例: 500文字）\n- **サーバーサイドバリデーション**: APIルートでもstopPatternの正規表現妥当性を検証する","title":"feat: Auto-Yesにターミナル出力のStop条件（正規表現）を追加"}
