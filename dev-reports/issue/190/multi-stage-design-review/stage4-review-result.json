{
  "issue_number": 190,
  "focus_area": "セキュリティ",
  "stage": 4,
  "stage_name": "セキュリティレビュー（OWASP Top 10準拠確認）",
  "status": "conditionally_approved",
  "score": 4,
  "findings": {
    "must_fix": [
      {
        "id": "SEC-MF-001",
        "category": "A03:2021 - Injection (Path Traversal)",
        "title": "repositoryPath入力に対するパストラバーサル防御が不十分",
        "description": "DELETE /api/repositories と PUT /api/repositories/restore の repositoryPath パラメータに対して、typeof === 'string' と空文字チェックのみが行われる設計になっている。path.resolve() による正規化は resolveRepositoryPath() 内で行われるが、これは正規化であってバリデーションではない。悪意のあるパス（例: '/etc/passwd', '../../../../etc/passwd'）がそのまま repositories テーブルに登録され、enabled=0 のレコードとして永続化される。直接的な被害は限定的（DB上のレコード操作のみ）だが、getExcludedRepositories() API経由で登録済みパスが漏洩し、ディレクトリ構造の推測に利用される可能性がある。",
        "severity": "Medium",
        "recommendation": "DELETE /api/repositories の route.ts および PUT /api/repositories/restore の route.ts で、repositoryPath が妥当なファイルシステムパスであることを検証するバリデーションを追加する。具体的には: (1) path.resolve() 後のパスがシステムディレクトリ（/etc, /usr, /sys等）でないことを isSystemDirectory() で確認する、(2) null byte (\u0000) を含まないことを確認する。scan/route.ts で既に実装されている isPathSafe() パターンを参考にする。",
        "affected_files": [
          "src/app/api/repositories/route.ts (DELETE)",
          "src/app/api/repositories/restore/route.ts (新規)"
        ]
      }
    ],
    "should_fix": [
      {
        "id": "SEC-SF-001",
        "category": "A01:2021 - Broken Access Control",
        "title": "GET /api/repositories/excluded APIによるファイルシステムパス漏洩",
        "description": "GET /api/repositories/excluded は認証なしで除外リポジトリの完全なパス情報を返す。CommandMateはローカルアクセス前提（127.0.0.1バインド）だが、リバースプロキシ構成での外部公開時に、サーバー上のディレクトリ構造が漏洩するリスクがある。",
        "severity": "Low",
        "recommendation": "設計書Section 8 の権限セクションに、GET /api/repositories/excluded がファイルパス情報を返すことを明記し、リバースプロキシ使用時にこのエンドポイントへのアクセス制御を推奨する旨を追加する。",
        "affected_files": [
          "src/app/api/repositories/excluded/route.ts (新規)"
        ]
      },
      {
        "id": "SEC-SF-002",
        "category": "A03:2021 - Injection (SQL Injection)",
        "title": "新規関数のSQLインジェクション対策の明示的確認",
        "description": "設計書ではプリペアドステートメント使用を明記しているが、getExcludedRepositoryPaths() と getExcludedRepositories() のコード例では固定SQL（パラメータバインドなし）のため実際にはSQLインジェクションリスクはない。ただし、filterExcludedPaths() 内の Array.includes() 比較はDB外での文字列比較であり、大文字小文字やロケールの違いによるバイパスの可能性がある。",
        "severity": "Low",
        "recommendation": "filterExcludedPaths() のパス比較がOS依存（macOSはcase-insensitive, Linuxはcase-sensitive）であることをコードコメントに明記する。実装時に resolveRepositoryPath() による正規化が確実に両側で適用されていることを検証するテストを追加する。",
        "affected_files": [
          "src/lib/db-repository.ts"
        ]
      },
      {
        "id": "SEC-SF-003",
        "category": "A05:2021 - Security Misconfiguration",
        "title": "エラーレスポンスからの内部情報漏洩リスク",
        "description": "sync/route.ts の500エラーレスポンスで error.message をそのまま返却している（既存コード line 44: 'error instanceof Error ? error.message : ...'）。新規追加する restore/route.ts でも同様のパターンが踏襲されると、内部例外メッセージ（DBエラー詳細、ファイルパス等）がクライアントに漏洩する可能性がある。",
        "severity": "Low",
        "recommendation": "新規作成する restore/route.ts と excluded/route.ts の500エラーレスポンスでは、error.message をそのまま返すのではなく、一般的なエラーメッセージ（'Failed to restore repository', 'Failed to get excluded repositories'）を返す。既存のDELETE route.ts のパターン（'Failed to delete repository' 固定文字列）を踏襲する。",
        "affected_files": [
          "src/app/api/repositories/restore/route.ts (新規)",
          "src/app/api/repositories/excluded/route.ts (新規)"
        ]
      },
      {
        "id": "SEC-SF-004",
        "category": "A04:2021 - Insecure Design",
        "title": "disableRepository() による無制限レコード蓄積（DoS的リスク）",
        "description": "disableRepository() は未登録パスに対しても enabled=0 で新規レコードを作成する設計。攻撃者（またはバグ）がランダムなパスで繰り返し DELETE リクエストを送信した場合、repositories テーブルに大量のゴミレコードが蓄積される。SQLiteのパフォーマンス劣化やディスク容量消費につながる。",
        "severity": "Low",
        "recommendation": "disableRepository() で新規登録する場合に、レート制限またはレコード数上限チェックを実装時に検討する。最低限、repositories テーブルの enabled=0 レコード数に上限（例: 1000件）を設け、超過時はエラーを返すか最古のレコードを削除する。設計書Section 15のC-I01「クリーンアップ機能」の優先度を上げることを推奨する。",
        "affected_files": [
          "src/lib/db-repository.ts"
        ]
      },
      {
        "id": "SEC-SF-005",
        "category": "A08:2021 - Software and Data Integrity Failures",
        "title": "復活API (PUT /api/repositories/restore) でのファイルシステム存在確認のレースコンディション",
        "description": "restore API はリポジトリパスのディスク存在確認後に scanWorktrees() を実行する設計だが、存在確認と scanWorktrees() の間にディレクトリが削除/移動される TOCTOU（Time of Check to Time of Use）リスクがある。scanWorktrees() は内部で git worktree list コマンドを exec() で実行するため、攻撃者がシンボリックリンクを差し替えることで意図しないディレクトリをスキャンさせる可能性がある。",
        "severity": "Low",
        "recommendation": "scanWorktrees() 内で既にpath.resolve(rootDir) が適用され、危険パスのフィルタリングも行われている（worktrees.ts line 181-193）ため、実際のリスクは限定的。ただし、設計書のセキュリティセクション（Section 8）にTOCTOUリスクの認識と、既存の scanWorktrees() 内の安全ガードに依存する旨を明記すること。",
        "affected_files": [
          "src/app/api/repositories/restore/route.ts (新規)"
        ]
      }
    ],
    "consider": [
      {
        "id": "SEC-C-001",
        "category": "A01:2021 - Broken Access Control",
        "title": "CSRF対策の不在",
        "description": "DELETE, PUT, POST の状態変更APIにCSRFトークン検証がない。現時点ではローカルアクセス前提のため問題ないが、リバースプロキシ経由での外部公開時にCSRF攻撃のリスクがある。これは本Issue固有の問題ではなく、プロジェクト全体の課題。",
        "recommendation": "将来的に外部公開を想定する場合、CSRF対策のフォローアップIssueを検討する。"
      },
      {
        "id": "SEC-C-002",
        "category": "A09:2021 - Security Logging and Monitoring Failures",
        "title": "除外登録/復活操作の監査ログ不足",
        "description": "disableRepository() と restoreRepository() の呼び出しに対する監査ログが設計に含まれていない。CLIモジュールでは security-logger.ts を使用したセキュリティイベントログが実装されているが、本設計ではconsole.infoのみ。",
        "recommendation": "セキュリティ重要度は低いが、除外・復活操作は意図しない変更の追跡に有用。console.info レベルのログ出力は既存のDELETE route.tsパターンで確保されているため、最低限の追跡は可能。将来的にセキュリティログの統合を検討。"
      },
      {
        "id": "SEC-C-003",
        "category": "A06:2021 - Vulnerable and Outdated Components",
        "title": "exec() によるコマンド実行のセキュリティ",
        "description": "scanWorktrees() で使用されている exec('git worktree list', { cwd: rootDir }) は、rootDir がユーザー入力由来の場合にコマンドインジェクションのリスクがある。ただし、scanWorktrees() は cwd オプション経由でパスを渡しており、コマンド文字列にパスを埋め込んでいないため、直接的なインジェクションリスクはない。本Issueで新規追加されるフローでは、restore API の自動sync時にこのパスが使用される。",
        "recommendation": "現状のexec + cwdパターンは安全。将来的にexecFile への移行を検討（git-utils.ts では既にexecFile使用パターンが確立されている）。"
      }
    ]
  },
  "owasp_top10_checklist": {
    "A01_Broken_Access_Control": {
      "status": "pass_with_note",
      "note": "ローカルアクセス前提で認証なし。リバースプロキシ認証推奨の方針はIssue #179で確立済み。GET /api/repositories/excluded でパス情報漏洩リスクあり（SEC-SF-001）。"
    },
    "A02_Cryptographic_Failures": {
      "status": "not_applicable",
      "note": "本設計で暗号化対象のデータは扱わない。"
    },
    "A03_Injection": {
      "status": "conditionally_pass",
      "note": "SQLクエリは全てプリペアドステートメント使用で安全。パストラバーサルについては repositoryPath のバリデーション強化が必要（SEC-MF-001）。"
    },
    "A04_Insecure_Design": {
      "status": "pass_with_note",
      "note": "disableRepository() の無制限レコード蓄積リスクあり（SEC-SF-004）。設計自体は妥当。"
    },
    "A05_Security_Misconfiguration": {
      "status": "conditionally_pass",
      "note": "エラーレスポンスでの内部情報漏洩リスクあり（SEC-SF-003）。新規APIでは既存DELETE APIの固定メッセージパターンを踏襲すべき。"
    },
    "A06_Vulnerable_Components": {
      "status": "pass",
      "note": "既存依存関係への新規追加なし。exec() 使用は既存パターンの踏襲。"
    },
    "A07_Auth_Failures": {
      "status": "not_applicable",
      "note": "Issue #179で認証機構は廃止済み。リバースプロキシ認証推奨。"
    },
    "A08_Software_Data_Integrity": {
      "status": "pass_with_note",
      "note": "restore APIのTOCTOUリスクは認識済み。既存のscanWorktrees()内安全ガードで緩和（SEC-SF-005）。"
    },
    "A09_Logging_Monitoring": {
      "status": "pass_with_note",
      "note": "基本的なconsole.infoログは既存パターンで確保。専用監査ログは未実装（SEC-C-002）。"
    },
    "A10_SSRF": {
      "status": "not_applicable",
      "note": "本設計にサーバーサイドリクエスト発行処理はない。"
    }
  },
  "risk_assessment": {
    "technical": "low",
    "security": "medium",
    "operational": "low"
  },
  "reviewed_files": [
    "dev-reports/design/issue-190-repository-exclusion-on-sync-design-policy.md",
    "src/lib/db-repository.ts",
    "src/app/api/repositories/route.ts",
    "src/app/api/repositories/sync/route.ts",
    "src/app/api/repositories/scan/route.ts",
    "src/lib/worktrees.ts",
    "src/lib/db.ts",
    "src/lib/path-validator.ts",
    "src/lib/env.ts",
    "src/lib/db-path-resolver.ts",
    "src/lib/file-operations.ts",
    "src/lib/clone-manager.ts",
    "src/components/worktree/WorktreeList.tsx",
    "tests/integration/api-repository-delete.test.ts"
  ],
  "timestamp": "2026-02-08T12:00:00Z"
}
