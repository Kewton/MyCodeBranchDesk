{
  "issue_number": 256,
  "focus_area": "影響範囲",
  "iteration": 1,
  "stage": 3,
  "review_date": "2026-02-13",
  "summary": {
    "must_fix_count": 1,
    "should_fix_count": 3,
    "nice_to_have_count": 2
  },
  "findings": {
    "must_fix": [
      {
        "id": "MF-1",
        "category": "破壊的変更",
        "issue": "isQuestionLikeLine()の変更はAuto-Yes機能の自動応答判定に直接波及し、False Positiveが自動応答の誤送信を引き起こすリスクがある。影響範囲セクションでAuto-Yesに関するファイル（auto-yes-manager.ts, auto-yes-resolver.ts）が関連ファイルとして明記されていない",
        "location": "## 影響範囲 > 関連ファイル（変更不要だが影響確認必要）",
        "recommendation": "関連ファイルに以下を追加すべき: (1) src/lib/auto-yes-manager.ts（L319: detectPrompt()を呼び出しプロンプト検出結果に基づき自動応答を送信する。isQuestionLikeLine()の判定緩和がFalse Positiveを増やした場合、pollAutoYes()が誤ったプロンプト検出に対して自動応答を送信する）、(2) src/lib/auto-yes-resolver.ts（resolveAutoAnswer()がpromptDataに基づき応答を決定。False Positive時にはmultiple_choiceの最初のオプション番号が自動送信される）。受入条件の「Auto-Yes機能有効時に誤検出による自動応答の誤送信が発生しないことを確認」は記載済みだが、テスト対象ファイルとしての明示が必要",
        "evidence": "auto-yes-manager.ts L319: `const promptDetection = detectPrompt(cleanOutput, promptOptions);` -- このコールがisQuestionLikeLine()の変更の直接的影響を受ける。L328: `const answer = resolveAutoAnswer(promptDetection.promptData);` でauto-yes-resolver.tsが呼ばれ、L336-398で実際にtmuxセッションにキー送信が行われる。False Positiveの場合、存在しないプロンプトに対してキー入力が送信され、CLIセッションの状態が壊れる"
      }
    ],
    "should_fix": [
      {
        "id": "SF-1",
        "category": "テスト範囲",
        "issue": "代替案A（上方走査）を採用した場合、detectMultipleChoicePrompt()内のPass 2逆スキャンとquestionEndIndex決定ロジックの変更が必要だが、既存テストのカバレッジ分析が不足",
        "location": "## 対策案 > パターンB対応",
        "recommendation": "代替案A（questionEndIndexから上方N行走査）を採用する場合、以下の既存テストへの影響を確認する必要がある: (1) T11h-T11m（False Positive防止）: 上方走査の範囲内にたまたまキーワードを含む行がある場合の挙動、(2) Issue #181のmultiline option continuation テスト: isContinuationLine()で走査を進めた後のquestionEndIndex位置が上方走査の起点となるため、走査範囲の計算に影響、(3) 50-line window boundary テスト: questionEndIndexの上方走査がscanStart境界を超える場合のガード。これらのテストシナリオを受入条件に明示すべき",
        "evidence": "prompt-detector.ts L461-496: Pass 2逆スキャンでquestionEndIndexが設定される。L514-529: SEC-001bガードでisQuestionLikeLine()が呼ばれる。代替案Aは L526 `if (!isQuestionLikeLine(questionLine))` の判定を、単一行ではなく複数行に拡張する変更となるため、questionEndIndex周辺のループ構造に影響する"
      },
      {
        "id": "SF-2",
        "category": "依存関係",
        "issue": "response-poller.tsのdetectPromptWithOptions()ヘルパーを経由するプロンプト検出パスの影響が分析されていない",
        "location": "## 影響範囲 > 関連ファイル",
        "recommendation": "response-poller.ts内でdetectPrompt()が3箇所で呼び出されている: (1) L330: extractResponse()内のClaude権限プロンプト早期検出、(2) L490: extractResponse()の末尾でのインタラクティブプロンプト検出、(3) L605: checkForResponse()でのレスポンス完了後のプロンプト検出。これら3箇所すべてでisQuestionLikeLine()の変更が波及する。特にL605の検出結果はDB保存とWebSocket配信に直結するため、False Positiveの場合、DBにゴーストプロンプトメッセージが保存され、フロントエンドにPromptPanelが誤表示される。影響範囲の記載は「プロンプト検出・DB保存」と簡潔すぎるため、具体的な影響パスを明記すべき",
        "evidence": "response-poller.ts L605-626: promptDetection.isPromptがtrueの場合、createMessage()でmessageType='prompt'のメッセージをDBに保存し、broadcastMessage()でWebSocketクライアントに配信する。L615: `content: promptDetection.rawContent || promptDetection.cleanContent` でDB保存。False Positiveの場合、通常のCLI出力がプロンプトメッセージとしてDBに保存され、UI上にPromptPanelが表示される"
      },
      {
        "id": "SF-3",
        "category": "影響ファイル",
        "issue": "current-output/route.tsにおけるdetectPrompt()の二重呼び出しパターンとisQuestionLikeLine()変更の波及",
        "location": "## 影響範囲 > 関連ファイル",
        "recommendation": "route.ts L80: detectSessionStatus(output, cliToolId)内でdetectPrompt()が呼ばれ（status-detector.ts L142）、L94: buildDetectPromptOptions() + detectPrompt()で再度呼ばれる。この二重呼び出しはSF-001として設計上許容されているが、isQuestionLikeLine()の変更が両方のパスに同一に波及する点を影響範囲として明記すべき。特にL99: `const isPromptWaiting = statusResult.hasActivePrompt` とL126: `promptData: isPromptWaiting ? promptDetection.promptData : null` で、statusResult.hasActivePromptとpromptDetection.isPromptが不一致になるケースは通常ないが、変更によってタイミング差が生じないことを確認すべき",
        "evidence": "route.ts L80-94: detectSessionStatus()とdetectPrompt()の二重呼び出し。両方ともbuildDetectPromptOptions(cliToolId)を使用し、同一のoptions（Claude: requireDefaultIndicator=false）でisQuestionLikeLine()を実行する。L99: isPromptWaitingはstatusResult.hasActivePromptから、L126: promptDataはpromptDetection.promptDataから取得。isQuestionLikeLine()の変更は両パスに同一に影響するため不整合リスクは低いが、確認は必要"
      }
    ],
    "nice_to_have": [
      {
        "id": "NTH-1",
        "category": "ドキュメント更新",
        "issue": "CLAUDE.mdのモジュール一覧でprompt-detector.tsの説明にisQuestionLikeLine()の変更履歴が追加される見込みだが、Issue #256の変更内容の反映漏れリスクがある",
        "location": "CLAUDE.md",
        "recommendation": "実装完了後にCLAUDE.mdの `src/lib/prompt-detector.ts` の説明行に Issue #256 の変更概要（isQuestionLikeLine()の複数行質問対応・上方走査キーワード検索）を追記すること。既存の記載: 'Issue #208: SEC-001b質問行妥当性検証追加、isQuestionLikeLine()による番号付きリスト誤検出防止' にIssue #256の変更を追加する形が適切"
      },
      {
        "id": "NTH-2",
        "category": "テスト範囲",
        "issue": "auto-yes-manager.test.tsにおけるLayer 1（thinking check）とisQuestionLikeLine()変更の統合テストの追加検討",
        "location": "## 受入条件 > テスト",
        "recommendation": "既存のauto-yes-manager.test.tsにはLayer 1のthinking check テスト（Issue #161）が含まれている。isQuestionLikeLine()の変更後、Auto-Yesパスでの統合テスト（thinking checkが効かない場合にisQuestionLikeLine()の変更がFalse Positiveを防ぐか）の追加を検討すると防御層の網羅性が向上する"
      }
    ]
  },
  "impact_analysis": {
    "directly_affected_files": [
      {
        "file": "src/lib/prompt-detector.ts",
        "impact": "変更対象。isQuestionLikeLine()関数の修正、および代替案A採用時にはdetectMultipleChoicePrompt()内のSEC-001bガード（L514-529）周辺の上方走査ロジック追加",
        "breaking_change": false
      },
      {
        "file": "tests/unit/prompt-detector.test.ts",
        "impact": "新規テストケース追加。既存テスト（特にT11h-T11m）の全パスを維持しつつ、パターンA（句点終端の折り返し行）・パターンB（model選択形式）・行内?チェック・isContinuationLine()相互作用のテストを追加",
        "breaking_change": false
      }
    ],
    "indirectly_affected_files": [
      {
        "file": "src/lib/auto-yes-manager.ts",
        "impact": "L319のdetectPrompt()呼び出しがisQuestionLikeLine()変更の影響を受ける。False Positiveの場合、pollAutoYes()がtmuxセッションに誤ったキー入力を送信する。影響度: 高",
        "breaking_change": false
      },
      {
        "file": "src/lib/auto-yes-resolver.ts",
        "impact": "auto-yes-manager.ts経由で間接的に影響。False Positive検出時にresolveAutoAnswer()がmultiple_choiceの最初のオプション番号を返す。影響度: 高（auto-yes-manager.tsと連動）",
        "breaking_change": false
      },
      {
        "file": "src/lib/response-poller.ts",
        "impact": "L330, L490, L605の3箇所でdetectPrompt()を呼び出し。False PositiveはDBへのゴーストプロンプトメッセージ保存とWebSocket配信を引き起こす。影響度: 中",
        "breaking_change": false
      },
      {
        "file": "src/lib/status-detector.ts",
        "impact": "L142のdetectPrompt()呼び出しでhasActivePromptが判定される。False Positiveはステータスの誤判定（'waiting'）を引き起こす。影響度: 中",
        "breaking_change": false
      },
      {
        "file": "src/app/api/worktrees/[id]/current-output/route.ts",
        "impact": "L80（detectSessionStatus経由）とL94（直接呼び出し）の二重パスでisQuestionLikeLine()変更の影響を受ける。isPromptWaitingとpromptDataがAPI応答に含まれ、フロントエンドのPromptPanel表示に直結。影響度: 中",
        "breaking_change": false
      },
      {
        "file": "src/components/worktree/PromptPanel.tsx",
        "impact": "promptData propを受け取り表示。検出ロジック変更の直接影響はないが、False Positive時に不正なpromptDataが渡される。変更不要。影響度: 低",
        "breaking_change": false
      },
      {
        "file": "src/components/mobile/MobilePromptSheet.tsx",
        "impact": "PromptPanelと同様。モバイル向けプロンプト表示。変更不要。影響度: 低",
        "breaking_change": false
      }
    ],
    "no_breaking_changes": true,
    "migration_required": false,
    "test_coverage_assessment": "既存テスト（T11h-T11m）がFalse Positive防止のセーフティネットとして機能する。isQuestionLikeLine()のどの変更案を採用しても、これらのテストが全パスすることが後方互換性の最低条件。追加で必要なテストは(1)パターンA: 句点終端折り返し行、(2)パターンB: model選択形式（requireDefaultIndicator=false）、(3)行内?チェックのFalse Positiveケース（URL含有行等）、(4)isContinuationLine()とインデント質問行の相互作用"
  },
  "code_references": [
    {
      "file": "src/lib/prompt-detector.ts",
      "lines": "L294, L315-332, L381-395, L461-496, L514-529",
      "relevance": "変更対象: isQuestionLikeLine()、QUESTION_KEYWORD_PATTERN、isContinuationLine()、detectMultipleChoicePrompt() Pass 2、Layer 5 SEC-001bガード"
    },
    {
      "file": "src/lib/auto-yes-manager.ts",
      "lines": "L311-319, L328-398",
      "relevance": "間接影響: detectPrompt()呼び出し -> resolveAutoAnswer() -> sendKeys()/sendSpecialKeys()。False Positiveの自動応答誤送信リスク"
    },
    {
      "file": "src/lib/auto-yes-resolver.ts",
      "lines": "L18-39",
      "relevance": "間接影響: resolveAutoAnswer()がpromptDataに基づき応答を決定"
    },
    {
      "file": "src/lib/response-poller.ts",
      "lines": "L125-131, L330, L490, L605-626",
      "relevance": "間接影響: detectPromptWithOptions()ヘルパー経由の3箇所のdetectPrompt()呼び出し"
    },
    {
      "file": "src/lib/status-detector.ts",
      "lines": "L141-150",
      "relevance": "間接影響: detectPrompt()結果によるhasActivePrompt判定"
    },
    {
      "file": "src/app/api/worktrees/[id]/current-output/route.ts",
      "lines": "L80, L91-99, L126",
      "relevance": "間接影響: detectSessionStatus() + detectPrompt()二重呼び出し、API応答でpromptData返却"
    },
    {
      "file": "src/lib/cli-patterns.ts",
      "lines": "L267-274",
      "relevance": "buildDetectPromptOptions(): Claude用requireDefaultIndicator=false設定"
    },
    {
      "file": "tests/unit/prompt-detector.test.ts",
      "lines": "L1201-1476 (T11h-T11m: L1346-1387)",
      "relevance": "False Positive防止テスト群。変更後の回帰テストのセーフティネット"
    }
  ],
  "doc_references": [
    {
      "file": "CLAUDE.md",
      "relevance": "prompt-detector.tsモジュール説明の更新対象"
    },
    {
      "file": "dev-reports/design/issue-208-auto-yes-numbered-list-false-positive-design-policy.md",
      "relevance": "SEC-001bの設計ポリシー。isQuestionLikeLine()の設計根拠"
    }
  ]
}
