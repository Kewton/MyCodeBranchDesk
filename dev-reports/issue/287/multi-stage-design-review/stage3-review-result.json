{
  "issue_number": 287,
  "focus_area": "影響範囲",
  "stage": 3,
  "stage_name": "影響分析レビュー",
  "status": "conditionally_approved",
  "score": 4,
  "findings": {
    "must_fix": [
      {
        "id": "MF-S3-001",
        "title": "auto-yes-manager.test.ts の既存テスト群がカーソルキーロジック抽出後に壊れるリスク",
        "description": "tests/unit/lib/auto-yes-manager.test.ts にはカーソルキー送信に関するテストが20件以上存在し（L708-945）、sendKeys/sendSpecialKeys のモック呼び出しを直接検証している。buildCursorKeys() への委譲後、これらのテストが内部実装の変更により失敗する可能性がある。設計方針書の修正ファイル一覧（Section 8）にはこのテストファイルの更新が記載されていない。",
        "severity": "high",
        "recommendation": "Section 8 の必須修正ファイル一覧に tests/unit/lib/auto-yes-manager.test.ts を追加し、pollAutoYes のカーソルキー関連テスト（Issue #193 テストスイート全体）の更新方針を明記すること。テストは buildCursorKeys() の振る舞いに依存しなくなるため、sendKeys/sendSpecialKeys のモック検証を維持しつつ、内部的に buildCursorKeys() が呼ばれることを確認するテストパターンに移行する必要がある。"
      }
    ],
    "should_fix": [
      {
        "id": "SF-S3-001",
        "title": "handlePromptRespond の useCallback 依存配列から activeCliTab を除外する影響",
        "description": "現在の handlePromptRespond（L1147）は依存配列に activeCliTab を含んでおり、タブ切替時に関数が再生成される。D-11 で activeCliTabRef.current に変更し依存配列から除外する計画だが、handleAutoYesToggle（L1197）は依然として activeCliTab を依存配列に含んでいる。同一コンポーネント内で同じ状態値に対して ref 経由と直接参照を混在させると、保守時の混乱を招く。",
        "severity": "medium",
        "recommendation": "handleAutoYesToggle は本 Issue のスコープ外ではあるが、コードコメントで handlePromptRespond が ref 経由に変更された理由と、handleAutoYesToggle が直接参照を維持している理由の差異を明記すること。将来の統一方針も注記することを推奨。"
      },
      {
        "id": "SF-S3-002",
        "title": "worktree-detail-integration.test.tsx のプロンプト応答テストがリクエストボディを検証していない",
        "description": "既存の結合テスト（L365-428: Prompt Response テストスイート）は mockFetch の呼び出し有無のみを検証しており、リクエストボディの内容（answer, cliTool フィールド）を検証していない。設計方針書 Section 11 で「リクエストボディに promptType, defaultOptionNumber が含まれる」テストケースを追加する計画だが、既存テストがそもそもボディ検証をしていないため、テストのベースラインが不十分。",
        "severity": "medium",
        "recommendation": "新規テストケース追加時に、既存の Prompt Response テスト（L365-428）のリクエストボディ検証も強化することを推奨。mockFetch.mock.calls からボディの JSON.parse() で answer と cliTool の検証を追加する。"
      },
      {
        "id": "SF-S3-003",
        "title": "auto-yes-manager.ts の pollAutoYes 内カーソルキーロジック変更時の captureSessionOutput 成功パスへの影響",
        "description": "auto-yes-manager.ts の pollAutoYes 関数（L274-419）では captureSessionOutput が常に成功する前提でカーソルキー送信ロジックが実行される。route.ts と異なり、promptCheck === null のフォールバックパスは存在しない（promptDetection.isPrompt が false なら early return する）。buildCursorKeys() 共通化時に effectivePromptType の導出ロジックが変わらないことを確認する必要がある。",
        "severity": "medium",
        "recommendation": "auto-yes-manager.ts での buildCursorKeys() 呼び出し時、effectivePromptType は常に promptDetection.promptData?.type から導出され、body.promptType のフォールバックは不要であることを実装時に明示的にコメントすること。"
      }
    ],
    "consider": [
      {
        "id": "C-S3-001",
        "title": "useAutoYes.ts への promptData 追加がポーリング頻度に与える影響",
        "description": "useAutoYes.ts の useEffect 依存配列（L93）に promptData が含まれている。buildPromptResponseBody() でリクエストボディを構築する際に promptData を使用するが、promptData はポーリング（2秒/5秒間隔）の度に参照が変わる可能性がある。ただし、useEffect は isPromptWaiting が false の場合に early return するため、実質的な影響は限定的。",
        "recommendation": "現状のまま許容可能。promptData の参照変更による useEffect 再実行は、isPromptWaiting のガードで制御されている。"
      },
      {
        "id": "C-S3-002",
        "title": "cursor-key-sender.ts の新規ファイルがバンドルサイズに与える影響",
        "description": "cursor-key-sender.ts はサーバーサイドの route.ts と auto-yes-manager.ts から使用される純粋関数ファイル。クライアントバンドルには含まれないため、バンドルサイズへの影響はない。prompt-response-utils.ts はクライアントサイドの WorktreeDetailRefactored.tsx と useAutoYes.ts から使用されるが、関数サイズが小さいため影響は無視できる。",
        "recommendation": "特段の対応不要。"
      },
      {
        "id": "C-S3-003",
        "title": "PromptMessage.tsx の onRespond シグネチャ不変の検証",
        "description": "設計方針書で PromptMessage.tsx は変更不要と記載されている。PromptMessage は MessageList.tsx 内で使用され（L549）、handlePromptResponse 経由で別の API（/api/worktrees/:id/respond）を呼び出す。prompt-response API とは独立したパスであり、今回の変更の影響を受けないことを確認した。",
        "recommendation": "確認済み。対応不要。"
      }
    ]
  },
  "risk_assessment": {
    "technical": "medium",
    "security": "low",
    "operational": "low"
  },
  "impact_analysis": {
    "directly_changed_files": [
      "src/lib/cursor-key-sender.ts (NEW)",
      "src/lib/prompt-response-utils.ts (NEW)",
      "src/app/api/worktrees/[id]/prompt-response/route.ts",
      "src/lib/auto-yes-manager.ts",
      "src/components/worktree/WorktreeDetailRefactored.tsx",
      "src/hooks/useAutoYes.ts"
    ],
    "test_files_requiring_update": [
      "tests/unit/api/prompt-response-verification.test.ts",
      "tests/unit/lib/auto-yes-manager.test.ts",
      "tests/unit/lib/cursor-key-sender.test.ts (NEW)",
      "tests/unit/lib/prompt-response-utils.test.ts (NEW)",
      "tests/integration/worktree-detail-integration.test.tsx"
    ],
    "indirectly_affected_files": [
      "src/components/worktree/PromptPanel.tsx (verified: no change needed)",
      "src/components/mobile/MobilePromptSheet.tsx (verified: no change needed)",
      "src/components/worktree/PromptMessage.tsx (verified: no change needed)",
      "src/lib/tmux.ts (verified: no change needed)",
      "src/lib/prompt-detector.ts (verified: no change needed)",
      "src/lib/auto-yes-resolver.ts (verified: no change needed)",
      "src/types/models.ts (verified: no change needed, type expansion deferred to C-001)",
      "src/hooks/useWorktreeUIState.ts (verified: no change needed)",
      "tests/integration/auto-yes-persistence.test.ts (verified: no change needed)"
    ],
    "unaffected_confirmed": [
      "src/lib/cli-session.ts",
      "src/lib/cli-patterns.ts",
      "src/lib/cli-tools/manager.ts",
      "src/lib/session-cleanup.ts",
      "src/config/auto-yes-config.ts",
      "src/app/api/worktrees/[id]/auto-yes/route.ts",
      "src/app/api/worktrees/[id]/current-output/route.ts"
    ]
  },
  "reviewed_files": [
    "dev-reports/design/issue-287-prompt-response-fallback-design-policy.md",
    "src/app/api/worktrees/[id]/prompt-response/route.ts",
    "src/lib/auto-yes-manager.ts",
    "src/components/worktree/WorktreeDetailRefactored.tsx",
    "src/hooks/useAutoYes.ts",
    "src/types/models.ts",
    "src/lib/auto-yes-resolver.ts",
    "src/lib/tmux.ts",
    "tests/unit/api/prompt-response-verification.test.ts",
    "tests/unit/lib/auto-yes-manager.test.ts",
    "tests/integration/worktree-detail-integration.test.tsx"
  ],
  "timestamp": "2026-02-15T00:00:00Z"
}
