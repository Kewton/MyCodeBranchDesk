# Issue #119 レビュー報告書

## レビュー概要

| 項目 | 内容 |
|------|------|
| **Issue番号** | #119 |
| **タイトル** | commandmate init: 対話形式セットアップの実装 |
| **レビュー日** | 2026-02-02 |
| **レビュアー** | Claude Code |

---

## 1. 妥当性評価

### ✅ 妥当な点

| 項目 | 評価 | 理由 |
|------|------|------|
| 問題の特定 | ◎ | コードレベルで正確に問題箇所を特定（init.ts 66-68行目） |
| 要件定義 | ○ | 機能要件・非機能要件が明確 |
| 実装方針 | ○ | readline 使用、TTY 対応の方針は適切 |
| 受け入れ条件 | ○ | 8項目で網羅的 |
| テストケース | △ | 基本ケースはあるが不足あり |

### ⚠️ 改善が必要な点

| 項目 | 問題 | 改善案 |
|------|------|--------|
| 参照実装の未記載 | シェルスクリプト版の存在が未記載 | `scripts/setup-env.sh` を参照実装として明記 |
| .env 保存場所 | 現在は cwd だが ~/.commandmate/ への統一が必要 | 保存場所の仕様を明確化 |
| 影響範囲の未特定 | ドキュメント更新範囲が不明確 | 影響を受けるドキュメントを列挙 |
| エッジケース不足 | パス存在確認、チルダ展開などの記載なし | エッジケースを追加 |

---

## 2. 影響範囲分析

### 2.1 コード変更

| ファイル | 変更種別 | 内容 |
|---------|---------|------|
| `src/cli/commands/init.ts` | 修正 | 対話形式ロジック追加 |
| `src/cli/utils/prompt.ts` | 新規 | 対話ユーティリティ |
| `src/cli/types/index.ts` | 修正 | PromptOptions 型追加 |
| `tests/unit/cli/commands/init.test.ts` | 修正 | 対話形式テスト追加 |
| `tests/unit/cli/utils/prompt.test.ts` | 新規 | prompt ユーティリティテスト |

### 2.2 ドキュメント影響

現在「対話形式」に言及している箇所（実装後は整合性を確認）:

| ファイル | 行番号 | 現状 | 対応 |
|---------|--------|------|------|
| `docs/user-guide/cli-setup-guide.md` | 78-89 | 対話形式の説明あり | 実装と一致させる |
| `docs/DEPLOYMENT.md` | 39-53 | 対話形式の記載あり | 実装と一致させる |
| `docs/internal/PRODUCTION_CHECKLIST.md` | 218-219 | 対話形式の記載あり | 実装と一致させる |
| `README.md` | - | commandmate init の説明 | 必要に応じて更新 |

### 2.3 参照実装

**`scripts/setup-env.sh`** に完全な対話形式実装が存在:

```bash
# 主要機能
- read_input(): デフォルト値付きプロンプト
- read_yesno(): Yes/No 確認
- generate_token(): 認証トークン生成
- backup_env(): 既存ファイルバックアップ
```

この実装を TypeScript に移植するのが最も効率的。

---

## 3. 改善提案

### 提案1: 参照実装の明記（Must Fix）

**理由**: シェルスクリプト版の存在を知らないと、ゼロから設計することになり非効率。

**追加内容**:
```markdown
## 参照実装

`scripts/setup-env.sh` に対話形式の完全な実装が存在する。
TypeScript 版はこの実装を移植する形で実装する。

### 移植対象の機能
- `read_input()` → `prompt()`: デフォルト値付き入力
- `read_yesno()` → `confirm()`: Yes/No 確認
- チルダ（~）の展開処理
- 設定サマリーの表示
```

### 提案2: .env 保存場所の明確化（Must Fix）

**理由**: 現在の実装は cwd に保存するが、グローバルインストール時は `~/.commandmate/` が適切。

**追加内容**:
```markdown
## .env ファイルの保存場所

### 保存場所の決定ロジック
1. グローバルインストール時: `~/.commandmate/.env`
2. 開発環境（git clone）時: `./（プロジェクトルート）/.env`

### 判定方法
- `process.cwd()` がパッケージディレクトリと同じ → グローバル
- それ以外 → 開発環境
```

### 提案3: エッジケースの追加（Should Fix）

**理由**: シェルスクリプト版で対応しているケースがカバーされていない。

**追加内容**:
```markdown
## エッジケース

### パス入力
- チルダ（~）の展開: `~/repos` → `/Users/xxx/repos`
- 存在しないパスの場合: 警告表示 + 作成確認
- 相対パスの場合: 絶対パスに変換

### ポート入力
- 数値以外の入力: エラー表示 + 再入力
- 範囲外（1-65535）: エラー表示 + 再入力
- 使用中ポート: 警告表示（起動時にエラーになる旨）

### 認証トークン
- 外部アクセス有効時: 自動生成
- トークンの表示: 全文表示 + 保存を促すメッセージ
```

### 提案4: テストケースの追加（Should Fix）

**理由**: 現在のテストケースでは対話形式をカバーできない。

**追加内容**:
```markdown
## 追加テストケース

### 対話形式テスト
1. stdin のモック方法の確立
2. 各プロンプトへの入力シミュレーション
3. デフォルト値の適用確認
4. バリデーションエラー時の再入力

### エッジケーステスト
1. チルダ展開のテスト
2. 存在しないパスの警告テスト
3. 無効なポート番号のテスト
4. TTY 判定のテスト
```

### 提案5: ドキュメント更新タスクの追加（Nice to Have）

**理由**: 実装後のドキュメント整合性を保証するため。

**追加内容**:
```markdown
## 実装後のドキュメント確認

以下のドキュメントが実装と一致していることを確認:
- [ ] `docs/user-guide/cli-setup-guide.md` の対話例
- [ ] `docs/DEPLOYMENT.md` のセットアップ手順
- [ ] `README.md` の Quick Start
```

---

## 4. 優先度分類

| 分類 | 提案 | 理由 |
|------|------|------|
| **Must Fix** | 提案1: 参照実装の明記 | 実装効率に直結 |
| **Must Fix** | 提案2: .env 保存場所 | ユーザー体験に直結 |
| **Should Fix** | 提案3: エッジケース | 品質向上 |
| **Should Fix** | 提案4: テストケース | 品質保証 |
| **Nice to Have** | 提案5: ドキュメント更新 | 保守性向上 |

---

## 5. 結論

Issue #119 は妥当であり、対話形式の実装は必要である。ただし、以下の改善を推奨:

1. **参照実装（`scripts/setup-env.sh`）を明記** - 実装効率向上
2. **`.env` 保存場所を明確化** - グローバル/ローカルの使い分け
3. **エッジケースを追加** - シェルスクリプト版との機能パリティ
4. **テストケースを拡充** - 対話形式のテスト方法を確立

これらの改善により、Issue の完成度が向上し、実装者が迷わず作業できる。
