{
  "stage": 4,
  "stage_name": "セキュリティレビュー",
  "issue_number": 49,
  "review_date": "2026-01-30",
  "reviewer": "Claude (Architecture Review Agent)",
  "design_doc_path": "dev-reports/design/issue-49-markdown-editor-design-policy.md",
  "findings": {
    "must_fix": [
      {
        "id": "SEC-MF-001",
        "category": "A03_injection",
        "title": "XSS対策: dangerouslySetInnerHTMLの使用リスク",
        "description": "設計書では react-markdown のサニタイズに依存しているが、既存コードの MessageList.tsx (L206, L611) で dangerouslySetInnerHTML を使用している。AnsiToHtml の escapeXML: true オプションで基本的なXML文字エスケープは行われているが、新しい MarkdownEditor でも同様のパターンを踏襲する場合、追加のサニタイズ層が必要。",
        "severity": "高",
        "location": "セクション 7.1 脅威と対策",
        "recommendation": "1. MarkdownEditor での dangerouslySetInnerHTML 使用を避ける設計を明記する\n2. react-markdown のデフォルトサニタイズに加えて rehype-sanitize の導入を検討\n3. または既存の isomorphic-dompurify (package.json で既に依存あり) を使用してコンテンツをサニタイズ"
      },
      {
        "id": "SEC-MF-002",
        "category": "A01_broken_access_control",
        "title": "ファイル書き込みAPIの認可制御不足",
        "description": "設計書セクション 6.1 の新規API (PUT/POST/DELETE/PATCH) は worktree ID によるスコープ制限のみで、どのユーザーがどの worktree に対して操作可能かの認可制御が明記されていない。現在の middleware.ts は認証のみを扱い、認可(Authorization)は実装されていない。",
        "severity": "高",
        "location": "セクション 6.1, 7.1",
        "recommendation": "1. worktree ごとの所有者/アクセス権限の概念を導入するか、明示的にシングルユーザーアプリケーションとして文書化\n2. マルチユーザー環境での使用を想定する場合、worktree 単位のアクセス制御を設計に追加\n3. 現状のシングルユーザー前提を明確に文書化（セキュリティ設計セクションに記載）"
      }
    ],
    "should_fix": [
      {
        "id": "SEC-SF-001",
        "category": "A03_injection",
        "title": "ファイル内容書き込み時のバリデーション強化",
        "description": "設計書セクション 7.3 で maxFileSize 検証は定義されているが、PUT API でファイル内容を書き込む際の追加検証（例: バイナリデータ混入検出、制御文字フィルタリング）が不足している。",
        "severity": "中",
        "location": "セクション 7.3, 6.2",
        "recommendation": "1. validateContent 関数にマークダウンとして不正なコンテンツを検出するロジックを追加\n2. UTF-8 以外のエンコーディングの検出と拒否\n3. 制御文字（NULL以外）のサニタイズまたは警告"
      },
      {
        "id": "SEC-SF-002",
        "category": "A05_security_misconfiguration",
        "title": "エラーメッセージの情報漏洩リスク",
        "description": "設計書セクション 6.3 のエラーレスポンスでファイルパス情報を含む可能性がある。例: 'ファイルが見つかりません: /full/server/path/...' のようなレスポンスはサーバーのディレクトリ構造を露出する。",
        "severity": "中",
        "location": "セクション 6.2, 6.3",
        "recommendation": "1. エラーレスポンスに絶対パスを含めない\n2. 相対パスのみを返す設計を明記\n3. 本番環境でのスタックトレース抑制を確認"
      },
      {
        "id": "SEC-SF-003",
        "category": "A01_broken_access_control",
        "title": "リネーム操作の宛先パス検証",
        "description": "PATCH API のリネーム操作で newName パラメータの検証が不十分。ディレクトリトラバーサル文字を含む newName（例: '../../../etc/passwd'）による攻撃を防ぐ必要がある。",
        "severity": "中",
        "location": "セクション 6.2 PATCH",
        "recommendation": "1. newName に対して isPathSafe() または同等の検証を適用\n2. newName にディレクトリセパレータ ('/', '\\\\') を含むことを禁止\n3. リネーム後のパスが worktree 内に収まることを検証"
      },
      {
        "id": "SEC-SF-004",
        "category": "A04_insecure_design",
        "title": "再帰削除の安全性確認",
        "description": "DELETE API の recursive=true オプションは強力な操作であり、誤操作または悪意のあるリクエストでworktree内の重要データを削除するリスクがある。",
        "severity": "中",
        "location": "セクション 6.2 DELETE",
        "recommendation": "1. 再帰削除の上限（最大ファイル数/深さ）を設定\n2. .git ディレクトリ配下の削除を明示的に禁止\n3. 削除対象のプレビュー機能（dry-run）を検討"
      }
    ],
    "nice_to_have": [
      {
        "id": "SEC-NTH-001",
        "category": "A09_security_logging_failures",
        "title": "ファイル操作の監査ログ",
        "description": "設計書にファイル作成/編集/削除操作の監査ログ出力が明記されていない。セキュリティインシデント発生時の調査に必要。",
        "severity": "低",
        "location": "設計書全体",
        "recommendation": "1. 全ファイル操作（PUT/POST/DELETE/PATCH）の監査ログを出力\n2. ログに timestamp, user (今後), worktreeId, operation, targetPath を含める\n3. 既存の logger.ts を活用"
      },
      {
        "id": "SEC-NTH-002",
        "category": "A06_vulnerable_components",
        "title": "依存パッケージのセキュリティ監視",
        "description": "react-markdown, remark-gfm, rehype-highlight などの依存パッケージに既知の脆弱性がないか定期的に確認する仕組みが言及されていない。",
        "severity": "低",
        "location": "セクション 3.1",
        "recommendation": "1. npm audit を CI/CD パイプラインに組み込む\n2. dependabot または renovate の導入を検討\n3. 脆弱性発見時の対応フローを文書化"
      },
      {
        "id": "SEC-NTH-003",
        "category": "A04_insecure_design",
        "title": "Rate Limiting の検討",
        "description": "新規 API エンドポイント（特に POST/DELETE）に対するレート制限が設計されていない。DoS 攻撃や大量ファイル作成/削除攻撃への対策が必要。",
        "severity": "低",
        "location": "セクション 6.1",
        "recommendation": "1. API レベルでのレート制限を検討\n2. 短時間での大量操作を検出・ブロック\n3. ただし localhost 使用前提なら優先度は低い"
      }
    ]
  },
  "owasp_evaluation": {
    "A01_broken_access_control": {
      "status": "要改善",
      "rating": "C",
      "details": "パストラバーサル対策（isPathSafe()）は設計されているが、ユーザー認可制御とリネーム操作の宛先検証が不足。worktree スコープ制限は実装されているが、マルチユーザー環境での考慮が欠けている。",
      "existing_measures": [
        "isPathSafe() によるパストラバーサル対策",
        "worktree ID によるスコープ制限",
        ".md 拡張子のみ編集可能"
      ],
      "missing_measures": [
        "ユーザー単位の認可制御",
        "リネーム操作の宛先パス検証"
      ]
    },
    "A02_cryptographic_failures": {
      "status": "該当なし",
      "rating": "N/A",
      "details": "本設計ではパスワード保存や機密データの暗号化は扱わない。認証トークン（CM_AUTH_TOKEN）は環境変数経由で管理されており、設計範囲外。",
      "existing_measures": [],
      "missing_measures": []
    },
    "A03_injection": {
      "status": "要改善",
      "rating": "B",
      "details": "パストラバーサル対策は堅牢だが、XSS 対策は react-markdown のデフォルトサニタイズに依存。既存コードで dangerouslySetInnerHTML が使用されており、新コンポーネントでの対策を明確にする必要がある。",
      "existing_measures": [
        "isPathSafe() による複合的なパス検証（URLデコード、null byte、相対パス）",
        "react-markdown のデフォルトサニタイズ",
        "EXCLUDED_PATTERNS による危険ファイル除外"
      ],
      "missing_measures": [
        "明示的な HTML サニタイズ層（rehype-sanitize または DOMPurify）",
        "ファイル内容のバリデーション強化"
      ]
    },
    "A04_insecure_design": {
      "status": "良好",
      "rating": "B+",
      "details": "設計原則（SOLID, KISS, YAGNI, DRY）に従った堅実な設計。再帰削除の安全性とレート制限に若干の改善余地あり。",
      "existing_measures": [
        "Facade パターンによるビジネスロジック分離",
        "編集可能拡張子の設定外部化",
        "最小権限原則（.md のみ編集可能）"
      ],
      "missing_measures": [
        "再帰削除の安全ガード",
        "操作のレート制限"
      ]
    },
    "A05_security_misconfiguration": {
      "status": "良好",
      "rating": "A-",
      "details": "EXCLUDED_PATTERNS による .env、.git 等の保護、ローカル環境とパブリック環境での認証切り替えは適切に設計されている。エラーメッセージの情報漏洩リスクのみ要確認。",
      "existing_measures": [
        "EXCLUDED_PATTERNS で機密ファイルを除外",
        "環境変数バリデーション",
        "CM_BIND=0.0.0.0 時の認証強制"
      ],
      "missing_measures": [
        "エラーレスポンスの絶対パス除去"
      ]
    },
    "A06_vulnerable_components": {
      "status": "良好",
      "rating": "B+",
      "details": "既存依存パッケージ（react-markdown, remark-gfm）を再利用する設計は適切。新規依存追加を最小限に抑えている。継続的な脆弱性監視の仕組みがあると更に良い。",
      "existing_measures": [
        "新規依存追加を最小限に抑制",
        "既存で実績のあるライブラリを再利用"
      ],
      "missing_measures": [
        "npm audit の CI/CD 統合",
        "依存パッケージの自動更新設定"
      ]
    },
    "A07_authentication_failures": {
      "status": "良好",
      "rating": "A",
      "details": "既存の middleware.ts による Bearer トークン認証が設計に含まれている。ローカル環境では認証スキップ、パブリック環境では必須という適切な設計。",
      "existing_measures": [
        "Bearer トークン認証",
        "CM_BIND による認証要否の自動判定",
        "不正トークン時の適切なエラーレスポンス"
      ],
      "missing_measures": []
    },
    "A08_software_integrity_failures": {
      "status": "良好",
      "rating": "A-",
      "details": "ファイル操作は明示的なユーザーアクション（手動保存）を要求する設計。自動保存は意図的にスコープ外とされており、意図しないデータ変更リスクを低減。",
      "existing_measures": [
        "手動保存のみ（自動保存なし）",
        "ファイル変更のコンフリクト防止（originalContent との比較）"
      ],
      "missing_measures": []
    },
    "A09_security_logging_failures": {
      "status": "要改善",
      "rating": "C+",
      "details": "設計書にファイル操作の監査ログ出力が明記されていない。既存の logger.ts は存在するが、新 API での使用方針が不明。",
      "existing_measures": [
        "既存 logger.ts の存在",
        "CM_AUTH_TOKEN マスキング対応"
      ],
      "missing_measures": [
        "ファイル操作の監査ログ",
        "セキュリティイベントのログ出力"
      ]
    },
    "A10_ssrf": {
      "status": "該当なし",
      "rating": "N/A",
      "details": "本設計ではサーバーサイドからの外部 URL リクエストは行わない。ファイル操作はローカルファイルシステムのみ。",
      "existing_measures": [],
      "missing_measures": []
    }
  },
  "security_score": {
    "overall": "B",
    "comment": "パストラバーサル対策、認証、機密ファイル保護など基本的なセキュリティ対策は設計されている。XSS対策の明確化、リネーム操作の宛先検証、監査ログの追加により更に堅牢な設計となる。"
  },
  "summary": "Issue #49 マークダウンエディタ設計書のセキュリティレビューを OWASP Top 10 の観点から実施しました。\n\n【全体評価: B】\n設計は基本的なセキュリティ対策を含んでおり、特にパストラバーサル対策（isPathSafe()）は堅牢です。しかし、以下の2点の Must Fix 項目が存在します:\n\n1. **XSS対策の強化（SEC-MF-001）**: react-markdown のデフォルトサニタイズに依存するだけでなく、明示的なサニタイズ層（rehype-sanitize または既存の DOMPurify）の導入を検討してください。\n\n2. **認可制御の明確化（SEC-MF-002）**: 現在の設計はシングルユーザー前提と思われますが、これを明示的に文書化するか、マルチユーザー環境での認可制御を設計に追加してください。\n\nShould Fix 項目として、リネーム操作の宛先パス検証（SEC-SF-003）は特に重要です。newName パラメータへのディレクトリトラバーサル攻撃を防ぐ必要があります。\n\n既存の path-validator.ts、middleware.ts、file-tree.ts（EXCLUDED_PATTERNS）との連携は適切に設計されており、これらを活用した堅牢な実装が可能です。",
  "implementation_checklist": {
    "must_fix": [
      {
        "id": "SEC-MF-001",
        "action": "MarkdownEditor での XSS 対策を明確化し、rehype-sanitize または isomorphic-dompurify の使用を設計に追加"
      },
      {
        "id": "SEC-MF-002",
        "action": "シングルユーザーアプリケーションとしての前提を設計書に明記、またはマルチユーザー認可制御を追加"
      }
    ],
    "should_fix": [
      {
        "id": "SEC-SF-003",
        "action": "PATCH API の newName パラメータに対するパス検証ロジックを設計に追加（ディレクトリセパレータ禁止、isPathSafe() 適用）"
      },
      {
        "id": "SEC-SF-004",
        "action": "DELETE API の recursive=true に対する安全ガード（.git 保護、削除上限）を設計に追加"
      }
    ],
    "nice_to_have": [
      {
        "id": "SEC-NTH-001",
        "action": "ファイル操作 API の監査ログ出力を設計に追加"
      }
    ]
  }
}
