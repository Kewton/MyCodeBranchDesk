{
  "issue_number": 125,
  "issue_title": "fix(cli): グローバルインストール時に start コマンドが ~/.commandmate/.env を読み込まない",
  "design_doc_path": "dev-reports/design/issue-125-global-install-env-loading-design-policy.md",
  "work_plan_path": "dev-reports/issue/125/work-plan.md",
  "acceptance_criteria": [
    "グローバルインストール時に任意のディレクトリから commandmate start できること",
    "~/.commandmate/.env の設定が正しく読み込まれること",
    "PIDファイルが ~/.commandmate/.commandmate.pid に作成されること",
    "stop/status コマンドが正しいPIDファイルを参照すること",
    "エラー発生時に期待される設定ファイルパスが表示されること",
    "ローカルインストール時の動作が維持されること（後方互換性）",
    "daemon.tsで.env読み込みエラー時にフォールバック動作すること",
    "statusコマンドで正しい設定値が表示されること",
    "getConfigDir()でシンボリックリンク解決とパストラバーサル検証が実装されていること",
    "CM_BIND=0.0.0.0の場合にセキュリティ警告が表示されること",
    "外部公開+認証未設定時に追加警告が表示されること",
    "起動成功ログに正確な設定値が表示されること"
  ],
  "implementation_tasks": [
    {
      "task_id": "1.1",
      "description": "dotenvパッケージをdependenciesに追加",
      "target_file": "package.json"
    },
    {
      "task_id": "2.1",
      "description": "getPidFilePath()関数をenv-setup.tsに追加",
      "target_file": "src/cli/utils/env-setup.ts"
    },
    {
      "task_id": "2.2",
      "description": "パストラバーサル対策（resolveSecurePath()、getConfigDir()修正）",
      "target_file": "src/cli/utils/env-setup.ts"
    },
    {
      "task_id": "3.1",
      "description": "start.tsでgetEnvPath(), getPidFilePath()を使用するよう修正",
      "target_file": "src/cli/commands/start.ts"
    },
    {
      "task_id": "3.2",
      "description": "stop.tsでgetPidFilePath()を使用するよう修正",
      "target_file": "src/cli/commands/stop.ts"
    },
    {
      "task_id": "3.3",
      "description": "status.tsでgetPidFilePath()を使用、dotenvConfig()追加",
      "target_file": "src/cli/commands/status.ts"
    },
    {
      "task_id": "4.1",
      "description": "daemon.tsでdotenv読み込み、セキュリティ警告追加",
      "target_file": "src/cli/utils/daemon.ts"
    }
  ],
  "target_coverage": 80,
  "test_files": [
    "tests/unit/cli/utils/env-setup.test.ts",
    "tests/unit/cli/commands/start.test.ts",
    "tests/unit/cli/commands/stop.test.ts",
    "tests/unit/cli/commands/status.test.ts",
    "tests/unit/cli/utils/daemon.test.ts"
  ],
  "security_requirements": [
    {
      "owasp": "A01:2021 - Broken Access Control",
      "requirement": "パストラバーサル対策: fs.realpathSync()によるシンボリックリンク解決"
    },
    {
      "owasp": "A05:2021 - Security Misconfiguration",
      "requirement": "外部公開設定時のセキュリティ警告表示"
    }
  ]
}
