{
  "review_metadata": {
    "issue_number": 94,
    "stage": 4,
    "stage_name": "セキュリティレビュー",
    "focus_area": "OWASP Top 10",
    "design_doc_path": "dev-reports/design/issue-94-file-upload-design-policy.md",
    "reviewed_at": "2026-01-30T00:00:00Z",
    "reviewer": "architecture-review-agent"
  },
  "findings": [
    {
      "id": "SEC-001",
      "severity": "must_fix",
      "category": "MIMEタイプ検証",
      "owasp_category": "A04:2021 - Insecure Design",
      "description": "MIMEタイプ検証がクライアント提供のContent-Typeヘッダーのみに依存している。クライアントは任意のMIMEタイプを指定可能であり、実際のファイル内容と異なる可能性がある。例えば、実行可能コードを含むファイルをimage/pngとして送信可能。",
      "suggestion": "Magic bytes（ファイルシグネチャ）による実際のファイル形式検証を追加。file-type npmパッケージやカスタムシグネチャ検出の導入を推奨。最低限、画像ファイル（PNG: 89 50 4E 47, JPEG: FF D8 FF, GIF: 47 49 46等）のマジックバイト検証を実装すること。",
      "location": "セクション3.2 validateMimeType()、セクション4.3"
    },
    {
      "id": "SEC-002",
      "severity": "must_fix",
      "category": "SVGファイル",
      "owasp_category": "A03:2021 - Injection",
      "description": "SVGファイル（.svg）がアップロード対象に含まれているが、SVGはXML形式でありJavaScriptやイベントハンドラを埋め込み可能。Stored XSS攻撃のベクターとなりうる重大なセキュリティリスク。",
      "suggestion": "SVGファイルを許可リストから削除するか、アップロード時にDOMPurify等でサニタイズ処理を追加。SVGを許可する場合は、scriptタグ、onload等のイベントハンドラ、外部リソース参照（xlink:href）の除去が必須。代替案として、SVGをPNGにラスタライズしてから保存。",
      "location": "セクション3.2 UPLOADABLE_EXTENSION_VALIDATORS"
    },
    {
      "id": "SEC-003",
      "severity": "should_fix",
      "category": "DoS攻撃耐性",
      "owasp_category": "A05:2021 - Security Misconfiguration",
      "description": "bodySizeLimit変更（2MB→6MB）により全APIエンドポイントの受付サイズが増加。同時多数のアップロード要求によるメモリ枯渇攻撃のリスクが増大。設計書セクション4.5で認識されているが、具体的な制御策が不十分。",
      "suggestion": "1. レートリミット導入（同一IPからの単位時間あたりのアップロード数制限）、2. アップロードAPI専用のroute segment configで個別のbodySizeLimit設定（他APIは2MB維持）、3. 同時アップロード数の制限（セマフォ等）。設計書記載の「将来的改善案」を初期実装に含めることを推奨。",
      "location": "セクション4.5 [CONS-006]"
    },
    {
      "id": "SEC-004",
      "severity": "should_fix",
      "category": "ファイル名検証",
      "owasp_category": "A03:2021 - Injection",
      "description": "isValidNewName()の拡張で null bytes と改行文字をチェックしているが、その他の制御文字（0x01-0x08, 0x0B-0x0C, 0x0E-0x1F）のチェックが不足。また、WindowsやmacOSで禁止されている文字（<>:\"|?*等）のチェックがない。",
      "suggestion": "1. 制御文字（ASCII 0x00-0x1F）を全て拒否、2. OS固有の禁止文字チェック追加（<>:\"|?*）、3. ファイル名の先頭/末尾スペース・ドットの除去または拒否（Windows互換性）。editable-extensions.tsのcontrolCharPatternパターンを参考に一貫した検証を実装。",
      "location": "セクション4.2 isValidNewName()"
    },
    {
      "id": "SEC-005",
      "severity": "should_fix",
      "category": "エラーメッセージ",
      "owasp_category": "A01:2021 - Broken Access Control",
      "description": "エラーメッセージ「対応していないファイル形式です（.exe）」のように拡張子を返却する設計。攻撃者に許可/禁止リストの情報を与える可能性。また、セクション5.1で「ファイル選択ダイアログでエラー表示」とあるが、クライアント側検証のみでは容易にバイパス可能。",
      "suggestion": "1. サーバーエラーメッセージから具体的な拡張子情報を除去（「対応していないファイル形式です」のみ）、2. クライアント側検証は常にサーバー側検証と併用し、クライアント側はUX向上目的のみとして位置付け。サーバー側の検証が正として設計することを明記。",
      "location": "セクション5.1, 5.2"
    },
    {
      "id": "SEC-006",
      "severity": "should_fix",
      "category": "YAMLファイル",
      "owasp_category": "A03:2021 - Injection",
      "description": "YAMLファイル（.yaml, .yml）がアップロード対象に含まれている。YAMLはタグ構文（!ruby/object等）やアンカー/エイリアス機能により、デシリアライズ時にコード実行やDoSを引き起こす可能性がある（YAML Deserialization攻撃）。",
      "suggestion": "1. YAMLファイルのアップロード時に安全性検証を追加（!タグの検出と拒否）、2. アップロード後にYAML解析を行う処理がある場合はsafe_load相当のパーサー使用を徹底、3. アップロード用途を限定し、設定ファイル自動適用等は行わない設計を明記。",
      "location": "セクション3.2 UPLOADABLE_EXTENSION_VALIDATORS"
    },
    {
      "id": "SEC-007",
      "severity": "should_fix",
      "category": "JSONファイル",
      "owasp_category": "A08:2021 - Software and Data Integrity Failures",
      "description": "JSONファイルのアップロードは許可されているが、JSONの構文検証（valid JSON check）が設計に含まれていない。不正なJSONをアップロード後に処理しようとした際のエラーハンドリングが明確でない。",
      "suggestion": "1. JSONファイルアップロード時にJSON.parse()で構文検証を行い、不正な場合はエラー返却、2. 検証をオプションとする場合でも、ファイル整合性の観点から推奨設定として位置付け、3. サイズの大きなJSONによるJSON.parse() DoSにも注意（10MB制限があるので影響は限定的）。",
      "location": "セクション3.2"
    },
    {
      "id": "SEC-008",
      "severity": "nice_to_have",
      "category": "アクセス制御",
      "owasp_category": "A01:2021 - Broken Access Control",
      "description": "アップロードAPIのアクセス制御について、既存のworktreeアクセス権チェック（getWorktreeById）以上の言及がない。ユーザー認証・認可の観点で、誰がどのworktreeにアップロード可能かの設計が暗黙的。",
      "suggestion": "1. CM_AUTH_TOKENによる認証がアップロードAPIにも適用されることを明記、2. worktree単位のアクセス制御ポリシー（read-only worktreeへのアップロード禁止等）の検討、3. 将来的なマルチユーザー対応を見据えた認可設計の方針を記載。",
      "location": "セクション2.1, 3.1"
    },
    {
      "id": "SEC-009",
      "severity": "nice_to_have",
      "category": "ログ・監査",
      "owasp_category": "A09:2021 - Security Logging and Monitoring Failures",
      "description": "ファイルアップロードのログ記録に関する設計が記載されていない。誰が、いつ、どのファイルをアップロードしたかの監査証跡が残らない可能性。",
      "suggestion": "1. アップロード成功/失敗のログ出力設計を追加（ユーザー識別子、タイムスタンプ、ファイル名、サイズ、結果）、2. セキュリティ関連イベント（拒否された拡張子、MIMEタイプ不一致等）の警告ログ出力、3. 既存のlogger.tsパターンとの一貫性維持。",
      "location": "全体"
    },
    {
      "id": "SEC-010",
      "severity": "nice_to_have",
      "category": "ファイル整合性",
      "owasp_category": "A08:2021 - Software and Data Integrity Failures",
      "description": "アップロードされたファイルの整合性検証（チェックサム等）が設計に含まれていない。ネットワーク転送中の破損やストレージ書き込み後の検証がない。",
      "suggestion": "1. オプションでクライアント側でファイルハッシュを計算し、サーバー側で書き込み後に検証する機能を追加、2. レスポンスにファイルハッシュ（SHA-256等）を含め、クライアント側で検証可能にする、3. 初期実装では見送りでも、将来拡張として設計に言及。",
      "location": "セクション3.1 レスポンス"
    },
    {
      "id": "SEC-011",
      "severity": "nice_to_have",
      "category": "拡張子偽装",
      "owasp_category": "A04:2021 - Insecure Design",
      "description": "二重拡張子（file.png.exe）や隠し拡張子（file.png ）のチェックが明示されていない。extname()は最後の拡張子のみ返すため、二重拡張子の検出には不十分。",
      "suggestion": "1. ファイル名に複数のドットが含まれる場合の検証ルール明確化、2. 末尾空白の除去（Windowsでは表示されないが存在可能）、3. 既知の危険な二重拡張子パターン（.js.png等）の明示的拒否。",
      "location": "セクション4.2"
    }
  ],
  "security_score": 6,
  "summary": {
    "overall_assessment": "設計書は基本的なセキュリティ対策（パストラバーサル防止、拡張子ホワイトリスト、MIMEタイプ検証、ファイルサイズ制限）を網羅しているが、OWASP Top 10の観点からいくつかの重要な改善点が特定された。",
    "positive_aspects": [
      "既存のisPathSafe()による堅牢なパストラバーサル防止の再利用",
      "拡張子ホワイトリスト方式の採用（ブラックリスト排除）",
      "多層防御（API層とfile-operations層の両方で検証）の設計思想",
      "ファイルサイズ制限の明確な設定（5MB）",
      "エラーレスポンスから絶対パスを除外する設計",
      "bodySizeLimit変更の影響分析と軽減策の検討"
    ],
    "critical_concerns": [
      "MIMEタイプ検証がクライアント提供値のみに依存（マジックバイト検証なし）",
      "SVGファイル許可によるStored XSSリスク"
    ],
    "recommendations": [
      "SEC-001: マジックバイト検証の実装（必須）",
      "SEC-002: SVGファイルの削除またはサニタイズ処理（必須）",
      "SEC-003: レートリミットまたはアップロードAPI専用設定（推奨）",
      "SEC-004: ファイル名検証の強化（推奨）",
      "SEC-005: エラーメッセージの情報漏洩防止（推奨）"
    ],
    "owasp_coverage": {
      "A01_Broken_Access_Control": "部分的対応（worktree境界のパス検証あり、認可設計は暗黙的）",
      "A03_Injection": "要改善（パストラバーサルは対応、SVG/YAML/ファイル名は要強化）",
      "A04_Insecure_Design": "要改善（MIMEタイプ検証の根本的見直しが必要）",
      "A05_Security_Misconfiguration": "部分的対応（bodySizeLimit影響は認識済み、DoS対策は不十分）",
      "A08_Software_Data_Integrity": "未対応（ファイル整合性検証なし）"
    }
  }
}
