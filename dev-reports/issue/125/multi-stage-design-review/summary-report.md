# ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†å ±å‘Š

## Issue #125: ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã®.envèª­ã¿è¾¼ã¿

### åŸºæœ¬æƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| Issueç•ªå· | #125 |
| ãƒ¬ãƒ“ãƒ¥ãƒ¼æ—¥ | 2026-02-02 |
| å¯¾è±¡è¨­è¨ˆæ›¸ | dev-reports/design/issue-125-global-install-env-loading-design-policy.md |

---

## ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥çµæœ

| Stage | ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¨®åˆ¥ | æŒ‡æ‘˜æ•° | å¯¾å¿œæ•° | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|-------|------------|-------|-------|----------|
| 1 | é€šå¸¸ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆè¨­è¨ˆåŸå‰‡ï¼‰ | 6 | 6 | âœ… å®Œäº† |
| 2 | æ•´åˆæ€§ãƒ¬ãƒ“ãƒ¥ãƒ¼ | 7 | 7 | âœ… å®Œäº† |
| 3 | å½±éŸ¿åˆ†æãƒ¬ãƒ“ãƒ¥ãƒ¼ | 6 | 6 | âœ… å®Œäº† |
| 4 | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼ | 7 | 7 | âœ… å®Œäº† |
| **åˆè¨ˆ** | - | **26** | **26** | âœ… **å…¨å®Œäº†** |

---

## æŒ‡æ‘˜å†…å®¹ã‚µãƒãƒªãƒ¼

### Stage 1: é€šå¸¸ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆè¨­è¨ˆåŸå‰‡ï¼‰

| é‡è¦åº¦ | ID | åŸå‰‡ | å†…å®¹ | å¯¾å¿œ |
|--------|-----|------|------|------|
| Must Fix | MF-1 | DRY | getPidFilePath()ã®3ç®‡æ‰€é‡è¤‡ | env-setup.tsã«é›†ç´„ |
| Must Fix | MF-2 | DRY | ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿ã®è²¬å‹™é‡è¤‡ | daemon.tsã«ä¸€å…ƒåŒ– |
| Should Fix | SF-1 | SRP | startCommand()ã®è²¬å‹™åˆ†å‰² | ä»Šå¾Œã®æ¤œè¨äº‹é …ã«è¨˜éŒ² |
| Should Fix | SF-2 | OCP | isGlobalInstall()ã®ãƒ‘ã‚¿ãƒ¼ãƒ³å¤–éƒ¨åŒ– | ä»Šå¾Œã®æ¤œè¨äº‹é …ã«è¨˜éŒ² |
| Should Fix | SF-3 | DIP | DaemonManagerã¸ã®ä¾å­˜æ€§æ³¨å…¥ | ä»Šå¾Œã®æ¤œè¨äº‹é …ã«è¨˜éŒ² |
| Should Fix | SF-4 | KISS | EnvSetupã‚¯ãƒ©ã‚¹ã®è²¬å‹™åˆ†é›¢ | ä»Šå¾Œã®æ¤œè¨äº‹é …ã«è¨˜éŒ² |

### Stage 2: æ•´åˆæ€§ãƒ¬ãƒ“ãƒ¥ãƒ¼

| é‡è¦åº¦ | ID | ã‚«ãƒ†ã‚´ãƒª | å†…å®¹ | å¯¾å¿œ |
|--------|-----|---------|------|------|
| Must Fix | MF-1 | è¨­è¨ˆæ›¸ã¨æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®æ•´åˆæ€§ | JSDocã‚³ãƒ¡ãƒ³ãƒˆã®ç²¾åº¦ä¸è¶³ | ã‚³ãƒ¡ãƒ³ãƒˆä¿®æ­£ |
| Must Fix | MF-2 | è¨­è¨ˆæ›¸å†…ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ã®æ•´åˆæ€§ | daemon.tsã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æœªè¨­è¨ˆ | envResult.errorãƒã‚§ãƒƒã‚¯è¿½åŠ  |
| Must Fix | MF-3 | APIã‚·ã‚°ãƒãƒãƒ£ã®æ•´åˆæ€§ | DaemonManagerã®ã‚·ã‚°ãƒãƒãƒ£æ¤œè¨ä¸è¶³ | è¨­è¨ˆæ„å›³ã‚’æ˜è¨˜ |
| Should Fix | SF-1 | å‘½åè¦å‰‡ã®ä¸€è²«æ€§ | PID_FILEâ†’pidFilePathã®ç§»è¡Œ | camelCaseçµ±ä¸€ã‚’æ˜è¨˜ |
| Should Fix | SF-2 | ãƒ†ã‚¹ãƒˆè¨ˆç”»ã¨å®Ÿè£…ã®æ•´åˆæ€§ | ãƒ†ã‚¹ãƒˆæ¤œè¨¼æ–¹æ³•ã®ä¸æ˜ç¢ºã• | spawnãƒ¢ãƒƒã‚¯åŒ–æ‰‹æ³•ã‚’è¿½è¨˜ |
| Should Fix | SF-3 | ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ•´åˆæ€§ | ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä¸çµ±ä¸€ | ä»Šå¾Œã®æ¤œè¨äº‹é …ã«è¨˜éŒ² |
| Should Fix | SF-4 | è¨­è¨ˆæ›¸å†…ã®æ•´åˆæ€§ | å½±éŸ¿ãªã—ãƒ•ã‚¡ã‚¤ãƒ«ã®æ˜è¨˜ | init.tsã‚’å½±éŸ¿ãªã—ã¨ã—ã¦æ˜è¨˜ |

### Stage 3: å½±éŸ¿åˆ†æãƒ¬ãƒ“ãƒ¥ãƒ¼

| é‡è¦åº¦ | ID | ã‚«ãƒ†ã‚´ãƒª | å†…å®¹ | å¯¾å¿œ |
|--------|-----|---------|------|------|
| Must Fix | MF-1 | ä¾å­˜é–¢ä¿‚ã®å¤‰åŒ– | dotenvä¾å­˜ã®è¿½åŠ æ¼ã‚Œ | package.jsonã¸ã®è¿½åŠ ã‚’æ˜è¨˜ |
| Must Fix | MF-2 | æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿ | getStatus()ã®è¨­å®šå€¤å–å¾—å•é¡Œ | status.tsã§dotenvConfig()å‘¼ã³å‡ºã— |
| Should Fix | SF-1 | æ³¢åŠåŠ¹æœ | env-setup.tsã®è²¬å‹™å¢—åŠ  | å°†æ¥çš„ãªpaths.tsåˆ†é›¢ã‚’æ¤œè¨ |
| Should Fix | SF-2 | å¾Œæ–¹äº’æ›æ€§ | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹æœªå®šç¾© | CHANGELOG.mdç§»è¡Œæ‰‹é †ã‚’æ¤œè¨ |
| Should Fix | SF-3 | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | ãƒ•ã‚¡ã‚¤ãƒ«I/Oã®å¢—åŠ  | å¯¾å¿œä¸è¦ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ç„¡è¦–å¯èƒ½ï¼‰ |
| Should Fix | SF-4 | é‹ç”¨ãƒ»ä¿å®ˆ | ãƒ‡ãƒãƒƒã‚°å®¹æ˜“æ€§ | ãƒ­ã‚°ã«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹å‡ºåŠ›ã‚’æ¤œè¨ |

### Stage 4: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼

| é‡è¦åº¦ | ID | ã‚«ãƒ†ã‚´ãƒª | OWASP | å†…å®¹ | å¯¾å¿œ |
|--------|-----|---------|-------|------|------|
| Must Fix | MF-1 | ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«å¯¾ç­– | A01:2021 | ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯è§£æ±ºä¸è¶³ | fs.realpathSync()è¿½åŠ  |
| Must Fix | MF-2 | æ©Ÿå¯†æƒ…å ±ã®å–ã‚Šæ‰±ã„ | A05:2021 | å¤–éƒ¨å…¬é–‹æ™‚ã®è­¦å‘Šæ¬ å¦‚ | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Šè¿½åŠ  |
| Should Fix | SF-1 | ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ | A03:2021 | options.portã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ– | ä»Šå¾Œã®æ¤œè¨äº‹é …ã«è¨˜éŒ² |
| Should Fix | SF-2 | ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ | A05:2021 | æ—¢å­˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼ | ä»Šå¾Œã®æ¤œè¨äº‹é …ã«è¨˜éŒ² |
| Should Fix | SF-3 | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚° | A09:2021 | é‡è¦ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ­ã‚°è¿½åŠ  | ä»Šå¾Œã®æ¤œè¨äº‹é …ã«è¨˜éŒ² |
| Should Fix | SF-4 | èªè¨¼ãƒ»èªå¯ | A07:2021 | startæ™‚ã®ãƒˆãƒ¼ã‚¯ãƒ³å†æ¤œè¨¼ | ä»Šå¾Œã®æ¤œè¨äº‹é …ã«è¨˜éŒ² |
| Should Fix | SF-5 | å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ | A03:2021 | sanitizePath()ã«..ãƒã‚§ãƒƒã‚¯è¿½åŠ  | ä»Šå¾Œã®æ¤œè¨äº‹é …ã«è¨˜éŒ² |

---

## è¨­è¨ˆæ–¹é‡æ›¸ã®ä¸»ãªæ›´æ–°å†…å®¹

### Must Fixå¯¾å¿œï¼ˆ9ä»¶ï¼‰

1. **getPidFilePath()ã®env-setup.tsé›†ç´„** (Stage 1 MF-1)
2. **ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿è²¬å‹™ã®daemon.tsä¸€å…ƒåŒ–** (Stage 1 MF-2)
3. **JSDocã‚³ãƒ¡ãƒ³ãƒˆã®ç²¾åº¦å‘ä¸Š** (Stage 2 MF-1)
4. **envResult.errorã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¿½åŠ ** (Stage 2 MF-2)
5. **DaemonManagerã®ã‚·ã‚°ãƒãƒãƒ£è¨­è¨ˆæ„å›³æ˜è¨˜** (Stage 2 MF-3)
6. **dotenvãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä¾å­˜è¿½åŠ ** (Stage 3 MF-1)
7. **status.tsã§ã®dotenvConfig()å‘¼ã³å‡ºã—** (Stage 3 MF-2)
8. **ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«å¯¾ç­–ï¼ˆfs.realpathSync()ï¼‰** (Stage 4 MF-1)
9. **å¤–éƒ¨å…¬é–‹è¨­å®šæ™‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Š** (Stage 4 MF-2)

### æ–°è¦è¿½åŠ ã‚»ã‚¯ã‚·ãƒ§ãƒ³

- **è©³ç´°è¨­è¨ˆ > 2. ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«å¯¾ç­–**
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ**ï¼ˆOWASPæº–æ‹ çŠ¶æ³ã€å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼‰
- **ä¾å­˜é–¢ä¿‚ã®è¿½åŠ **ï¼ˆdotenvãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±ï¼‰
- **ãƒ†ã‚¹ãƒˆæ¤œè¨¼æ–¹æ³•**ï¼ˆspawnãƒ¢ãƒƒã‚¯åŒ–æ‰‹æ³•ï¼‰
- **ä»Šå¾Œã®æ¤œè¨äº‹é …**ï¼ˆå„Stage ã®Should Fixé …ç›®ï¼‰
- **ãƒ¬ãƒ“ãƒ¥ãƒ¼å±¥æ­´**

---

## ä»Šå¾Œã®æ¤œè¨äº‹é …ï¼ˆShould Fixï¼‰

### å„ªå…ˆåº¦: é«˜
- SF-4 (Stage 4): startæ™‚ã®0.0.0.0 + ãƒˆãƒ¼ã‚¯ãƒ³æœªè¨­å®šã®å†æ¤œè¨¼
- SF-3 (Stage 4): ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ãƒ»ç›£è¦–ã®å¼·åŒ–

### å„ªå…ˆåº¦: ä¸­
- SF-1 (Stage 1): startCommand()ã®è²¬å‹™åˆ†å‰²
- SF-3 (Stage 1): DaemonManagerã¸ã®ä¾å­˜æ€§æ³¨å…¥
- SF-1 (Stage 4): options.portã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–
- SF-5 (Stage 4): sanitizePath()ã«..ãƒã‚§ãƒƒã‚¯è¿½åŠ 

### å„ªå…ˆåº¦: ä½
- SF-2 (Stage 1): isGlobalInstall()ã®ãƒ‘ã‚¿ãƒ¼ãƒ³å¤–éƒ¨åŒ–
- SF-4 (Stage 1): EnvSetupã‚¯ãƒ©ã‚¹ã®è²¬å‹™åˆ†é›¢
- SF-2 (Stage 4): æ—¢å­˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼

---

## å¤‰æ›´å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ« | å¤‰æ›´å†…å®¹ |
|---------|---------|
| `src/cli/utils/env-setup.ts` | getPidFilePath()è¿½åŠ ã€ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«å¯¾ç­–è¿½åŠ  |
| `src/cli/commands/start.ts` | getEnvPath(), getPidFilePath()ä½¿ç”¨ã€ãƒ­ã‚°æ”¹å–„ |
| `src/cli/commands/stop.ts` | getPidFilePath()ä½¿ç”¨ |
| `src/cli/commands/status.ts` | getPidFilePath()ä½¿ç”¨ã€dotenvConfig()è¿½åŠ  |
| `src/cli/utils/daemon.ts` | dotenvèª­ã¿è¾¼ã¿ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Šè¿½åŠ  |
| `package.json` | dotenvä¾å­˜è¿½åŠ  |

---

## OWASP Top 10 æº–æ‹ çŠ¶æ³

| OWASPé …ç›® | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | å¯¾å¿œå†…å®¹ |
|-----------|----------|---------|
| A01: Broken Access Control | âœ… å¯¾å¿œæ¸ˆ | ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«å¯¾ç­–è¿½åŠ  |
| A02: Cryptographic Failures | âœ… æº–æ‹  | ï¼ˆå¤‰æ›´ãªã—ï¼‰ |
| A03: Injection | âœ… æ¦‚ã­æº–æ‹  | spawnå¼•æ•°é…åˆ—ä½¿ç”¨ç¶­æŒ |
| A05: Security Misconfiguration | âœ… å¯¾å¿œæ¸ˆ | å¤–éƒ¨å…¬é–‹è­¦å‘Šè¿½åŠ  |
| A07: Authentication Failures | ğŸ“‹ æ¤œè¨ä¸­ | ä»Šå¾Œã®æ¤œè¨äº‹é …ã«è¨˜éŒ² |
| A09: Logging Failures | ğŸ“‹ æ¤œè¨ä¸­ | ä»Šå¾Œã®æ¤œè¨äº‹é …ã«è¨˜éŒ² |

---

## æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

- [ ] è¨­è¨ˆæ–¹é‡æ›¸ã®æœ€çµ‚ç¢ºèª
- [ ] `/tdd-impl` ã¾ãŸã¯ `/pm-auto-dev` ã§å®Ÿè£…ã‚’é–‹å§‹
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆã®ä½œæˆ
- [ ] ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼
- [ ] PRä½œæˆ

---

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

### ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ
- `dev-reports/issue/125/multi-stage-design-review/stage1-review-result.json`
- `dev-reports/issue/125/multi-stage-design-review/stage2-review-result.json`
- `dev-reports/issue/125/multi-stage-design-review/stage3-review-result.json`
- `dev-reports/issue/125/multi-stage-design-review/stage4-review-result.json`

### å¯¾å¿œçµæœ
- `dev-reports/issue/125/multi-stage-design-review/stage1-apply-result.json`
- `dev-reports/issue/125/multi-stage-design-review/stage2-apply-result.json`
- `dev-reports/issue/125/multi-stage-design-review/stage3-apply-result.json`
- `dev-reports/issue/125/multi-stage-design-review/stage4-apply-result.json`

### è¨­è¨ˆæ–¹é‡æ›¸
- `dev-reports/design/issue-125-global-install-env-loading-design-policy.md`

---

*Generated by Multi-Stage Design Review Command*
*Date: 2026-02-02*
