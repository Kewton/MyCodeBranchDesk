---
model: opus
description: "Issue内容を分析し、ユーザーに質問しながら不足情報を補完・更新"
---

# Issue補完コマンド

## 概要

Issueの記載内容を分析し、不足しているセクションを特定し、ユーザーに質問して情報を収集した上でIssue本文を補完・更新するコマンドです。

> **目的**: タイトルのみ・本文が不十分なIssueを、ユーザーとの対話を通じて実装可能な品質まで引き上げる

## 使用方法

```bash
/issue-enhance [Issue番号]
```

**例**:
```bash
/issue-enhance 159
```

## 実行内容

あなたはIssue補完の専門家です。以下の4フェーズでIssue内容を分析・補完します。

### パラメータ

- **issue_number**: 対象Issue番号（必須）

---

## Phase 1: Issue読み込みと分析

### 1-1. Issue内容の取得

```bash
gh issue view {issue_number} --json title,body,labels
```

取得したIssue内容を確認し、現状の記載状況を把握する。

### 1-2. Issue種別の判定

以下の優先順位で種別を判定する：

1. **ラベルから判定**: `feature`, `bug`, `documentation`, `refactor` ラベルの有無
2. **タイトルprefixから判定**: `feat:`, `fix:`, `docs:`, `refactor:` 等の接頭辞
3. **タイトル内容から推測**: キーワード（「追加」「修正」「バグ」「不具合」「リファクタ」「ドキュメント」等）
4. **判定不能時**: AskUserQuestionでユーザーに質問

```
AskUserQuestion:
  question: "Issue #{issue_number} の種別を教えてください"
  header: "Issue種別"
  options:
    - label: "Feature（機能追加）"
      description: "新しい機能やUIの追加"
    - label: "Bug Fix（バグ修正）"
      description: "既存機能の不具合修正"
    - label: "Refactor（リファクタリング）"
      description: "機能変更なしのコード改善"
    - label: "Docs（ドキュメント）"
      description: "ドキュメントの追加・更新"
```

### 1-3. 必須セクションチェック

種別に応じた必須セクションの充足状況を確認する。

**Feature (feat)**:
| セクション | 必須度 | チェック内容 |
|-----------|--------|-------------|
| 概要 | 必須 | 何を実現する機能か |
| 背景・課題 | 必須 | なぜこの機能が必要か |
| 提案する解決策 | 必須 | どう実装するか（方針レベル） |
| 実装タスク | 推奨 | 具体的な作業ステップ |
| 受入条件 | 必須 | 完了の判定基準 |
| 影響範囲 | 推奨 | 変更の波及先 |

**Bug Fix (fix)**:
| セクション | 必須度 | チェック内容 |
|-----------|--------|-------------|
| 概要 | 必須 | どのような不具合か |
| 再現手順 | 必須 | 不具合の再現方法 |
| 期待する動作 | 必須 | 本来どう動作すべきか |
| 実際の動作 | 必須 | 現在どう動作しているか |
| 根本原因の仮説 | 推奨 | 原因の見当 |
| 対策案 | 推奨 | 修正方針 |
| 影響範囲 | 推奨 | 修正の波及先 |

**Refactor (refactor)**:
| セクション | 必須度 | チェック内容 |
|-----------|--------|-------------|
| 概要 | 必須 | 何をリファクタリングするか |
| 背景・動機 | 必須 | なぜリファクタリングが必要か |
| リファクタリング方針 | 必須 | どのように改善するか |
| 影響範囲 | 推奨 | 変更の波及先 |
| 受入条件 | 必須 | 完了の判定基準 |

**Docs (docs)**:
| セクション | 必須度 | チェック内容 |
|-----------|--------|-------------|
| 概要 | 必須 | 何のドキュメントか |
| 更新対象ドキュメント | 必須 | どのファイルを変更するか |
| 更新内容 | 必須 | 何を追加・修正するか |

不足セクションのリストを作成する。すでに記載されている内容は「充足」として保持する。

---

## Phase 2: コードベース調査

### 2-1. 関連コンポーネントの特定

Issue内（タイトル・本文）で言及されているファイル、コンポーネント、機能名を抽出する。

### 2-2. コードベース調査

Explore agentを使用して関連コードを調査する。

```
Task (Explore agent):
  Issue #{issue_number} に関連するコードベースを調査してください。

  調査対象:
  - Issue内で言及されたファイル/コンポーネント
  - 関連する型定義、API、ユーティリティ
  - 既存の類似実装パターン

  出力:
  - 関連ファイルのリスト（パスと概要）
  - 現在の実装状況のサマリー
  - 影響を受ける可能性のあるファイル
```

### 2-3. 調査結果の蓄積

コードベース調査の結果を整理し、Phase 3の質問とPhase 4の本文生成で活用する素材として保持する。

---

## Phase 3: ユーザーへの質問

### 3-1. 質問の構成

Phase 1で特定した不足セクションについて、ユーザーに質問する。

**質問のルール**:
- AskUserQuestionの制限（1回あたり最大4問）を考慮し、重要度の高い「必須」セクションから優先的に質問
- 不足セクションが5つ以上の場合、複数回に分けて質問
- コードベース調査結果から推測できる内容は選択肢として提示（ユーザーの負担軽減）
- 各質問には、Issue種別に応じた具体的なガイダンスを含める

### 3-2. Issue種別ごとの質問テンプレート

#### Feature (feat) の場合

**質問ラウンド1（核心）**:

```
AskUserQuestion (最大4問、不足セクションに応じて選択):

Q1（背景・課題が不足時）:
  question: "この機能が必要になった背景・課題は何ですか？"
  header: "背景"
  options:
    - label: "{コードベース調査から推測される背景1}"
      description: "{詳細}"
    - label: "{コードベース調査から推測される背景2}"
      description: "{詳細}"
    - label: "UXの改善"
      description: "ユーザー体験を向上させるため"
    - label: "技術的制約の解消"
      description: "現在の実装の制約を解消するため"

Q2（解決策が不足時）:
  question: "どのような実装方針を考えていますか？"
  header: "実装方針"
  options:
    - label: "{コードベース調査から推測される方針1}"
      description: "{詳細}"
    - label: "{コードベース調査から推測される方針2}"
      description: "{詳細}"
    - label: "おまかせ"
      description: "コードベース調査結果を元にClaude Codeが提案"

Q3（受入条件が不足時）:
  question: "完了条件として重要なポイントは何ですか？"
  header: "受入条件"
  options:
    - label: "動作すればOK"
      description: "基本的な機能が動作すること"
    - label: "テスト必須"
      description: "ユニットテストとE2Eテストが必要"
    - label: "パフォーマンス要件あり"
      description: "レスポンス時間等の要件がある"

Q4（影響範囲が不足時）:
  question: "この変更の影響範囲で気になる点はありますか？"
  header: "影響範囲"
  options:
    - label: "特になし"
      description: "コードベース調査結果に任せる"
    - label: "既存UIへの影響"
      description: "既存の画面表示に影響がある"
    - label: "API互換性"
      description: "既存APIとの互換性に注意が必要"
    - label: "データベース変更"
      description: "DBスキーマの変更を伴う"
```

#### Bug Fix (fix) の場合

**質問ラウンド1（核心）**:

```
AskUserQuestion (最大4問、不足セクションに応じて選択):

Q1（再現手順が不足時）:
  question: "バグの再現手順を教えてください"
  header: "再現手順"
  options:
    - label: "特定の操作で発生"
      description: "特定の手順を踏むと再現する"
    - label: "ランダムに発生"
      description: "不定期に発生し、確実な再現方法が不明"
    - label: "特定環境のみ"
      description: "特定のブラウザ/OS/デバイスでのみ発生"

Q2（期待する動作が不足時）:
  question: "本来どのように動作すべきですか？"
  header: "期待動作"
  options:
    - label: "{コードベースから推測される正常動作1}"
      description: "{詳細}"
    - label: "{コードベースから推測される正常動作2}"
      description: "{詳細}"

Q3（実際の動作が不足時）:
  question: "現在どのような動作になっていますか？"
  header: "実際の動作"
  options:
    - label: "エラーが表示される"
      description: "エラーメッセージやスタックトレースがある"
    - label: "表示が崩れる"
      description: "UIが正しく表示されない"
    - label: "機能しない"
      description: "操作しても反応がない/動作しない"
    - label: "データの不整合"
      description: "データが正しく保存/表示されない"

Q4（根本原因が不足時）:
  question: "原因について心当たりはありますか？"
  header: "原因仮説"
  options:
    - label: "{コードベース調査から推測される原因1}"
      description: "{詳細}"
    - label: "{コードベース調査から推測される原因2}"
      description: "{詳細}"
    - label: "心当たりなし"
      description: "原因は不明"
```

#### Refactor / Docs の場合

不足セクションに応じて同様に質問を構成する（上記テンプレートを参考に種別に合わせた質問を生成）。

### 3-3. 追加質問（必要な場合）

1回目の質問で得られた回答を踏まえ、さらに詳細が必要な場合は追加ラウンドを実施する。
ただし、質問回数は**最大3ラウンド**までとし、過度な質問でユーザーの負担を増やさない。

---

## Phase 4: Issue本文生成・更新

### 4-1. 情報の統合

以下の3つの情報源を統合する：

1. **既存のIssue内容**: すでに記載されている情報はそのまま保持
2. **コードベース調査結果**: 関連ファイル、影響範囲、実装パターン
3. **ユーザーの回答**: Phase 3で収集した情報

### 4-2. Issue本文の生成

Issue種別に応じたテンプレートに沿ってIssue本文を生成する。

#### Feature テンプレート

```markdown
## 概要

{概要}

## 背景・課題

{背景・課題}

## 提案する解決策

{実装方針}

### 主要な変更点

- {変更点1}
- {変更点2}

## 実装タスク

- [ ] {タスク1}
- [ ] {タスク2}
- [ ] {タスク3}

## 受入条件

- [ ] {条件1}
- [ ] {条件2}
- [ ] {条件3}

## 影響範囲

### 変更対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| {ファイル1} | {内容} |
| {ファイル2} | {内容} |

### 関連コンポーネント

- {コンポーネント1}
- {コンポーネント2}
```

#### Bug Fix テンプレート

```markdown
## 概要

{概要}

## 再現手順

1. {手順1}
2. {手順2}
3. {手順3}

## 期待する動作

{期待する動作}

## 実際の動作

{実際の動作}

## 根本原因の仮説

{原因仮説}

## 対策案

{対策案}

## 影響範囲

### 変更対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| {ファイル1} | {内容} |

### 関連コンポーネント

- {コンポーネント1}
```

#### Refactor テンプレート

```markdown
## 概要

{概要}

## 背景・動機

{背景・動機}

## リファクタリング方針

{方針}

### Before / After

**Before**:
- {現状の問題点}

**After**:
- {改善後の状態}

## 影響範囲

| ファイル | 変更内容 |
|---------|---------|
| {ファイル1} | {内容} |

## 受入条件

- [ ] {条件1}
- [ ] {条件2}
- [ ] 既存テストがすべてパスすること
```

#### Docs テンプレート

```markdown
## 概要

{概要}

## 更新対象ドキュメント

| ファイル | 更新内容 |
|---------|---------|
| {ファイル1} | {内容} |

## 更新内容

{更新内容の詳細}
```

### 4-3. ユーザー確認

生成したIssue本文をユーザーに提示し、更新前に確認を取る。

```
AskUserQuestion:
  question: "以下の内容でIssue #{issue_number} を更新してよろしいですか？（上記に生成内容を表示済み）"
  header: "更新確認"
  options:
    - label: "更新する"
      description: "この内容でGitHub Issueを更新"
    - label: "修正してから更新"
      description: "一部修正したい箇所がある"
    - label: "キャンセル"
      description: "更新せずに終了"
```

**「修正してから更新」の場合**: ユーザーの修正指示を受けて本文を調整し、再度確認。

### 4-4. GitHub Issue更新

```bash
gh issue edit {issue_number} --body "$(cat <<'ISSUE_BODY'
{生成したIssue本文}
ISSUE_BODY
)"
```

### 4-5. 完了報告

```
Issue #{issue_number} を更新しました。

更新URL: https://github.com/Kewton/CommandMate/issues/{issue_number}

補完されたセクション:
- {セクション1}
- {セクション2}
- {セクション3}

次のアクション:
- /multi-stage-issue-review {issue_number} でIssueレビューを実施
- /design-policy で設計方針を策定
- /work-plan {issue_number} で作業計画を立案
```

---

## 完了条件

以下をすべて満たすこと：

- Issue種別が判定されている
- コードベース調査が完了している
- ユーザーへの質問が完了している
- 生成したIssue本文をユーザーが確認している
- GitHub Issueが更新されている
- 完了報告が表示されている

---

## 関連コマンド

- `/multi-stage-issue-review`: Issue内容の多段階レビュー
- `/design-policy`: 設計方針策定
- `/work-plan`: 作業計画立案
- `/pm-auto-dev`: 自動開発フロー
