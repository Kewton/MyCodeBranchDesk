{"body":"## 概要\n\n新規セッション開始時に、最初のメッセージがClaude CLIに正しく送信されないケースが多発している。2回目以降のメッセージは正常に送信される。\n\n## 再現手順\n\n1. CommandMateでWorktreeを選択（Claude CLIセッション未起動の状態）\n2. メッセージを入力して送信\n3. APIは201を返すが、Claude CLIがメッセージを受け取らない\n\n## 期待する動作\n\n初回メッセージもClaude CLIに確実に送信・処理されること。\n\n## 原因分析\n\n### 問題点1（最重要）: `sendMessageToClaude()` でプロンプト検出後の安定化待機がない\n\n**ファイル**: `src/lib/claude-session.ts` L374-393\n\n`startClaudeSession()` ではプロンプト検出後に `CLAUDE_POST_PROMPT_DELAY`（500ms）の安定化待機を行っているが、`sendMessageToClaude()` 内の `waitForPrompt()` 復帰後には安定化待機がない。\n\n```typescript\n// startClaudeSession() - 安定化待機あり ✅\nif (CLAUDE_PROMPT_PATTERN.test(cleanOutput) || ...) {\n    await new Promise(resolve => setTimeout(resolve, CLAUDE_POST_PROMPT_DELAY)); // 500ms\n    break;\n}\n\n// sendMessageToClaude() - 安定化待機なし ❌\nif (!CLAUDE_PROMPT_PATTERN.test(stripAnsi(output))) {\n    try {\n        await waitForPrompt(sessionName, 10000); // 検出直後にreturn\n    } catch {\n        console.warn(`Prompt not detected, sending anyway`);\n    }\n}\n// 安定化待機なしで直ちに sendKeys 実行\nawait sendKeys(sessionName, message, false);\nawait sendKeys(sessionName, '', true);\n```\n\n**影響**: `startClaudeSession()` がセパレータで早期復帰した場合、`sendMessageToClaude()` 側で初めてプロンプトを検出し、検出直後に即座にメッセージを送信。Claude CLIの入力ハンドラが未完了の状態でキーが送られ、メッセージが消失する。\n\n### 問題点2: `startClaudeSession()` のセパレータ早期検出\n\n**ファイル**: `src/lib/claude-session.ts` L325\n\n```typescript\nif (CLAUDE_PROMPT_PATTERN.test(cleanOutput) || CLAUDE_SEPARATOR_PATTERN.test(cleanOutput)) {\n```\n\n`CLAUDE_SEPARATOR_PATTERN`（`^─{10,}$`）がプロンプトより先に出現する場合、プロンプト未出現のまま `startClaudeSession()` が復帰する。\n\n### 問題点3: タイムアウト時の送信強行\n\n**ファイル**: `src/lib/claude-session.ts` L380-386\n\n```typescript\ntry {\n    await waitForPrompt(sessionName, 10000);\n} catch {\n    console.warn(`Prompt not detected, sending anyway`);\n}\n```\n\n10秒のタイムアウト後、プロンプト未検出でもメッセージを強制送信する。\n\n### 問題点4: 入力エリアのクリアなしでのメッセージ送信\n\n**ファイル**: `src/lib/claude-session.ts` L390-391\n\n送信前に入力エリアの既存テキストをクリアする処理がない。Claude CLIがサジェスト（例: `❯ /help`）を表示中の場合、メッセージが結合される可能性がある。\n\n### 問題点5: `stripAnsi` の不完全なエスケープシーケンス除去\n\n**ファイル**: `src/lib/cli-patterns.ts` L167\n\n```typescript\nconst ANSI_PATTERN = /\\x1b\\[[0-9;]*[a-zA-Z]|\\x1b\\][^\\x07]*\\x07|\\[[0-9;]*m/g;\n```\n\nDEC Private Mode（`\\x1b[?25h` 等）に未対応。残存したシーケンスがプロンプトパターンの `^` アンカーとの一致を妨げる可能性がある（影響は限定的）。\n\n## 改善案\n\n| 優先度 | 対策 | 対象ファイル |\n|--------|------|-------------|\n| **P0** | `sendMessageToClaude()` 内で `waitForPrompt()` 復帰後に `CLAUDE_POST_PROMPT_DELAY` を適用 | `claude-session.ts` |\n| **P0** | `sendMessageToClaude()` 内でプロンプト即検出時にも安定化待機を適用（初回判定） | `claude-session.ts` |\n| **P1** | `startClaudeSession()` の初期化判定からセパレータパターンを除外（プロンプトのみで判定） | `claude-session.ts` |\n| **P1** | タイムアウト時の送信強行をエラースローに変更 | `claude-session.ts` |\n| **P2** | メッセージ送信前に `Ctrl+U` でClaude CLI入力エリアをクリア | `claude-session.ts` |\n| **P2** | `stripAnsi` のDEC Private Mode対応 | `cli-patterns.ts` |\n\n## 初回のみ失敗する理由\n\n2回目以降はClaude CLIが完全に初期化済みで、プロンプト状態が安定しているため問題が発生しない。初回は `startClaudeSession()` → `sendMessageToClaude()` の流れでプロンプト検出と安定化のタイミングにギャップが生じ、入力ハンドラが未準備の状態でメッセージが送信される。\n\n## 関連\n\n- Issue #152（セッション初回メッセージ送信の信頼性向上）- 同様の問題に対する過去の改善\n- `src/lib/claude-session.ts` - コア実装\n- `src/lib/cli-patterns.ts` - パターン定義","title":"fix: セッション初回メッセージが送信されないケースが多発する"}
