{"body":"## 概要\n\n既にディレクトリが存在するルートディレクトリに新しいディレクトリを追加しようとすると、エラーメッセージが表示されて作成できない。\n\n## 再現手順\n\n1. Worktree詳細画面でファイルツリーを表示する\n2. ルートディレクトリに1つ以上のディレクトリが既に存在する状態にする\n3. ルートレベルの「New Directory」ボタンをクリックする\n4. プロンプトでディレクトリ名を入力してOKを押す\n5. → エラーメッセージが表示され、ディレクトリが作成されない\n\n## 期待する動作\n\n- 既存ディレクトリの有無に関係なく、ルートディレクトリに新しいディレクトリを作成できる\n- 同名のディレクトリが存在する場合のみエラーとなる\n\n## 実際の動作\n\n- 既にディレクトリが1つ以上存在するルートディレクトリでは、新しいディレクトリの作成がエラーとなる\n\n## 根本原因の仮説\n\n### 仮説1: パス検証ロジックの問題\n\n`src/lib/path-validator.ts:29-68` の `isPathSafe()` で、ルートレベルのパス処理に問題がある可能性。\n\n- ルートの「New Directory」ボタンは `onNewDirectory('')` でparentPath=''を渡す（`FileTreeView.tsx:843`）\n- `handleNewDirectory()`（`WorktreeDetailRefactored.tsx:1271-1295`）で `parentPath ? parentPath/dirName : dirName` としてパスを構成\n- API呼び出し時に `encodeURIComponent(newPath)` でエンコードされるが、`[...path]` のNext.js catchallルートとの組み合わせで意図しないパスになる可能性\n\n### 仮説2: createFileOrDirectory()の既存チェック\n\n`src/lib/file-operations.ts:298-335` の `createFileOrDirectory()` で `existsSync(fullPath)` による既存チェックが、親ディレクトリのパスに対して実行されている可能性。\n\n### 仮説3: getWorktreeAndValidatePath()のパス解決\n\n`src/app/api/worktrees/[id]/files/[...path]/route.ts:96-123` で `pathSegments.join('/')` やpath.normalize()の処理過程で、既存ディレクトリと衝突する結果になる可能性。\n\n## 対策案\n\n1. **エラーレスポンスの詳細確認**: ブラウザDevToolsでAPIレスポンスの実際のエラーコード（`FILE_EXISTS` / `INVALID_PATH`）を特定\n2. **パス検証ロジックの修正**: `isPathSafe()` または `getWorktreeAndValidatePath()` のルートレベルパス処理を修正\n3. **エラーハンドリング改善**: `handleNewDirectory()` でエラーコードに応じた具体的なメッセージを表示\n\n## 影響範囲\n\n### 変更対象ファイル（候補）\n\n| ファイル | 変更内容 |\n|---------|---------|\n| `src/lib/path-validator.ts` | isPathSafe()のルートレベルパス処理修正 |\n| `src/lib/file-operations.ts` | createFileOrDirectory()の既存チェック修正 |\n| `src/app/api/worktrees/[id]/files/[...path]/route.ts` | パス検証・エラーレスポンス改善 |\n| `src/components/worktree/WorktreeDetailRefactored.tsx` | handleNewDirectory()のエラーハンドリング改善 |\n| `tests/unit/lib/file-operations.test.ts` | ルートレベルディレクトリ作成のテスト追加 |\n| `tests/unit/path-validator.test.ts` | isPathSafeのエッジケーステスト追加 |\n\n### 関連コンポーネント\n\n- `src/components/worktree/FileTreeView.tsx`（New Directoryボタン）\n- `src/components/worktree/ContextMenu.tsx`（右クリックメニュー）","title":"ルートディレクトリにディレクトリを追加出来ない"}
