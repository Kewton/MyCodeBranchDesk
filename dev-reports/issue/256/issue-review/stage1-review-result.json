{
  "issue_number": 256,
  "focus_area": "通常",
  "iteration": 1,
  "stage": 1,
  "review_date": "2026-02-13",
  "summary": {
    "must_fix_count": 1,
    "should_fix_count": 4,
    "nice_to_have_count": 2
  },
  "findings": {
    "must_fix": [
      {
        "id": "MF-1",
        "category": "技術的妥当性",
        "issue": "Pattern 4（末尾句読点に依存しないキーワードチェック）の追加はSEC-001bの防御機能を大幅に緩和し、False Positive（通常の番号付きリストの誤検出）リスクを発生させる",
        "location": "## 対策案 > 具体的な修正案",
        "recommendation": "Pattern 4を無条件に追加するのではなく、(A) questionEndIndexから上方に走査して?/キーワードを含む行を探索する方法、または (B) hasDefaultIndicator（❯指標の有無）との組み合わせ判定、のいずれかの代替案を採用すべき。Issueの「注意」セクションで代替案に言及しているが、対策案の「具体的な修正案」セクションはPattern 4を無条件追加する形で記載されており、最終的にどちらを採用するかが明確でない",
        "evidence": "現行のSEC-001bは `isQuestionLikeLine()` でFalse Positiveを防いでいる（Issue #208設計ポリシー参照）。Pattern 4を追加した場合、QUESTION_KEYWORD_PATTERNにはtype, how, where, option等の汎用的なキーワードが含まれるため、例えば 'The following types of changes were made.' + 番号付きリスト や 'Here are the options available.' + 番号付きリスト のような通常出力がmultiple_choiceプロンプトとして誤検出される。特にAuto-Yes機能が有効な場合、誤検出は自動応答の誤送信につながるため、セキュリティ上の影響が大きい。既存テストT11h-T11mで保護されている False Positive 防止ケース（Recommendations:, Steps:, Changes Made:, Completed tasks:, I did the following:）のうち、T11mの 'I did the following:' はPattern 2（:終端）で保護されていたが、Pattern 4追加後はキーワードに依存せず任意の行にマッチする可能性がある"
      }
    ],
    "should_fix": [
      {
        "id": "SF-1",
        "category": "完全性",
        "issue": "パターンBのmodel選択プロンプトはrequireDefaultIndicator=true（デフォルト）で処理されるケースについての考慮が不足",
        "location": "## 失敗パターンB: 質問形式でないプロンプト",
        "recommendation": "model選択プロンプト（/modelコマンド）が❯指標を含む場合（`❯ 1. Default (recommended)`の形式）、requireDefaultIndicator=trueのパスではSEC-001bガードが適用されない（L514 `if (!requireDefault)` ブロック内のため）。この場合、Pass 1/Pass 2/Layer 3/Layer 4の各チェックは通過するため、本来検出される可能性がある。Issueの再現手順のmodel選択プロンプトの例には❯指標があるため、requireDefault=true（Codex/Gemini）ではSEC-001bが適用されず検出される可能性がある一方、requireDefault=false（Claude）ではSEC-001bが適用されて検出失敗する。この場合分けをIssueに明記すべき",
        "evidence": "src/lib/prompt-detector.ts L514: `if (!requireDefault)` - SEC-001bはrequireDefault=falseの場合のみ適用。src/lib/cli-patterns.ts L271: Claudeのみ `requireDefaultIndicator: false`。パターンBのmodel選択例には `❯ 1. Default (recommended)` があり、requireDefault=trueのパスではLayer 5をスキップする"
      },
      {
        "id": "SF-2",
        "category": "完全性",
        "issue": "パターンAの「不定期発生の理由」に関する追加テストケースの記載が不足",
        "location": "## 受入条件",
        "recommendation": "受入条件にはパターンA（「。」終端）とパターンB（model選択形式）のテストケースが記載されているが、以下のエッジケースのテストも必要: (1) 1行に収まる場合（末尾が「？」で正常検出される既存動作の回帰テスト）、(2) 折り返し位置が「?」の直前で折り返される場合（行中に「?」が含まれるケース）、(3) 句点「。」以外の日本語句読点（「、」等）で終わる行のケース",
        "evidence": "Issueの「不定期発生の理由」に「ターミナル幅や質問文の長さに依存。1行に収まれば末尾が？なので検出成功。」と記載があるが、このケースの回帰テストが受入条件に明示されていない"
      },
      {
        "id": "SF-3",
        "category": "明確性",
        "issue": "修正案のPattern 2（行内に?/？を含むかチェック）のFalse Positiveリスクが未評価",
        "location": "## 対策案 > 具体的な修正案",
        "recommendation": "Pattern 2（line.includes('?') || line.includes('\\uff1f')）は、質問文以外の文脈で?が含まれる行もtrueを返す。例: 'See README.md for details? No, check CHANGELOG instead.' のような行や、URLパラメータを含む行（'https://example.com/api?key=value'）が質問行として誤判定される可能性がある。Pattern 2のFalse Positiveリスクの評価と、必要に応じた追加ガード（例: 行末近くに?があるかの位置チェック）を検討すべき",
        "evidence": "現行のPattern 1は `line.endsWith('?')` で末尾一致のため安全だが、提案のPattern 2は `line.includes('?')` で行内任意位置にマッチする。isContinuationLine()のendsWithQuestion条件（L388）は末尾一致のみで、行中の?は考慮していないため、isQuestionLikeLine()内での行中?チェックは新しい判定軸となる"
      },
      {
        "id": "SF-4",
        "category": "受け入れ条件",
        "issue": "isContinuationLine()との相互作用についてのテストケースが受入条件に含まれていない",
        "location": "## 受入条件",
        "recommendation": "パターンBのmodel選択プロンプトのように、質問行（`Select model`や`Switch between...`）がインデントされている場合、isContinuationLine()のhasLeadingSpaces条件でcontinuation lineとして扱われる可能性がある（L389: 2スペース以上のインデント + 非数字開始）。この場合、questionEndIndexが正しく設定されない可能性があり、テストが必要。受入条件に「インデントされた質問行がcontinuation lineとして誤分類されないこと」を追加すべき",
        "evidence": "パターンBの例では ` Select model` と `Switch between...` が先頭にスペースを持つ。isContinuationLine() L389: `const hasLeadingSpaces = /^\\s{2,}[^\\d]/.test(rawLine) && !/^\\s*\\d+\\./.test(rawLine) && !endsWithQuestion;` - 「。」や「.」で終わる行はendsWithQuestionがfalseのためhasLeadingSpacesのガードが効かない"
      }
    ],
    "nice_to_have": [
      {
        "id": "NTH-1",
        "category": "完全性",
        "issue": "関連Issueへのリンクが不足",
        "location": "Issue本文",
        "recommendation": "Issue #208（SEC-001b導入）、Issue #193（requireDefaultIndicator導入）、Issue #161（2パス検出導入）への明示的なリンクを追加すると、変更の文脈が理解しやすくなる"
      },
      {
        "id": "NTH-2",
        "category": "完全性",
        "issue": "PromptPanelおよびMobilePromptSheetへの影響確認が影響範囲に記載されているが、UI側での表示確認の受入条件がない",
        "location": "## 受入条件",
        "recommendation": "プロンプト検出が成功した場合のUI表示確認（デスクトップのPromptPanelとモバイルのMobilePromptSheetで質問文と選択肢が正しく表示されること）を手動テスト観点として追加すると網羅性が向上する"
      }
    ]
  },
  "code_references": [
    {
      "file": "src/lib/prompt-detector.ts",
      "lines": "L294, L315-332, L381-395, L510-529",
      "relevance": "修正対象: isQuestionLikeLine()関数、QUESTION_KEYWORD_PATTERN、isContinuationLine()、Layer 5 SEC-001bガード"
    },
    {
      "file": "src/lib/cli-patterns.ts",
      "lines": "L267-273",
      "relevance": "buildDetectPromptOptions(): Claude用にrequireDefaultIndicator=falseを返す"
    },
    {
      "file": "src/lib/status-detector.ts",
      "lines": "L141-142",
      "relevance": "detectSessionStatus()内でdetectPrompt()を呼び出し、hasActivePromptを判定"
    },
    {
      "file": "src/app/api/worktrees/[id]/current-output/route.ts",
      "lines": "L93-94",
      "relevance": "API応答でdetectPrompt()を呼び出し、promptDataを返す"
    }
  ],
  "doc_references": [
    {
      "file": "dev-reports/design/issue-208-auto-yes-numbered-list-false-positive-design-policy.md",
      "relevance": "SEC-001bの設計ポリシー・QUESTION_KEYWORD_PATTERNの設計根拠"
    },
    {
      "file": "CLAUDE.md",
      "relevance": "prompt-detector.tsのモジュール説明にisQuestionLikeLine()の記載あり"
    }
  ]
}
