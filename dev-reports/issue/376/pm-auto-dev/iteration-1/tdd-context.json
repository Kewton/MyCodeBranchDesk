{
  "issue_number": 376,
  "issue_title": "fix: External Apps proxy strips pathPrefix causing Bad Gateway for basePath-configured apps",
  "acceptance_criteria": [
    "http://localhost:3000/proxy/{pathPrefix}/ 経由でbasePath設定済みアプリにアクセスできる",
    "ヘルスチェックが正常に動作する",
    "既存のテストが通る",
    "新規テストが追加されパスする",
    "TypeScript エラーなし（npx tsc --noEmit）",
    "ESLint エラーなし（npm run lint）"
  ],
  "implementation_tasks": [
    "Task 1.1: src/app/proxy/[...path]/route.ts の path構築ロジック修正 - const [pathPrefix, ...rest] を const [pathPrefix] に変更し、path = '/proxy/' + pathSegments.join('/') に修正",
    "Task 1.2: src/lib/proxy/logger.ts の二重プレフィックス修正 - logProxyRequest()とlogProxyError()のメッセージ構築からpathPrefix手動結合を除去、JSDoc更新",
    "Task 1.3: src/lib/proxy/handler.ts のコメント・JSDoc更新（buildUpstreamUrl()とproxyHttp()のコメント修正）",
    "Task 2.1: tests/unit/proxy/logger.test.ts のテストデータ更新（path値をフルパス形式に変更、'should format log message correctly'テストのCIパス確保）",
    "Task 2.2: tests/unit/proxy/handler.test.ts のコメント更新と新規テスト追加（buildUpstreamUrlにフルパス対応テスト追加）",
    "Task 2.3: tests/unit/proxy/route.test.ts の新規統合テスト作成（pathPrefix保持動作・ログ出力検証）"
  ],
  "target_files": [
    "src/app/proxy/[...path]/route.ts",
    "src/lib/proxy/handler.ts",
    "src/lib/proxy/logger.ts",
    "tests/unit/proxy/logger.test.ts",
    "tests/unit/proxy/handler.test.ts",
    "tests/unit/proxy/route.test.ts"
  ],
  "target_coverage": 80,
  "design_policy_path": "dev-reports/design/issue-376-proxy-pathprefix-fix-design-policy.md",
  "work_plan_path": "dev-reports/issue/376/work-plan.md",
  "key_changes": {
    "route_ts": {
      "line": 31,
      "before": "const [pathPrefix, ...rest] = pathSegments;\nconst path = '/' + rest.join('/');",
      "after": "const [pathPrefix] = pathSegments;\nconst path = '/proxy/' + pathSegments.join('/');"
    },
    "logger_ts_line60": {
      "before": "`[Proxy] ${entry.method} /proxy/${entry.pathPrefix}${entry.path}`",
      "after": "`[Proxy] ${entry.method} ${entry.path}`"
    },
    "logger_ts_line88": {
      "before": "`[Proxy] ${method} /proxy/${pathPrefix}${path} failed: ${error.message}`",
      "after": "`[Proxy] ${method} ${path} failed: ${error.message}`"
    },
    "logger_test_ts_line138": {
      "before": "path: '/api/data'",
      "after": "path: '/proxy/app-streamlit/api/data'"
    }
  }
}
