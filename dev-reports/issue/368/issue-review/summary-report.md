# Issue #368 マルチステージレビュー完了報告

## レビュー日時
- 開始: 2026-02-25
- 完了: 2026-02-25

## 仮説検証結果（Phase 0.5）

| # | 仮説/主張 | 判定 |
|---|----------|------|
| 1 | `CLI_TOOL_IDS` に `['claude', 'codex', 'gemini']` が定義されている | Confirmed |
| 2 | UIでは `claude` と `codex` のみハードコード表示（L1795, L2081） | Confirmed |
| 3 | CMATEタブが `NotesAndLogsPane.tsx` に実装（Notes/Logsのみ） | Confirmed |
| 4 | `ALLOWED_CLI_TOOLS` が `claude-executor.ts` に存在し拡張が必要 | Confirmed |
| 5 | vibe-localはPythonスクリプトのため起動コマンドが異なる可能性 | Unverifiable |
| 6 | worktreesテーブルに `selected_agents` カラムが存在しない | Confirmed |
| 7 | vibe-localがコードベースに未実装 | Confirmed |

## ステージ別結果

| Stage | レビュー種別 | 指摘数 | 対応数 | ステータス |
|-------|------------|-------|-------|----------|
| 1 | 通常レビュー（1回目） | 12件（Must:3, Should:6, Nice:3） | - | ✅ |
| 2 | 指摘事項反映（1回目） | - | 12/12件 | ✅ |
| 3 | 影響範囲レビュー（1回目） | 12件（Must:3, Should:6, Nice:3） | - | ✅ |
| 4 | 指摘事項反映（1回目） | - | 12/12件 | ✅ |
| 5 | 通常レビュー（2回目） | 5件（Must:0, Should:2, Nice:3） | - | ✅ |
| 6 | 指摘事項反映（2回目） | - | 5/5件 | ✅ |
| 7 | 影響範囲レビュー（2回目） | 5件（Must:0, Should:3, Nice:2） | - | ✅ |
| 8 | 指摘事項反映（2回目） | - | 5/5件 | ✅ |

## 統計

- **総指摘数**: 34件
- **対応完了**: 34件
- **スキップ**: 0件

## 主な改善点

1. **変更対象ファイルの網羅化**: 当初4ファイルだった変更対象を、実際のコードベース照合で20ファイル以上に拡大（`cli-patterns.ts`、`assistant-response-saver.ts`、`MessageList.tsx`、`sidebar.ts`、`api-client.ts`、`db.ts` 等）
2. **`cli_tool_id` と `selected_agents` の設計整合性**: 両カラムの役割（アクティブツール vs 表示ツール選択）と整合性ルールを明確化
3. **vibe-local技術調査フェーズの追加**: 実行コマンド・プロンプト検出パターン等の調査タスクをIssueに明記
4. **switch文defaultフォールバック問題の特定**: 5箇所でvibe-localがclaude扱いされるリスクを発見し、exhaustive switchパターンの導入方針を追加
5. **JSONバリデーション戦略の設計**: `selected_agents` のパース関数の設計方針と検証観点6項目を追記
6. **表示名共通化（F703）**: `capitalizeFirst()`/`formatCliToolName()` のvibe-local表示名問題を特定し、`getCliToolDisplayName()` 導入方針を追加
7. **SQL IN句の動的化（F701）**: `db.ts` のハードコードSQL IN句をCLI_TOOL_IDSベースの動的プレースホルダに変更する方針を追記
8. **セクション0（前提リファクタリング）の追加**: CLI_TOOL_IDS一元化・表示名共通化を先行実施する推奨実装順序を設定

## Issue差分サマリー

### 追加されたセクション
- 推奨実装順序テーブル
- セクション0: 前提作業（CLI_TOOL_IDSリファクタリング、表示名共通化）
- vibe-local技術調査フェーズ
- `cli_tool_id` と `selected_agents` の設計方針
- switch文のdefaultフォールバック対応
- `selected_agents` のJSONバリデーション設計
- `selected_agents` 更新のAPI設計（PATCH UI更新方針含む）
- selected_agents変更時のセッション管理方針
- DBマイグレーション詳細設計

### 修正されたセクション
- 変更対象ファイル一覧（4ファイル → 20ファイル以上）
- 技術的考慮事項（8項目追加）
- 受け入れ基準（テスト項目・コード品質項目追加）
- クラス名typo修正（ViveLocalTool → VibeLocalTool）

## 次のアクション

- [ ] Issueの最終確認
- [ ] 設計方針書作成（/design-policy）
- [ ] 実装開始（/pm-auto-dev）

## 関連ファイル

- 元のIssue: `dev-reports/issue/368/issue-review/original-issue.json`
- 仮説検証: `dev-reports/issue/368/issue-review/hypothesis-verification.md`
- Stage 1レビュー: `dev-reports/issue/368/issue-review/stage1-review-result.json`
- Stage 3レビュー: `dev-reports/issue/368/issue-review/stage3-review-result.json`
- Stage 5レビュー: `dev-reports/issue/368/issue-review/stage5-review-result.json`
- Stage 7レビュー: `dev-reports/issue/368/issue-review/stage7-review-result.json`

---
*Generated by multi-stage-issue-review command*
