{
  "issue_number": 94,
  "focus_area": "影響範囲",
  "iteration": 1,
  "stage": 3,
  "stage_name": "影響範囲レビュー（1回目）",
  "review_date": "2026-01-30",
  "summary": {
    "must_fix_count": 2,
    "should_fix_count": 4,
    "nice_to_have_count": 3
  },
  "findings": {
    "must_fix": [
      {
        "id": "MF-1",
        "category": "設定ファイルへの影響",
        "issue": "next.config.jsのbodySizeLimit設定が不足",
        "location": "next.config.js / 提案する解決策 セクション",
        "recommendation": "next.config.jsの現在の設定は`serverActions.bodySizeLimit: '2mb'`のみ。5MBのファイルアップロードにはAPI Routesのリクエストボディ制限の設定が必要。具体的な設定方法をIssueに記載すべき",
        "evidence": "next.config.js:8-11では`experimental.serverActions.bodySizeLimit: '2mb'`のみ設定。API Routesのデフォルトは4MB制限だが、5MBアップロードを許可するには`api.bodyParser.sizeLimit`または`api.responseLimit`の設定が必要"
      },
      {
        "id": "MF-2",
        "category": "既存APIへの影響",
        "issue": "既存ファイル操作APIがmultipart/form-data非対応",
        "location": "既存ファイル操作APIとの整合性 セクション",
        "recommendation": "既存の`/api/worktrees/[id]/files/[...path]/route.ts`はJSON形式のリクエストボディのみ対応（request.json()使用）。バイナリアップロードには根本的なAPI設計変更が必要。新規エンドポイントを作成するか、既存APIを拡張するかを明確に決定すべき",
        "evidence": "route.ts:162 `const body = await request.json();` - 現在はJSONのみ。FormData対応には`request.formData()`への変更またはContent-Type判定が必要"
      }
    ],
    "should_fix": [
      {
        "id": "SF-1",
        "category": "影響ファイル",
        "issue": "影響を受けるファイルの一覧が不完全",
        "location": "技術参照 セクション",
        "recommendation": "以下のファイルも影響範囲に含めるべき: (1) src/config/uploadable-extensions.ts（新規作成予定だが存在確認が必要）、(2) src/types/markdown-editor.ts（FileOperationRequestの拡張が必要か）、(3) src/hooks/useContextMenu.ts（Upload用のメニュー項目追加）、(4) next.config.js（bodyParser設定）",
        "evidence": "useContextMenu.tsは現在file/directoryのみ対応。uploadアクション追加時の型拡張が必要"
      },
      {
        "id": "SF-2",
        "category": "テストへの影響",
        "issue": "テスト計画の記載がない",
        "location": "Issue本文全体",
        "recommendation": "以下のテスト追加が必要: (1) 単体テスト: uploadable-extensions.ts、アップロードロジック（2) 結合テスト: APIエンドポイント（multipart/form-data処理）（3) E2Eテスト: tests/e2e/file-upload.spec.ts（右クリックメニューからのアップロードフロー）",
        "evidence": "tests/unit/lib/file-operations.test.ts、tests/e2e/file-tree-operations.spec.tsが既存。アップロード機能用テストの追加が必要"
      },
      {
        "id": "SF-3",
        "category": "依存関係",
        "issue": "ファイルアップロード用ライブラリの検討が未記載",
        "location": "提案する解決策 セクション",
        "recommendation": "multipart/form-dataの処理にはNext.jsのネイティブサポートを使用するか、追加ライブラリ（formidable等）を検討する必要がある。package.jsonへの依存追加の有無を明記すべき",
        "evidence": "package.json現在の依存関係にはmultipart処理ライブラリなし。Next.js 13+はFormDataをネイティブサポートするが、ファイル処理の詳細設計が必要"
      },
      {
        "id": "SF-4",
        "category": "パフォーマンスへの影響",
        "issue": "大量ファイル処理時の考慮が不足",
        "location": "ファイルサイズ制限 セクション",
        "recommendation": "5MBファイルのアップロード時のメモリ使用量、同時アップロード数の制限、ストリーミングアップロードの必要性について検討を追加すべき。現在のeditable-extensions.tsでは1MB制限なので、5MB処理の負荷影響を評価すべき",
        "evidence": "editable-extensions.ts:35 `maxFileSize: 1024 * 1024` (1MB)。5MB対応では5倍のメモリ使用が想定される"
      }
    ],
    "nice_to_have": [
      {
        "id": "NTH-1",
        "category": "ドキュメント更新",
        "issue": "ドキュメント更新計画の記載がない",
        "location": "Issue本文全体",
        "recommendation": "以下のドキュメント更新が必要: (1) CLAUDE.md: 主要機能モジュールにuploadable-extensions.ts追加、(2) docs/features/: ファイルアップロード機能のドキュメント追加、(3) APIドキュメント: 新規/拡張エンドポイントの仕様"
      },
      {
        "id": "NTH-2",
        "category": "破壊的変更",
        "issue": "後方互換性への影響確認",
        "location": "既存ファイル操作APIとの整合性 セクション",
        "recommendation": "新規エンドポイント作成の場合は後方互換性に問題なし。既存APIを拡張する場合、Content-Type判定を追加することで既存のJSON形式リクエストとの互換性を維持可能。この方針を明記すべき"
      },
      {
        "id": "NTH-3",
        "category": "関連Issue",
        "issue": "Issue #95との依存関係の詳細化",
        "location": "関連Issue セクション",
        "recommendation": "Issue #95（画像ファイルビューワ）との実装順序、共通コンポーネント（画像プレビュー等）の検討を追記すると計画が明確になる"
      }
    ]
  },
  "code_references": [
    {
      "file": "src/app/api/worktrees/[id]/files/[...path]/route.ts",
      "relevance": "既存ファイル操作API。JSON形式のみ対応のため、multipart/form-data対応の拡張または新規エンドポイント作成が必要"
    },
    {
      "file": "src/lib/file-operations.ts",
      "relevance": "ファイル操作ビジネスロジック。createFileOrDirectory()はテキストコンテンツのみ対応。バイナリ書き込み用関数の追加が必要"
    },
    {
      "file": "src/lib/path-validator.ts",
      "relevance": "isPathSafe()によるパストラバーサル防止。アップロード先パスの検証に使用可能"
    },
    {
      "file": "src/config/editable-extensions.ts",
      "relevance": "拡張子設定の参考設計。uploadable-extensions.ts新規作成時のテンプレート"
    },
    {
      "file": "src/components/worktree/FileTreeView.tsx",
      "relevance": "アップロードUIの追加箇所。onUpload callback propの追加が必要"
    },
    {
      "file": "src/components/worktree/ContextMenu.tsx",
      "relevance": "右クリックメニュー。「ファイルをアップロード」項目の追加が必要"
    },
    {
      "file": "src/hooks/useContextMenu.ts",
      "relevance": "コンテキストメニュー状態管理。アップロードアクション用の型拡張検討"
    },
    {
      "file": "next.config.js",
      "relevance": "5MBアップロードに対応するためのbodyParser設定追加が必要"
    },
    {
      "file": "src/types/markdown-editor.ts",
      "relevance": "FileOperationRequest/Response型。アップロードレスポンス型の追加検討"
    },
    {
      "file": "src/config/file-operations.ts",
      "relevance": "ファイル操作安全設定。アップロードサイズ制限設定の追加検討"
    }
  ],
  "doc_references": [
    {
      "file": "CLAUDE.md",
      "relevance": "プロジェクトガイドライン。主要機能モジュール一覧への追加が必要"
    }
  ],
  "test_references": [
    {
      "file": "tests/unit/lib/file-operations.test.ts",
      "relevance": "既存ファイル操作テスト。アップロード機能用テストケースの追加が必要"
    },
    {
      "file": "tests/e2e/file-tree-operations.spec.ts",
      "relevance": "既存FileTree E2Eテスト。アップロードメニュー項目のテスト追加が必要"
    },
    {
      "file": "tests/integration/security.test.ts",
      "relevance": "セキュリティテスト。アップロード時のパストラバーサル防止テスト追加が必要"
    }
  ],
  "impact_summary": {
    "affected_files": {
      "new": [
        "src/config/uploadable-extensions.ts",
        "tests/unit/config/uploadable-extensions.test.ts",
        "tests/e2e/file-upload.spec.ts"
      ],
      "modified": [
        "src/app/api/worktrees/[id]/files/[...path]/route.ts or 新規uploadエンドポイント",
        "src/lib/file-operations.ts",
        "src/components/worktree/FileTreeView.tsx",
        "src/components/worktree/ContextMenu.tsx",
        "src/types/markdown-editor.ts",
        "next.config.js"
      ]
    },
    "breaking_changes": false,
    "performance_considerations": [
      "5MBファイルアップロード時のメモリ使用量増加",
      "同時アップロード処理時のサーバー負荷"
    ],
    "security_considerations": [
      "MIMEタイプ検証の実装",
      "実行ファイルブロックリストの管理",
      "アップロードサイズ制限の適用"
    ]
  }
}
