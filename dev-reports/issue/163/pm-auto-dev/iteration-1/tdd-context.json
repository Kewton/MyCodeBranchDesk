{
  "issue_number": 163,
  "issue_title": "長いメッセージ（複数行テキスト）の場合、メッセージを送信してもClaude側で処理が開始されない",
  "design_doc_path": "dev-reports/design/issue-163-multiline-message-buffer-design-policy.md",
  "work_plan_path": "dev-reports/issue/163/work-plan.md",
  "acceptance_criteria": [
    "50行以上の複数行メッセージがClaude CLIに正常に送信されること",
    "100行以上の複数行メッセージがClaude CLIに正常に送信されること",
    "改行を含むテキストが正しく送信されること（改行が保持される）",
    "送信後、Claude CLIが処理を開始すること（[Pasted text...]で停止しない）",
    "特殊文字（$, \", \\, `）を含むメッセージが正しくエスケープされること",
    "コマンドインジェクション試行テストをパスすること（例: $(whoami), `id`）",
    "バッファ名に不正な文字が含まれる場合、サニタイズされること",
    "NULバイトを含むテキストが適切に処理されること（除去後に送信）",
    "バッファ作成失敗時に適切なエラーメッセージが出力されること",
    "ペースト失敗時にバッファがクリーンアップされること（リーク防止）"
  ],
  "implementation_tasks": [
    {
      "id": "1.1",
      "title": "sendTextViaBuffer() 関数の新規追加",
      "file": "src/lib/tmux.ts",
      "test_file": "tests/unit/lib/tmux.test.ts",
      "description": "tmux load-buffer/paste-buffer を使用した複数行テキスト送信関数。バッファ名サニタイズ([^a-zA-Z0-9_-]→_、プレフィックスcm-)、NULバイト除去、エスケープ処理(\\→\\\\\\\\、$→\\\\$、\"→\\\\\"、`→\\\\`)、try-catchでバッファクリーンアップ",
      "test_cases": 15
    },
    {
      "id": "1.2",
      "title": "sendMessageToClaude() の修正",
      "file": "src/lib/claude-session.ts",
      "test_file": "tests/unit/lib/claude-session.test.ts",
      "description": "sendKeys() 2回呼び出しを sendTextViaBuffer() 1回に置換。import文にsendTextViaBufferを追加。変更前: sendKeys(sessionName, message, false) + sendKeys(sessionName, '', true) → 変更後: sendTextViaBuffer(sessionName, message, true)"
    },
    {
      "id": "1.3",
      "title": "Codex CLI sendMessage() の修正",
      "file": "src/lib/cli-tools/codex.ts",
      "test_file": "tests/unit/cli-tools/codex.test.ts",
      "description": "sendKeys() + execAsync(C-m) を sendTextViaBuffer() に置換。import文にsendTextViaBufferを追加。変更前: sendKeys + 100ms待機 + execAsync(tmux send-keys ... C-m) → 変更後: sendTextViaBuffer(sessionName, message, true)"
    }
  ],
  "target_coverage": 80,
  "security_requirements": [
    "SEC-001: エスケープ処理 - \\, $, \", ` の4種（バックスラッシュ最初に処理）",
    "SEC-002: バッファ名サニタイズ - [^a-zA-Z0-9_-] → _, プレフィックス cm-",
    "SEC-003: バッファリーク防止 - paste-buffer -d + エラー時cleanup",
    "SEC-004: NULバイト除去 - text.replace(/\\0/g, '')",
    "SEC-005: 制御文字パススルー - NUL以外の制御文字(\\r, \\x08等)は意図的にパススルー",
    "SEC-MF-001: %文字のエスケープ不要 - printf '%s'の引数のため"
  ]
}
