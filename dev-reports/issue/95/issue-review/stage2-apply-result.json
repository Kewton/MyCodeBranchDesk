{
  "issue_number": 95,
  "iteration": 1,
  "stage": 2,
  "stage_name": "指摘事項反映（1回目）",
  "apply_date": "2026-01-30",
  "applied_items": [
    {
      "id": "MF-1",
      "category": "明確性",
      "description": "受け入れ条件を追加",
      "action": "「## 受け入れ条件」セクションを新規追加。対応画像形式、表示サイズ、サイズ上限エラー、テスト要件を明記"
    },
    {
      "id": "MF-2",
      "category": "完全性",
      "description": "技術的な実装方針を追加",
      "action": "「### 技術的な実装方針」セクションを新規追加。対応画像形式、表示方法（FileViewer拡張）、API拡張方針（Base64）、拡張子設定ファイルの方針を明記"
    },
    {
      "id": "SF-1",
      "category": "整合性",
      "description": "既存のファイルビューワー構成との関係を明確化",
      "action": "実装方針内で関連コンポーネント（FileViewer.tsx, FileTreeView.tsx, WorktreeDetailRefactored.tsx）との関係を明記"
    },
    {
      "id": "SF-2",
      "category": "整合性",
      "description": "API層での画像バイナリ対応を検討",
      "action": "「#### 3. 画像データ取得方法」で GET /api/worktrees/:id/files/:path のBase64拡張方針を記載"
    },
    {
      "id": "SF-3",
      "category": "技術的妥当性",
      "description": "セキュリティ考慮事項を追加",
      "action": "「### セキュリティ考慮事項」セクションを新規追加。ホワイトリスト、サイズ上限10MB、MIMEタイプ検証、パストラバーサル防止を明記"
    },
    {
      "id": "SF-4",
      "category": "正確性",
      "description": "誤字を修正",
      "action": "「ビューワてま確認可能」を「ビューワで確認可能」に修正"
    }
  ],
  "skipped_items": [],
  "nice_to_have_addressed": [
    {
      "id": "NTH-1",
      "description": "関連Issueへの参照を追加",
      "action": "「## 関連Issue」セクションで #49 を参照"
    },
    {
      "id": "NTH-2",
      "description": "ユースケースの具体例を追加",
      "action": "「### 具体的なユースケース」で4つの具体例を記載"
    },
    {
      "id": "NTH-3",
      "description": "対象外事項を追加",
      "action": "「## 対象外事項（スコープ外）」セクションを新規追加"
    }
  ],
  "new_body": "## 概要\n\nFilesにて画像ファイルを視認したい\n\n## 背景・課題\n\nClaude Codeと視覚的なコミュニケーションがとれるようになる。\n\n### 具体的なユースケース\n- スクリーンショットを確認しながらUIの問題を議論\n- 生成された図表やダイアグラムの確認\n- デザインモックアップのレビュー\n- エラー画面のスクリーンショット確認\n\n## 提案する解決策\n\n画像ファイルの場合ビューワで確認可能とする。\n\n### 技術的な実装方針\n\n#### 1. 対応する画像形式\n- PNG (.png)\n- JPEG (.jpg, .jpeg)\n- GIF (.gif)\n- WebP (.webp)\n- SVG (.svg)\n\n#### 2. 画像表示方法\n既存の `FileViewer.tsx` を拡張し、画像ファイル判定時に画像表示コンポーネントを表示する。\n\n**関連コンポーネント**:\n- `src/components/worktree/FileViewer.tsx` - 拡張対象のファイルビューワー\n- `src/components/worktree/FileTreeView.tsx` - ファイル選択処理\n- `src/components/worktree/WorktreeDetailRefactored.tsx` - 表示切替処理\n\n#### 3. 画像データ取得方法\n`GET /api/worktrees/:id/files/:path` APIを拡張し、画像ファイルの場合はBase64エンコードで返却する。\n\n**API拡張方針**:\n- レスポンスに `isImage` フラグと `mimeType` を追加\n- 画像コンテンツは `content` フィールドにBase64エンコードで格納\n- 参考: `src/app/api/worktrees/[id]/files/[...path]/route.ts`\n\n#### 4. 画像拡張子設定\n`src/config/editable-extensions.ts` と同様のパターンで、`src/config/image-extensions.ts` を新規作成し、対応画像拡張子をホワイトリストで管理する。\n\n### セキュリティ考慮事項\n\n1. **対応拡張子のホワイトリスト**: `IMAGE_EXTENSIONS` 設定で対応拡張子を制限\n2. **画像ファイルサイズ上限**: 10MB を上限として設定（大容量ファイルの読み込み防止）\n3. **MIMEタイプ検証**: 拡張子だけでなくファイルのMIMEタイプも検証\n4. **パストラバーサル防止**: 既存の `isPathSafe()` 関数を活用\n\n## 受け入れ条件\n\n- [ ] PNG, JPG, GIF, WEBP, SVG形式の画像ファイルがFileTreeViewで選択可能\n- [ ] 選択した画像ファイルがビューワ領域に表示される\n- [ ] 画像は最大幅100%、最大高さ500pxで表示される\n- [ ] 画像クリック時にモーダルで拡大表示（オプション）\n- [ ] 10MB以上の画像ファイルはエラーメッセージを表示\n- [ ] 対応外のファイル形式は従来通りの動作（テキスト表示 or エラー）\n- [ ] 単体テストが追加されている\n- [ ] E2Eテストが追加されている\n\n## 対象外事項（スコープ外）\n\n- 画像のアップロード機能\n- 画像の編集・加工機能\n- 動画ファイルの再生\n- 画像のサムネイル生成\n- 画像のキャッシュ機能\n\n## 関連Issue\n\n- #49 マークダウンエディタとビューワー（設計パターンの参考）\n\n## 参考資料\n\n- 設計参考: `dev-reports/design/issue-49-markdown-editor-design-policy.md`\n- アーキテクチャ: `docs/architecture.md`",
  "github_url": "https://github.com/Kewton/CommandMate/issues/95"
}
