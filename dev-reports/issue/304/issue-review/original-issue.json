{"body":"## 概要\n\n`npm run test:unit` 実行時に `NODE_ENV` が明示的に設定されないため、シェル環境に `NODE_ENV=production` が残留している場合に62ファイル/1112テストが失敗する。\n\n## 再現手順\n\n1. `NODE_ENV=production npm run build` 等でサーバーをビルド・起動する（`build-and-start.sh` 等）\n2. 同じシェルセッションで `npm run test:unit` を実行する\n3. 62ファイル/1112テストが失敗する\n\n## 期待する動作\n\nシェル環境の `NODE_ENV` に依存せず、テストが常に正しく実行される。\n\n## 実際の動作\n\n`NODE_ENV=production` が継承され、Reactのproduction buildが使用される。production buildでは `act()` が無効化されているため、`@testing-library/react` を使用する全UIテストが以下のエラーで失敗する：\n\n```\nError: act(...) is not supported in production builds of React.\n```\n\n## 根本原因\n\n1. **`package.json` の `test:unit` スクリプトに `NODE_ENV=test` が明示されていない**\n2. **`env.test.ts` で `.env` ファイルの環境変数（`CM_ROOT_DIR` 等）がテスト内のモック値を上書きしている**（`NODE_ENV=test` でも9テスト失敗）\n\n## 対策案\n\n### 対策1: `package.json` のテストスクリプトに `NODE_ENV=test` を明示\n\n```json\n{\n  \"scripts\": {\n    \"test\": \"NODE_ENV=test vitest\",\n    \"test:unit\": \"NODE_ENV=test vitest --project unit\"\n  }\n}\n```\n\n### 対策2: `env.test.ts` のテストで環境変数を適切に分離\n\n`beforeEach` で対象の環境変数を退避・削除し、`afterEach` で復元する。\n\n```typescript\nbeforeEach(() => {\n  savedEnv = { ...process.env };\n  delete process.env.CM_ROOT_DIR;\n  delete process.env.MCBD_ROOT_DIR;\n  // ...\n});\n\nafterEach(() => {\n  process.env = savedEnv;\n});\n```\n\n## 受入条件\n\n- [ ] `NODE_ENV=production` が設定されたシェルで `npm run test:unit` を実行しても全テストがパスすること\n- [ ] `env.test.ts` のテストがシェル環境の `.env` に依存せずパスすること\n- [ ] 既存テストに影響がないこと\n\n## 影響範囲\n\n### 変更対象ファイル\n\n| ファイル | 変更内容 |\n|---------|---------|\n| `package.json` | テストスクリプトに `NODE_ENV=test` を追加 |\n| `tests/unit/env.test.ts` | 環境変数の分離処理を追加 |\n\n### 影響度\n\n- 修正量: 小（設定変更のみ）\n- リスク: 低（テスト環境のみの変更）","title":"fix: テスト実行時にNODE_ENVが明示されず本番ビルドのReactが使用される"}
