{
  "review_type": "影響範囲",
  "issue_number": 94,
  "stage": 3,
  "stage_name": "影響分析レビュー",
  "reviewed_at": "2026-01-30T00:00:00Z",
  "design_doc_path": "dev-reports/design/issue-94-file-upload-design-policy.md",
  "findings": [
    {
      "id": "IMPACT-001",
      "severity": "must_fix",
      "category": "後方互換性",
      "description": "FileOperationResult型に size?: number を追加する設計は既存の関数全てに影響する。現在 FileOperationResult を返す関数 (readFileContent, updateFileContent, createFileOrDirectory, deleteFileOrDirectory, renameFileOrDirectory) は size を返していないが、型定義上オプショナルなので問題ない。ただし、型の一貫性を保つため、将来的に他の操作でも size を返すか、Upload専用の型を検討すべき。",
      "suggestion": "現時点では size?: number のオプショナル追加で問題なし。ただし、設計書に「FileOperationResultのsize追加は後方互換性あり（オプショナルプロパティのため既存コードに影響なし）」を明記すること。",
      "location": "src/lib/file-operations.ts - FileOperationResult interface"
    },
    {
      "id": "IMPACT-002",
      "severity": "must_fix",
      "category": "依存関係",
      "description": "ContextMenuProps に onUpload を追加する際、FileTreeView が ContextMenu を直接レンダリングしているため、FileTreeViewProps にも onUpload を追加する必要がある。設計書には FileTreeViewProps への追加が記載されているが、実際に FileTreeView.tsx が ContextMenu に onUpload を渡す部分の実装パスが明確でない。",
      "suggestion": "設計書セクション3.4「UI変更」に、FileTreeView から ContextMenu への props の流れ（FileTreeViewProps.onUpload -> ContextMenu.onUpload）を明示的に記載すること。",
      "location": "src/components/worktree/FileTreeView.tsx lines 500-510"
    },
    {
      "id": "IMPACT-003",
      "severity": "must_fix",
      "category": "設定変更の影響",
      "description": "next.config.js の bodySizeLimit を 2mb から 6mb に変更することは全ての API ルートに影響する。設計書では影響分析と軽減策が記載されているが、既存の API エンドポイント（POST /api/worktrees/[id]/files/[...path] など）が大きなリクエストを受け付けるようになるリスクがある。",
      "suggestion": "影響を受ける既存APIルートをリストアップし、各エンドポイントでの入力サイズ検証が適切に行われていることを確認するテストケースを追加すること。または、route segment config で upload API のみに bodySizeLimit を適用する方式を初期実装から採用することを検討。",
      "location": "next.config.js line 10"
    },
    {
      "id": "IMPACT-004",
      "severity": "should_fix",
      "category": "変更の波及効果",
      "description": "WorktreeDetailRefactored.tsx は FileTreeView を使用しており、handleNewFile, handleNewDirectory, handleRename, handleDelete を既に実装している。新しい onUpload コールバックを追加する必要がある。この変更は 1514 行の大きなコンポーネントに対する追加となる。",
      "suggestion": "WorktreeDetailRefactored.tsx に handleUpload コールバックの実装が必要であることを設計書の影響範囲セクションに追加すること。また、ファイルアップロード成功後の refreshTrigger 更新も必要。",
      "location": "src/components/worktree/WorktreeDetailRefactored.tsx lines 1049-1156"
    },
    {
      "id": "IMPACT-005",
      "severity": "should_fix",
      "category": "テストカバレッジ",
      "description": "既存のテストファイル tests/unit/lib/file-operations.test.ts には isValidNewName のテストがあるが、forUpload オプションのテストケースが設計書に記載されている。また、tests/unit/config/editable-extensions.test.ts との並行関係として tests/unit/config/uploadable-extensions.test.ts の作成が必要。",
      "suggestion": "テスト設計を以下のように整理: 1) tests/unit/config/uploadable-extensions.test.ts - 新規作成 2) tests/unit/lib/file-operations.test.ts - isValidNewName の forUpload オプションテスト追加 3) tests/integration/api-file-upload.test.ts - 結合テスト新規作成",
      "location": "tests/unit/lib/file-operations.test.ts, tests/unit/config/editable-extensions.test.ts"
    },
    {
      "id": "IMPACT-006",
      "severity": "should_fix",
      "category": "型定義変更の影響",
      "description": "FileOperationErrorCode に INVALID_EXTENSION, INVALID_MIME_TYPE, FILE_TOO_LARGE を追加する。これにより ERROR_MESSAGES と ERROR_CODE_TO_HTTP_STATUS の両方を更新する必要がある。設計書では ERROR_CODE_TO_HTTP_STATUS のみ言及されているが、ERROR_MESSAGES も更新が必要。",
      "suggestion": "設計書のセクション3.1またはセクション12の実装チェックリストに「ERROR_MESSAGES への新エラーコードのメッセージ追加」を明記すること。",
      "location": "src/lib/file-operations.ts lines 47-61"
    },
    {
      "id": "IMPACT-007",
      "severity": "should_fix",
      "category": "依存関係",
      "description": "upload/route.ts から uploadable-extensions.ts への依存が追加される。この新しい設定ファイルの変更は upload API のみに影響するが、将来的に他の機能（例: 画像プレビュー Issue #95）からも参照される可能性がある。",
      "suggestion": "uploadable-extensions.ts の設計において、将来の拡張（Issue #95 画像プレビュー機能など）との連携を考慮したエクスポート設計になっていることを確認。具体的には、UPLOADABLE_EXTENSION_VALIDATORS は他のモジュールからも参照しやすい形式で公開されている。",
      "location": "src/config/uploadable-extensions.ts (新規)"
    },
    {
      "id": "IMPACT-008",
      "severity": "should_fix",
      "category": "テストカバレッジ",
      "description": "useContextMenu フックのテスト (tests/unit/hooks/useContextMenu.test.ts) が存在する。onUpload アクションの追加がこのフックに影響を与えるかどうかの分析が設計書にない。現在の実装では useContextMenu は openMenu, closeMenu, resetMenu のみを提供し、アクション固有のロジックは含まない。",
      "suggestion": "useContextMenu.ts への変更は不要であることを確認し、設計書のセクション8.2「変更ファイル」から useContextMenu.ts を削除するか、変更内容を明確化すること。現状の設計書では「アップロードアクション型追加」と記載されているが、実際の useContextMenu は型追加は不要。",
      "location": "src/hooks/useContextMenu.ts, tests/unit/hooks/useContextMenu.test.ts"
    },
    {
      "id": "IMPACT-009",
      "severity": "nice_to_have",
      "category": "変更の波及効果",
      "description": "MobileContent コンポーネント (WorktreeDetailRefactored 内) も FileTreeView を使用しているため、モバイルレイアウトでもファイルアップロード機能が使用可能になる。モバイルでのファイル選択 UI の動作確認が必要。",
      "suggestion": "E2E テスト (tests/e2e/file-upload.spec.ts) にモバイルビューポートでのテストケースを追加することを検討。",
      "location": "src/components/worktree/WorktreeDetailRefactored.tsx lines 720-794"
    },
    {
      "id": "IMPACT-010",
      "severity": "nice_to_have",
      "category": "後方互換性",
      "description": "新しい API エンドポイント /api/worktrees/[id]/files/[...path]/upload の追加は純粋な追加であり、既存 API に影響しない。Content-Type の違い (multipart/form-data vs application/json) により既存エンドポイントとの棲み分けは明確。",
      "suggestion": "設計の妥当性を確認。問題なし。",
      "location": "src/app/api/worktrees/[id]/files/[...path]/upload/route.ts (新規)"
    }
  ],
  "impact_matrix": {
    "high_impact": [
      {
        "file": "src/lib/file-operations.ts",
        "changes": [
          "FileOperationResult に size?: number 追加",
          "FileOperationErrorCode に 3 つのエラーコード追加",
          "ERROR_MESSAGES に 3 つのメッセージ追加",
          "isValidNewName に options 引数追加",
          "writeBinaryFile 関数新規追加"
        ],
        "affected_consumers": [
          "全ての file-operations 関数を使用するコード",
          "API ルート (GET/PUT/POST/DELETE/PATCH /api/worktrees/[id]/files/[...path])"
        ],
        "backward_compatibility": "高 (オプショナル追加のため)"
      },
      {
        "file": "next.config.js",
        "changes": [
          "bodySizeLimit を 2mb から 6mb に変更"
        ],
        "affected_consumers": [
          "全ての Server Actions と API ルート"
        ],
        "backward_compatibility": "中 (リクエストサイズ上限が緩和される)"
      },
      {
        "file": "src/app/api/worktrees/[id]/files/[...path]/route.ts",
        "changes": [
          "ERROR_CODE_TO_HTTP_STATUS に 3 つのマッピング追加"
        ],
        "affected_consumers": [
          "既存の file operations API"
        ],
        "backward_compatibility": "高 (新規コードの追加のみ)"
      }
    ],
    "medium_impact": [
      {
        "file": "src/components/worktree/ContextMenu.tsx",
        "changes": [
          "ContextMenuProps に onUpload 追加",
          "アップロードメニュー項目追加",
          "Upload アイコンの import 追加"
        ],
        "affected_consumers": [
          "FileTreeView コンポーネント"
        ],
        "backward_compatibility": "高 (オプショナル prop)"
      },
      {
        "file": "src/components/worktree/FileTreeView.tsx",
        "changes": [
          "FileTreeViewProps に onUpload 追加",
          "ContextMenu への onUpload prop 伝播"
        ],
        "affected_consumers": [
          "WorktreeDetailRefactored コンポーネント"
        ],
        "backward_compatibility": "高 (オプショナル prop)"
      },
      {
        "file": "src/components/worktree/WorktreeDetailRefactored.tsx",
        "changes": [
          "handleUpload コールバック追加",
          "FileTreeView への onUpload prop 追加"
        ],
        "affected_consumers": [
          "ページコンポーネント"
        ],
        "backward_compatibility": "高 (機能追加のみ)"
      }
    ],
    "low_impact": [
      {
        "file": "src/config/uploadable-extensions.ts",
        "changes": [
          "新規ファイル作成"
        ],
        "affected_consumers": [
          "upload/route.ts のみ"
        ],
        "backward_compatibility": "該当なし (新規)"
      },
      {
        "file": "src/app/api/worktrees/[id]/files/[...path]/upload/route.ts",
        "changes": [
          "新規ファイル作成"
        ],
        "affected_consumers": [
          "クライアント側アップロード処理"
        ],
        "backward_compatibility": "該当なし (新規)"
      }
    ],
    "test_files_affected": [
      {
        "file": "tests/unit/config/uploadable-extensions.test.ts",
        "action": "新規作成"
      },
      {
        "file": "tests/unit/lib/file-operations.test.ts",
        "action": "テストケース追加 (isValidNewName, createErrorResult)"
      },
      {
        "file": "tests/integration/api/file-upload.test.ts",
        "action": "新規作成"
      },
      {
        "file": "tests/e2e/file-upload.spec.ts",
        "action": "新規作成"
      },
      {
        "file": "tests/unit/components/worktree/FileTreeView.test.tsx",
        "action": "テストケース追加 (onUpload)"
      }
    ]
  },
  "summary": {
    "overall_assessment": "APPROVED_WITH_COMMENTS",
    "risk_level": "低",
    "key_concerns": [
      "bodySizeLimit の全体適用による既存 API への間接的影響",
      "WorktreeDetailRefactored.tsx への変更が設計書に明記されていない",
      "ERROR_MESSAGES への追加が設計書に明記されていない"
    ],
    "strengths": [
      "新規 API エンドポイントの追加は既存機能に影響しない設計",
      "オプショナルプロパティの活用により後方互換性が高い",
      "多層防御によるセキュリティ設計",
      "既存パターン (editable-extensions.ts) との整合性が取れている"
    ],
    "recommendations": [
      "設計書に WorktreeDetailRefactored.tsx への変更を追記すること (IMPACT-004)",
      "ERROR_MESSAGES への追加を明記すること (IMPACT-006)",
      "useContextMenu.ts の変更有無を明確化すること (IMPACT-008)",
      "bodySizeLimit 変更の影響を受ける既存 API のリストアップを検討 (IMPACT-003)"
    ],
    "must_fix_count": 3,
    "should_fix_count": 5,
    "nice_to_have_count": 2
  }
}
