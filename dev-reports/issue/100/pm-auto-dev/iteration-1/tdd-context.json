{
  "issue_number": 100,
  "title": "feat: マークダウンプレビューでmermaidダイアグラムを描画できるようにする",
  "design_policy_path": "dev-reports/design/issue-100-mermaid-diagram-design-policy.md",
  "work_plan_path": "dev-reports/issue/100/work-plan.md",
  "acceptance_criteria": [
    {
      "id": "AC-01",
      "description": "mermaidコードブロックがSVGダイアグラムとして描画される",
      "test_method": "T5.1, T5.3"
    },
    {
      "id": "AC-02",
      "description": "構文エラー時にエラーメッセージが表示される（UIがクラッシュしない）",
      "test_method": "T5.1"
    },
    {
      "id": "AC-03",
      "description": "既存のマークダウンプレビュー機能に影響がない",
      "test_method": "T5.3（回帰テスト）"
    },
    {
      "id": "AC-04",
      "description": "テストが追加されている",
      "test_method": "T5.1, T5.2, T5.3"
    },
    {
      "id": "AC-05",
      "description": "mermaidのsecurityLevelが'strict'に設定されている",
      "test_method": "T5.1（設定検証テスト）"
    },
    {
      "id": "AC-06",
      "description": "CLAUDE.mdが更新されている",
      "test_method": "T6.1"
    }
  ],
  "implementation_tasks": [
    {
      "id": "T1.1",
      "name": "mermaid設定ファイル作成",
      "file": "src/config/mermaid-config.ts",
      "dependencies": [],
      "subtasks": [
        "MERMAID_CONFIG定数を定義（securityLevel: 'strict', startOnLoad: false, theme: 'default'）",
        "MermaidConfig型を定義（as const + typeof）",
        "securityLevel変更禁止のセキュリティコメント追加",
        "@moduleタグ付きJSDocを追加"
      ]
    },
    {
      "id": "T1.2",
      "name": "依存パッケージ追加",
      "file": "package.json",
      "dependencies": [],
      "subtasks": [
        "npm install mermaid@^11.12.2",
        "package-lock.jsonの更新確認"
      ]
    },
    {
      "id": "T2.1",
      "name": "MermaidDiagramコンポーネント作成",
      "file": "src/components/worktree/MermaidDiagram.tsx",
      "dependencies": ["T1.1", "T1.2"],
      "subtasks": [
        "'use client' ディレクティブ追加",
        "MermaidDiagramProps インターフェース定義（code: string, id?: string）",
        "mermaid-configからの設定読み込み",
        "initializeMermaidWithValidation()関数実装（securityLevel検証フェイルセーフ）",
        "useEffect内でmermaid.render()実装",
        "状態管理: svg, error, isLoading",
        "エラーハンドリング（SyntaxError, RenderError）",
        "エラー表示UI（Tailwind CSS）",
        "dangerouslySetInnerHTMLでSVG描画"
      ]
    },
    {
      "id": "T3.1",
      "name": "MermaidCodeBlockコンポーネント作成",
      "file": "src/components/worktree/MermaidCodeBlock.tsx",
      "dependencies": ["T2.1"],
      "subtasks": [
        "'use client' ディレクティブ追加",
        "MermaidCodeBlockPropsインターフェース定義（ReactMarkdown互換）",
        "next/dynamicでMermaidDiagramを遅延読み込み（ssr: false）",
        "Loader2スピナー付きloading UI",
        "className解析による言語判定（language-mermaid）",
        "mermaidの場合はMermaidDiagramに委譲",
        "非mermaidの場合は既存のcode要素をパススルー",
        "inline codeブロックはパススルー"
      ]
    },
    {
      "id": "T4.1",
      "name": "MarkdownEditor.tsx修正",
      "file": "src/components/worktree/MarkdownEditor.tsx",
      "dependencies": ["T3.1"],
      "subtasks": [
        "MermaidCodeBlockのimport追加",
        "ReactMarkdownのcomponents prop追加（code: MermaidCodeBlock）",
        "2箇所のReactMarkdownに適用（モバイル/デスクトップ）"
      ]
    },
    {
      "id": "T5.1",
      "name": "MermaidDiagramテスト作成",
      "file": "tests/unit/components/MermaidDiagram.test.tsx",
      "dependencies": ["T2.1"],
      "subtasks": [
        "@vitest-environment jsdom ディレクティブ",
        "正常系: flowchart描画成功",
        "正常系: sequenceDiagram描画成功",
        "異常系: 構文エラー時のエラー表示",
        "異常系: 空コードの処理",
        "セキュリティ設定検証テスト（securityLevel='strict'）",
        "XSS回帰テスト（script, event handlers, javascript: URL, nested malicious content）",
        "Issue #95 SVG XSS整合性テスト（5項目）"
      ]
    },
    {
      "id": "T5.2",
      "name": "MermaidCodeBlockテスト作成",
      "file": "tests/unit/components/MermaidCodeBlock.test.tsx",
      "dependencies": ["T3.1"],
      "subtasks": [
        "@vitest-environment jsdom ディレクティブ",
        "mermaid言語判定テスト（className='language-mermaid'）",
        "非mermaidコードブロックのパススルーテスト",
        "inline codeブロックのパススルーテスト"
      ]
    },
    {
      "id": "T5.3",
      "name": "MarkdownEditor回帰テスト追加",
      "file": "tests/unit/components/MarkdownEditor.test.tsx",
      "dependencies": ["T4.1"],
      "subtasks": [
        "mermaidコードブロックを含むマークダウンのレンダリングテスト",
        "既存機能の回帰テスト（GFMテーブル、リスト、コードブロック）",
        "rehype-sanitizeとの互換性テスト",
        "rehype-highlightとの互換性テスト（シンタックスハイライト）"
      ]
    },
    {
      "id": "T6.1",
      "name": "CLAUDE.md更新",
      "file": "CLAUDE.md",
      "dependencies": ["T5.1", "T5.2", "T5.3"],
      "subtasks": [
        "「最近の実装機能」セクションにIssue #100を追加",
        "機能概要: mermaidダイアグラム描画",
        "対応ファイル形式、セキュリティ対策（securityLevel='strict'）を記載",
        "主要コンポーネント一覧を追加"
      ]
    }
  ],
  "security_requirements": [
    {
      "id": "SEC-001",
      "requirement": "mermaid securityLevel='strict'設定",
      "verification": "T5.1 セキュリティ設定検証テスト"
    },
    {
      "id": "SEC-002",
      "requirement": "XSS防止（script, event handlers, javascript: URL）",
      "verification": "T5.1 XSS回帰テスト"
    },
    {
      "id": "SEC-003",
      "requirement": "Issue #95 SVG XSS対策との整合性",
      "verification": "T5.1 Issue #95整合性テスト"
    },
    {
      "id": "SEC-004",
      "requirement": "securityLevel検証フェイルセーフ機構",
      "verification": "MermaidDiagram初期化時の検証"
    }
  ],
  "quality_checks": {
    "typescript": "npx tsc --noEmit",
    "eslint": "npm run lint",
    "unit_test": "npm run test:unit",
    "build": "npm run build"
  },
  "target_coverage": 80,
  "created_at": "2026-01-31T00:00:00Z"
}
