{
  "stage": 2,
  "stage_name": "指摘事項対応（整合性）",
  "issue_number": 135,
  "applied_date": "2026-02-03",
  "applied_items": [
    {
      "id": "CONS-001",
      "category": "must_fix",
      "title": "db-instance.ts のデフォルトファイル名の不一致",
      "section_updated": "Section 4.1 Singleton パターン",
      "action": "現状の問題点と修正後のあるべき姿を明確に分離して記載。db.sqlite から cm.db へのファイル名変更を強調。"
    },
    {
      "id": "CONS-002",
      "category": "must_fix",
      "title": "env-setup.ts の ENV_DEFAULTS.CM_DB_PATH 値の不一致",
      "section_updated": "Section 6.1.2 env-setup.ts の ENV_DEFAULTS 修正",
      "action": "現在の ENV_DEFAULTS の状態を明記し、CM_DB_PATH を定数から削除して関数で動的に取得する修正内容を明確化。"
    },
    {
      "id": "CONS-003",
      "category": "should_fix",
      "title": "init.ts のDBパスプロンプトデフォルト値",
      "section_updated": "Section 6.1.3 init.ts の createDefaultConfig() および promptForConfig() 修正",
      "action": "createDefaultConfig() と promptForConfig() の両方の修正箇所を網羅的にリストアップ。現在の実装（init.ts:40, init.ts:101-104）を明記。"
    },
    {
      "id": "CONS-004",
      "category": "should_fix",
      "title": "Strategy パターンとシンプル実装の選択基準",
      "section_updated": "Section 4.2 Strategy パターン, Section 6.1.1 env.ts の getEnv() 修正",
      "action": "関数ベース実装を推奨とし、Strategy パターンは将来の拡張時に検討する方針を明記。コード例を両パターンで示す形に修正。"
    },
    {
      "id": "CONS-005",
      "category": "should_fix",
      "title": "docs/architecture.md の環境変数名が旧名称のまま",
      "section_updated": "Section 11.3 間接的な影響",
      "action": "docs/architecture.md の MCBD_* 参照が Issue #135 スコープ外であることを明記。Issue #77 Phase 4 での対応を推奨。"
    },
    {
      "id": "CONS-006",
      "category": "should_fix",
      "title": "影響範囲のAPI箇所数の精度",
      "section_updated": "Section 11.3 間接的な影響",
      "action": "ファイル数を「30ファイル、66箇所」から「約34ファイル、74箇所」に修正。grep調査結果に基づく正確な数値を反映。"
    },
    {
      "id": "CONS-007",
      "category": "nice_to_have",
      "title": "マイグレーション検出パターンの網羅性",
      "section_updated": "Section 5.2 マイグレーション検出対象",
      "action": "マイグレーション検出対象表に「getLegacyDbPaths()で検出」列を追加。npm-global パターンの除外理由を注記として追加。"
    },
    {
      "id": "CONS-009",
      "category": "nice_to_have",
      "title": ".env.example のデフォルト値が db.sqlite のまま",
      "section_updated": "Section 11.3 間接的な影響",
      "action": ".env.example の具体的な修正内容（cm.db への変更、コメント追加）を明記。"
    }
  ],
  "skipped_items": [
    {
      "id": "CONS-008",
      "category": "nice_to_have",
      "title": "ホームディレクトリの表記揺れ",
      "reason": "コード例では関数名を、説明文では ~ を使用する現状の方針で一貫性があると判断。過度な統一は可読性を損なう可能性があるため見送り。"
    }
  ],
  "summary": "Stage 2 整合性レビューの指摘事項 9 件のうち 8 件を設計書に反映。must_fix 2件、should_fix 4件は全て対応済み。nice_to_have 3件のうち 2件（CONS-007, CONS-009）を対応し、1件（CONS-008）は現状の方針で問題ないと判断し見送り。主な更新内容: (1) Section 4.1 に現状と修正後の差異を明確化、(2) Section 6.1.2/6.1.3 に詳細な修正箇所を追記、(3) Section 4.2/6.1.1 の Strategy vs 関数ベースの矛盾を解消、(4) Section 11.3 のファイル数を正確な数値に更新、(5) docs/architecture.md のスコープ外明記。"
}
