{
  "issue_number": 326,
  "issue_title": "fix: インタラクティブプロンプト検出時にtmuxバッファ全体がレスポンスとして保存される",
  "acceptance_criteria": [
    "インタラクティブプロンプト（選択肢形式の質問）が検出された場合、AssistantメッセージにはlastCapturedLine以降の行のみが含まれる",
    "前の会話の内容がAssistantメッセージに混入しない",
    "箇所1（Claude早期プロンプト検出）と箇所2（フォールバックプロンプト検出）の両方で修正が適用される",
    "箇所2のレスポンスにもstripAnsi()が適用される",
    "resolveExtractionStartIndex()関数が@internal exportとして実装される",
    "既存のextractResponse()の通常レスポンス抽出パスの動作が変わらない"
  ],
  "implementation_tasks": [
    "Task 1.1: resolveExtractionStartIndex()ヘルパー関数を src/lib/response-poller.ts に追加（@internal export）",
    "Task 1.2: 箇所1（行326-341付近のClaude早期プロンプト検出）を修正。stripAnsi(fullOutput)の代わりにlines.slice(startIndex)を使用",
    "Task 1.3: 箇所2（行487-499付近のフォールバックプロンプト検出）を修正。fullOutputの代わりにlines.slice(startIndex)を使用し、stripAnsi()を追加",
    "Task 1.4: 通常レスポンスパス（行364-386付近）の既存4分岐ロジックをresolveExtractionStartIndex()呼び出しにリファクタリング",
    "Task 2.1: tests/unit/lib/resolve-extraction-start-index.test.ts を新規作成（10テストケース）"
  ],
  "design_doc_path": "dev-reports/design/issue-326-prompt-response-extraction-design-policy.md",
  "work_plan_path": "dev-reports/issue/326/work-plan.md",
  "key_files": [
    "src/lib/response-poller.ts"
  ],
  "new_test_files": [
    "tests/unit/lib/resolve-extraction-start-index.test.ts"
  ],
  "target_coverage": 80,
  "implementation_notes": [
    "resolveExtractionStartIndex()の引数: lastCapturedLine, totalLines, bufferReset, cliToolId, findRecentUserPromptIndex",
    "関数冒頭でlastCapturedLine = Math.max(0, lastCapturedLine)の防御的バリデーション",
    "関数内部でbufferWasReset = lastCapturedLine >= totalLines || bufferResetを計算",
    "cliToolId === 'claude'ブロック内から呼ばれる箇所1では、codex分岐は到達不能だが汎用性のためcliToolIdを引数として保持",
    "部分レスポンスパス（L501-533付近）は修正対象外",
    "箇所2のstripAnsi追加はセキュリティ上の必須修正（dangerouslySetInnerHTMLパス経由のXSSリスク軽減）"
  ]
}
