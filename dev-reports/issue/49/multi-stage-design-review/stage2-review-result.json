{
  "stage": 2,
  "stage_name": "整合性レビュー",
  "issue_number": 49,
  "review_date": "2026-01-30",
  "status": "conditionally_approved",
  "score": 4,
  "findings": {
    "must_fix": [
      {
        "id": "MF-001",
        "category": "設計 vs コード",
        "title": "debounce関数の参照先が存在しない",
        "description": "設計書 Section 8.2 で `import { debounce } from '@/lib/utils'` と記載されているが、実際には src/lib/utils.ts ファイルは存在しない。",
        "design_reference": "設計書 8.2 デバウンス実装",
        "current_code": "src/lib/utils.ts は存在しない",
        "recommendation": "debounce関数を新規作成するか、既存のlodash-esや自作hookを使用する方針を設計書に明記する必要がある",
        "severity": "high"
      }
    ],
    "should_fix": [
      {
        "id": "SF-001",
        "category": "設計内部整合性",
        "title": "PATCHリクエストのエンドポイント設計の曖昧さ",
        "description": "設計書 Section 6.1 では PATCH を `/api/worktrees/:id/files/:path` に配置と記載。一方、Issue #49では `/api/worktrees/:id/files/:path/rename` との記載もあり、混乱がある。設計書 6.2 では PATCH リクエストボディに `action: rename` を使用する方式が示されており、これが正しい実装方針と思われるが、明確化が必要。",
        "design_reference": "設計書 6.1, 6.2, Issue #49 技術仕様",
        "recommendation": "設計書でPATCHエンドポイントが `[...path]/route.ts` 内で `action: rename` により処理される旨を明確に記載する",
        "severity": "medium"
      },
      {
        "id": "SF-002",
        "category": "設計 vs コード",
        "title": "既存route.tsのパス検証との統合方針の具体化",
        "description": "設計書 7.2 では既存route.ts（34-39行目）の独自パス検証を `isPathSafe()` に置き換えると記載されているが、実際の既存コードでは `normalizedPath.includes('..') || normalizedPath.startsWith('/')` という条件で検証している。isPathSafe() はより堅牢（URLデコード、null byte検出など）だが、既存動作との互換性確認が必要。",
        "design_reference": "設計書 7.2",
        "current_code": "route.ts L34-39: `if (normalizedPath.includes('..') || normalizedPath.startsWith('/')) { ... }`",
        "recommendation": "isPathSafe() への移行により既存の正当なリクエストが拒否されないことをテストケースで確認する",
        "severity": "medium"
      },
      {
        "id": "SF-003",
        "category": "設計 vs コード",
        "title": "FileTreeView.tsx の行数と変更規模の再確認",
        "description": "設計書で FileTreeView.tsx は 465行と記載されているが、実際には 465行で一致。ただし、右クリックメニュー追加は状態管理、イベントハンドラ、Menu UIコンポーネント追加など大幅な変更となるため、推定150-200行の追加が見込まれる。コンポーネント分割を検討すべき。",
        "design_reference": "設計書 2.1, 11.2",
        "current_code": "FileTreeView.tsx: 465行",
        "recommendation": "右クリックメニュー機能を ContextMenu.tsx として分離し、FileTreeView.tsx の肥大化を防止する",
        "severity": "medium"
      }
    ],
    "nice_to_have": [
      {
        "id": "NTH-001",
        "category": "設計内部整合性",
        "title": "Toast コンポーネントの配置ディレクトリ",
        "description": "設計書では `src/components/common/Toast.tsx` に配置予定だが、このディレクトリは新規作成となる。Issue #49 では将来的な汎用UIコンポーネント配置場所として言及あり。",
        "design_reference": "設計書 3.1, Issue #49",
        "recommendation": "common/ ディレクトリ作成と配置方針をCLAUDE.mdに追記することを検討",
        "severity": "low"
      },
      {
        "id": "NTH-002",
        "category": "設計 vs Issue",
        "title": "大容量ファイル警告の閾値",
        "description": "設計書とIssue #49の両方で 500KB を警告閾値、1MB を上限としており整合している。ただし、既存の LIMITS.MAX_FILE_SIZE_PREVIEW (file-tree.ts) の定義値との一致も確認済み。",
        "design_reference": "設計書 8.1, 8.3",
        "current_code": "file-tree.ts L58: MAX_FILE_SIZE_PREVIEW: 1024 * 1024",
        "recommendation": "現状問題なし。設計どおり既存定数を流用する方針で良い",
        "severity": "low"
      },
      {
        "id": "NTH-003",
        "category": "設計 vs コード",
        "title": "WorktreeDetailRefactored.tsx の変更箇所特定",
        "description": "設計書では L891-901 のファイル選択ハンドラーへの拡張子判定分岐追加と記載。実際のコードでは handleFileSelect (L895-897) が該当し、現在は単に setFileViewerPath を呼び出すだけ。ここに .md 判定ロジックを追加する設計は妥当。",
        "design_reference": "設計書 11.2",
        "current_code": "WorktreeDetailRefactored.tsx L895-897: handleFileSelect",
        "recommendation": "設計どおりの実装で問題なし",
        "severity": "low"
      }
    ]
  },
  "consistency_checks": {
    "design_vs_code": [
      {
        "item": "既存API route.ts の構造",
        "design_doc": "GET のみ実装、PUT/POST/DELETE/PATCH を追加",
        "actual_code": "GET のみ実装（95行）",
        "status": "consistent",
        "note": "設計どおり"
      },
      {
        "item": "react-markdown の使用",
        "design_doc": "既存依存として react-markdown + remark-gfm を使用",
        "actual_code": "package.json に react-markdown ^10.1.0, remark-gfm ^4.0.1 が存在。MessageList.tsx で使用実績あり",
        "status": "consistent",
        "note": "設計どおり"
      },
      {
        "item": "path-validator.ts の isPathSafe 関数",
        "design_doc": "パストラバーサル対策に isPathSafe() を使用",
        "actual_code": "isPathSafe() は path-validator.ts L29-68 に実装済み。URLデコード、null byte検出、相対パス検証を含む堅牢な実装",
        "status": "consistent",
        "note": "設計どおり使用可能"
      },
      {
        "item": "file-tree.ts の EXCLUDED_PATTERNS",
        "design_doc": ".env, .git 等への書き込み禁止",
        "actual_code": "EXCLUDED_PATTERNS (L34-47) に .git, .env, .env.*, node_modules 等が定義済み",
        "status": "consistent",
        "note": "設計どおり流用可能"
      },
      {
        "item": "FileTreeView.tsx の TreeItem インターフェース",
        "design_doc": "TreeItem インターフェースに準拠",
        "actual_code": "types/models.ts に TreeItem 定義あり。name, type, size, extension, itemCount フィールド",
        "status": "consistent",
        "note": "設計どおり"
      },
      {
        "item": "debounce 関数",
        "design_doc": "@/lib/utils から import",
        "actual_code": "src/lib/utils.ts は存在しない",
        "status": "inconsistent",
        "note": "MF-001 として報告済み"
      }
    ],
    "design_internal": [
      {
        "item": "API エンドポイントの一貫性",
        "section_a": "6.1 エンドポイント一覧",
        "section_b": "6.2 リクエスト/レスポンス仕様",
        "status": "consistent",
        "note": "全てのHTTPメソッドが同一パス `/api/worktrees/:id/files/:path` を使用"
      },
      {
        "item": "エラーコードの一貫性",
        "section_a": "6.3 エラーコード一覧",
        "section_b": "7.1 脅威と対策",
        "status": "consistent",
        "note": "INVALID_PATH (400) がパストラバーサル検出時のコードとして一貫"
      },
      {
        "item": "ファイル操作ロジックの配置",
        "section_a": "4.3 Facadeパターン",
        "section_b": "11.2 変更ファイル一覧",
        "status": "consistent",
        "note": "file-operations.ts を新規作成し、route.ts は薄いController層として機能"
      },
      {
        "item": "表示モードの型定義",
        "section_a": "4.2 Strategyパターン",
        "section_b": "5.1 型定義",
        "status": "consistent",
        "note": "ViewMode = 'split' | 'editor' | 'preview' が両セクションで一致"
      }
    ],
    "design_vs_issue": [
      {
        "item": "機能要件のスコープ",
        "design_doc": "md ファイルのみ編集可、画像アップロードなし、自動保存なし",
        "issue": "対象外として同項目を明記",
        "status": "consistent",
        "note": "完全一致"
      },
      {
        "item": "トースト通知の実装方針",
        "design_doc": "自作 Toast.tsx を src/components/common/ に配置",
        "issue": "新規 Toast.tsx 作成、src/components/common/ 新規作成",
        "status": "consistent",
        "note": "完全一致"
      },
      {
        "item": "ローカルストレージキー",
        "design_doc": "commandmate:md-editor-view-mode",
        "issue": "commandmate:md-editor-view-mode",
        "status": "consistent",
        "note": "完全一致"
      },
      {
        "item": "再帰削除の確認フロー",
        "design_doc": "DELETE リクエストに recursive=true クエリパラメータ",
        "issue": "空でないディレクトリの再帰削除確認ダイアログ、recursive=true クエリパラメータ",
        "status": "consistent",
        "note": "完全一致"
      },
      {
        "item": "リネームAPIの実装方法",
        "design_doc": "PATCH メソッドで action: rename を使用",
        "issue": "推奨実装方法として action: rename フィールドでの識別を記載",
        "status": "consistent",
        "note": "SF-001 で明確化を推奨"
      }
    ]
  },
  "risk_assessment": {
    "technical": "low",
    "security": "low",
    "operational": "low"
  },
  "reviewed_files": [
    "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/dev-reports/design/issue-49-markdown-editor-design-policy.md",
    "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/app/api/worktrees/[id]/files/[...path]/route.ts",
    "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/components/worktree/FileTreeView.tsx",
    "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/lib/path-validator.ts",
    "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/lib/file-tree.ts",
    "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/components/worktree/MessageList.tsx",
    "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/components/worktree/WorktreeDetailRefactored.tsx",
    "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/package.json",
    "/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/types/models.ts"
  ],
  "timestamp": "2026-01-30T12:00:00Z"
}
