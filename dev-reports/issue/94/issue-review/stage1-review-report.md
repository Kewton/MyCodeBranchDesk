# Issue #94 レビューレポート

**レビュー日**: 2026-01-30
**フォーカス**: 通常レビュー（整合性・正確性）
**イテレーション**: 1回目

---

## サマリー

| カテゴリ | 件数 |
|---------|------|
| Must Fix | 3 |
| Should Fix | 5 |
| Nice to Have | 3 |

---

## Must Fix（必須対応）

### MF-1: 受け入れ条件が記載されていない

**カテゴリ**: 完全性
**場所**: Issue本文

**問題**:
Issue本文には概要・背景・解決策のみ記載されており、受け入れ条件（Acceptance Criteria）セクションが存在しません。これにより、機能の完了条件が不明確となり、実装者とレビュアーの間で認識の齟齬が生じるリスクがあります。

**推奨対応**:
具体的で検証可能な受け入れ条件を追加してください。

例：
```markdown
## 受け入れ条件
- [ ] 1ファイルあたり最大10MBまでアップロード可能
- [ ] 対応形式: .png, .jpg, .jpeg, .gif, .md, .txt, .csv
- [ ] アップロード中のプログレス表示
- [ ] アップロード完了後にファイルツリーが自動更新される
- [ ] アップロード成功/失敗時にToast通知表示
```

---

### MF-2: 対象ファイルの拡張子が曖昧

**カテゴリ**: 明確性
**場所**: ## 提案する解決策 セクション

**問題**:
「画像ファイル」「テキストファイル」といった曖昧な表現のみ記載されています。以下のような点が不明です：
- 画像ファイル: .svg, .bmp, .ico, .webp は含まれるか？
- テキストファイル: .log, .yaml, .json は含まれるか？

**証拠**:
現在のIssue記載：
> 対象ファイル：
> 画像ファイル
> テキストファイル
> markdownファイル
> csvファイル

**推奨対応**:
具体的な拡張子を明記してください：
```markdown
対象ファイル：
- 画像ファイル: .png, .jpg, .jpeg, .gif, .webp
- テキストファイル: .txt
- markdownファイル: .md
- csvファイル: .csv
```

---

### MF-3: 既存ファイル操作APIとの整合性が不明確

**カテゴリ**: 技術的妥当性
**場所**: ## 提案する解決策 セクション

**問題**:
既存の `/api/worktrees/:id/files/:path` APIはJSONリクエストボディ（`request.json()`）でコンテンツを受け取る設計です。画像などのバイナリファイルのアップロードには `multipart/form-data` 形式への対応が必要となりますが、この技術的な変更について言及がありません。

**証拠**:
`src/app/api/worktrees/[id]/files/[...path]/route.ts` のPOSTハンドラ：
```typescript
const body = await request.json();
const { type, content } = body;
```

**推奨対応**:
以下のいずれかの方針を明確にしてください：
1. 既存APIを拡張して `multipart/form-data` に対応
2. 新規エンドポイント（例: `/api/worktrees/:id/upload`）を作成
3. Base64エンコードされたバイナリをJSONで送信（サイズ増大のデメリットあり）

---

## Should Fix（推奨対応）

### SF-1: 「指定したディレクトリ」の範囲が不明確

**カテゴリ**: 明確性
**場所**: ## 提案する解決策 セクション

**問題**:
「Filesにて指定したディレクトリにファイルをアップロード」と記載されていますが、ディレクトリの指定方法が不明です。

**推奨対応**:
具体的な指定方法を明確にしてください：
- FileTreeViewで選択中のディレクトリにアップロード
- 右クリックメニューから「ファイルをアップロード」を選択
- ドラッグ&ドロップ先のディレクトリにアップロード

---

### SF-2: ファイルサイズ制限の記載がない

**カテゴリ**: 技術的妥当性
**場所**: Issue本文

**問題**:
アップロード可能なファイルサイズの上限が定義されていません。

**証拠**:
- Next.js API Routesのデフォルト制限: 4MB
- 既存設定 (`src/config/editable-extensions.ts`): .mdファイルに1MB制限

**推奨対応**:
ファイルサイズ制限を明記してください。スクリーンショット画像を想定する場合、5-10MB程度が妥当と考えられます。

---

### SF-3: セキュリティ考慮事項の記載がない

**カテゴリ**: 技術的妥当性
**場所**: Issue本文

**問題**:
ファイルアップロード機能にはセキュリティリスクが伴いますが、対策について言及がありません。

**推奨対応**:
以下のセキュリティ対策について検討・記載してください：
1. パストラバーサル防止（既存 `isPathSafe()` を活用）
2. ファイル名のサニタイズ（特殊文字の除去）
3. MIMEタイプ検証（拡張子と実際のファイル内容の一致確認）
4. 悪意のあるファイル（.exe, .sh等）のブロック

---

### SF-4: UI/UXの詳細が不足

**カテゴリ**: 明確性
**場所**: Issue本文

**問題**:
ユーザーインターフェースに関する記述がありません。

**推奨対応**:
以下を明確にしてください：
- アップロードのトリガー: ボタンクリック / ドラッグ&ドロップ / 両方
- 複数ファイル同時アップロード: 対応 / 非対応
- 進捗表示: プログレスバー / スピナー
- フィードバック: Toast通知 / インライン表示

---

### SF-5: 関連Issue #95との依存関係が不明確

**カテゴリ**: 整合性
**場所**: Issue本文

**問題**:
Issue #95「画像ファイルビューワ」が別途存在します。画像をアップロードしても表示機能がなければ確認ができないため、依存関係を明確にすべきです。

**証拠**:
Issue #95の概要：
> Filesにて画像ファイルを視認したい
> claude codeと視覚的なコミュニケーションがとれるようになる

**推奨対応**:
Issue本文に関連Issueへのリンクと依存関係を記載してください：
```markdown
## 関連Issue
- #95 画像ファイルビューワ（アップロード画像の確認に必要）
```

---

## Nice to Have（あれば良い）

### NTH-1: 同名ファイル存在時の動作が未定義

**カテゴリ**: 完全性
**場所**: Issue本文

**問題**:
アップロード先に同名ファイルが存在する場合の動作が定義されていません。

**証拠**:
既存の `createFileOrDirectory()` 関数では、同名ファイル存在時に `FILE_EXISTS` エラーを返す実装になっています。

**推奨対応**:
以下のいずれかの動作を定義してください：
- 上書き確認ダイアログを表示
- 自動リネーム（例：file(1).png）
- エラーとして拒否（現行踏襲）

---

### NTH-2: 実装フェーズの分割案がない

**カテゴリ**: 完全性
**場所**: Issue本文

**問題**:
段階的な実装計画の記載がありません。

**証拠**:
Issue #49（マークダウンエディタ）では5フェーズに分割して実装された実績があります。

**推奨対応**:
段階的な実装計画を記載することを推奨します：
```markdown
## 実装フェーズ
- Phase 1: 単一ファイルアップロード（ボタンから選択）
- Phase 2: 複数ファイル対応
- Phase 3: ドラッグ&ドロップ対応
```

---

### NTH-3: テスト観点の記載がない

**カテゴリ**: 完全性
**場所**: Issue本文

**問題**:
テスト観点の記載がありません。

**推奨対応**:
テスト観点を追加することを推奨します：
```markdown
## テスト観点
- 正常系: 各対応形式のファイルアップロード成功
- 異常系: サイズ超過、不正拡張子、パストラバーサル攻撃
- E2E: ブラウザからのアップロード操作一連の流れ
```

---

## 参照ファイル

### コード

| ファイル | 関連性 |
|---------|--------|
| `src/app/api/worktrees/[id]/files/[...path]/route.ts` | 既存のファイル操作API。バイナリファイル対応の拡張が必要 |
| `src/lib/file-operations.ts` | ファイル操作ビジネスロジック。バイナリ対応関数の追加が必要 |
| `src/lib/path-validator.ts` | パストラバーサル防止。isPathSafe()をアップロード時にも使用 |
| `src/config/editable-extensions.ts` | 対応拡張子の設定。アップロード可能拡張子の設定に参考 |
| `src/components/worktree/FileTreeView.tsx` | ファイルツリーUI。アップロードUIの追加箇所 |

### ドキュメント

| ファイル | 関連性 |
|---------|--------|
| `CLAUDE.md` | Issue #49のマークダウンエディタ実装の参考情報 |
| `docs/architecture.md` | システムアーキテクチャ。ファイル操作の設計指針 |
| `docs/TRUST_AND_SAFETY.md` | セキュリティモデル。ファイル操作のセキュリティ考慮事項 |
