{
  "issue_number": 162,
  "focus_area": "整合性",
  "stage": 2,
  "stage_name": "整合性レビュー",
  "status": "conditionally_approved",
  "score": 4,
  "findings": {
    "must_fix": [
      {
        "id": "MF-S2-001",
        "category": "i18n-consistency",
        "title": "ContextMenu labels are hardcoded English but design assumes i18n via worktree.json",
        "description": "The design specifies adding i18n keys like fileTree.move to worktree.json and using useTranslations('worktree') in components. However, the existing ContextMenu.tsx does NOT use i18n at all - all labels ('New File', 'New Directory', 'Rename', 'Delete', 'Upload File') are hardcoded in English. Adding 'Move' via i18n would be inconsistent with the other menu items. Either all ContextMenu labels should be internationalized (scope expansion) or the new 'Move' label should remain hardcoded English to match existing patterns.",
        "design_reference": "Section 5-1, Section 3-1-4",
        "actual_code": "src/components/worktree/ContextMenu.tsx lines 112-146: all labels are hardcoded English strings",
        "recommendation": "For consistency, hardcode the 'Move' label in English to match existing ContextMenu patterns. If i18n for ContextMenu is desired, it should be a separate refactoring issue covering all menu items."
      },
      {
        "id": "MF-S2-002",
        "category": "i18n-consistency",
        "title": "FileTreeView.tsx does not use i18n - adding formatRelativeTime with locale parameter is pattern-inconsistent",
        "description": "The design specifies formatRelativeTime(item.birthtime, locale) in FileTreeView.tsx, but FileTreeView.tsx currently does not import or use useTranslations or next-intl at all. There is no existing locale variable available in the component. The design needs to address how the locale parameter will be obtained within FileTreeView (e.g., via useLocale() from next-intl) or the TreeNode component.",
        "design_reference": "Section 3-2-3, Section 3-2-4",
        "actual_code": "src/components/worktree/FileTreeView.tsx - no i18n imports present",
        "recommendation": "Add useLocale() from next-intl to FileTreeView or pass locale via props from WorktreeDetailRefactored. Document the exact locale acquisition strategy in the design."
      }
    ],
    "should_fix": [
      {
        "id": "SF-S2-001",
        "category": "error-handling-consistency",
        "title": "Move error messages should follow existing error.json pattern, not worktree.json",
        "description": "The design places move success/failure messages in worktree.json (fileTree.moveSuccess, fileTree.moveFailed). However, the existing pattern for file operation error messages uses the error.json namespace (error.fileOps.failedToCreateFile, error.fileOps.failedToRename, etc.) accessed via tError('fileOps.failedToRename'). Move failure messages should follow this established pattern.",
        "design_reference": "Section 5-1 (worktree.json fileTree section)",
        "actual_code": "locales/en/error.json line 6-11: fileOps section with failedToCreateFile, failedToCreateDirectory, failedToRename, failedToDelete",
        "recommendation": "Add 'failedToMove' to error.json fileOps section (not worktree.json). Keep UI labels (e.g., 'Move', 'Move to...') in worktree.json if i18n is applied, but error messages should go in error.json."
      },
      {
        "id": "SF-S2-002",
        "category": "api-consistency",
        "title": "PATCH handler validation message should list all supported actions",
        "description": "The current PATCH handler returns 'Unknown action. Supported: \"rename\"' when an unknown action is received. When 'move' is added, this error message must be updated to 'Unknown action. Supported: \"rename\", \"move\"'. The design does not explicitly mention this error message update.",
        "design_reference": "Section 3-1-2",
        "actual_code": "src/app/api/worktrees/[id]/files/[...path]/route.ts line 375: action !== 'rename' check with error message",
        "recommendation": "Update the design to explicitly note the error message change from 'Supported: \"rename\"' to 'Supported: \"rename\", \"move\"'."
      },
      {
        "id": "SF-S2-003",
        "category": "validation-consistency",
        "title": "validateFileOperation() should handle empty path consistently with isPathSafe()",
        "description": "The existing isPathSafe() function returns false for empty strings (line 31-33). The design's validateFileOperation() calls isPathSafe() first, which would catch empty paths. However, renameFileOrDirectory() currently also validates the new name via isValidNewName() which has its own empty check. The design should clarify that validateFileOperation() only validates the source path and that moveFileOrDirectory() has separate validation for the destination path via isPathSafe().",
        "design_reference": "Section 3-1-0, Section 3-1-1",
        "actual_code": "src/lib/path-validator.ts line 31-33: empty path check in isPathSafe()",
        "recommendation": "The design already includes a validation responsibility matrix (Section 3-1-0 table) which is good. Ensure implementation follows it precisely."
      },
      {
        "id": "SF-S2-004",
        "category": "component-consistency",
        "title": "FileViewer copy button needs locale for Toast messages if i18n is applied",
        "description": "The design specifies adding a copy button to FileViewer.tsx with success/failure feedback via icon change (Copy -> Check). The design also lists i18n keys for copySuccess and copyFailed in worktree.json. However, FileViewer.tsx currently does not use i18n at all. The icon-based feedback approach (Copy -> Check icon) does not require text, so the i18n keys may be unnecessary unless Toast notifications are also used.",
        "design_reference": "Section 3-3-1, Section 5-1",
        "actual_code": "src/components/worktree/FileViewer.tsx - no i18n imports, no Toast usage",
        "recommendation": "Clarify whether copy feedback uses icon-only approach (no i18n needed) or Toast notification (i18n needed). If icon-only, remove copySuccess/copyFailed from worktree.json. If Toast is used, add useLocale/useTranslations to FileViewer."
      },
      {
        "id": "SF-S2-005",
        "category": "security-consistency",
        "title": "Move destination should also check isProtectedDirectory() for the destination directory itself",
        "description": "The design's Section 4-1 security table says isProtectedDirectory() is used for move destination verification. The existing isProtectedDirectory() checks if a path starts with .git, .github, or node_modules. However, the design's moveFileOrDirectory() should also prevent moving items INTO these protected directories (e.g., moving a file into .git/), not just preventing deletion of them. The design mentions this but the validation responsibility table (Section 3-1-0) only lists 'protection directory check' for moveFileOrDirectory(), not for validateFileOperation(). This is correct but should be more explicit about what 'into' means.",
        "design_reference": "Section 3-1-0 table, Section 4-1",
        "actual_code": "src/config/file-operations.ts line 46-67: isProtectedDirectory() implementation checks path prefix",
        "recommendation": "The design correctly assigns protected directory check to moveFileOrDirectory() (not validateFileOperation()). Ensure implementation checks both: (1) destination directory itself is not protected, and (2) the final path (destination + filename) does not land inside a protected directory."
      }
    ],
    "consider": [
      {
        "id": "CO-S2-001",
        "category": "pattern-consistency",
        "title": "Existing file operation handlers in WorktreeDetailRefactored use window.prompt/window.alert, but design uses MoveDialog and Toast",
        "description": "The existing handleNewFile, handleNewDirectory, handleRename use window.prompt() for input and window.alert() for error display. The new handleMove uses a dedicated MoveDialog component and Toast notifications. This creates an inconsistency in user interaction patterns within the same component. While the MoveDialog approach is arguably superior, the mixed patterns may confuse users.",
        "design_reference": "Section 3-1-5, Section 3-1-6",
        "actual_code": "src/components/worktree/WorktreeDetailRefactored.tsx lines 1231-1337: window.prompt/window.alert usage",
        "recommendation": "Accept the inconsistency for now. The useFileOperations() hook (Phase 2) is designed to eventually consolidate all file operation handlers, which would be the right time to migrate existing handlers to Dialog/Toast patterns."
      },
      {
        "id": "CO-S2-002",
        "category": "api-consistency",
        "title": "PATCH move action uses 'destination' field while rename uses 'newName' - consistent with different semantics",
        "description": "The design uses 'destination' for move and 'newName' for rename in the PATCH request body. This is semantically correct (move targets a directory, rename targets a name), but slightly different API field naming conventions. This is acceptable as the actions have fundamentally different semantics.",
        "design_reference": "Section 3-1-2",
        "actual_code": "src/app/api/worktrees/[id]/files/[...path]/route.ts line 373: body destructuring for rename",
        "recommendation": "No change needed. The naming is semantically appropriate."
      },
      {
        "id": "CO-S2-003",
        "category": "date-formatting-consistency",
        "title": "formatRelativeTime() in date-utils.ts vs inline formatDistanceToNow in WorktreeCard.tsx",
        "description": "WorktreeCard.tsx calls formatDistanceToNow() inline (line 46) with { addSuffix: true, locale: dateFnsLocale }. The new formatRelativeTime() in date-utils.ts wraps the same function. For full consistency, WorktreeCard.tsx should also use formatRelativeTime() in the future, but that is scope creep for this Issue.",
        "design_reference": "Section 3-2-4",
        "actual_code": "src/components/worktree/WorktreeCard.tsx line 46",
        "recommendation": "Document this as a future DRY improvement. The new formatRelativeTime() can serve as the canonical utility for future consolidation."
      },
      {
        "id": "CO-S2-004",
        "category": "i18n-consistency",
        "title": "Design i18n key 'moveCancel' in worktree.json duplicates existing common.json 'cancel' key",
        "description": "The design adds fileTree.moveCancel: 'Cancel' to worktree.json, but common.json already has a 'cancel' key. The MoveDialog could use the existing common.cancel key for the cancel button to follow DRY principle.",
        "design_reference": "Section 5-1",
        "actual_code": "locales/en/common.json line 2: 'cancel': 'Cancel'",
        "recommendation": "Use tCommon('cancel') for the MoveDialog cancel button instead of introducing a duplicate fileTree.moveCancel key."
      }
    ],
    "compliant": [
      {
        "id": "CP-S2-001",
        "category": "api-pattern",
        "title": "PATCH action dispatch pattern matches existing route.ts structure",
        "description": "The design correctly extends the existing PATCH handler with a new action type, following the established pattern of action-based dispatch in the same route file."
      },
      {
        "id": "CP-S2-002",
        "category": "error-code-pattern",
        "title": "ERROR_CODE_TO_HTTP_STATUS map extension follows existing pattern",
        "description": "Adding MOVE_SAME_PATH: 400 and MOVE_INTO_SELF: 400 to the existing centralized error code mapping is consistent with how upload-specific codes were added."
      },
      {
        "id": "CP-S2-003",
        "category": "file-operation-pattern",
        "title": "moveFileOrDirectory() follows existing function signature patterns",
        "description": "The function signature (worktreeRoot, sourcePath, destinationDir) -> Promise<FileOperationResult> is consistent with existing functions like renameFileOrDirectory(worktreeRoot, relativePath, newName)."
      },
      {
        "id": "CP-S2-004",
        "category": "security-pattern",
        "title": "isPathSafe() usage for both source and destination follows defense-in-depth pattern",
        "description": "The design correctly applies isPathSafe() validation on both source and destination paths, consistent with how rename validates both old and new paths."
      },
      {
        "id": "CP-S2-005",
        "category": "component-pattern",
        "title": "MoveDialog uses existing Modal component",
        "description": "Using the existing Modal component from src/components/ui/Modal.tsx follows the established UI pattern for dialog components."
      },
      {
        "id": "CP-S2-006",
        "category": "hook-pattern",
        "title": "useFileOperations() follows existing custom hook naming and location patterns",
        "description": "Placing the hook in src/hooks/useFileOperations.ts follows the established convention of src/hooks/use*.ts files like useContextMenu, useFileSearch, useAutoYes, etc."
      },
      {
        "id": "CP-S2-007",
        "category": "data-model-pattern",
        "title": "TreeItem birthtime as optional field follows backward compatibility pattern",
        "description": "Adding birthtime?: string to TreeItem follows the same pattern as other optional fields (size?, extension?, itemCount?) ensuring backward compatibility."
      },
      {
        "id": "CP-S2-008",
        "category": "utility-pattern",
        "title": "date-utils.ts placement in src/lib/ follows existing utility module pattern",
        "description": "Creating date-utils.ts alongside date-locale.ts in src/lib/ follows the established pattern of utility modules in the lib directory."
      },
      {
        "id": "CP-S2-009",
        "category": "clipboard-pattern",
        "title": "Reusing existing copyToClipboard() from clipboard-utils.ts",
        "description": "The design correctly reuses the existing copyToClipboard() utility which already handles ANSI stripping and empty string validation."
      },
      {
        "id": "CP-S2-010",
        "category": "fs-pattern",
        "title": "Using lstat() for birthtime follows existing readDirectory() pattern",
        "description": "readDirectory() in file-tree.ts already calls lstat() on line 179. Extracting birthtime from the same stat result adds no additional I/O cost."
      },
      {
        "id": "CP-S2-011",
        "category": "context-menu-pattern",
        "title": "ContextMenu onMove callback follows existing optional callback pattern",
        "description": "Adding onMove?: (path: string) => void follows the same pattern as onRename?, onDelete?, onUpload? in ContextMenuProps."
      },
      {
        "id": "CP-S2-012",
        "category": "error-result-pattern",
        "title": "createErrorResult() reuse follows DRY pattern",
        "description": "Using the existing createErrorResult() function for error responses in moveFileOrDirectory() is consistent with all other file operation functions."
      }
    ]
  },
  "risk_assessment": {
    "technical": "low",
    "security": "low",
    "operational": "low"
  },
  "consistency_matrix": [
    {
      "area": "File Operation Functions",
      "design_approach": "moveFileOrDirectory() with validateFileOperation() helper",
      "existing_pattern": "renameFileOrDirectory(), deleteFileOrDirectory() with inline validation",
      "consistency_rating": "high",
      "notes": "DRY improvement via validateFileOperation() is a positive enhancement over existing patterns"
    },
    {
      "area": "API Route",
      "design_approach": "PATCH action: 'move' dispatch with switch statement",
      "existing_pattern": "PATCH action: 'rename' with if-check",
      "consistency_rating": "high",
      "notes": "Natural extension of existing pattern"
    },
    {
      "area": "Error Code Mapping",
      "design_approach": "Add MOVE_SAME_PATH, MOVE_INTO_SELF to ERROR_CODE_TO_HTTP_STATUS",
      "existing_pattern": "Centralized error code map in route.ts",
      "consistency_rating": "high",
      "notes": "Perfect alignment with existing DRY pattern"
    },
    {
      "area": "i18n",
      "design_approach": "Add fileTree section to worktree.json, use useTranslations('worktree')",
      "existing_pattern": "ContextMenu/FileTreeView/FileViewer have NO i18n; error messages in error.json",
      "consistency_rating": "low",
      "notes": "Must-fix: ContextMenu and FileViewer do not use i18n. Error messages should go to error.json"
    },
    {
      "area": "Component Dialog Pattern",
      "design_approach": "MoveDialog with Modal, useFileOperations hook",
      "existing_pattern": "window.prompt() for rename/create, Toast for upload",
      "consistency_rating": "medium",
      "notes": "Improved pattern; acknowledged as Phase 1 of migration"
    },
    {
      "area": "Data Model",
      "design_approach": "TreeItem.birthtime?: string (ISO 8601)",
      "existing_pattern": "TreeItem with optional size?, extension?, itemCount?",
      "consistency_rating": "high",
      "notes": "Follows established optional field pattern"
    },
    {
      "area": "Security Validation",
      "design_approach": "isPathSafe() + isProtectedDirectory() for move",
      "existing_pattern": "isPathSafe() for rename, isProtectedDirectory() for delete",
      "consistency_rating": "high",
      "notes": "Correct combination of existing security patterns"
    },
    {
      "area": "Custom Hooks",
      "design_approach": "useFileOperations() in src/hooks/",
      "existing_pattern": "useContextMenu, useFileSearch, etc. in src/hooks/",
      "consistency_rating": "high",
      "notes": "Follows established hook directory and naming conventions"
    }
  ],
  "reviewed_files": [
    "src/lib/file-operations.ts",
    "src/lib/file-tree.ts",
    "src/lib/path-validator.ts",
    "src/lib/clipboard-utils.ts",
    "src/lib/date-locale.ts",
    "src/types/models.ts",
    "src/config/file-operations.ts",
    "src/config/system-directories.ts",
    "src/components/worktree/ContextMenu.tsx",
    "src/components/worktree/FileTreeView.tsx",
    "src/components/worktree/FileViewer.tsx",
    "src/components/worktree/WorktreeDetailRefactored.tsx",
    "src/components/worktree/WorktreeCard.tsx",
    "src/components/ui/Modal.tsx",
    "src/hooks/useContextMenu.ts",
    "src/app/api/worktrees/[id]/files/[...path]/route.ts",
    "locales/en/worktree.json",
    "locales/ja/worktree.json",
    "locales/en/common.json",
    "locales/en/error.json",
    "locales/ja/error.json",
    "dev-reports/design/issue-162-file-enhancement-design-policy.md"
  ],
  "timestamp": "2026-02-15T12:00:00Z"
}
