{"body":"## 概要\n\nIssue #163 の新しい解決アプローチ。複数行メッセージ送信後、Claude CLIが `[Pasted text #1 +XX lines]` と表示して処理を開始しない場合に、自動的にEnterキーを追加送信して処理を開始させる。\n\n## 背景\n\nIssue #163 では5回の実装試行（PR #171〜#176）で「ペースト検出を**回避**する」アプローチを取ったが、全てRevert済み。Claude CLIのink-based TextInputがpaste-bufferやbracketed paste markersに対して想定通りに反応しないことが判明している。\n\n本Issueでは、ペースト検出を回避するのではなく、Claude CLIの挙動に**追従**するアプローチを取る。\n\n## 解決方針（方式E: Pasted text検知 + Enter自動送信）\n\n### 原理\n\nClaude CLIは複数行テキストのペーストを検知すると `[Pasted text #N +XX lines]` と折りたたみ表示し、ユーザーの確認（Enter）を待つ。この挙動を利用し、検知時にEnterを自動送信する。\n\n### 実装フロー\n\n```\n1. sendKeys(message) + Enter送信（既存フロー）\n2. 短時間待機（例: 500ms）\n3. tmux出力をキャプチャ\n4. \"[Pasted text\" パターンを検知\n5. 検知した場合 → Enter追加送信\n6. （オプション）検知しない場合 → 通常の処理開始を確認\n```\n\n### 実装箇所\n\n主な変更対象は `src/lib/claude-session.ts` の `sendMessageToClaude()`:\n\n```typescript\n// 既存フロー\nawait sendKeys(sessionName, message, false);\nawait sendKeys(sessionName, '', true);  // Enter\n\n// 追加: Pasted text検知とEnter再送\nawait new Promise(resolve => setTimeout(resolve, 500));\nconst output = await capturePane(sessionName, { startLine: -10 });\nif (/\\[Pasted text #\\d+/.test(stripAnsi(output))) {\n  await sendKeys(sessionName, '', true);  // Enter追加送信\n}\n```\n\n### メリット\n\n- **シンプル**: 検知 + Enter送信のみ。過去の複雑なアプローチ（paste-buffer、bracketed paste等）と比較して極めて低リスク\n- **既存インフラ活用**: `sendKeys()`、`capturePane()`、`stripAnsi()` 等の既存関数をそのまま使用\n- **後方互換性**: 単一行メッセージの動作に影響なし（検知パターンが出現しないため追加Enterは送信されない）\n- **Claude CLIの挙動に追従**: ペースト検出を回避するのではなく、想定されたユーザー操作（Enter確認）を自動化\n\n### 考慮事項\n\n- **検知タイミング**: ペースト表示までのラグに対応するため、適切な待機時間の設定が必要\n- **リトライ**: 1回の検知で不十分な場合のリトライ戦略（最大N回、指数バックオフ等）\n- **Codex CLI**: 同様の問題が発生する場合は `src/lib/cli-tools/codex.ts` の `sendMessage()` にも適用\n- **検知パターンの堅牢性**: Claude CLIのバージョンアップで表示形式が変更された場合の対応\n\n## 影響範囲\n\n### 直接変更対象\n\n| ファイル | 変更内容 |\n|---------|---------|\n| `src/lib/claude-session.ts` | `sendMessageToClaude()` にPasted text検知+Enter再送ロジック追加 |\n| `src/lib/cli-tools/codex.ts` | `sendMessage()` に同様のロジック追加（必要に応じて） |\n\n### テスト\n\n| テストファイル | 変更内容 |\n|--------------|---------|\n| `tests/unit/lib/claude-session.test.ts` | Pasted text検知時のEnter再送テスト追加 |\n\n## 受け入れ条件\n\n- [ ] 3-10行の複数行メッセージが正常に送信・処理されること\n- [ ] 50行以上の複数行メッセージが正常に送信・処理されること\n- [ ] 単一行メッセージの既存動作に影響がないこと\n- [ ] `[Pasted text]` 検知時にEnterが自動送信されること\n- [ ] 特殊文字を含むメッセージが正しく処理されること\n\n## 関連Issue\n\n- #163 （親Issue・詳細な原因分析と過去の試行履歴）","title":"fix: 複数行メッセージ送信時の[Pasted text]表示を検知してEnter自動送信"}
