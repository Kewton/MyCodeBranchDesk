# Issue #95 レビューレポート（Stage 5）

**レビュー日**: 2026-01-30
**フォーカス**: 通常レビュー
**イテレーション**: 2回目
**ステージ**: Stage 5（通常レビュー 2回目）

---

## サマリー

| カテゴリ | 件数 |
|---------|------|
| Must Fix | 0 |
| Should Fix | 2 |
| Nice to Have | 2 |

**総合評価**: Stage 1で指摘された全ての問題（9件）が適切に対応済み。Issueは実装開始可能な高品質な状態となった。

---

## Stage 1 指摘事項の対応状況

### Must Fix（必須対応）- 全て対応済み

| ID | 指摘内容 | 状態 | 対応内容 |
|----|---------|------|---------|
| MF-1 | 受け入れ条件が未定義 | **対応済み** | 7項目の具体的な受け入れ条件を追加 |
| MF-2 | 技術的な実装方針が未記載 | **対応済み** | 4セクションに分けた詳細な技術仕様を追加 |

### Should Fix（推奨対応）- 全て対応済み

| ID | 指摘内容 | 状態 | 対応内容 |
|----|---------|------|---------|
| SF-1 | FileViewer構成との関係が不明確 | **対応済み** | 関連コンポーネント一覧とDRY原則対応を明記 |
| SF-2 | API層での画像バイナリ対応が未検討 | **対応済み** | Base64 data URI形式、後方互換性維持を詳細記載 |
| SF-3 | セキュリティ考慮事項が未記載 | **対応済み** | 専用セクションで4項目のセキュリティ対策を記載 |
| SF-4 | 誤字「ビューワてま」 | **対応済み** | 「ビューワで」に修正 |

### Nice to Have（あれば良い）- 全て対応済み

| ID | 指摘内容 | 状態 | 対応内容 |
|----|---------|------|---------|
| NTH-1 | 関連Issueへの参照がない | **対応済み** | Issue #49への参照を追加 |
| NTH-2 | ユースケースの具体例がない | **対応済み** | 4つの具体的ユースケースを追加 |
| NTH-3 | 対象外事項の明記がない | **対応済み** | 5項目のスコープ外事項を追加 |

---

## 新規指摘事項

### Should Fix（推奨対応）

#### SF-001: FileContent interfaceの定義場所の不整合

**カテゴリ**: 整合性
**場所**: 技術的実装方針 - 型定義の更新

**問題**:
Issueでは「`src/types/models.ts`にFileContent interfaceを拡張」と記載されているが、実際のFileContent interfaceは`src/components/worktree/FileViewer.tsx`（L18-23）にローカル定義されている。

**現在の定義（FileViewer.tsx L18-23）**:
```typescript
interface FileContent {
  path: string;
  content: string;
  extension: string;
  worktreePath: string;
}
```

**推奨対応**:
型定義の統一方針を明確に記載すること:
1. FileViewer.tsx内のローカル定義を拡張する、または
2. `src/types/models.ts`に移動して一元管理する

---

#### SF-002: SVGファイルのマジックバイト検証の詳細不足

**カテゴリ**: 技術的妥当性
**場所**: セキュリティ考慮事項 - MIMEタイプ検証

**問題**:
SVGはテキストベースの形式であり、PNG/JPEG/GIF/WebPのようなバイナリのマジックバイト検証とは異なるアプローチが必要。

**推奨対応**:
以下を明記すること:
1. XMLヘッダ判定: `<?xml version=`で始まるか
2. SVGタグ判定: `<svg`を含むか
3. セキュリティ対策: 悪意のある`<script>`タグのサニタイズ検討

---

### Nice to Have（あれば良い）

#### NTH-001: isImageFile()とisEditableFile()の関係性明記

**カテゴリ**: 完全性
**場所**: 影響ファイル一覧 - 軽微な変更

**現状**:
`src/lib/file-operations.ts`へのisImageFile()追加が記載されているが、既存のisEditableFile()（L83-86）との関係性が不明確。

**推奨対応**:
同様のパターンで実装することを明記し、将来的な「ファイル種別判定ユーティリティ」への統合可能性を補足すると理解しやすい。

---

#### NTH-002: モーダル拡大表示機能の実装判断基準

**カテゴリ**: 完全性
**場所**: 受け入れ条件 - 画像クリック時にモーダルで拡大表示（オプション）

**現状**:
受け入れ条件で「（オプション）」と記載されているが、実装判断の基準が不明確。

**推奨対応**:
「基本実装完了後、工数に余裕があれば実装」または「Phase 2として別Issueで対応」など、判断基準を明記すると良い。

---

## 参照ファイル

### コード

| ファイル | 行番号 | 関連性 |
|---------|--------|--------|
| `src/components/worktree/FileViewer.tsx` | 18-23 | FileContent interfaceの現在の定義場所 |
| `src/lib/file-operations.ts` | 83-86 | isEditableFile()関数（パターン参考） |
| `src/app/api/worktrees/[id]/files/[...path]/route.ts` | 106-139 | GET handler拡張対象 |
| `src/config/editable-extensions.ts` | 全体 | image-extensions.tsの設計参考 |
| `src/types/models.ts` | 全体 | FileContent interfaceは未定義 |

### ドキュメント

| ファイル | 関連性 |
|---------|--------|
| `dev-reports/design/issue-49-markdown-editor-design-policy.md` | 設計パターン参考 |
| `CLAUDE.md` | 実装完了後の更新対象 |

---

## 結論

Issue #95はStage 1のレビューを経て大幅に改善され、以下の点で高品質な状態となった:

1. **明確な受け入れ条件**: 7項目の検証可能な条件を定義
2. **詳細な技術仕様**: 対応形式、表示方法、API拡張、設定管理を網羅
3. **セキュリティ考慮**: ホワイトリスト、サイズ上限、MIMEタイプ検証、パストラバーサル防止
4. **影響範囲の明確化**: 主要変更/新規作成/軽微な変更ファイルを分類
5. **テスト戦略**: 単体テスト、E2Eテストの具体的シナリオを記載

残りの指摘2件（should_fix）は既存コードとの整合性に関する軽微な修正であり、実装フェーズで対応可能。2件（nice_to_have）はドキュメントの可読性向上のための提案である。

**判定**: 実装開始可能
