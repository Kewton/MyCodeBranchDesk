# Issue #323 仮説検証レポート

## 検証日時
- 2026-02-21

## 検証結果サマリー

| # | 仮説/主張 | 判定 | 根拠 |
|---|----------|------|------|
| 1 | `auto-yes-manager.ts` は706行 | Confirmed | ファイル末尾がL706 |
| 2 | `pollAutoYes()` が139行・7責務・条件分岐14個 | Confirmed | L455-L593（139行）、7責務確認、分岐約12-14個 |
| 3 | 外部依存が6つ（全てモック必須） | Confirmed | captureSessionOutput, detectThinking, detectPrompt, resolveAutoAnswer, sendPromptAnswer, CLIToolManager の6依存 |
| 4 | `stopCheckBaselineLength` の初期値 `-1` と3パターン分岐 | Confirmed | L660で初期値 `-1`、L508/L513/L520で3パターン（＋暗黙の第4パターン：長さ変化なし=スキップ） |
| 5 | pollerState 存在確認が複数箇所で重複（L457, L606, L680等） | Confirmed | pollAutoYes/scheduleNextPoll/stopAutoYesPollingの各関数冒頭で同一パターン重複 |

## 詳細検証

### 仮説 1: `auto-yes-manager.ts` は706行

**Issue内の記述**: `src/lib/auto-yes-manager.ts`（706行）の複雑度を下げるリファクタリング

**検証手順**:
1. `src/lib/auto-yes-manager.ts` を読み込み
2. ファイル末尾行を確認

**判定**: Confirmed

**根拠**: ファイルの最終行はL706（`stopAllAutoYesPolling()`の末尾の空行）。

---

### 仮説 2: `pollAutoYes()` が139行・7責務・条件分岐14個

**Issue内の記述**: `pollAutoYes()` 関数（139行、条件分岐14個、責務7つ）

**検証手順**:
1. L455 `async function pollAutoYes` ～ L593 `}` を確認
2. 関数内の条件分岐と責務を数える

**判定**: Confirmed

**根拠**:
- 行数：L455〜L593 = 139行 ✅
- 7責務（確認済み）：
  1. タイマー停止確認（L457-458）
  2. auto-yes有効性チェック（L461-465）
  3. tmux出力キャプチャ（L469）
  4. ANSI処理（L472）
  5. thinking状態検出（L492-496）
  6. 停止条件チェック（L498-525）
  7. プロンプト検出・自動応答（L527-582）
- 条件分岐（`if/else if/||/&&` カウント）：約12〜14個。Issueの「14個」は概数として妥当 ✅

---

### 仮説 3: 外部依存が6つ（全てモック必須）

**Issue内の記述**: 外部依存が6つ（captureSessionOutput, detectThinking, detectPrompt, resolveAutoAnswer, sendPromptAnswer, CLIToolManager）あり、全てモック必須

**検証手順**:
1. `pollAutoYes()` 内で呼び出されているモジュール外関数を列挙

**判定**: Confirmed

**根拠**:
- `captureSessionOutput` (L469) - `./cli-session`
- `detectThinking` (L493) - `./cli-patterns`
- `detectPrompt` (L529) - `./prompt-detector`
- `resolveAutoAnswer` (L546) - `./auto-yes-resolver`
- `sendPromptAnswer` (L561) - `./prompt-answer-sender`
- `CLIToolManager.getInstance()` (L554) - `./cli-tools/manager`

6つの外部依存を確認 ✅

---

### 仮説 4: `stopCheckBaselineLength` の初期値 `-1` と3パターン分岐が不明瞭

**Issue内の記述**: `stopCheckBaselineLength` の初期値 `-1` と3パターン分岐（> = <）のデルタベース判定が不明瞭

**検証手順**:
1. `startAutoYesPolling()` で初期値を確認（L660）
2. `pollAutoYes()` 内のL508-524の分岐ロジックを分析

**判定**: Confirmed

**根拠**:
- L660: `stopCheckBaselineLength: -1` // `-1` = 初回ポーリング（ベースライン未設定）
- 分岐パターン：
  - L508: `< 0`（初回ポーリング）→ ベースライン設定してスキップ
  - L513: `> baseline`（出力増加）→ 差分のみチェック
  - L520: `< baseline`（バッファ縮小）→ ベースラインリセット
  - 暗黙の第4パターン（`=== baseline`、長さ変化なし）→ スキップ

現状の実装は `-1` 初期値 + 3分岐の構造で、意図が若干わかりにくい点は事実だが、コメントで説明されている（Partially Confirmed寄りのConfirmed）。

---

### 仮説 5: pollerState 存在確認が複数箇所で重複

**Issue内の記述**: pollerState の存在確認が複数箇所で重複（L457, L606, L680等）

**検証手順**:
1. `autoYesPollerStates.get(worktreeId)` の呼び出し箇所を全確認

**判定**: Confirmed

**根拠**:
- `pollAutoYes()` L457-458: `const pollerState = autoYesPollerStates.get(worktreeId); if (!pollerState) return;`
- `scheduleNextPoll()` L606-607: `const pollerState = autoYesPollerStates.get(worktreeId); if (!pollerState) return;`
- `stopAutoYesPolling()` L680-681: `const pollerState = autoYesPollerStates.get(worktreeId); if (!pollerState) return;`
- また `updateLastServerResponseTimestamp()`（L318）、`resetErrorCount()`（L329）、`incrementErrorCount()`（L342）でも同様のパターンあり

重複確認 ✅

---

## Stage 1レビューへの申し送り事項

- 全仮説はConfirmedであり、Issue記載の事実関係はコードと一致している
- `stopCheckBaselineLength` の分岐は「不明瞭」とあるが、コメントで説明されているため、`StopConditionChecker` クラスへの抽出による自己文書化効果の有無が重点確認ポイント
- `pollAutoYes()` のL508-525の停止条件チェックブロックは、既に `checkStopCondition()` というヘルパー関数（L409）が存在しており、「デルタ計算」ロジック自体は `pollAutoYes()` 内に残っている点に注意
- Issue内で提案している `validatePollingContext()` 関数は、既存の `isValidWorktreeId()` との責務重複が生じる可能性があるため、責務の境界を明確にすることが重要

*Generated by hypothesis-verification phase*
