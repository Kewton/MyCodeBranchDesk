# Issue #343 マルチステージレビュー完了報告

## レビュー日時
- 開始: 2026-02-22
- 完了: 2026-02-22

## 仮説検証結果（Phase 0.5）

機能追加Issueのため、コードの事実確認（前提条件の検証）を実施。

| # | 主張 | 判定 |
|---|------|------|
| 1 | `slash-commands.ts` は `.claude/commands/*.md` のみを読み込む | Confirmed |
| 2 | worktree APIルートが `.claude/commands/` からコマンドを取得 | Confirmed |
| 3 | `command-merger.ts` が Standard + MCBD + Worktree をマージ | Partially Confirmed（MCBD は別ルートで処理） |
| 4 | `useSlashCommands.ts` が API からコマンドを取得し UI に表示 | Confirmed |
| 5 | `SlashCommandSelector.tsx` がセレクター UI | Confirmed |

## ステージ別結果

| Stage | レビュー種別 | 指摘数 | 対応数 | ステータス |
|-------|------------|-------|-------|----------|
| 0.5 | 仮説検証 | - | - | ✅ |
| 1 | 通常レビュー（1回目） | 10（Must:2, Should:4, Nice:4） | - | ✅ |
| 2 | 指摘事項反映（1回目） | - | 6 | ✅ |
| 3 | 影響範囲レビュー（1回目） | 13（Must:3, Should:7, Nice:3） | - | ✅ |
| 4 | 指摘事項反映（1回目） | - | 6 | ✅ |
| 5 | 通常レビュー（2回目） | 6（Must:0, Should:4, Nice:2） | - | ✅ |
| 6 | 指摘事項反映（2回目） | - | 4 | ✅ |
| 7 | 影響範囲レビュー（2回目） | 7（Must:0, Should:5, Nice:2） | - | ✅ |
| 8 | 指摘事項反映（2回目） | - | 5 | ✅ |

## 統計

- **総指摘数**: 36件
- **Must Fix 指摘**: 5件（全て対応済み）
- **Should Fix 指摘**: 20件（17件対応、3件スキップ）
- **Nice to Have 指摘**: 11件（1件対応、10件スキップ）

## 主な改善点

1. **SlashCommandSource 型への 'skill' 追加**を変更候補に明記
2. **CATEGORY_ORDER の 'skill' 配置**を「workflow と standard-session の間」に具体化
3. **CATEGORY_LABELS への 'skill: Skills' 追加**（コンパイルエラー防止）を明記
4. **sourcesレスポンスに skill カウント追加**（型定義・変数・オブジェクト3段階）を具体化
5. **commandsCache/skillsCache の独立管理**と再ロード条件を明確化
6. **MCBD ルートは変更不要**（getSlashCommandGroups 内部統合）を明確化
7. **skills のマージ責務分担**（slash-commands.ts がマージ、command-merger.ts は CATEGORY_ORDER のみ）を明確化
8. **skills のセキュリティ**（シンボリックリンク不追跡、..パス拒否）を非機能要件に追加
9. **commands と skills の名前衝突時の優先順位**（command を優先）を明記
10. **既存テストの修正箇所**（labelMap, validCategories への 'skill' 追加）を影響範囲に明記

## Issue差分サマリー

### 追加されたセクション
- 機能要件: cliTools 方針、マージ順序方針、名前衝突時の優先順位
- skills の SKILL.md 構造: frontmatter フィールドの取り扱い方針サブセクション
- 非機能要件: スキップ時のエラーハンドリング、セキュリティ考慮
- 変更不要ファイルセクション（新設）
- テスト影響セクション（新設）

### 更新された変更候補テーブル
- `src/types/slash-commands.ts`: SlashCommandSource・CATEGORY_LABELS 追加も明記
- `src/lib/slash-commands.ts`: skillsCache、clearCache 両方クリア、統合フロー
- `src/lib/command-merger.ts`: CATEGORY_ORDER の具体的な配置位置を明確化
- `src/app/api/worktrees/[id]/slash-commands/route.ts`: 3段階の変更を具体化
- `src/app/api/slash-commands/route.ts`: 変更候補から変更不要ファイルに移動

### 更新された受け入れ条件
- 条件6: SlashCommandSource に 'skill' が追加されている
- 条件7: MCBD ルート（/api/slash-commands）でも skills が表示される
- 条件8: 同名の command と skill が存在する場合、command が優先される
- 条件9: TypeScript コンパイルがエラーなしで通過する（CATEGORY_LABELS 完全性）
- 条件10: skills キャッシュが独立管理され、clearCache() で両方クリアされる
- 条件11: CATEGORY_ORDER に 'skill' が追加され、workflow と standard-session の間に表示される

## 次のアクション

- [x] Issueの最終確認
- [ ] 設計方針書作成（/design-policy）
- [ ] 実装開始（/pm-auto-dev）

## 関連ファイル

- 元のIssue: `dev-reports/issue/343/issue-review/original-issue.json`
- 仮説検証: `dev-reports/issue/343/issue-review/hypothesis-verification.md`
- レビュー結果: `dev-reports/issue/343/issue-review/stage*-review-result.json`
- 反映結果: `dev-reports/issue/343/issue-review/stage*-apply-result.json`

---

*Generated by multi-stage-issue-review command*
