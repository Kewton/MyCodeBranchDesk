{
  "stage": 2,
  "stage_name": "整合性レビュー",
  "focus_area": "整合性",
  "review_date": "2026-02-01",
  "findings": {
    "must_fix": [
      {
        "id": "MF-001",
        "category": "依存チェーン分析の不正確性",
        "severity": "critical",
        "description": "設計書Section 2.3の依存チェーン分析が不完全。response-poller.tsが複数の@/パスを使用していると記載されているが、実際のソースコードを確認したところ、response-poller.tsは相対パスのみを使用している（./cli-session, ./db-instance, ./db, ./ws-server, ./prompt-detector, ./conversation-logger, ./cli-tools/types, ./claude-output, ./cli-patterns）。@/パスを使用していない。",
        "location": "設計書 Section 2.3",
        "actual_code": "import { captureSessionOutput, isSessionRunning } from './cli-session'; import type { CLIToolType } from './cli-tools/types';",
        "expected": "@/パス使用を正確に記載",
        "recommendation": "response-poller.tsの@/パス使用列から削除し、依存チェーン分析表を再検証する"
      },
      {
        "id": "MF-002",
        "category": "tsconfig.server.json includeリストの不足",
        "severity": "critical",
        "description": "設計書のtsconfig.server.json案ではresponse-poller.tsの実際の依存ファイルが不足している。response-poller.tsはcli-session.ts, prompt-detector.ts, conversation-logger.ts, claude-output.ts, cli-patterns.tsをimportしているが、これらはincludeリストに含まれていない。",
        "location": "設計書 Section 3.5",
        "actual_dependencies": [
          "src/lib/cli-session.ts",
          "src/lib/prompt-detector.ts",
          "src/lib/conversation-logger.ts",
          "src/lib/claude-output.ts",
          "src/lib/cli-patterns.ts"
        ],
        "expected_include": "上記ファイルをincludeリストに追加",
        "recommendation": "server.tsからの完全な依存チェーンを再分析し、includeリストを更新する。または 'src/lib/**/*.ts' の広範囲includeを検討"
      },
      {
        "id": "MF-003",
        "category": "filesフィールドの整合性問題",
        "severity": "critical",
        "description": "設計書Section 3.6のpackage.json案では 'files' に '.next/' と 'public/' が追加されているが、現在のpackage.jsonにはこれらが含まれていない。これらを追加する場合、パッケージサイズへの影響が大きい可能性がある。また、設計書に記載されている 'src/' 除外の明示的記述が現行package.jsonでは既に除外されている状態。",
        "location": "設計書 Section 3.6, package.json",
        "current_files": ["bin/", "dist/", ".env.example"],
        "proposed_files": ["bin/", "dist/", ".next/", "public/", ".env.example"],
        "recommendation": ".next/ と public/ の追加がグローバルインストール時に必要か検証し、必要であれば追加理由を設計書に明記する"
      }
    ],
    "should_fix": [
      {
        "id": "SF-001",
        "category": "tsconfig.cli.jsonとの設定差異",
        "severity": "medium",
        "description": "設計書のtsconfig.base.json案ではbaseUrlとpathsを含めているが、現在のtsconfig.cli.jsonはbaseUrl/pathsを持っていない。tsconfig.cli.jsonをextendsでtsconfig.base.jsonから継承させる場合、CLIビルドにもパスエイリアスが適用され、tsc-aliasが必要になる可能性がある。",
        "location": "tsconfig.cli.json, 設計書 Section 3.3",
        "current_cli_config": "baseUrl/paths なし、rootDir: ./src",
        "proposed_base_config": "baseUrl: '.', paths: { '@/*': ['./src/*'] }",
        "recommendation": "tsconfig.cli.jsonがtsconfig.base.jsonを継承する際、pathsをオーバーライドして無効化するか、CLIビルドにもtsc-aliasを適用するか明確化する"
      },
      {
        "id": "SF-002",
        "category": "CI/CDステップ配置の正確性",
        "severity": "medium",
        "description": "設計書Section 4.2ではci-pr.ymlのbuildジョブにbuild:serverステップを追加する記載があるが、現在のci-pr.ymlのbuildジョブはnpm run buildのみを実行している。また、publish.ymlの記載ではbuild:serverの後にパッケージサイズ計測を追加する案があるが、現在のpublish.ymlにはその記述がない。",
        "location": ".github/workflows/ci-pr.yml, .github/workflows/publish.yml",
        "recommendation": "CI/CDの具体的な変更差分を明確化し、既存ステップとの関係を明示する"
      },
      {
        "id": "SF-003",
        "category": "src/types内の@/パス使用",
        "severity": "medium",
        "description": "src/types/models.tsは@/lib/cli-tools/typesをimportしている。tsconfig.server.jsonのincludeには 'src/types/**/*.ts' が含まれているが、この循環的な依存関係がtsc-aliasで正しく解決されるか検証が必要。",
        "location": "src/types/models.ts",
        "actual_code": "import type { CLIToolType } from '@/lib/cli-tools/types';",
        "recommendation": "tsc-aliasがtype-onlyのimportを正しく解決するか確認し、必要であれば相対パスに変更"
      },
      {
        "id": "SF-004",
        "category": "prepublishOnlyスクリプトの変更",
        "severity": "low",
        "description": "設計書ではprepublishOnlyをnpm run build:allに変更する案があるが、現在はnpm run build:cliのみ。build:allはbuild + build:cli + build:serverを含むため、publish時にNext.jsビルドも実行される。これが意図した動作か確認が必要。",
        "location": "package.json scripts.prepublishOnly",
        "current": "npm run build:cli",
        "proposed": "npm run build:all",
        "recommendation": "prepublishOnlyでNext.jsビルドを実行する必要性を検討。publish.ymlで既にbuildステップが存在するため重複になる可能性"
      }
    ],
    "nice_to_have": [
      {
        "id": "NTH-001",
        "category": "db-instance.tsのDATABASE_PATHフォールバック",
        "description": "db-instance.tsはprocess.env.DATABASE_PATHを使用しているが、getEnvByKey('CM_DB_PATH')を使用していない。設計書ではenv.tsのCM_DB_PATHフォールバックに言及がないが、一貫性のため検討に値する。",
        "location": "src/lib/db-instance.ts line 25"
      },
      {
        "id": "NTH-002",
        "category": "依存分析ツールの自動化",
        "description": "設計書Section 3.8で将来課題として記載されているmadge等の依存分析ツールの導入は、MF-001/MF-002のような分析ミスを防ぐために早期導入を検討してもよい。",
        "location": "設計書 Section 3.8"
      },
      {
        "id": "NTH-003",
        "category": "ビルドディレクトリ構成の詳細",
        "description": "設計書Section 4.1のディレクトリ構成案ではdist/server/src/lib/以下にファイルが配置されるが、rootDir: '.' の設定でこの構成になるか検証が必要。tscのrootDirとoutDirの関係に依存する。",
        "location": "設計書 Section 4.1"
      }
    ]
  },
  "consistency_checks": {
    "file_path_verification": {
      "status": "pass",
      "details": "全ての参照ファイルが存在することを確認: server.ts, src/lib/env.ts, src/lib/worktrees.ts, src/lib/db.ts, src/lib/db-instance.ts, src/lib/db-migrations.ts, src/lib/response-poller.ts, src/lib/ws-server.ts, tsconfig.cli.json, tsconfig.json, package.json, .github/workflows/ci-pr.yml, .github/workflows/publish.yml"
    },
    "dependency_chain_accuracy": {
      "status": "fail",
      "details": "response-poller.tsの@/パス使用記述が不正確。実際は相対パスを使用。worktrees.ts, db.tsは正確に@/パスを使用している。"
    },
    "tsc_alias_validity": {
      "status": "pass",
      "details": "tsc-aliasは有効なnpmパッケージ（v1.8.16、週間200万+ダウンロード）であり、設計書の記載通り使用可能。MIT License。"
    },
    "existing_config_compatibility": {
      "status": "partial",
      "details": "tsconfig.cli.jsonとの互換性に注意が必要。現在のtsconfig.cli.jsonはbaseUrl/pathsを持たないため、tsconfig.base.jsonを継承する際の影響を考慮する必要がある。"
    }
  },
  "summary": "設計書と実際のコードベースとの間に重要な整合性問題が3件発見された。最も重要なのは依存チェーン分析の不正確性（response-poller.tsが@/パスを使用していると記載されているが実際は相対パス）と、tsconfig.server.jsonのincludeリストが不完全であること。これらを修正しないと、ビルドが失敗する可能性がある。また、tsconfig.base.jsonを導入する際のtsconfig.cli.jsonとの互換性も検討が必要。tsc-aliasの選択自体は妥当であり、ツールの技術的な記述は正確である。"
}
