{
  "issue_number": 212,
  "focus_area": "影響範囲",
  "stage": 3,
  "stage_name": "影響分析レビュー",
  "status": "conditionally_approved",
  "score": 4,
  "findings": {
    "must_fix": [
      {
        "id": "MF-S3-001",
        "category": "間接影響の見落とし",
        "title": "assistant-response-saver.ts の cleanClaudeResponse() 依存に対する影響が未評価",
        "description": "src/lib/assistant-response-saver.ts は response-poller.ts から cleanClaudeResponse() をimportしている（L24）。cleanClaudeResponse() 内の skipPatterns に PASTED_TEXT_PATTERN を追加する変更は、assistant-response-saver.ts 経由のレスポンスクリーニングにも影響する。設計書 Section 10 の『影響なし確認済み』に assistant-response-saver.ts が含まれていないため、この間接影響が見落とされている。",
        "impact": "assistant-response-saver.ts の cleanCliResponse() -> cleanClaudeResponse() パス経由で、[Pasted text] 行がフィルタリングされるようになる。これ自体は望ましい動作だが、設計書で明示的に評価されていないことが問題。",
        "recommendation": "Section 10 の影響範囲サマリーに assistant-response-saver.ts を追加し、cleanClaudeResponse() のskipPatterns変更による間接的な正の影響（[Pasted text] 行が assistant-response-saver.ts 経由でも除去される）を記載する。回帰テストの対象として明記する。",
        "severity": "medium",
        "effort": "small"
      }
    ],
    "should_fix": [
      {
        "id": "SF-S3-001",
        "category": "テスト影響範囲",
        "title": "cli-patterns.test.ts のテストファイル二重存在に関する対応方針が未記載",
        "description": "cli-patterns のテストファイルが2箇所に存在する: (1) src/lib/__tests__/cli-patterns.test.ts (2) tests/unit/lib/cli-patterns.test.ts。設計書 Section 5.5 では tests/unit/lib/cli-patterns.test.ts にテスト追加と記載しているが、src/lib/__tests__/cli-patterns.test.ts にも PASTED_TEXT_PATTERN 関連のテストが必要かどうかの判断が記載されていない。",
        "impact": "テスト追加先の不明確さにより、実装時にどちらのファイルに追加するか判断が分かれ、テストカバレッジの漏れが発生する可能性がある。",
        "recommendation": "設計書に tests/unit/lib/cli-patterns.test.ts を正とする旨を明記し、src/lib/__tests__/cli-patterns.test.ts との関係（レガシーテスト or 別スコープ）を注記する。",
        "severity": "low",
        "effort": "small"
      },
      {
        "id": "SF-S3-002",
        "category": "テスト影響範囲",
        "title": "codex.test.ts の既存テストがモック不足でsendMessage()テスト追加に支障",
        "description": "現在の tests/unit/cli-tools/codex.test.ts はプロパティ確認レベルのテストのみで、tmux/child_process のモックが設定されていない。設計書 Section 5.4 で記載されているモック基盤構築（~100行）は大規模であり、既存テストとの構造的整合性（describeブロック構成）への影響も大きい。この大規模なモック構築の影響範囲とリスクが設計書で十分に評価されていない。",
        "impact": "codex.test.ts のモック基盤追加により、既存テスト（isRunning, isInstalled等）の実行環境が変わり、既存テストがモックの影響で失敗する可能性がある。特に isRunning テストの 'should return false for non-existent session' は実際の tmux コマンドを実行しているため、vi.mock によりテスト挙動が変わる。",
        "recommendation": "codex.test.ts のモック基盤を既存テストに影響しない形（独立したdescribeブロック内でのモック、またはbeforeEach/afterEachでのモック復元）で追加する方針を設計書に記載する。あるいは、新規テストファイル（codex-pasted-text.test.ts）として分離する選択肢を検討する。",
        "severity": "medium",
        "effort": "medium"
      },
      {
        "id": "SF-S3-003",
        "category": "間接影響",
        "title": "getCliToolPatterns('codex') への PASTED_TEXT_PATTERN 追加の影響範囲が不十分",
        "description": "設計書 Section 4.6 で getCliToolPatterns('codex') の skipPatterns にも PASTED_TEXT_PATTERN を追加する方針だが、codex の skipPatterns は response-poller.ts の extractResponse() 内で使用されている（L277）。codex のレスポンス抽出時に [Pasted text] 行がスキップされることの影響が評価されていない。",
        "impact": "Codex CLI の出力に [Pasted text] 表示が含まれた場合、レスポンス抽出から除外される。これは期待通りの動作だが、Codex CLI で [Pasted text] が実際に発生するかどうかの検証が不足している。設計書では『Codexでも同様のPasted text表示が発生する可能性』と可能性表現に留まっている。",
        "recommendation": "Codex CLI での [Pasted text] 発生有無を実測確認し、確認結果を設計書に追記する。発生しない場合でも防御的追加として記録する。",
        "severity": "low",
        "effort": "small"
      },
      {
        "id": "SF-S3-004",
        "category": "統合テスト影響",
        "title": "api-send-cli-tool.test.ts の統合テストでの回帰リスク",
        "description": "tests/integration/api-send-cli-tool.test.ts は sendMessageToClaude をモックしている（L16）が、sendMessageToClaude の内部で detectAndResendIfPastedText() が呼ばれるようになるため、モックにより新機能は検証されない。しかし、sendMessageToClaude のシグネチャは変わらないため、モックによるテスト失敗リスクは低い。設計書 Section 5.1 で回帰テストとして api-send-cli-tool.test.ts を挙げているが、具体的に何をパス確認するかの基準が不明確。",
        "impact": "低。モックされているため統合テストは影響を受けない。ただし、実際のE2E動作は統合テストでカバーされていない。",
        "recommendation": "Section 5.1 の回帰テスト欄に、api-send-cli-tool.test.ts は『sendMessageToClaude がモックされているため、新機能の動作検証ではなく既存APIインターフェースの不変性を確認する』旨を明記する。",
        "severity": "low",
        "effort": "small"
      }
    ],
    "consider": [
      {
        "id": "C-S3-001",
        "category": "パフォーマンス影響",
        "title": "capturePane({ startLine: -10 }) のキャプチャ範囲と既存 capturePane({ startLine: -50 }) との整合性",
        "description": "pasted-text-helper.ts では capturePane(sessionName, { startLine: -10 }) で直近10行を取得するが、claude-session.ts の waitForPrompt() や sendMessageToClaude() では capturePane(sessionName, { startLine: -50 }) を使用している。異なるキャプチャ範囲の使用が混在することで、将来の保守性に影響する可能性がある。",
        "impact": "低。機能的には問題ないが、キャプチャ範囲の選択理由が異なるユースケースごとに異なるため、将来の変更時に混乱を招く可能性がある。",
        "recommendation": "PASTE-002 コメントに、-10行が選択された理由（[Pasted text] は常に直近の数行に表示されるため、50行取得は不要）を明記する。現行の設計で問題ない。"
      },
      {
        "id": "C-S3-002",
        "category": "互換性影響",
        "title": "Claude CLI バージョンアップ時の [Pasted text] フォーマット変更リスク",
        "description": "PASTED_TEXT_PATTERN (/\\[Pasted text #\\d+/) は Claude CLI の特定のフォーマットに依存している。Claude CLI のバージョンアップにより、このフォーマットが変更された場合（例: '[Pasted text +46 lines]' のように番号が省略される等）、パターンがマッチしなくなる。設計書 Section 11 の技術的制約で言及されているが、具体的なバージョン互換性テスト方針が不明。",
        "impact": "低～中。パターン不一致時は [Pasted text] が検知されず、Enter 再送が行われない。ただし、この場合は Issue #212 以前の状態に戻るだけで、新たな問題は発生しない（graceful degradation）。",
        "recommendation": "PASTED_TEXT_PATTERN のコメントに、パターン不一致時の挙動が graceful degradation である旨を追記する。CLI バージョンアップ時のテスト手順を開発ガイドに記載することを検討。"
      },
      {
        "id": "C-S3-003",
        "category": "将来の拡張性",
        "title": "Gemini CLI が将来インタラクティブモードに対応した場合の影響パス",
        "description": "設計書 Section 2 のレイヤー構成表で gemini.ts は『変更なし（将来インタラクティブモード対応時は共通ヘルパー呼び出し追加が必要）』と記載されている。この記載は適切だが、共通ヘルパーの関数シグネチャが sessionName のみである点が、Gemini の非 tmux ベースのインタラクティブモード（仮にそうなった場合）と互換しない可能性がある。",
        "impact": "低。現時点では影響なし。",
        "recommendation": "設計書の記載で十分。YAGNI 原則に従い、現時点での対応は不要。"
      },
      {
        "id": "C-S3-004",
        "category": "テスト影響範囲",
        "title": "response-poller.test.ts が新規作成だが、cleanClaudeResponse() の既存テストの有無",
        "description": "設計書 Section 10 で response-poller.test.ts を新規作成と記載しているが、cleanClaudeResponse() には既存のテストが他の場所に存在しないか確認が必要。Grep の結果、response-poller.test.ts は tests/unit/lib/ に存在しないことを確認済み。テスト対象が cleanClaudeResponse() のみの場合、ファイル名を cleanClaudeResponse.test.ts とする選択肢もあるが、response-poller.test.ts の方がモジュール単位の命名と整合する。",
        "impact": "低。命名の問題のみ。",
        "recommendation": "response-poller.test.ts の命名で問題ない。将来的に extractResponse() のテストも追加される可能性を考慮すると、モジュール名での命名が適切。"
      },
      {
        "id": "C-S3-005",
        "category": "間接影響",
        "title": "claude-poller.ts（レガシーポーラー）への影響",
        "description": "src/lib/claude-poller.ts が claude-session.ts の captureClaudeOutput/isClaudeRunning をimportしている。sendMessageToClaude() の変更は claude-poller.ts に影響しないが、claude-poller.ts が今も使用されているかどうかの確認が必要。",
        "impact": "低。sendMessageToClaude の変更は claude-poller.ts に影響しない（captureClaudeOutput と isClaudeRunning のみを使用しているため）。",
        "recommendation": "影響なしで問題ない。設計書への追記は不要。"
      }
    ]
  },
  "impact_analysis": {
    "direct_changes": {
      "files": [
        {
          "path": "src/lib/cli-patterns.ts",
          "change_type": "定数追加 + skipPatterns追加",
          "risk": "low",
          "assessment": "既存exportに追加のみ。既存コードの動作に影響なし。getCliToolPatterns() のskipPatterns配列に要素追加だが、既存パターンの動作は変わらない。"
        },
        {
          "path": "src/lib/pasted-text-helper.ts",
          "change_type": "新規ファイル",
          "risk": "low",
          "assessment": "新規モジュール追加。既存コードへの影響なし。tmux.ts と cli-patterns.ts に依存するが、これらの既存インターフェースを消費するのみ。"
        },
        {
          "path": "src/lib/claude-session.ts",
          "change_type": "import追加 + ガード条件 + ヘルパー呼び出し追加",
          "risk": "low",
          "assessment": "sendMessageToClaude() の L425（sendKeys Enter）の後に条件付きヘルパー呼び出しを追加。改行なしメッセージは既存動作のまま。改行ありメッセージに最大+1500msの遅延が追加されるが、関数シグネチャは変更なし。"
        },
        {
          "path": "src/lib/cli-tools/codex.ts",
          "change_type": "import追加 + ガード条件 + ヘルパー呼び出し追加",
          "risk": "low",
          "assessment": "sendMessage() の L133の後に条件付きヘルパー呼び出しを追加。claude-session.ts と同等の低リスク変更。"
        },
        {
          "path": "src/lib/response-poller.ts",
          "change_type": "skipPatterns追加",
          "risk": "low",
          "assessment": "cleanClaudeResponse() の skipPatterns 配列に1要素追加。extractResponse() 内の getCliToolPatterns() 経由でも影響するが、[Pasted text] 行のスキップは期待通りの動作。"
        }
      ],
      "coverage": "adequate",
      "missing_files": []
    },
    "indirect_impacts": {
      "files": [
        {
          "path": "src/lib/assistant-response-saver.ts",
          "dependency": "cleanClaudeResponse() を response-poller.ts からimport（L24）",
          "impact": "正の影響: [Pasted text] 行が assistant response 保存時にもフィルタリングされる",
          "risk": "low",
          "designed_covered": false,
          "note": "MF-S3-001: 設計書で未記載"
        },
        {
          "path": "src/lib/cli-tools/claude.ts",
          "dependency": "sendMessageToClaude() を claude-session.ts からimport",
          "impact": "変更が自動的に反映される（設計書記載済み）",
          "risk": "low",
          "designed_covered": true
        },
        {
          "path": "src/app/api/worktrees/[id]/send/route.ts",
          "dependency": "cliTool.sendMessage() 経由で間接的に影響",
          "impact": "API レスポンスタイムに最大+1500msの影響（複数行メッセージ時のみ）",
          "risk": "low",
          "designed_covered": true
        },
        {
          "path": "src/lib/auto-yes-manager.ts",
          "dependency": "cli-patterns.ts の stripAnsi, detectThinking, buildDetectPromptOptions をimport",
          "impact": "影響なし。PASTED_TEXT_PATTERN は auto-yes-manager.ts で使用されない",
          "risk": "none",
          "designed_covered": false,
          "note": "影響なしだが、設計書 Section 10 の影響なし確認済みリストに含まれている"
        },
        {
          "path": "src/lib/status-detector.ts",
          "dependency": "cli-patterns.ts の stripAnsi, detectThinking, getCliToolPatterns, buildDetectPromptOptions をimport",
          "impact": "getCliToolPatterns() の skipPatterns に PASTED_TEXT_PATTERN が追加されるが、status-detector.ts は skipPatterns を直接使用しないため影響なし",
          "risk": "none",
          "designed_covered": true
        },
        {
          "path": "src/app/api/worktrees/[id]/prompt-response/route.ts",
          "dependency": "cli-patterns.ts の stripAnsi, buildDetectPromptOptions をimport",
          "impact": "影響なし。PASTED_TEXT_PATTERN を使用しない",
          "risk": "none",
          "designed_covered": false,
          "note": "影響なしのため記載不要"
        },
        {
          "path": "src/app/api/worktrees/[id]/current-output/route.ts",
          "dependency": "cli-patterns.ts の stripAnsi, buildDetectPromptOptions をimport",
          "impact": "影響なし。PASTED_TEXT_PATTERN を使用しない",
          "risk": "none",
          "designed_covered": false,
          "note": "影響なしのため記載不要"
        }
      ]
    },
    "api_changes": {
      "affected_endpoints": [],
      "breaking_changes": false,
      "notes": "API シグネチャの変更なし。内部実装の変更のみ。POST /api/worktrees/:id/send のレスポンスタイムに複数行メッセージ時最大+1500ms影響。"
    },
    "database_changes": {
      "schema_changes": false,
      "migration_required": false,
      "notes": "データベーススキーマへの変更なし。"
    }
  },
  "test_impact": {
    "new_test_files": [
      "tests/unit/lib/pasted-text-helper.test.ts",
      "tests/unit/lib/response-poller.test.ts"
    ],
    "modified_test_files": [
      "tests/unit/lib/cli-patterns.test.ts",
      "tests/unit/lib/claude-session.test.ts",
      "tests/unit/cli-tools/codex.test.ts"
    ],
    "regression_tests": [
      "tests/integration/api-send-cli-tool.test.ts"
    ],
    "coverage_gaps": [
      "assistant-response-saver.ts 経由の cleanClaudeResponse() パスに対するテストが計画されていない（MF-S3-001）",
      "src/lib/__tests__/cli-patterns.test.ts と tests/unit/lib/cli-patterns.test.ts の二重存在の取り扱い（SF-S3-001）"
    ]
  },
  "performance_impact": {
    "assessment": "acceptable",
    "details": {
      "single_line_message": "+0ms（改行ガードによるスキップ）",
      "multi_line_no_pasted_text": "+500ms（1回の検知確認）",
      "multi_line_with_resolution": "+1000ms（検知+再送+再確認）",
      "worst_case": "+1500ms（3回リトライ）",
      "api_response_time_impact": "複数行メッセージ時のみ最大+1500ms。CLI応答時間（数秒～数十秒）に対して許容範囲。"
    },
    "bottleneck_risk": "none",
    "scalability_impact": "none"
  },
  "compatibility_impact": {
    "backward_compatibility": "maintained",
    "forward_extensibility": "good",
    "notes": "関数シグネチャ変更なし。既存の呼び出し元コードの変更不要。共通ヘルパーにより将来のCLIツール追加時の拡張が容易。"
  },
  "risk_assessment": {
    "technical": "low",
    "security": "low",
    "operational": "low",
    "overall": "low"
  },
  "reviewed_files": [
    "dev-reports/design/issue-212-pasted-text-detection-design-policy.md",
    "src/lib/cli-patterns.ts",
    "src/lib/claude-session.ts",
    "src/lib/response-poller.ts",
    "src/lib/cli-tools/codex.ts",
    "src/lib/cli-tools/claude.ts",
    "src/lib/cli-tools/gemini.ts",
    "src/lib/cli-tools/base.ts",
    "src/lib/tmux.ts",
    "src/lib/logger.ts",
    "src/lib/auto-yes-manager.ts",
    "src/lib/prompt-detector.ts",
    "src/lib/status-detector.ts",
    "src/lib/assistant-response-saver.ts",
    "src/app/api/worktrees/[id]/send/route.ts",
    "src/lib/__tests__/cli-patterns.test.ts",
    "tests/unit/lib/cli-patterns.test.ts",
    "tests/unit/lib/claude-session.test.ts",
    "tests/unit/cli-tools/codex.test.ts",
    "tests/integration/api-send-cli-tool.test.ts"
  ],
  "timestamp": "2026-02-10T12:00:00Z"
}
