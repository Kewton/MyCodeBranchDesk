{
  "stage": 3,
  "focus_area": "影響範囲",
  "review_date": "2026-01-30",
  "issue_number": 100,
  "issue_title": "feat: マークダウンプレビューでmermaidダイアグラムを描画できるようにする",
  "findings": {
    "must_fix": [
      {
        "id": "MF-001",
        "category": "dependency_impact",
        "title": "mermaidライブラリのSSR非互換性への対応が不十分",
        "description": "Issue本文ではSSR環境でのプレースホルダー表示を記載しているが、具体的な実装方針が不足。mermaidはDOMに依存するため、next/dynamicのssr: falseオプションまたはuseEffectでの遅延レンダリングが必要。rehype-mermaidやremark-mermaidsの利用時にも同様の考慮が必要。",
        "impact": "SSR時のビルドエラーまたはハイドレーションミスマッチが発生する可能性がある",
        "recommendation": "非機能要件に「next/dynamicでssr: falseを使用した遅延読み込み」または「useEffectでのクライアントサイドレンダリング」の具体的な実装方針を追記する"
      }
    ],
    "should_fix": [
      {
        "id": "SF-001",
        "category": "performance_impact",
        "title": "バンドルサイズ増加に対する具体的な軽減策が不足",
        "description": "mermaidは約500KB以上のサイズで、現在のreact-markdown関連パッケージ（約50KB）と比較して10倍以上。Issue本文でdynamic importの検討を記載しているが、code splitting戦略やchunk分割の具体案がない。",
        "impact": "初期バンドルサイズの大幅増加（+500KB以上）により、ページロード時間が悪化する可能性がある",
        "recommendation": "技術検討事項に以下を追記: (1) next/dynamicでの遅延読み込み実装例、(2) mermaidコードブロックがない場合はロードしない条件付き読み込み、(3) バンドルサイズ測定方法（npm run build後のサイズ確認）"
      },
      {
        "id": "SF-002",
        "category": "test_coverage",
        "title": "テスト戦略にrehype-sanitize互換性テストが含まれていない",
        "description": "AC-04でテストケースの例（flowchart, sequenceDiagram描画）が追加されたが、rehype-sanitizeとの互換性テストが含まれていない。mermaid生成SVGがサニタイズによりブロックされないことを確認するテストが必要。",
        "impact": "セキュリティ設定とmermaid機能の両立が検証されず、本番環境で問題が発生する可能性がある",
        "recommendation": "AC-04に「rehype-sanitizeとの互換性: mermaid生成SVGが正常に表示されること」のテストケースを追加する"
      },
      {
        "id": "SF-003",
        "category": "ci_cd_impact",
        "title": "CI/CDパイプラインへの影響（ビルド時間・メモリ使用量）が未考慮",
        "description": "mermaid追加によりnpm installとビルド時間が増加する可能性がある。現在のCI/CD（.github/workflows/ci-pr.yml）ではbuild, lint, type-check, test-unitが実行されている。mermaidの依存関係によりビルドキャッシュ効率が低下する可能性がある。",
        "impact": "PRごとのCI実行時間が増加し、開発効率が低下する可能性がある",
        "recommendation": "技術検討事項に「CI/CDへの影響: npm install時間+10-20秒、ビルド時間への影響は軽微（遅延読み込みのため）」の見積もりを追記する"
      },
      {
        "id": "SF-004",
        "category": "backward_compatibility",
        "title": "既存マークダウンプレビュー機能への非破壊性保証が明示されていない",
        "description": "AC-03に「既存のマークダウンプレビュー機能に影響がない」と記載されているが、rehypePluginsの順序変更やスキーマ変更による副作用の検証方法が不明確。",
        "impact": "既存のマークダウンレンダリング（GFMテーブル、コードハイライト等）が意図せず変更される可能性がある",
        "recommendation": "AC-03に「回帰テスト: 既存のGFMテーブル、リスト、コードブロック（mermaid以外）のレンダリングが変更されないことを確認」を追記する"
      }
    ],
    "nice_to_have": [
      {
        "id": "NTH-001",
        "category": "documentation",
        "title": "アプローチ選定の推奨案が明示されていない",
        "description": "技術検討事項で3つのアプローチ（カスタムコンポーネント、rehype-mermaidプラグイン、動的スクリプト読み込み）が列挙されているが、推奨案や選定基準が示されていない。",
        "recommendation": "各アプローチの比較表に「推奨度」列を追加し、「アプローチB（rehype-mermaid）を推奨。理由: 既存のrehype-sanitize, rehype-highlightとの統合が容易、メンテナンスが活発」等の推奨案を記載する"
      },
      {
        "id": "NTH-002",
        "category": "future_extensibility",
        "title": "将来のダイアグラム拡張（PlantUML等）への考慮がない",
        "description": "mermaid対応後、他のダイアグラム記法（PlantUML, Graphviz等）への要望が出る可能性がある。抽象化設計がないと、各記法ごとに別実装が必要になる。",
        "recommendation": "将来の拡張ポイントとして「ダイアグラムレンダラーの抽象化（DiagramRenderer interface）」を検討事項に追加する"
      },
      {
        "id": "NTH-003",
        "category": "documentation",
        "title": "mermaidバージョンの固定方針が未記載",
        "description": "mermaidライブラリはバージョン間で構文変更やセキュリティ修正が行われる。バージョン固定またはsemver範囲の方針が記載されていない。",
        "recommendation": "技術検討事項に「mermaidバージョンはマイナーバージョンで固定（^11.12.x）、セキュリティアップデートは定期的に確認」を追記する"
      }
    ]
  },
  "impact_analysis": {
    "affected_files": [
      {
        "path": "src/components/worktree/MarkdownEditor.tsx",
        "change_type": "modify",
        "risk_level": "medium",
        "description": "rehypePluginsまたはcomponents propへのmermaid統合追加",
        "estimated_lines_changed": "20-50"
      },
      {
        "path": "package.json",
        "change_type": "modify",
        "risk_level": "low",
        "description": "mermaid（または rehype-mermaid/remark-mermaidjs）依存追加",
        "estimated_lines_changed": "2-4"
      },
      {
        "path": "tests/unit/components/MarkdownEditor.test.tsx",
        "change_type": "modify",
        "risk_level": "medium",
        "description": "mermaidダイアグラム描画テスト追加",
        "estimated_lines_changed": "50-100"
      },
      {
        "path": "src/styles/mermaid.css または src/app/globals.css",
        "change_type": "create_or_modify",
        "risk_level": "low",
        "description": "mermaidダイアグラムのカスタムスタイル（オプション）",
        "estimated_lines_changed": "10-30"
      }
    ],
    "affected_features": [
      {
        "feature": "マークダウンプレビュー",
        "impact": "機能拡張（mermaidコードブロックの描画追加）",
        "risk": "低（既存機能への影響は限定的）"
      },
      {
        "feature": "エディタ/プレビュー分割表示",
        "impact": "SVGダイアグラムのレイアウト調整が必要な可能性",
        "risk": "低"
      },
      {
        "feature": "モバイル表示",
        "impact": "大きなダイアグラムのスクロール/ズーム対応が必要な可能性",
        "risk": "低"
      }
    ],
    "dependencies_impact": {
      "new_dependencies": [
        {
          "package": "mermaid",
          "version": "^11.12.x",
          "size": "~500KB (unpacked)",
          "purpose": "ダイアグラム描画ライブラリ"
        }
      ],
      "alternative_packages": [
        {
          "package": "rehype-mermaid",
          "version": "^3.0.0",
          "description": "rehype/reactmarkdown統合プラグイン"
        },
        {
          "package": "remark-mermaidjs",
          "version": "^7.0.0",
          "description": "remark統合プラグイン"
        }
      ],
      "existing_dependencies_affected": [
        {
          "package": "react-markdown",
          "impact": "components prop追加またはrehypePlugins順序変更"
        },
        {
          "package": "rehype-sanitize",
          "impact": "サニタイズスキーマのカスタマイズが必要な可能性"
        }
      ]
    },
    "performance_impact": {
      "bundle_size": {
        "increase": "+500KB (mermaid) または +50-100KB (rehype-mermaid + 遅延読み込み)",
        "mitigation": "next/dynamic ssr:false, 条件付きインポート"
      },
      "runtime": {
        "description": "mermaidダイアグラムの初期レンダリング時に追加処理",
        "estimated_delay": "50-200ms（ダイアグラム複雑度による）"
      },
      "memory": {
        "description": "mermaidインスタンスによるメモリ使用",
        "estimated_increase": "軽微（ダイアグラム表示時のみ）"
      }
    },
    "backward_compatibility": {
      "breaking_changes": [],
      "non_breaking_changes": [
        "mermaidコードブロックのレンダリング追加（既存のプレーンテキスト表示から変更）"
      ],
      "migration_required": false,
      "migration_notes": "既存のマークダウンファイルへの影響なし。mermaidコードブロックを含むファイルのみ新機能が適用される"
    },
    "security_considerations": {
      "xss_risk": {
        "level": "medium",
        "mitigation": "mermaid securityLevel='strict' + rehype-sanitize維持"
      },
      "svg_injection_risk": {
        "level": "low",
        "mitigation": "mermaid内蔵のサニタイズ + strictモード"
      }
    }
  },
  "ci_cd_impact": {
    "build_time_increase": "+10-20秒（npm install）",
    "test_time_increase": "+5-10秒（新規テストケース）",
    "bundle_size_check": "現在のCI/CDにバンドルサイズチェックなし。追加検討を推奨",
    "affected_workflows": [
      ".github/workflows/ci-pr.yml"
    ]
  },
  "test_strategy_coverage": {
    "unit_tests": {
      "existing_file": "tests/unit/components/MarkdownEditor.test.tsx",
      "new_tests_required": [
        "mermaidコードブロックのSVG描画",
        "構文エラー時のエラー表示",
        "rehype-sanitizeとの互換性",
        "既存マークダウン機能の回帰テスト"
      ]
    },
    "integration_tests": {
      "coverage": "現在のMarkdownEditor統合テストなし",
      "recommendation": "mermaid描画のE2E検証を検討"
    }
  },
  "checklist_results": {
    "affected_files_completeness": {
      "status": "partial",
      "notes": "スタイル関連ファイルは記載されているが、テストファイルへの言及がない"
    },
    "dependency_impact_analysis": {
      "status": "partial",
      "notes": "バンドルサイズは記載されているが、CI/CD影響やビルド時間への影響が未考慮"
    },
    "breaking_changes_identified": {
      "status": "good",
      "notes": "破壊的変更なし（機能追加のみ）"
    },
    "test_coverage_plan": {
      "status": "partial",
      "notes": "テストケース例は記載されているが、rehype-sanitize互換性テストが不足"
    },
    "migration_path_defined": {
      "status": "good",
      "notes": "マイグレーション不要（新機能追加のみ）"
    },
    "documentation_update_plan": {
      "status": "good",
      "notes": "参考資料が記載されている。CLAUDE.mdへの反映は実装完了後"
    }
  },
  "summary": "Issue #100（mermaidダイアグラム描画機能）の影響範囲レビュー結果。主な影響: (1) MarkdownEditor.tsxの修正（rehypePluginsまたはcomponents prop追加）、(2) 新規依存パッケージ追加（mermaid約500KB）、(3) テストファイルの拡張。懸念事項: (1) SSR非互換性への具体的な対応方針が不足（MF-001）、(2) バンドルサイズ増加への軽減策が不十分（SF-001）、(3) rehype-sanitize互換性テストが未計画（SF-002）。破壊的変更はなく、既存機能への影響は限定的。CI/CD影響も軽微（ビルド時間+10-20秒程度）。",
  "recommendation": "must_fix項目（MF-001: SSR対応の具体化）を反映後、設計・実装フェーズに進むことを推奨。should_fix項目（SF-001-SF-004）は実装計画の品質向上に寄与するため、可能な限り反映することを推奨。"
}
