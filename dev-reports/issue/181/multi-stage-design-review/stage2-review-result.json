{
  "issue_number": 181,
  "focus_area": "整合性",
  "stage": 2,
  "stage_name": "整合性レビュー",
  "status": "conditionally_approved",
  "score": 4,
  "findings": {
    "must_fix": [
      {
        "id": "S2-001",
        "category": "test_code_reference",
        "title": "テストコードで使用される isMultipleChoicePrompt 関数が prompt-detector.ts からエクスポートされていない",
        "description": "設計書セクション6-3-1、6-3-3のテストコードでは isMultipleChoicePrompt(result.promptData) 型ガードを使用しているが、この関数は src/lib/prompt-detector.ts からエクスポートされていない。既存のテストファイル tests/unit/prompt-detector.test.ts ではテストファイル内にローカル定義（L11-13）として存在している。設計書のテストコードがこのローカル定義を前提としていることを明記するか、テストコード例にローカル定義を含めるべきである。",
        "location": "設計書セクション6-3-1, 6-3-3",
        "recommendation": "テストコード例は既存テストファイルの describe ブロック内に追加される前提であり、既存のローカル型ガード isMultipleChoicePrompt を利用可能であることを設計書に注記する。あるいはテストコード例にimport/ローカル定義の前提条件を記載する。"
      }
    ],
    "should_fix": [
      {
        "id": "S2-002",
        "category": "code_reference",
        "title": "設計書セクション4-2の修正前コードが実際のコードベースと行番号・コンテキストで不一致",
        "description": "設計書セクション4-2『修正前の継続行条件』で示されているコードブロックは、実際の prompt-detector.ts L288-295 のコードと内容的には一致しているが、設計書では変数が独立して定義されているように見える一方、実際のコードでは if (options.length > 0 && line && !line.match(/^[-─]+$/)) ブロックの内部に位置している。この重要なガード条件（options.length > 0）が設計書の修正前・修正後のコード例から省略されているため、isContinuationLine() が常に評価されるかのような誤解を招く。特にセクション5-2の偽陽性リスク分析で 'options.length > 0 の場合のみ評価される' と記載されている点と、コード例の間に表現の齟齬がある。",
        "location": "設計書セクション4-2",
        "recommendation": "修正後のコード例において、isContinuationLine() が options.length > 0 のガード内で呼び出されることを明示する。例えば、呼び出し元コンテキストを示すか、JSDocコメントに注記を追加する。"
      },
      {
        "id": "S2-003",
        "category": "cross_section",
        "title": "設計書セクション6-3-4のテストケース 'should treat single character lines correctly' の期待値がロジックと不整合",
        "description": "セクション6-3-4の2番目のテスト 'should treat single character lines correctly with minimum length check' では、入力が '❯ 1. Option A' + 'Y' + '  2. Option B' で期待結果が options.length === 2 としている。しかし実際のロジックの逆順スキャンでは、'Y' は1文字の行（line.length < 5 かつ line.endsWith('?') === false）であるため、既存の isShortFragment 条件で継続行として認識されスキップされる。つまり SF-001 の line.length >= 2 チェックの有無にかかわらず、この行は isShortFragment でスキップされる。このテストは SF-001 の効果を正確に検証できていない。",
        "location": "設計書セクション6-3-4, テストケース2",
        "recommendation": "SF-001 の効果を正確に検証するには、isShortFragment に該当しない（5文字以上の）1文字パス断片をテストするか、isPathContinuation のみがマッチする入力を使用する。例えば 'Y' の代わりに isShortFragment にマッチせず isPathContinuation にのみ依存する入力（5文字以上の英数字行など）でテストするべき。ただし SF-001 のポイントは '1文字行の除外' なので、テストの意図自体は明確であり、コメントで isShortFragment による保護が先に働くことを注記するだけでもよい。"
      },
      {
        "id": "S2-004",
        "category": "cross_section",
        "title": "設計書セクション2-2の影響スコープ図に prompt-response/route.ts が含まれていない",
        "description": "設計書セクション2-2の mermaid 影響スコープ図では間接影響としてAPIルートファイルが列挙されているが、src/app/api/worktrees/[id]/prompt-response/route.ts が含まれていない。実際のコードベースでは prompt-response/route.ts の L75 で detectPrompt(cleanOutput) が呼び出されており、間接影響を受けるファイルである。Issue #161 設計書のセクション7.1でもこのファイルは呼び出し元として記載されている（PRR として参照）。",
        "location": "設計書セクション2-2 mermaid図",
        "recommendation": "mermaid図の間接影響にPRR[prompt-response/route.ts]のノードが既に含まれていることを確認した。このノードの正式名称が省略形であるため、実際のファイルパスとの対応を注記に追加するか、ノードラベルを 'prompt-response/route.ts' に変更する。（注: 図中の PRR は実際にはラベルが 'prompt-response/route.ts' に対応しているため、これは軽微な指摘である。）"
      },
      {
        "id": "S2-005",
        "category": "code_reference",
        "title": "設計書セクション4-2の isContinuationLine 関数の rawLine 使用と実際のスキャン構造の不整合",
        "description": "設計書セクション4-2の修正後コード例では isContinuationLine(rawLine, line) を独立関数として定義しているが、実際の detectMultipleChoicePrompt 内の Pass 2 逆順スキャンでは rawLine = lines[i] で取得し、line = lines[i].trim() で取得している。関数抽出時に rawLine の取得方法を正確に反映するために、呼び出し側のコンテキストも設計書に含めるべきである。現状の設計書のコード例だけでは、rawLine が何を指すのかが不明確であり、既存コードの L292 の 'const rawLine = lines[i];' との対応が明示されていない。",
        "location": "設計書セクション4-2",
        "recommendation": "関数シグネチャの JSDoc に rawLine と line の定義を明記する。例: '@param rawLine - Original line with indentation preserved (lines[i])', '@param line - Trimmed line (lines[i].trim())'。"
      },
      {
        "id": "S2-006",
        "category": "issue_design",
        "title": "Issue #161設計書との用語・パターンの整合性確認",
        "description": "Issue #181設計書はIssue #161の '2パス検出方式' と '多層防御' の用語を正確に使用しており、Layer 1-4の番号も一致している。Issue #161設計書の DEFAULT_OPTION_PATTERN と NORMAL_OPTION_PATTERN の定義も正確に参照されている。ただし、Issue #181設計書セクション4-1で参照している '多層防御 Layer 1-4' のうち Layer 1（thinking状態チェック）はIssue #181の修正対象外であるにもかかわらず、セクション4-1のテーブルに含まれている。Issue #181はLayer 2内部の逆順スキャンロジックのみの修正であることを明確にするため、Layer 1への言及は参考情報として区別するのが望ましい。",
        "location": "設計書セクション4-1",
        "recommendation": "セクション4-1の多層防御テーブルで、Layer 1 が Issue #181 の変更スコープ外であることを注記する。"
      }
    ],
    "consider": [
      {
        "id": "C-001",
        "category": "test_coverage",
        "title": "Esc to cancel フッター行の有無でテスト結果が変わる可能性",
        "description": "設計書セクション6-3-1のテストでは 'Esc to cancel ...' フッター行が含まれているが、セクション6-3-3のテストでは含まれていない。実際の detectMultipleChoicePrompt のロジックでは、空行や非オプション行は逆順スキャンの終了条件に影響する。フッター行が含まれる場合と含まれない場合の両方で動作が一貫することをテストで確認すべきである。現在の実装では空行はスキャンをスキップするため、結果は同じになるはずだが、明示的に検証する価値がある。",
        "location": "設計書セクション6-3-1, 6-3-3",
        "recommendation": "両テストケースでフッター行の有無を揃えるか、フッター行の有無が結果に影響しないことを確認するテストを追加する。"
      },
      {
        "id": "C-002",
        "category": "cross_section",
        "title": "設計書セクション11の受け入れ条件にラベル非連結検証テストの明示がない",
        "description": "設計書セクション6-3-3でラベル非連結検証テストが定義されているが、セクション11の受け入れ条件には '既存のプロンプト検出が退行しないこと' と 'テスト要件に記載のテストケースが追加されていること' という汎用的な記述のみで、ラベル非連結検証を明示的に要求していない。セクション6で定義されたテストは全てセクション11の受け入れ条件に包含されるはずだが、重要な検証ポイントであるラベル非連結を明示することで実装漏れを防げる。",
        "location": "設計書セクション11",
        "recommendation": "受け入れ条件に '継続行テキストがオプションラベルに連結されないこと' を明示的に追加する。"
      },
      {
        "id": "C-003",
        "category": "design_consistency",
        "title": "設計書セクション5-3の '継続行スキップの動作' の記述と実装の整合確認",
        "description": "セクション5-3で '継続行と判定された行は continue でスキップされるのみ。直前のオプションの label には連結されない' と明記されている。実際の prompt-detector.ts L297-299 のコードでは確かに continue でスキップされており、ラベル連結ロジックは存在しない。この整合性は確認できた。ただし、設計書では '直前のオプション' という表現が使われているが、逆順スキャンのため実際には '直後にスキャンされるオプション'（逆順で先に発見されたオプション）が正確な表現である。",
        "location": "設計書セクション5-3",
        "recommendation": "逆順スキャンのコンテキストを考慮した表現に修正する。例: '最後に検出されたオプション' など。"
      },
      {
        "id": "C-004",
        "category": "code_reference",
        "title": "claude-poller.ts の detectPrompt 呼び出し箇所が Issue #161 設計書と #181 設計書で異なる",
        "description": "Issue #161設計書セクション7.1ではclaude-poller.tsのdetectPrompt呼び出しが L164 としているが、実際のコードではL164とL232の2箇所が存在する。Issue #181設計書のセクション2-2の影響スコープ図では CP[claude-poller.ts] として1ノードで表現されており、呼び出し箇所数は明示されていない。これは#181設計書の範囲では問題ないが、影響分析の精度を考慮すると注意すべき点である。",
        "location": "設計書セクション2-2",
        "recommendation": "影響スコープの詳細度はセクション2-2のレベルでは問題ない。ただし将来の影響分析で正確な呼び出し箇所を追跡する必要がある場合、Issue #161設計書セクション7.1の情報を参照し更新することを推奨する。"
      }
    ]
  },
  "risk_assessment": {
    "technical": "low",
    "security": "low",
    "operational": "low"
  },
  "consistency_evaluation": {
    "design_vs_code": {
      "score": 4,
      "comment": "設計書の修正前コード引用は実際のコードベースと内容的に一致している。関数名、変数名、パターン定義は正確。ただし、options.length > 0 ガード条件の省略やrawLine/lineの取得コンテキストの不足がある。"
    },
    "design_vs_issue": {
      "score": 5,
      "comment": "設計書はIssue #181の問題（複数行折り返しオプション検出失敗）に正確に対応している。再現シナリオ、根本原因分析、修正方針が一貫している。"
    },
    "cross_section": {
      "score": 4,
      "comment": "修正案、テスト設計、受け入れ条件の間に重大な不整合はない。SF-001/SF-002/SF-003の指摘がセクション4-2, 9-1, 10-1, 11に一貫して反映されている。テストケース6-3-4の2番目のテストがSF-001の効果を正確に検証できていない点が軽微な不整合。"
    },
    "design_vs_issue161": {
      "score": 5,
      "comment": "Issue #161の2パス検出方式、多層防御Layer 1-4、DEFAULT_OPTION_PATTERN/NORMAL_OPTION_PATTERNの参照が全て正確。用語の一貫性も維持されている。"
    },
    "test_vs_design": {
      "score": 4,
      "comment": "テストケースの期待値は設計と概ね整合しているが、テストケース6-3-4のSF-001効果検証の精度に課題がある。また、isMultipleChoicePrompt型ガードの前提条件が不明確。"
    }
  },
  "reviewed_files": [
    "dev-reports/design/issue-181-multiline-option-continuation-design-policy.md",
    "dev-reports/design/issue-161-auto-yes-false-positive-design-policy.md",
    "src/lib/prompt-detector.ts",
    "src/lib/auto-yes-manager.ts",
    "src/lib/auto-yes-resolver.ts",
    "src/lib/status-detector.ts",
    "src/lib/cli-patterns.ts",
    "src/types/models.ts",
    "tests/unit/prompt-detector.test.ts",
    "src/app/api/worktrees/[id]/prompt-response/route.ts",
    "src/app/api/worktrees/[id]/current-output/route.ts",
    "src/app/api/worktrees/[id]/route.ts",
    "src/app/api/worktrees/route.ts",
    "src/lib/response-poller.ts",
    "src/lib/claude-poller.ts"
  ],
  "timestamp": "2026-02-07T12:00:00Z"
}
