{"body":"## 概要\n\nモバイル画面の「Claudeからの確認」ダイアログで選択肢（例: 1. Yes）を選んで「送信」しても、Claude Codeが入力を認識せずプロンプトが残り続ける。\n\n## 再現手順\n\n1. Claude Codeセッションで複数選択肢プロンプト（AskUserQuestion）が表示される\n2. CommandMateのモバイルUIで選択肢を選択\n3. 「送信」ボタンをタップ\n4. → Claude Codeが応答せず、プロンプトが残り続ける\n\n## 原因\n\n`src/app/api/worktrees/[id]/prompt-response/route.ts` の72〜89行目にあるプロンプト再検証処理がサイレント失敗した場合、`promptCheck` が `null` のままとなり、96〜98行目の `isClaudeMultiChoice` 判定が常に `false` になる。\n\n結果、149〜157行目のテキスト入力フォールバック（`sendKeys(\"1\")` + Enter）が実行されるが、Claude Codeの選択肢プロンプトはカーソルキーベースのナビゲーション（Arrow Up/Down + Enter）を要求するため、文字列入力は無視される。\n\n### 処理フロー\n\n```\nUI: selectedOption.toString() → \"1\" → onRespond(\"1\")\n    ↓\nAPI (prompt-response/route.ts):\n  [L72-89] captureSessionOutput() → 例外発生 → promptCheck = null\n  [L96-98] promptCheck?.promptData?.type → undefined → isClaudeMultiChoice = false\n  [L149-157] sendKeys(\"1\") + Enter → Claude Codeは認識しない ✗\n```\n\n### 期待される動作 vs 実際の動作\n\n| 期待される入力 | 実際に送られる入力 |\n|---|---|\n| `sendSpecialKeys([\"Enter\"])` (デフォルト選択時) | `sendKeys(\"1\")` + `sendKeys(\"\", Enter)` |\n| カーソルキー操作 → Enter | 文字列 \"1\" → Enter |\n\n## 影響範囲\n\n- Claude Codeの**複数選択肢プロンプト**（AskUserQuestion）のみ\n- Yes/Noプロンプトはテキスト送信で動作するため影響なし\n- Codexには影響なし\n\n## 修正方針案\n\n`promptCheck` が `null`（再検証失敗）の場合でも、以下の条件を満たせばカーソルキー方式で送信するフォールバックを追加する:\n\n- `cliToolId === 'claude'`\n- `answer` が数値文字列\n\nただし、デフォルト選択肢の番号が不明なため、UI側から `defaultOption` 情報もリクエストに含める設計変更が必要になる可能性がある。\n\n## 関連ファイル\n\n- `src/app/api/worktrees/[id]/prompt-response/route.ts` (主要修正対象)\n- `src/components/mobile/MobilePromptSheet.tsx`\n- `src/components/worktree/PromptPanel.tsx`\n- `src/components/worktree/WorktreeDetailRefactored.tsx`\n- `src/lib/tmux.ts` (`sendKeys` / `sendSpecialKeys`)\n- `tests/unit/api/prompt-response-verification.test.ts`\n\n## スクリーンショット\n\n問題発生時のモバイル画面:\n![Screenshot](workspace/Screenshot_20260215-184345.png)","title":"fix: 選択肢プロンプトの送信がClaude Codeに認識されない（promptCheck再検証失敗時のフォールバック不備）"}
