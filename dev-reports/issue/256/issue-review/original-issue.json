{"body":"## 概要\n\nClaude CLIで選択メッセージ（multiple_choice プロンプト）がアクティブプロンプトパネルに表示されない不具合。\nプロンプトパネル自体が出現せず、質問文・選択肢ともに一切表示されない。\n\n## 再現手順\n\n### パターンA: 複数行質問の折り返し\n1. CommandMateでClaude CLIセッションを開始する\n2. Claude CLIがAskUserQuestion形式のmultiple_choiceプロンプトを発行する\n3. **質問文が複数行に折り返される（質問部分＋説明部分が続く）パターン**のプロンプトを待つ\n4. アクティブプロンプトパネルが表示されないことを確認する\n\n### パターンB: model選択プロンプト\n1. CommandMateでClaude CLIセッションを開始する\n2. Claude CLIで `/model` コマンドを実行し、model選択プロンプトを表示する\n3. アクティブプロンプトパネルが表示されないことを確認する\n\n## 期待する動作\n\n- 選択メッセージの質問文と選択肢がプロンプトパネルに表示される\n- ユーザーが選択肢をクリック/タップして回答できる\n\n## 実際の動作\n\n- プロンプトパネルが表示されない（質問文・選択肢ともに非表示）\n- 不定期に発生（パターンAは折り返し時のみ、パターンBは常に発生）\n- デスクトップ・モバイル両方で発生\n\n## スクリーンショット\n\n![Screenshot_20260213-004044.png](https://github.com/user-attachments/assets/fe0b7149-9499-4b44-8a03-8fb398347ff4)\n\n## 根本原因（特定済み）\n\n### 原因箇所: `src/lib/prompt-detector.ts` の `isQuestionLikeLine()` 関数（L315-332）\n\n**Layer 5 SEC-001b** の質問行妥当性検証で検出が失敗する。2つの失敗パターンがある。\n\n### 失敗パターンA: 複数行折り返しの質問文\n\nClaude CLIのAskUserQuestion形式で、質問文が折り返されるケース:\n\n```\n対策方針としてどれが適切ですか？コード調査の結果、visibilitychangeイベントリスナーがなく、\nエラー時の自動リトライもないことが原因と推測されます。\n```\n\n1. Pass 2の逆スキャンで、オプション1の手前にある**最後の非オプション行**が `questionEndIndex` に設定される\n2. その行の末尾は **「。」（句点）** で終わっている\n3. `isQuestionLikeLine()` は `?`、`？`（全角）、`:` のみチェックし、**`。`は未対応**\n4. Layer 5 SEC-001b で「質問行ではない」と判定 → **プロンプト未検出**\n\n**不定期発生の理由**: ターミナル幅や質問文の長さに依存。1行に収まれば末尾が `？` なので検出成功。\n\n### 失敗パターンB: 質問形式でないプロンプト（model選択等）\n\nClaude CLIの `/model` コマンドなど、質問文が命令形/説明文のケース:\n\n```\n Select model\n Switch between Claude models. Applies to this session and future Claude Code sessions. For other/previous model names, specify with --model.\n\n ❯ 1. Default (recommended) ✔  Opus 4.6 · Most capable for complex work\n   2. Sonnet                   Sonnet 4.5 · Best for everyday tasks\n   3. Haiku                    Haiku 4.5 · Fastest for quick answers\n```\n\n1. Pass 2の逆スキャンでオプション1-3を収集し、`questionEndIndex` に「Switch between...--model.」行を設定\n2. この行の末尾は **`.`（ピリオド）** で終わっている\n3. `isQuestionLikeLine()` で `?` でも `？` でも `:` でもない → **false**\n4. Layer 5 SEC-001b で「質問行ではない」と判定 → **プロンプト未検出**\n\n**注意**: この行には「select」「specify」等のキーワードが含まれているが、Pattern 2は `:` 終端時のみキーワードチェックするため、`.` 終端では活用されない。\n\n### 該当コード\n\n```typescript\n// prompt-detector.ts L315-332\nfunction isQuestionLikeLine(line: string): boolean {\n  if (line.length === 0) return false;\n\n  // Pattern 1: Lines ending with question mark\n  if (line.endsWith('?') || line.endsWith('\\uff1f')) return true;  // ？対応済み\n\n  // Pattern 2: Lines ending with colon that contain selection keyword\n  if (line.endsWith(':')) {\n    if (QUESTION_KEYWORD_PATTERN.test(line)) return true;\n  }\n\n  return false;  // ← 「。」「.」で終わる行はここでfalseを返す\n}\n```\n\n```typescript\n// QUESTION_KEYWORD_PATTERN（L294）\nconst QUESTION_KEYWORD_PATTERN = /(?:select|choose|pick|which|what|how|where|enter|type|specify|confirm|approve|accept|reject|decide|preference|option)/i;\n```\n\n## 対策案\n\n### 修正方針\n\n`isQuestionLikeLine()` に以下の拡張が必要:\n\n1. **行内に `?` または `？` を含むかチェック**（末尾だけでなく途中に含まれるケース＝パターンA対応）\n2. **末尾の句読点に依存しないキーワードチェック**（`:` 終端でなくてもQUESTION_KEYWORD_PATTERNでチェック＝パターンB対応）\n\n### 具体的な修正案\n\n```typescript\nfunction isQuestionLikeLine(line: string): boolean {\n  if (line.length === 0) return false;\n\n  // Pattern 1: Lines ending with question mark (English or full-width Japanese)\n  if (line.endsWith('?') || line.endsWith('\\uff1f')) return true;\n\n  // Pattern 2: Lines containing question mark anywhere (multi-line question wrapping)\n  if (line.includes('?') || line.includes('\\uff1f')) return true;\n\n  // Pattern 3: Lines ending with colon that contain selection keyword\n  if (line.endsWith(':')) {\n    if (QUESTION_KEYWORD_PATTERN.test(line)) return true;\n  }\n\n  // Pattern 4: Lines containing selection keyword (for non-question prompts like model selection)\n  if (QUESTION_KEYWORD_PATTERN.test(line)) return true;\n\n  return false;\n}\n```\n\n**注意**: Pattern 4の追加はSEC-001の誤検出防止ガードを緩める可能性があるため、セキュリティ影響の検討が必要。代替案として:\n- `questionEndIndex` から上方に走査して、`?`/`？`/キーワードを含む行を探索する方法\n- `hasDefaultIndicator`（❯指標の有無）も組み合わせた判定\n\n## 影響範囲\n\n### 変更対象ファイル\n\n| ファイル | 変更内容 |\n|---------|---------|\n| `src/lib/prompt-detector.ts` | `isQuestionLikeLine()` の複数行質問対応・キーワードチェック拡張 |\n| `tests/unit/prompt-detector.test.ts` | 新パターンのテスト追加 |\n\n### 関連ファイル（変更不要だが影響確認必要）\n\n| ファイル | 関連 |\n|---------|------|\n| `src/app/api/worktrees/[id]/current-output/route.ts` | プロンプト検出・API応答 |\n| `src/lib/status-detector.ts` | セッションステータス・プロンプト検出判定 |\n| `src/lib/response-poller.ts` | プロンプト検出・DB保存 |\n| `src/components/worktree/PromptPanel.tsx` | デスクトップUI表示 |\n| `src/components/mobile/MobilePromptSheet.tsx` | モバイルUI表示 |\n\n## 受入条件\n\n- [ ] 複数行に折り返された質問文（末尾が「。」）でもmultiple_choiceプロンプトが検出される（パターンA）\n- [ ] model選択等の質問形式でないプロンプトもmultiple_choiceとして検出される（パターンB）\n- [ ] 1行に収まる質問文での検出が引き続き正常に動作する\n- [ ] SEC-001の誤検出防止ガードが維持される（通常の番号付きリストが誤検出されない）\n- [ ] 既存のprompt-detectorテストがすべてパスする\n- [ ] 新規テストケース（パターンA: 「。」終端、パターンB: model選択形式）が追加されている","title":"選択メッセージが表示されない"}
