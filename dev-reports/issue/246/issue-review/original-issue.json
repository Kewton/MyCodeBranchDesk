{"body":"## 概要\n\nスマートフォンでCommandMateを使用中、アプリをバックグラウンドにした後フォアグラウンドに復帰すると「Error loading worktree」エラーが表示される。ブラウザをリロードすると即座に正常に戻る。\n\n## 再現手順\n\n1. スマートフォンのブラウザでCommandMateを開き、Worktree詳細画面を表示する\n2. ホームボタンやアプリ切り替えでブラウザをバックグラウンドにする\n3. しばらく（数十秒〜数分）待つ\n4. ブラウザに戻る（フォアグラウンド復帰）\n5. 「Error loading worktree」エラーが表示される\n\n## 期待する動作\n\nスマートフォンのバックグラウンド復帰時に、エラーを表示せず自動的にデータを再取得して正常な画面を表示する。\n\n## 実際の動作\n\n「Error loading worktree」エラーが画面に表示され、手動でブラウザをリロードしないと復帰しない。\n\n![Screenshot_20260212-011035.png](https://github.com/user-attachments/assets/9d988047-0090-4242-85cb-7ae5baa2cef5)\n\n## 根本原因の仮説\n\nコードベース調査の結果、以下が原因と推測される：\n\n1. **`visibilitychange`イベントリスナーの欠如**: `WorktreeDetailRefactored.tsx`にブラウザのフォーカス復帰やページ可視性変更を検知するイベントリスナーがない\n2. **ポーリングタイマーの停止**: スマホがバックグラウンドに入るとブラウザがタイマーを一時停止し、復帰時にポーリングが正常に再開されない\n3. **エラー状態からの自動復帰なし**: ポーリングエフェクト（L1479-1493）で`error`が`true`になるとポーリングが完全に停止し、自動リトライの仕組みがない\n4. **初期化ガードの影響**: `initialLoadCompletedRef`が一度`true`になると初期化処理が再実行されないため、復帰時の再初期化が行われない\n\n### エラー発生フロー\n\n```\nスマホバックグラウンド → タイマー停止 → フォアグラウンド復帰\n→ ポーリング再開遅延/API失敗 → setError() → ポーリング停止\n→ ErrorDisplay表示 → 自動復帰手段なし → 手動リロードが必要\n```\n\n## 対策案\n\n`visibilitychange`イベントリスナーを追加し、ページ復帰時にデータ再取得をトリガーする。\n\n### 主要な変更点\n\n- `WorktreeDetailRefactored.tsx`に`visibilitychange`イベントリスナーを追加\n- ページ復帰時（`document.visibilityState === 'visible'`）にエラー状態をリセットしてデータ再取得を実行\n- 必要に応じて`WorktreeList.tsx`のポーリングにも同様の対応を追加\n\n## 実装タスク\n\n- [ ] `WorktreeDetailRefactored.tsx`に`visibilitychange`イベントリスナーを追加\n- [ ] ページ復帰時のエラーリセット＆データ再取得ロジックを実装\n- [ ] `WorktreeList.tsx`のポーリングにも`visibilitychange`対応を追加\n- [ ] ユニットテストの追加\n- [ ] スマートフォン実機での動作確認\n\n## 受入条件\n\n- [ ] スマートフォンでバックグラウンド復帰時にエラーが表示されず、自動的にデータが再取得される\n- [ ] `visibilitychange`イベントで適切にデータ再取得がトリガーされる\n- [ ] 既存のポーリング動作に影響がない\n- [ ] 既存テストがすべてパスする\n\n## 影響範囲\n\n### 変更対象ファイル\n\n| ファイル | 変更内容 |\n|---------|---------|\n| `src/components/worktree/WorktreeDetailRefactored.tsx` | `visibilitychange`イベントリスナー追加、復帰時のデータ再取得ロジック |\n| `src/components/worktree/WorktreeList.tsx` | ポーリングの`visibilitychange`対応 |\n\n### 関連コンポーネント\n\n- `src/hooks/useWorktreeUIState.ts` - エラーリセットアクション\n- `src/app/api/worktrees/[id]/route.ts` - Worktree取得API\n- `src/app/api/worktrees/[id]/current-output/route.ts` - ターミナル出力取得API\n- `src/app/api/worktrees/[id]/messages/route.ts` - メッセージ取得API","title":"スマホにて再開時Error loading worktreeとなる"}
