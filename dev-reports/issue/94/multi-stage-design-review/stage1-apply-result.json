{
  "issue_number": 94,
  "stage": 1,
  "stage_name": "設計原則レビュー",
  "apply_date": "2026-01-30",
  "target_file": "dev-reports/design/issue-94-file-upload-design-policy.md",
  "applied_items": [
    {
      "id": "DRY-001",
      "severity": "must_fix",
      "description": "sanitizeFilename()が既存のisValidNewName()と重複",
      "action_taken": "sanitizeFilename()関数の新規作成を取りやめ、既存のisValidNewName()関数にオプション引数{ forUpload?: boolean }を追加する設計に変更。アップロード用の追加検証（null byte、改行文字）をオプションで有効化する形式に統一。セクション4.2で詳細な実装例を追加。"
    },
    {
      "id": "CONSISTENCY-001",
      "severity": "must_fix",
      "description": "uploadable-extensions.tsがeditable-extensions.tsと異なる設計パターン",
      "action_taken": "uploadable-extensions.tsの設計をExtensionValidatorパターンに統一。UploadableExtensionValidatorインターフェースを定義し、extension/maxFileSize/allowedMimeTypesをプロパティとして持つ設計に変更。セクション3.2で完全な実装例を追加。"
    },
    {
      "id": "SOLID-001",
      "severity": "should_fix",
      "description": "writeBinaryFile()の責務が多い",
      "action_taken": "セクション3.3に「多層防御」の設計判断を明記。APIルート層とfile-operations層の責務分離を説明し、意図的な設計であることをドキュメント化。"
    },
    {
      "id": "SOLID-002",
      "severity": "should_fix",
      "description": "ホワイトリストとブラックリストの併用",
      "action_taken": "セクション4.4を追加し、ホワイトリスト方式のみを採用する方針を明記。BLOCKED_EXTENSIONSリストは実装しないことを明確化。理由として、許可リストと拒否リストの併用による混乱防止、セキュリティ上の優位性を記載。"
    },
    {
      "id": "DRY-002",
      "severity": "should_fix",
      "description": "パストラバーサル検証の重複",
      "action_taken": "セクション3.3に多層防御として意図的な重複であることを明記。3つの理由（セキュリティ上重要な検証は多層で行うべき、他コンテキストからの呼び出し対応、オーバーヘッドは軽微）を記載。"
    },
    {
      "id": "CONSISTENCY-002",
      "severity": "should_fix",
      "description": "新エラーコードの型定義が不完全",
      "action_taken": "セクション3.1にFileOperationErrorCode型への追加（INVALID_EXTENSION, INVALID_MIME_TYPE, FILE_TOO_LARGE）を明記。ERROR_CODE_TO_HTTP_STATUSマッピングの更新も記載。セクション8.2の変更ファイル一覧を更新。"
    },
    {
      "id": "QUALITY-001",
      "severity": "should_fix",
      "description": "FileOperationResultの型定義が不完全",
      "action_taken": "セクション3.3にFileOperationResultインターフェースへのsize?: numberプロパティ追加を明記。writeBinaryFile()の実装例でsizeを返却するコードを追加。"
    },
    {
      "id": "QUALITY-002",
      "severity": "nice_to_have",
      "description": "MIMEタイプ偽装のテストケースが不足",
      "action_taken": "セクション7.2の結合テストにMIMEタイプ偽装テストケースを追加。.png拡張子でtext/plain送信時のINVALID_MIME_TYPEエラー検証を明記。"
    }
  ],
  "skipped_items": [
    {
      "id": "SOLID-003",
      "severity": "should_fix",
      "reason": "レビュー結果で「設計書に明記済みで問題なし」と評価されており、対応不要"
    },
    {
      "id": "KISS-001",
      "severity": "nice_to_have",
      "reason": "レビュー結果で「現状の設計は適切。特に変更不要」と評価されており、対応不要"
    },
    {
      "id": "KISS-002",
      "severity": "nice_to_have",
      "reason": "セクション2.3にエンドポイント分離の技術的理由（Content-Typeの違い）を追加済みで対応完了"
    },
    {
      "id": "YAGNI-001",
      "severity": "nice_to_have",
      "reason": "セクション10.2/10.3を更新し、プログレス表示は5MB制限では不要と明記。スピナーの記述を削除し、Toast通知のみで十分と修正済み"
    }
  ],
  "changes_made": {
    "summary": "Stage 1設計原則レビューの指摘事項8件を設計方針書に反映。must_fix 2件、should_fix 5件、nice_to_have 1件を対応。",
    "sections_modified": [
      "2.1 システム構成図 - UploadableExtensionValidatorインターフェース追加",
      "2.3 エンドポイント分離の設計根拠 - 新規セクション追加",
      "3.1 新規APIエンドポイント - エラーコード型拡張の説明追加",
      "3.2 新規設定ファイル - ExtensionValidatorパターンに統一した実装例に全面書き換え",
      "3.3 バイナリファイル書き込み関数 - 多層防御の設計説明、FileOperationResult拡張を追加",
      "4.2 ファイル名検証 - isValidNewName()拡張の詳細設計を追加",
      "4.4 拡張子検証方針 - ホワイトリスト方式統一の説明を新規追加",
      "7.1 単体テスト - getMaxFileSize、isValidNewNameオプションのテスト追加",
      "7.2 結合テスト - MIMEタイプ偽装テストケース追加",
      "8.2 変更ファイル - route.tsのERROR_CODE_TO_HTTP_STATUS更新を追記",
      "10.1-10.4 設計原則の適用 - レビュー指摘を反映した説明に更新",
      "11. レビュー指摘事項の反映サマリー - 新規セクション追加",
      "12. 実装チェックリスト - Phaseベースに再構成"
    ],
    "new_sections_added": [
      "2.3 エンドポイント分離の設計根拠",
      "4.4 拡張子検証方針",
      "11. レビュー指摘事項の反映サマリー"
    ]
  },
  "status": "completed"
}
