{
  "stage": 3,
  "stage_name": "影響分析レビュー",
  "focus_area": "影響範囲",
  "summary": "Issue #376のproxy pathPrefix保持修正は、変更対象がproxyモジュール内に閉じており、波及範囲は限定的。ただし、logProxyError()のシグネチャにおける二重プレフィックス問題の対処漏れ、IProxyHandlerインターフェースのJSDoc更新漏れ、健康チェックURLとの整合性確認の必要性、およびlogger.test.tsのテストカバレッジ不足が確認された。後方互換性リスクはIssue #42の設計意図に照らして許容範囲内だが、ドキュメント上の注意喚起が必要。",
  "must_fix": [
    {
      "id": "SF3-001",
      "title": "logProxyError()の二重プレフィックス問題が設計方針書のlogProxyError修正仕様と現行route.tsの呼び出しパターンで矛盾する",
      "description": "設計方針書ではlogger.tsのlogProxyError()内のメッセージ構築を `${path}` に変更すると記載（SF2-001）。しかし、route.ts line 104の `logProxyError(pathPrefix, method, path, error)` は引き続き pathPrefix を第1引数で渡している。修正後はpathが '/proxy/{pathPrefix}/...' 形式になるため、logProxyError()内で `/proxy/${pathPrefix}${path}` を構築すると三重プレフィックスになる。設計方針書のlogProxyError修正（line 88を `${path}` に変更）は正しいが、この場合pathPrefix引数自体が冗長になる。route.tsから呼び出し時にpathPrefixを渡す必要性と、logProxyError()内部でpathPrefixをログの構造化データとしてのみ使用し表示文字列からは除外する方針を明確にすべき。現行の設計方針書の修正仕様（line 88を `${method} ${path}` に変更）自体は正しいため、実装時にこの方針通りに行えば動作は正しくなるが、logProxyErrorの@example JSDocも更新が必要。",
      "file": "/Users/maenokota/share/work/github_kewton/commandmate-issue-376/src/lib/proxy/logger.ts",
      "line": "79,88",
      "risk": "Medium"
    },
    {
      "id": "SF3-002",
      "title": "logger.test.tsの 'should format log message correctly' テストが修正後の期待値と不整合",
      "description": "logger.test.ts line 147の `expect.stringContaining('POST /proxy/app-streamlit/api/data')` は現行のlogProxyRequest()の出力形式 `/proxy/${entry.pathPrefix}${entry.path}` に基づく期待値。修正後はentry.pathが '/proxy/app-streamlit/api/data' 形式になり、ログ出力は `${entry.path}` のみとなる。テストのentry.pathを '/api/data' のまま放置すると、修正後のlogProxyRequest()が `[Proxy] POST /api/data -> 201 (120ms)` を出力し、期待値 `'POST /proxy/app-streamlit/api/data'` と不一致でテストが失敗する。テストのentry.pathを '/proxy/app-streamlit/api/data' に更新し、期待値もそれに合わせる必要がある。",
      "file": "/Users/maenokota/share/work/github_kewton/commandmate-issue-376/tests/unit/proxy/logger.test.ts",
      "line": "131-150",
      "risk": "High"
    }
  ],
  "should_fix": [
    {
      "id": "SF3-003",
      "title": "IProxyHandler インターフェースのJSDoc更新が設計方針書に含まれていない",
      "description": "src/lib/external-apps/interfaces.ts line 86のIProxyHandler.proxyHttp()のJSDoc `@param path - Request path (after removing /proxy/{pathPrefix})` が修正後の仕様と不整合になる。interfaces.tsは直接変更されないファイルだが、proxyHttp()のpath引数の意味が変わるため、インターフェース定義側のドキュメントも更新すべき。",
      "file": "/Users/maenokota/share/work/github_kewton/commandmate-issue-376/src/lib/external-apps/interfaces.ts",
      "line": "86",
      "risk": "Low"
    },
    {
      "id": "SF3-004",
      "title": "logger.test.ts全体のテストデータがpath修正後の形式に更新されていない",
      "description": "logger.test.tsの全テストケース（line 54, 75, 94, 114, 138, 159, 181, 201）でentry.pathが '/page', '/api/data', '/_stcore/stream' など旧形式（pathPrefix除去後）のまま。修正後はpathがフルパス形式（'/proxy/{pathPrefix}/...'）になるため、テストデータの大部分が旧仕様の値を使用している。テスト自体は動作するケースもあるが（stringContaining等の緩いマッチ）、テストデータが実際の利用パターンを反映しておらず、ドキュメントとしての価値が低下する。少なくとも主要テストケースのpathを修正後の形式に更新し、テストの実用性を高めるべき。",
      "file": "/Users/maenokota/share/work/github_kewton/commandmate-issue-376/tests/unit/proxy/logger.test.ts",
      "line": "49-210",
      "risk": "Low"
    },
    {
      "id": "SF3-005",
      "title": "logProxyError()の@example JSDocが修正後の呼び出しパターンと不整合",
      "description": "logger.ts line 79の@exampleで `logProxyError('app-svelte', 'GET', '/page', new Error('ECONNREFUSED'))` と記載されている。修正後はpathが '/proxy/app-svelte/page' 形式になるため、exampleも `logProxyError('app-svelte', 'GET', '/proxy/app-svelte/page', new Error('ECONNREFUSED'))` に更新すべき。同様にlogProxyRequest()の@example（line 47-57）もpathフィールドの例示値を更新すべき。",
      "file": "/Users/maenokota/share/work/github_kewton/commandmate-issue-376/src/lib/proxy/logger.ts",
      "line": "47-57,77-80",
      "risk": "Low"
    },
    {
      "id": "SF3-006",
      "title": "healthチェックのURLパス形式とproxy転送パス形式の整合性確認",
      "description": "health check (api/external-apps/[id]/health/route.ts line 30) は `http://${host}:${port}/` でルートにHEADリクエストを送る。修正後、upstreamアプリはbasePath: '/proxy/{pathPrefix}' で動作する前提のため、ルートパスのヘルスチェックは依然として到達可能（Next.jsはbasePath設定時もルートにリダイレクト可能）。ただし、Streamlitなど非Next.jsアプリでbasePath相当の設定が必要な場合、ヘルスチェックURLもbasePath付きに変更する必要がある可能性がある。現時点ではヘルスチェックは「ポート到達性確認」であり、パスの正確性は検証していないため、直接的な破壊はないが、将来的にはヘルスチェックパスの設定可能化を検討すべき。",
      "file": "/Users/maenokota/share/work/github_kewton/commandmate-issue-376/src/app/api/external-apps/[id]/health/route.ts",
      "line": "30",
      "risk": "Low"
    },
    {
      "id": "SF3-007",
      "title": "handler.test.ts内のproxyHttp/proxyWebSocketテストのpath引数が旧形式のまま",
      "description": "handler.test.tsの既存テスト（line 62, 85, 108, 126, 141, 158, 178, 196）でproxyHttp/proxyWebSocketに渡すpath引数が '/page', '/api/data' 等の旧形式。設計方針書では「proxyHttp単体テストは引数として受け取ったpathをそのまま転送することを確認するもので変更不要」と記載（SF2-005で追加テスト推奨）。確かにhandler.tsの関数自体はpath引数をそのまま使うだけなので単体テストの正当性は維持されるが、実際の呼び出しパターンを反映したテストケースの追加（SF2-005）が実装されることを確認すべき。",
      "file": "/Users/maenokota/share/work/github_kewton/commandmate-issue-376/tests/unit/proxy/handler.test.ts",
      "line": "46-166",
      "risk": "Low"
    }
  ],
  "good_points": [
    "変更の影響範囲がproxyモジュール内（route.ts, handler.ts, logger.ts）に完全に閉じており、proxy以外のモジュール（middleware.ts, external-apps API, UIコンポーネント等）への直接的なコード変更が不要",
    "ExternalAppCard.tsx (line 76) の `proxyUrl = /proxy/${app.pathPrefix}/` はブラウザ側のURL構築であり、proxy route handlerの内部パス処理とは独立しているため影響を受けない",
    "handler.tsのbuildUpstreamUrl()が純粋関数として設計されており、route.ts側のpath変更のみで転送先URLが正しくなるアーキテクチャは変更の局所化に成功している",
    "middleware.tsはproxy関連の特別な処理を持たず、通常のNext.jsルーティングとして/proxy/パスを通過させるため影響なし",
    "next.config.jsにproxyパス固有のrewrites/redirects設定がなく、セキュリティヘッダーは全パスに一律適用されるため影響なし",
    "設計方針書がStage 1, 2の全指摘を適切に反映しており、実装チェックリストが網羅的に整備されている",
    "後方互換性の影響を設計方針書で明示的に記述し、Issue #42の設計意図に基づく正当化がなされている"
  ],
  "impact_analysis": {
    "direct_changes": [
      {
        "file": "src/app/proxy/[...path]/route.ts",
        "change": "path構築ロジック修正（1行）",
        "risk": "Low"
      },
      {
        "file": "src/lib/proxy/handler.ts",
        "change": "コメント・JSDoc更新のみ",
        "risk": "Minimal"
      },
      {
        "file": "src/lib/proxy/logger.ts",
        "change": "ログメッセージ構築修正・JSDoc更新",
        "risk": "Low"
      }
    ],
    "indirect_impacts": [
      {
        "file": "src/lib/external-apps/interfaces.ts",
        "change": "IProxyHandler.proxyHttp @param path JSDoc不整合（動作影響なし）",
        "risk": "Minimal"
      },
      {
        "file": "src/app/api/external-apps/[id]/health/route.ts",
        "change": "ヘルスチェックURLはルートパス使用のため直接影響なし（将来的にbasePath対応検討）",
        "risk": "Minimal"
      },
      {
        "file": "src/components/external-apps/ExternalAppCard.tsx",
        "change": "影響なし（ブラウザ側URL構築で独立）",
        "risk": "None"
      },
      {
        "file": "src/middleware.ts",
        "change": "影響なし（proxy固有処理なし）",
        "risk": "None"
      },
      {
        "file": "next.config.js",
        "change": "影響なし（proxy固有設定なし）",
        "risk": "None"
      }
    ],
    "external_system_impact": {
      "upstream_apps": "basePath: '/proxy/{pathPrefix}' の設定が必須となる。basePath未設定のアプリは修正後にルーティングが変わる（旧: '/' + rest, 新: '/proxy/' + segments.join('/')）。Issue #42の設計意図通りだがマイグレーション手順の文書化が望ましい。",
      "browser_clients": "影響なし。ブラウザは /proxy/{pathPrefix}/ にアクセスするだけで、内部パス処理の変更は透過的。",
      "websocket_clients": "proxyWebSocket()もpath引数を同様に使用するため、WebSocket直接接続URL（ws://host:port/proxy/{pathPrefix}/...）にも影響。426レスポンスのdirectWsUrlにフルパスが含まれるようになる。"
    },
    "backward_compatibility": {
      "risk_level": "Medium",
      "description": "basePath未設定で '/proxy/{pathPrefix}/' 経由でルートパスにアクセスしていた既存upstreamアプリは、修正後 '/proxy/{pathPrefix}/' がそのままupstreamに転送されるため404になる可能性がある。これはIssue #42の設計意図に合致したバグ修正であるが、既存ユーザーへのマイグレーションガイダンスが必要。",
      "mitigation": "設計方針書の「後方互換性への影響」セクションで説明済み。受入条件に既存アプリの動作確認を含めることを推奨。"
    },
    "test_coverage": {
      "adequate": [
        "handler.test.ts: buildUpstreamUrl()の単体テストが純粋関数の動作を適切にカバー",
        "handler.test.ts: proxyHttp/proxyWebSocketの基本動作テストは既存で十分",
        "設計方針書のSF2-005: handler.test.tsへの修正後パターン追加テスト計画あり"
      ],
      "gaps": [
        "logger.test.ts: 修正後のpath形式（フルパス）を使用したテストケースが未定義（SF3-002/SF3-004）",
        "logger.test.ts: logProxyError()の出力メッセージ内容を検証するテストが存在しない（現在はstringContaining('[Proxy]')のみ）",
        "route.test.ts: 設計方針書で新規追加予定だが未作成（設計段階のためOK）",
        "統合テスト: external-apps-api.test.tsにproxy経由のE2Eフローテストがない（スコープ外だが将来課題）"
      ]
    }
  },
  "overall_score": 8,
  "timestamp": "2026-02-28T12:00:00Z"
}
