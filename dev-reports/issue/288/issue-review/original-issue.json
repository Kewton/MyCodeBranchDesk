{"body":"## 概要\n\nメッセージ入力欄のスラッシュコマンドセレクターで「Enter custom command...」を選択した後、カスタムコマンドを入力してもEnterキーで送信できない。入力欄に「/」がセットされ文字の追加入力は可能だが、入力のたびにコマンドセレクターが再表示されるため、Enterキーがセレクター操作に消費されて送信されない。CodexとClaude Codeの両方で発生する。\n\n## 再現手順\n\n1. Worktree詳細画面を開く（Codex or Claude Codeセッション）\n2. メッセージ入力欄に `/` を入力し、スラッシュコマンドセレクターを表示\n3. 「Enter custom command...」ボタンをクリック\n4. セレクターが閉じ、入力欄に `/` がセットされる\n5. 続けてコマンド名を入力（例: `model`）→ 入力欄は `/model` になる\n6. **この時点でコマンドセレクターが再表示される**\n7. Enterキーを押す → セレクターの操作として処理され、メッセージが送信されない\n\n## 期待する動作\n\n「Enter custom command...」選択後にカスタムコマンド（例: `/model gpt-4o`）を入力し、Enterキーで正常にCLIセッションへ送信できる。\n\n## 実際の動作\n\n- 「Enter custom command...」選択後、`/` の後に文字を入力するとコマンドセレクターが再度表示される\n- セレクターが開いている間はEnterキーがセレクター操作に消費され、メッセージ送信ができない\n- 結果として、カスタムコマンド機能が実質的に使用不可能な状態\n\n## 根本原因の仮説\n\n`src/components/worktree/MessageInput.tsx` L158 の `handleMessageChange` 内のセレクター表示ロジックに問題がある。\n\n```typescript\n// L157-162\nif (newValue === '/' || (newValue.startsWith('/') && !newValue.includes(' '))) {\n  setShowCommandSelector(true);  // ← handleFreeInput()で閉じても再表示される\n} else {\n  setShowCommandSelector(false);\n}\n```\n\n`handleFreeInput()`（L141-148）はセレクターを閉じて `/` をセットするが、その後の入力で `handleMessageChange` が呼ばれるたびに、メッセージが `/` で始まりスペースを含まない場合にセレクターが再表示されてしまう。\n\n## 対策案\n\n`handleFreeInput()` 呼び出し時にフリー入力モードのフラグ（例: `isFreeInputMode`）をセットし、`handleMessageChange` 内でこのフラグが `true` の場合はセレクターを再表示しないようにする。フラグはメッセージ送信時またはメッセージがクリアされた時にリセットする。\n\n### 主な変更点\n\n1. `isFreeInputMode` ステートの追加\n2. `handleFreeInput()` でフラグを `true` に設定\n3. `handleMessageChange()` でフラグ `true` 時にセレクター表示をスキップ\n4. `submitMessage()` およびメッセージクリア時にフラグをリセット\n\n## 影響範囲\n\n### 変更対象ファイル\n\n| ファイル | 変更内容 |\n|---------|---------|\n| `src/components/worktree/MessageInput.tsx` | `isFreeInputMode` ステート追加、`handleFreeInput`/`handleMessageChange`/`submitMessage` の修正 |\n\n### 関連コンポーネント\n\n- `src/components/worktree/SlashCommandSelector.tsx`（変更不要だが関連）\n- `src/lib/standard-commands.ts`（変更不要だが関連）\n\n## 受入条件\n\n- [ ] 「Enter custom command...」選択後、カスタムコマンドを入力してEnterキーで送信できる\n- [ ] カスタムコマンド入力中にコマンドセレクターが再表示されない\n- [ ] 通常の `/` 入力時のコマンドセレクター表示は従来通り動作する\n- [ ] Codex・Claude Code両方で正常に動作する\n- [ ] 既存のスラッシュコマンド選択機能に影響がない","title":"Codexにてカスタムモデルが利用出来ない"}
