{"body":"## 概要\n\n現在UIに表示されるコーディングエージェントは `claude` と `codex` の2つにハードコードされている。新たなコーディングエージェント（vibe-local等）への対応を強化するため、CMATEタブに「Agent」サブタブを追加し、ユーザーがUIに表示するエージェント2つを選択できるようにする。\n\n## 背景\n\n- 現在 `CLI_TOOL_IDS` には `['claude', 'codex', 'gemini']` が定義されているが、UIでは `claude` と `codex` のみハードコード表示\n- [vibe-local](https://github.com/ochyai/vibe-local) など新しいコーディングエージェントが登場しており、対応の拡張が必要\n- UIの制約上、ターミナルヘッダーに表示できるエージェントタブは**2つまで**（デスクトップ・モバイル共通）\n\n## 対応方針\n\n### 1. 新規コーディングエージェントの追加\n\n`vibe-local` を4つ目のCLIツールとして追加する。\n\n| 項目 | 内容 |\n|------|------|\n| ID | `vibe-local` |\n| 特徴 | Ollama利用のオフラインAIコーディングエージェント |\n| リポジトリ | https://github.com/ochyai/vibe-local |\n| tmux連携 | 既存のclaude/codexと同様のtmuxセッション管理 |\n\n**変更対象:**\n- `src/lib/cli-tools/types.ts` - `CLI_TOOL_IDS` に `'vibe-local'` 追加\n- `src/lib/cli-tools/vibe-local.ts` - 新規: ViveLocalTool クラス実装（BaseCLITool継承）\n- `src/lib/cli-tools/manager.ts` - ViveLocalTool のインスタンス登録\n\n### 2. CMATEタブに「Agent」サブタブを追加\n\n現在のCMATEタブ（Notes / Logs）に3つ目のサブタブ「Agent」を追加する。\n\n**変更対象:**\n- `src/components/worktree/NotesAndLogsPane.tsx` - SubTabに `'agent'` 追加、AgentSettingsPaneの表示切替\n- `src/components/worktree/AgentSettingsPane.tsx` - 新規: エージェント選択UI\n\n**Agent サブタブのUI仕様:**\n- 利用可能なエージェント一覧をリスト表示（claude, codex, gemini, vibe-local）\n- チェックボックスまたはトグルで**2つまで**選択可能\n- 2つ選択済みの状態で3つ目を選択しようとした場合は選択不可（disabled表示 + ツールチップ等で説明）\n- 選択状態はWorktree単位で永続化（DB）\n\n### 3. エージェント選択の永続化\n\n選択状態をWorktree単位でDBに保存する。\n\n**変更対象:**\n- `src/lib/db-*.ts` 関連 - worktreesテーブルに `selected_agents` カラム追加（JSON文字列、デフォルト `'[\"claude\",\"codex\"]'`）\n- `src/app/api/worktrees/[id]/route.ts` - 選択エージェントの取得・更新対応\n- 新規API or 既存PATCH APIの拡張で選択状態を保存\n\n### 4. UIの動的レンダリング\n\nハードコードされた `(['claude', 'codex'] as const)` を、DBから取得した選択状態に基づいて動的に描画する。\n\n**変更対象:**\n- `src/components/worktree/WorktreeDetailRefactored.tsx`\n  - Line 1795付近（デスクトップ）: ハードコード配列を `selectedAgents` state に置換\n  - Line 2081付近（モバイル）: 同上\n- `src/lib/claude-executor.ts` - `ALLOWED_CLI_TOOLS` を全ツール対応に拡張\n\n## 受け入れ基準\n\n- [ ] CMATEタブに「Agent」サブタブが表示される\n- [ ] Agentタブで利用可能なエージェント一覧（claude, codex, gemini, vibe-local）が表示される\n- [ ] ユーザーが2つのエージェントを選択できる\n- [ ] 3つ以上の選択はできない（UIで制御）\n- [ ] 選択状態がWorktree単位で永続化される\n- [ ] ターミナルヘッダーのエージェントタブが選択に応じて動的に切り替わる\n- [ ] デフォルト値は `['claude', 'codex']`（既存動作の維持）\n- [ ] デスクトップ・モバイル両方で正しく動作する\n- [ ] vibe-localのtmuxセッション管理が他ツールと同様に機能する\n\n## 技術的考慮事項\n\n- `CLIToolType` 型に `'vibe-local'` を追加するため、ハイフン付きの文字列リテラルとなる（既存の命名規則を確認）\n- vibe-localはPythonスクリプトのため、tmuxセッション起動コマンドが他ツールと異なる可能性がある\n- `selected_agents` のDBマイグレーションが必要（既存worktreeはデフォルト値を適用）\n- スケジュール実行（`ALLOWED_CLI_TOOLS`）も選択に連動させるか要検討\n\n## 参考\n\n- vibe-local: https://github.com/ochyai/vibe-local\n- 現在のCLIツール定義: `src/lib/cli-tools/types.ts`\n- UIハードコード箇所: `src/components/worktree/WorktreeDetailRefactored.tsx` L1795, L2081\n- CMATEタブ実装: `src/components/worktree/NotesAndLogsPane.tsx`","title":"feat: CMATEタブにAgent設定タブを追加し、表示するコーディングエージェントを選択可能にする"}
