{
  "stage": 2,
  "stage_name": "整合性レビュー",
  "focus_area": "整合性",
  "review_date": "2026-01-30",
  "reviewer": "architecture-review-agent",
  "design_doc_path": "dev-reports/design/issue-95-image-viewer-design-policy.md",
  "findings": {
    "must_fix": [
      {
        "id": "MF-001",
        "category": "型定義整合性",
        "title": "FileContent interfaceのsuccess fieldsの不整合",
        "description": "設計方針書では FileContent interface に `success: boolean` を含めているが、既存の FileViewer.tsx (L18-23) のローカル定義には `success` フィールドが存在しない。API レスポンスと UI コンポーネント間で型の解釈に齟齬が生じる可能性がある。",
        "current_code": {
          "file": "src/components/worktree/FileViewer.tsx",
          "lines": "18-23",
          "content": "interface FileContent {\n  path: string;\n  content: string;\n  extension: string;\n  worktreePath: string;\n}"
        },
        "design_doc_definition": "export interface FileContent {\n  success: boolean;\n  path: string;\n  content: string;\n  extension: string;\n  worktreePath: string;\n  isImage?: boolean;\n  mimeType?: string;\n}",
        "recommendation": "FileContent interface を src/types/models.ts へ移動する際、既存の FileViewer.tsx 側のローカル定義と API レスポンス（route.ts L136-142）の両方を精査し、`success` フィールドの取り扱いを統一する。API レスポンスは wrapper として `{ success: true, ...data }` を返すため、FileContent は data 部分のみを表す型として定義し、success は含めない方が明確。"
      }
    ],
    "should_fix": [
      {
        "id": "SF-001",
        "category": "命名規則整合性",
        "title": "IMAGE_MAX_SIZE_BYTES vs IMAGE_MAX_SIZE_MB の命名不一致",
        "description": "設計方針書内で `IMAGE_MAX_SIZE_BYTES = 5 * 1024 * 1024` と定義しているが、Issue本文では `IMAGE_MAX_SIZE_MB` という設定名を提案している。命名規則の一貫性が欠けている。",
        "design_doc_location": "データモデル設計セクション L122",
        "issue_reference": "Issue #95 セキュリティ考慮事項セクション",
        "recommendation": "既存パターン（editable-extensions.ts の maxFileSize）に合わせて `IMAGE_MAX_SIZE_BYTES` に統一し、Issue本文の記載を設計方針書に合わせて更新する。バイト単位の方が内部処理で直接使用できるため合理的。"
      },
      {
        "id": "SF-002",
        "category": "関数シグネチャ整合性",
        "title": "isImageExtension関数の戻り値型が不明確",
        "description": "設計方針書の isImageExtension() は boolean を返すが、editable-extensions.ts の isEditableExtension() と ContentValidationResult を返す validateContent() という2パターンの関数が存在する。IMAGE_EXTENSION_VALIDATORS を持つなら、validateImageExtension() のような検証関数も必要になる可能性がある。",
        "current_pattern": {
          "file": "src/config/editable-extensions.ts",
          "functions": [
            "isEditableExtension(extension: string): boolean",
            "validateContent(extension: string, content: string): ContentValidationResult"
          ]
        },
        "recommendation": "image-extensions.ts にも同様に isImageExtension() と validateImageContent() の2つの関数を用意することを設計方針書に明記する。validateImageContent() は ContentValidationResult 型を再利用するか、または同等の ImageValidationResult 型を定義する。"
      },
      {
        "id": "SF-003",
        "category": "API レスポンス整合性",
        "title": "extension フィールドの形式不一致",
        "description": "設計方針書の API レスポンス例では `extension: \"png\"` (ドットなし) としているが、IMAGE_EXTENSIONS は `['.png', '.jpg', ...]` (ドット付き) で定義。既存 route.ts (L134) も `extension = relativePath.split('.').pop()` でドットなしを返している。一貫性はあるが、比較時に注意が必要。",
        "recommendation": "isImageExtension() 関数内で `.toLowerCase()` に加えて、ドットの有無を正規化する処理を追加するか、設計方針書にこの変換処理を明記する。例: `const normalizedExt = ext.startsWith('.') ? ext : '.' + ext;`"
      },
      {
        "id": "SF-004",
        "category": "既存コードパターン整合性",
        "title": "ImageExtensionValidator interface と ExtensionValidator interface の重複",
        "description": "設計方針書で新規に ImageExtensionValidator interface を定義しているが、既存の editable-extensions.ts には ExtensionValidator interface が存在する。両者は類似構造だが、magicBytes フィールドなど画像固有の属性がある。",
        "current_interface": {
          "file": "src/config/editable-extensions.ts",
          "lines": "20-27",
          "content": "export interface ExtensionValidator {\n  extension: string;\n  maxFileSize?: number;\n  additionalValidation?: (content: string) => boolean;\n}"
        },
        "recommendation": "共通の基底インターフェースを検討するか、または明確に分離した設計意図をドキュメントに記載する。例: `interface BaseExtensionValidator { extension: string; maxFileSize?: number; }` を共通化し、画像固有・テキスト固有の拡張を行う。"
      }
    ],
    "nice_to_have": [
      {
        "id": "NTH-001",
        "category": "型定義の配置",
        "title": "FileContent を models.ts に移動することの影響確認",
        "description": "設計方針書では FileContent を src/types/models.ts へ移動するとしているが、models.ts は主に DB モデル（Worktree, Repository, ChatMessage 等）を定義している。ファイル操作関連の型は file-operations.ts の FileOperationResult のように別ファイルにあるパターンもある。",
        "recommendation": "FileContent は API レスポンス型であり、DB モデルとは性質が異なる。src/types/api.ts または src/types/file-content.ts のような専用ファイルを検討するか、models.ts に配置する理由を明確にする。"
      },
      {
        "id": "NTH-002",
        "category": "コード参照整合性",
        "title": "ImageViewer props の mimeType 使用箇所",
        "description": "設計方針書の ImageViewerProps には `mimeType?: string` が含まれているが、実装例の ImageViewer コンポーネントでは mimeType を使用していない（props 定義のみで実際の処理なし）。",
        "recommendation": "mimeType を将来的にエラーハンドリングや条件分岐で使用する予定があれば実装例にも反映する。使用予定がなければ props から削除して YAGNI 原則に従う。"
      },
      {
        "id": "NTH-003",
        "category": "テストファイル整合性",
        "title": "単体テストファイルパスの不一致",
        "description": "設計方針書では `tests/unit/config/image-extensions.test.ts` としているが、既存の editable-extensions.ts のテストパスを確認する必要がある。tests/ ディレクトリ構造との整合性を確認すべき。",
        "recommendation": "既存のテストファイル構造（tests/unit/ または src/**/__tests__/）に合わせてパスを統一する。"
      }
    ]
  },
  "consistency_checklist": {
    "issue_vs_design_doc": {
      "status": "mostly_consistent",
      "notes": "Stage 1 レビューで多くの指摘が反映済み。IMAGE_MAX_SIZE の命名のみ軽微な不整合。"
    },
    "design_doc_vs_existing_code": {
      "status": "needs_clarification",
      "notes": "FileContent interface の success フィールドの扱いに不整合。既存パターンとの整合性は概ね良好だが、型定義の配置場所は要検討。"
    },
    "type_definitions": {
      "status": "needs_fix",
      "notes": "FileContent の定義内容が既存ローカル定義と設計方針書で異なる。ImageExtensionValidator と ExtensionValidator の関係性も要整理。"
    },
    "function_signatures": {
      "status": "mostly_consistent",
      "notes": "isImageFile() は isEditableFile() パターンに準拠。検証関数の追加要否を検討。"
    },
    "naming_conventions": {
      "status": "consistent",
      "notes": "既存パターン（editable-extensions.ts, file-operations.ts）の命名規則を踏襲している。"
    }
  },
  "summary": "設計方針書は既存コードパターンとの整合性が概ね保たれているが、FileContent interface の success フィールドの取り扱いに重要な不整合がある（must_fix: 1件）。型定義の移動先、IMAGE_MAX_SIZE の命名統一、検証関数の設計など、実装前に確認・調整すべき点がいくつかある（should_fix: 4件）。全体としては Stage 1 レビューの指摘が適切に反映されており、既存の editable-extensions.ts, file-operations.ts のパターンを踏襲した設計になっている。"
}
