{"body":"## 概要\n\nClaude CLIの応答が完了し `>` プロンプトが表示されているにもかかわらず、サイドバーのステータスがスピナー（`running`）のまま更新されない。\n\n## 再現手順\n\n1. CommandMateでWorktreeを選択し、Claude CLIにメッセージを送信\n2. Claude CLIが応答を完了（`>` プロンプト + セパレータが表示される）\n3. サイドバーのステータスインジケータがスピナーのまま `ready`（緑）に変わらない\n\n## スクリーンショット\n\nターミナル出力では `>` プロンプトが表示されており応答完了しているが、サイドバーはスピナー表示のまま。\n\n## 原因分析\n\n### 根本原因: thinkingインジケータの検出ウィンドウが広すぎる＋thinking検出がプロンプト検出を無条件で上書き\n\n応答完了時のターミナル内容（下から）:\n\n```\n... Thinking / ステータスバー         ← 非空行 -1\nPR #157 · ctrl+t to hide tasks      ← 非空行 -2\n>                                    ← 非空行 -3（プロンプト＝応答完了）\n────────────────────                 ← 非空行 -4~-6（セパレータ）\n✻ Churned for 41s                   ← 非空行 -7（完了済みthinkingインジケータ）\n応答本文...                           ← 非空行 -8~-15\n```\n\n「最後15行（非空行）」のウィンドウには、**完了済みの応答処理で表示されたthinkingインジケータ**（`✻ Churned for 41s…` や `(esc to interrupt)` を含むステータスバー）が含まれてしまう。\n\n`CLAUDE_THINKING_PATTERN` がこれにマッチし、プロンプト（`>`）が存在していてもthinking検出が無条件で優先されるため、`isProcessing = true`（スピナー表示）となる。\n\n### 問題箇所1: サイドバーステータス検出\n\n**ファイル**: `src/app/api/worktrees/route.ts` L66-83\n\n```typescript\n// 空行を除いた最後の15行を検出ウィンドウとして使用\nconst nonEmptyLines = cleanOutput.split('\\n').filter(line => line.trim() !== '');\nconst lastLines = nonEmptyLines.slice(-15).join('\\n');\n\n// thinking検出が無条件で優先 → プロンプトが見えていても上書きされる\nif (detectThinking(cliToolId, lastLines)) {\n    isProcessing = true;   // ← スピナー表示\n} else {\n    const hasInputPrompt = promptPattern.test(lastLines);\n    if (!hasInputPrompt) {\n        isProcessing = true;\n    }\n}\n```\n\n### 問題箇所2: current-output API\n\n**ファイル**: `src/app/api/worktrees/[id]/current-output/route.ts` L72-88\n\n```typescript\nconst nonEmptyLines = lines.map(l => stripAnsi(l)).filter(line => line.trim() !== '');\nconst lastSection = nonEmptyLines.slice(-15).join('\\n');\n\nconst thinking = detectThinkingState(cliToolId, lastSection);\n\n// thinking=trueの場合、プロンプト検出が完全にスキップされる（Issue #161対策の副作用）\nconst promptDetection = thinking\n    ? { isPrompt: false, cleanContent: cleanOutput }\n    : detectPrompt(cleanOutput);\n\nreturn NextResponse.json({\n    isGenerating: thinking,  // ← UIにthinking状態として伝達\n});\n```\n\n### レスポンスポーラーとの検出ウィンドウの不整合\n\n| 検出箇所 | ウィンドウ | 結果 |\n|----------|-----------|------|\n| `response-poller.ts` `extractResponse()` | 最後20行（空行含むraw行） | 応答完了を正しく検出 ✅ |\n| `worktrees/route.ts` サイドバー | 最後15行（非空行のみ） | thinkingを誤検出 ❌ |\n| `current-output/route.ts` | 最後15行（非空行のみ） | thinkingを誤検出 ❌ |\n\nレスポンスポーラーは「最後20 raw行」を検査するため、thinkingインジケータが20行以上前にあれば正しく完了検出する。一方、サイドバーとcurrent-outputは「最後15 非空行」のため、空行をスキップした結果より広い範囲を検査し、完了済みのthinkingインジケータが含まれてしまう。\n\n## 問題点の一覧\n\n| 優先度 | 問題 | ファイル |\n|--------|------|----------|\n| **P0** | thinking検出がプロンプト検出を無条件で上書き（プロンプトが見えていてもthinkingが優先） | `worktrees/route.ts` L69-83 |\n| **P0** | thinking検出ウィンドウ（非空行15行）が広すぎ、完了済み応答のthinkingインジケータを含む | `worktrees/route.ts` L67-68, `current-output/route.ts` L72-74 |\n| **P1** | `current-output` でthinking=trueの場合プロンプト検出が完全スキップ（Issue #161対策の副作用） | `current-output/route.ts` L88 |\n| **P1** | レスポンスポーラー（raw 20行）とステータス検出（非空行15行）のウィンドウ方式不整合 | 両ファイル |\n| **P2** | `claude-poller.ts`（レガシー）のthinkingパターンがスピナー文字の存在のみでマッチし誤検出しやすい | `claude-poller.ts` L76 |\n\n## 改善案\n\n| 優先度 | 対策 | 対象ファイル |\n|--------|------|-------------|\n| **P0** | プロンプト+セパレータ検出時はthinkingインジケータが同時存在しても「応答完了」と判定 | `worktrees/route.ts`, `current-output/route.ts` |\n| **P0** | thinking検出ウィンドウを縮小（非空行15行 → raw行で最後5行程度に限定） | 同上 |\n| **P1** | Issue #161対策を維持しつつ、プロンプト+セパレータ共存時はプロンプト検出を許可 | `current-output/route.ts` |\n| **P1** | レスポンスポーラーとステータス検出のウィンドウ方式を統一 | 全ポーラー・ステータス検出 |\n| **P2** | レガシー `claude-poller.ts` のthinkingパターンを `CLAUDE_THINKING_PATTERN` に統一 | `claude-poller.ts` |\n\n## 関連\n\n- Issue #161（Auto-Yes誤検出修正）- thinking優先のロジックが導入された経緯\n- Issue #31（サイドバーのUX改善）- ステータスインジケータの元実装\n- Issue #4（CLIツールサポート）- CLI別ステータス検出の実装\n- `src/lib/cli-patterns.ts` - `CLAUDE_THINKING_PATTERN` 定義","title":"fix: 応答完了後もスピナーが表示され続ける（thinkingインジケータの誤検出）"}
