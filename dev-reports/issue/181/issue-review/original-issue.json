{"body":"## 問題概要\n\nClaude CLIのmultiple choiceプロンプトで、オプションのテキストが長く複数行にまたがる場合、プロンプトとして検出されず、UIにyes/noメッセージとして表示されない。\n\n## 再現手順\n\n1. Claude CLIで長いパスを含むコマンド実行の確認プロンプトを表示させる\n2. 例: `curl`や`python3`コマンドの実行許可プロンプト\n3. オプション2のテキストが長く、ターミナル幅で折り返される状態\n\n## 期待される動作\n\n3択プロンプト（Yes / Yes, and don't ask again... / No）がUIにプロンプトメッセージとして表示され、ボタンで回答できる。\n\n## 実際の動作\n\nプロンプトが検出されず、ターミナル出力としてのみ表示される。Auto-Yesも動作しない。\n\n## スクリーンショット\n\nターミナル出力:\n```\nDo you want to proceed?\n❯ 1. Yes\n  2. Yes, and don't ask again for curl and python3 commands in\n/Users/maenokota/share/work/github_kewton/comma\nndmate-issue-161\n  3. No\n\nEsc to cancel · Tab to amend · ctrl+e to explain\n```\n\nオプション2の長いパスが複数行に折り返されている。\n\n## 根本原因\n\n`src/lib/prompt-detector.ts` の `detectMultipleChoicePrompt()` 関数で、継続行の検出が不十分。\n\n### 検出アルゴリズムの問題\n\nアルゴリズムは末尾から逆順にスキャンする:\n\n1. `  3. No` → オプション3として検出 ✓\n2. `ndmate-issue-161` → **継続行として認識されない** ✗\n3. スキャン中断、オプション1・2は検出されない\n\n### 継続行検出の制限（line 293-295）\n\n```typescript\nconst hasLeadingSpaces = rawLine.match(/^\\s{2,}[^\\d]/) && !rawLine.match(/^\\s*\\d+\\./);\nconst isShortFragment = line.length < 5 && !line.endsWith('?');\nconst isContinuationLine = hasLeadingSpaces || isShortFragment;\n```\n\n現在の検出条件:\n- 2文字以上の先頭スペースがある、または\n- 5文字未満の短い行\n\n**不足している条件:**\n- パス継続（`/`で始まる行）\n- ファイル名の断片（英数字のみで構成される行）\n- 長い行が折り返された場合の一般的なパターン\n\n### 結果\n\n```typescript\noptions = [{number: 3, label: \"No\", isDefault: false}]\nisConsecutiveFromOne([3]) → false  // 1から始まっていない\n→ isPrompt: false  // プロンプトとして認識されない\n```\n\n## 修正案\n\n継続行の検出条件を拡張:\n\n```typescript\n// 現在\nconst isContinuationLine = hasLeadingSpaces || isShortFragment;\n\n// 修正案\nconst isPathContinuation = /^[\\/~]/.test(line) || /^[a-zA-Z0-9_-]+$/.test(line);\nconst isContinuationLine = hasLeadingSpaces || isShortFragment || isPathContinuation;\n```\n\nまたは、より堅牢なアプローチ:\n- オプション番号パターン (`^\\s*\\d+\\.`) に一致しない行はすべて継続行として扱う\n- ただし、質問文の検出ロジックとの兼ね合いに注意\n\n## 影響範囲\n\n- `src/lib/prompt-detector.ts` - `detectMultipleChoicePrompt()` 関数\n- Auto-Yes機能（プロンプト検出に依存）\n- UIのプロンプト表示機能\n\n## 関連Issue\n\n- #180 (ステータス表示の不整合 - 同じく検出ロジックの問題)","title":"fix: 複数行オプションを含むmultiple choiceプロンプトが検出されない"}
