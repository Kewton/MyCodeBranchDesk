{
  "stage": 3,
  "stage_name": "影響分析レビュー",
  "apply_date": "2026-01-30",
  "status": "completed",
  "design_doc_path": "dev-reports/design/issue-95-image-viewer-design-policy.md",
  "applied_findings": {
    "must_fix": [
      {
        "id": "MF-001",
        "title": "GET APIレスポンスの拡張による既存クライアントへの影響",
        "action": "Stage 2で既に対応済み。実装前確認事項としてFileContent型参照箇所のGrep確認を追加。"
      }
    ],
    "should_fix": [
      {
        "id": "SF-001",
        "title": "file-operations.ts への isImageFile() 追加による責務の問題",
        "action": "設計変更: isImageExtension() を src/config/image-extensions.ts に配置。editable-extensions.ts の isEditableExtension() パターンを踏襲。レイヤー構成、影響ファイル一覧、実装タスクを更新。"
      },
      {
        "id": "SF-002",
        "title": "既存 API テストへの影響確認が必要",
        "action": "実装前チェック項目を追加: tests/integration/api-file-operations.test.ts の内容確認、オプショナルフィールド追加による影響検証。"
      },
      {
        "id": "SF-003",
        "title": "FileViewer の責務拡大への懸念",
        "action": "将来の検討事項 NTH-004 として FileViewerFactory / Strategy パターンへの移行を追加。"
      },
      {
        "id": "SF-004",
        "title": "WorktreeDetailRefactored の handleFileSelect との連携",
        "action": "handleFileSelect の画像ファイル取り扱いフローをコメントで明記することを実装タスクに追加。E2E テストで一連のフローをテストすることを明記。"
      }
    ],
    "nice_to_have": [
      {
        "id": "NTH-001",
        "title": "uploadable-extensions.ts との設計パターン統一",
        "action": "将来の検討事項 NTH-005 として画像拡張子の共通定数化を追加。"
      },
      {
        "id": "NTH-002",
        "title": "テストファイル配置の既存パターン踏襲",
        "action": "Stage 1 の NTH-003 と同様。既存パターン踏襲で問題なし。"
      },
      {
        "id": "NTH-003",
        "title": "画像読み込みエラー時の route.ts エラーコード追加",
        "action": "既存エラーコード（INVALID_MAGIC_BYTES, FILE_TOO_LARGE）の活用を実装タスク Phase 2 に明記。"
      }
    ]
  },
  "design_doc_changes": [
    {
      "section": "レイヤー構成",
      "change": "file-operations.ts を削除、image-extensions.ts に isImageExtension() を配置する旨を追記"
    },
    {
      "section": "影響ファイル一覧",
      "change": "file-operations.ts を削除、image-extensions.ts の説明を更新、影響確認が必要なテストセクションを追加"
    },
    {
      "section": "実装タスク",
      "change": "事前確認フェーズを追加、Phase 1 から isImageFile() を削除し isImageExtension() を image-extensions.ts に配置、Phase 2-4 に Stage 3 指摘事項を反映"
    },
    {
      "section": "実装チェックリスト",
      "change": "実装前確認事項セクションを追加、各 Phase に Stage 3 指摘事項を反映"
    },
    {
      "section": "レビュー指摘対応",
      "change": "Stage 3: 影響分析レビューセクションを追加（must_fix 1件、should_fix 4件、nice_to_have 3件）"
    },
    {
      "section": "将来の検討事項",
      "change": "NTH-004（FileViewerFactory パターン）、NTH-005（画像拡張子の共通定数化）を追加"
    }
  ],
  "summary": "Stage 3 影響分析レビューの指摘事項を設計方針書に反映完了。主な変更点: (1) isImageExtension() の配置場所を file-operations.ts から image-extensions.ts に変更（SF-001）、(2) 実装前確認事項の追加（SF-002）、(3) 将来の検討事項として FileViewerFactory パターンと画像拡張子共通定数化を追加（SF-003, NTH-001）、(4) E2E テストの一連フロー確認を明記（SF-004）。後方互換性は維持され、影響範囲は最小限に抑えられている。"
}
