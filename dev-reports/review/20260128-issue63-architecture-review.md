# Issue #63 アーキテクチャレビュー

**対象**: `dev-reports/design/issue-63-auto-yes-warning-design-policy.md`
**日時**: 2026-01-28
**レビュアー**: Claude Code

---

## 1. 設計原則の遵守確認

### SOLID原則

| 原則 | 判定 | 根拠 |
|------|------|------|
| **Single Responsibility** | OK | `AutoYesConfirmDialog`は確認UIのみ、`AutoYesToggle`はトグル操作＋確認フロー制御。責務は妥当 |
| **Open/Closed** | OK | 新規コンポーネント追加で対応。既存の`Modal`・API・サーバーロジックは変更不要 |
| **Liskov Substitution** | N/A | 継承を使用していない |
| **Interface Segregation** | OK | `AutoYesConfirmDialogProps`は`isOpen`/`onConfirm`/`onCancel`の3つのみで最小限 |
| **Dependency Inversion** | OK | `AutoYesConfirmDialog`は既存`Modal`に依存するが、UIコンポーネントの合成として適切 |

### その他の原則

| 原則 | 判定 | 根拠 |
|------|------|------|
| **KISS** | OK | ダイアログ表示→同意→有効化という単純なフロー。過剰な抽象化がない |
| **YAGNI** | OK | 同意記憶機能やカスタマイズ機能を入れていない。必要最小限の設計 |
| **DRY** | OK | 既存`Modal`を再利用。ダイアログ基盤の重複実装を回避 |

---

## 2. アーキテクチャ評価

### 構造的品質

| 評価項目 | スコア(1-5) | コメント |
|---------|------------|----------|
| モジュール性 | 5 | 新規コンポーネント1つ＋既存1ファイル修正のみ。独立性が高い |
| 結合度 | 5 | `AutoYesConfirmDialog`→`Modal`の依存のみ。親への影響なし |
| 凝集度 | 4 | `AutoYesToggle`にダイアログ状態管理が加わるが、ON操作の確認という関連性のある責務 |
| 拡張性 | 4 | 警告内容の変更は`AutoYesConfirmDialog`内で完結する |
| 保守性 | 5 | 影響範囲が2ファイルに閉じており、変更時の認知負荷が低い |

### パフォーマンス観点

問題なし。ダイアログは`isOpen`がfalseのとき`Modal`内部で`return null`されるため、DOM上にコストを発生させない（`Modal.tsx:64`）。

---

## 3. セキュリティレビュー

| 観点 | 判定 | 根拠 |
|------|------|------|
| XSS | OK | ダイアログ内容は静的テキストのみ。ユーザー入力を表示しない |
| クリックジャッキング | OK | `Modal`の`z-50`と背景オーバーレイにより保護されている |
| CSRF | N/A | 本変更ではAPIリクエストを追加しない |

**補足**: 本Issueはフロントエンドの確認UIであり、サーバー側のセキュリティ境界には変更がない。auto yesモード自体のセキュリティリスク（CLIツールへの自動応答）は#61の設計範囲であり、本Issueはそのリスクをユーザーに認知させる改善。

---

## 4. 既存システムとの整合性

### 統合ポイント

| ポイント | 判定 | 根拠 |
|---------|------|------|
| `Modal`コンポーネントとの整合 | OK | `ModalProps`のインターフェースをそのまま利用。`size="sm"`、`showCloseButton=false`は既存APIで対応可能 |
| `AutoYesToggle`のProps | OK | `AutoYesToggleProps`に変更なし。親コンポーネントの呼び出しコードは一切変更不要 |
| APIとの整合 | OK | `onToggle(true)`の呼び出しタイミングがダイアログ同意後に変わるだけで、API呼び出し自体は同一 |

### z-indexの競合確認

`Modal`は`z-50`を使用。`AutoYesToggle`はモバイルで`z-30`のコンテナ内に配置されている（`WorktreeDetailRefactored.tsx:1241`）。`Modal`が上に表示されるため問題なし。

---

## 5. リスク評価

| リスク種別 | 内容 | 影響度 | 発生確率 | 対策 |
|-----------|------|-------|---------|------|
| 技術的 | `Modal`のbackdropクリックでEscape同時発火しonCancelが2回呼ばれる | 低 | 低 | `setShowConfirmDialog(false)`が冪等なため実害なし |
| UX | ダイアログ表示によりON操作が1ステップ増加 | 低 | 確定 | 安全性とのトレードオフとして許容。Issueで合意済み |
| 運用 | 免責文言の法的妥当性 | 中 | 中 | PRレビュー時に確定する方針は妥当。必要なら法務確認 |

---

## 6. 改善提案

### 必須改善項目（Must Fix）

なし。設計に重大な問題は検出されなかった。

### 推奨改善項目（Should Fix）

**S1. `showCloseButton: false`ではなく`true`を推奨**

設計書では`showCloseButton: false`（アクションボタンで閉じる設計）としているが、既存`Modal`の挙動として背景クリックとEscapeキーでは`onClose`（＝キャンセル）が発火する。閉じるボタンを非表示にしても背景クリック/Escapeで閉じられるため、ユーザーにとっては「Xボタンがないのに閉じられる」という不整合が生じる。

**提案**: `showCloseButton: true`にして、Xボタン・背景クリック・Escapeすべてをキャンセル動作として統一する。これにより操作の一貫性が向上する。

### 検討事項（Consider）

**C1. トグルON時の色を警告色に変更する検討**

現在のトグルON色は`bg-blue-600`（通常のアクティブ色）。auto yesモードのリスクを視覚的に表現するため、ON状態で`bg-yellow-600`や`bg-orange-500`にする案がある。ただしこれは#63のスコープ外であり、別Issueとして検討すべき。

---

## 7. ベストプラクティスとの比較

### 確認ダイアログの設計パターン

本設計は「破壊的操作の前に確認を挟む」という一般的なUXパターンに沿っている。

| パターン | 本設計での適用 |
|---------|--------------|
| 明示的な同意ボタン | 「同意して有効化」ボタンで適用済み |
| リスクの具体的説明 | ファイル操作・コマンド実行への自動許可を明記 |
| キャンセルのデフォルト化 | 背景クリック・Escapeがキャンセルとして機能 |
| 操作の可逆性の提示 | 1時間タイムアウトと手動OFFが可能であることを表示 |

---

## 8. 総合評価

### レビューサマリ

- **全体評価**: 4.5 / 5
- **強み**:
  - 影響範囲が2ファイルに閉じた最小設計
  - 既存`Modal`の再利用によるUI一貫性と実装効率
  - 親コンポーネント・API・サーバー側に変更不要
  - 設計判断ごとに代替案との比較が明記されている
- **弱み**:
  - `showCloseButton`の設定に軽微な不整合がある（S1参照）

### 承認判定

**条件付き承認（Conditionally Approved）**

条件: S1（`showCloseButton`の設定）をPR実装時に反映すること。

### 次のステップ

1. S1の反映を設計書に追記
2. 実装着手（`/tdd-impl`または`/pm-auto-dev`で実行可能）
3. PR作成時に免責文言を確定
