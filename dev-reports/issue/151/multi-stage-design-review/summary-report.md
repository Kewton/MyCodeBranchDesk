# マルチステージ設計レビュー完了報告

## Issue #151: worktree-cleanup サーバー検出機能改善

### レビュー日時
- 完了: 2026-02-04

---

## ステージ別結果

| Stage | レビュー種別 | フォーカス | 指摘数 | 対応数 | ステータス |
|-------|------------|----------|-------|-------|----------|
| 1 | 通常レビュー | 設計原則 | MF:1, SF:3, NTH:3 | 4件 | ✅ |
| 2 | 整合性レビュー | 整合性 | MF:2, SF:4, NTH:3 | 6件 | ✅ |
| 3 | 影響分析レビュー | 影響範囲 | MF:1, SF:3, NTH:2 | 4件 | ✅ |
| 4 | セキュリティレビュー | セキュリティ | MF:1, SF:4, NTH:3 | 5件 | ✅ |

---

## 統計

- **総指摘数**: 30件
- **設計方針書反映**: 19件
- **スキップ（Nice to Have）**: 11件

---

## 主な改善点

### Stage 1: 設計原則レビュー

| ID | 原則 | 改善内容 |
|----|------|---------|
| MF-DRY-001 | DRY | 共通validators.sh導入によるIssue番号検証の一元化 |
| SF-SRP-001 | SRP | stop_server_by_port()の責務分離（5関数に分割） |
| SF-KISS-001 | KISS | ポート算出ロジックの不整合を文書化、両方式検出に対応 |
| SF-DRY-002 | DRY | process-utils.sh導入によるOS判定ロジックの再利用化 |

### Stage 2: 整合性レビュー

| ID | 改善内容 |
|----|---------|
| MF-CONS-001 | Issue番号検証範囲を既存コード（MAX_ISSUE_NO=2147483647）と整合 |
| MF-CONS-002 | port-allocator.tsとworktree-setup.mdのポート算出ロジック差異を文書化 |
| SF-CONS-001 | .claude/lib/ディレクトリ新規作成を明記 |
| SF-CONS-002 | エラーハンドリング表の文言修正を明記 |
| SF-CONS-003 | 待機時間を2秒から3秒に統一 |
| SF-CONS-004 | port-allocator.tsとの将来的な統一を検討事項に追加 |

### Stage 3: 影響分析レビュー

| ID | 改善内容 |
|----|---------|
| MF-IMP-001 | 新規作成ファイル（validators.sh, process-utils.sh）を影響範囲に追加 |
| SF-IMP-001 | CLAUDE.mdドキュメント影響を追加 |
| SF-IMP-002 | ポート算出ロジックの境界値テスト（Issue #99）を追加 |
| SF-IMP-003 | `commandmate stop --issue`と`/worktree-cleanup`の機能分担を明確化 |

### Stage 4: セキュリティレビュー

| ID | 改善内容 |
|----|---------|
| MF-SEC-001 | lsof出力解析をスペース含むパス対応（`lsof -F n`形式）に修正 |
| SF-SEC-001 | プロセスコマンド検証（node/npm）を追加 |
| SF-SEC-002 | セキュリティ監査ログ（~/.commandmate/logs/security.log）を追加 |
| SF-SEC-003 | プロセス所有者検証を追加 |
| SF-SEC-004 | TOCTOUレース条件の認識と許容根拠を文書化 |

---

## セキュリティ対策一覧（最終版）

| ID | 対策 | 説明 |
|----|------|------|
| SEC-001 | Issue番号検証 | 正の整数、1-2147483647範囲 |
| SEC-002 | パス検証 | `~/.commandmate/`内のみ許可 |
| SEC-003 | cwd検証 | Worktreeパスとマッチング（誤停止防止） |
| SEC-004 | 権限制限 | 現在ユーザーのプロセスのみ |
| SEC-005 | インジェクション防止 | ポート番号は整数検証済み |
| SEC-006 | 監査ログ | プロセス終了イベントをログ記録 |
| SEC-007 | コマンド検証 | node/npmプロセスのみ対象 |
| SEC-008 | TOCTOU認識 | 最小限のレース条件ウィンドウを許容 |

---

## 設計方針書の構造（最終版）

```
issue-151-worktree-cleanup-server-detection-design-policy.md
├── 1. 概要
├── 2. 設計原則（SOLID/KISS/YAGNI/DRY）
├── 3. アーキテクチャ設計
│   ├── 3.1 コンポーネント構成
│   ├── 3.2 フロー図
│   └── 3.3 OS互換性（lsof -F n対応）
├── 4. 詳細設計
│   ├── 4.1 検出対象ポート
│   ├── 4.2 Issue専用ポートの桁数制限
│   └── 4.3 関数設計（7関数）
├── 5. セキュリティ設計
│   ├── 5.1 対策一覧（8項目）
│   ├── 5.2 cwd検証の重要性
│   └── 5.3 TOCTOUレース条件認識
├── 6. 影響範囲
│   ├── 6.1 変更対象ファイル（4ファイル）
│   ├── 6.2 関連ドキュメント影響
│   ├── 6.3 CLIコマンドとの機能分担
│   └── 6.4 後方互換性
├── 7. テスト計画（10項目）
├── 8. 実装チェックリスト
├── 9. レビュー指摘対応サマリー
├── 10. 将来検討事項
└── 11. 参考資料
```

---

## 変更対象ファイル一覧

| ファイル | 変更内容 | 規模 |
|---------|---------|------|
| `.claude/commands/worktree-cleanup.md` | Phase 1修正、Phase 2拡張 | 約60-80行追加 |
| `.claude/commands/worktree-setup.md` | Phase 1検証範囲修正 | 約2行修正 |
| `.claude/lib/validators.sh` | Issue番号検証関数（新規作成） | 約15行 |
| `.claude/lib/process-utils.sh` | プロセス関連関数（新規作成） | 約30行 |

---

## 次のアクション

- [ ] 設計方針書の最終確認
- [ ] 実装開始（/tdd-impl または /pm-auto-dev）
- [ ] CLAUDE.md更新（実装完了後）

---

## 関連ファイル

### レビュー結果
- Stage 1: `dev-reports/issue/151/multi-stage-design-review/stage1-review-result.json`
- Stage 2: `dev-reports/issue/151/multi-stage-design-review/stage2-review-result.json`
- Stage 3: `dev-reports/issue/151/multi-stage-design-review/stage3-review-result.json`
- Stage 4: `dev-reports/issue/151/multi-stage-design-review/stage4-review-result.json`

### 反映結果
- Stage 1: `dev-reports/issue/151/multi-stage-design-review/stage1-apply-result.json`
- Stage 2: `dev-reports/issue/151/multi-stage-design-review/stage2-apply-result.json`
- Stage 3: `dev-reports/issue/151/multi-stage-design-review/stage3-apply-result.json`
- Stage 4: `dev-reports/issue/151/multi-stage-design-review/stage4-apply-result.json`

### 設計方針書
- `dev-reports/design/issue-151-worktree-cleanup-server-detection-design-policy.md`

---

*Generated by multi-stage-design-review command*
