{"body":"## 概要\n\nトップ画面にて登録済みのリポジトリをUIから削除しても、Sync All実行時に再スキャンされ復活してしまう。\n\n## 再現手順\n\n1. `WORKTREE_REPOS` 環境変数に複数のリポジトリパスを設定（例: `/repo1,/repo2`）\n2. CommandMateを起動し、トップ画面で登録済みリポジトリを確認\n3. UIからリポジトリの1つを削除（確認ダイアログで \"delete\" を入力）\n4. 削除完了を確認（UIから消える）\n5. Sync Allボタンを押す\n6. 削除したはずのリポジトリが再表示される\n\n## 期待する動作\n\nUIで削除したリポジトリは、Sync All実行時にも復活せず、削除状態が維持される。\n\n## 実際の動作\n\nUIで削除したリポジトリが、Sync All実行時に再スキャン・再登録されて復活する。\n\n## スクリーンショット\n\n削除前\n\n<img width=\"1920\" height=\"1080\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/256fdeb9-26c4-4c19-a0b4-a1fae3c2ba89\" />\n\n削除後\n\n<img width=\"1920\" height=\"1080\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/f3674497-b050-4d34-8f58-adfdd6cc8475\" />\n\nsync all後\n\n<img width=\"1920\" height=\"1080\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/8f9922e2-2885-4245-87f3-34e6fd539526\" />\n\n## 根本原因の仮説\n\n`syncWorktreesToDB()`は環境変数（`WORKTREE_REPOS`/`CM_ROOT_DIR`）で設定されたパスを毎回スキャンし、見つかったworktreeをDBにupsertする。削除されたリポジトリを記録・除外する仕組みがないため、ディスク上に存在する限り再登録される。\n\n### 処理フロー\n\n```\nT1: 初期状態 - repo1, repo2 がDBに登録済み（WORKTREE_REPOS=\"/repo1,/repo2\"）\nT2: ユーザーがUIからrepo1を削除 → DBからrepo1のworktreesが物理削除される\nT3: Sync All実行 → WORKTREE_REPOS=\"/repo1,/repo2\" を読み込み → repo1を再スキャン → upsertで復活\n```\n\n### 既存の対応（不十分）\n\n`WorktreeList.tsx`に環境変数設定リポジトリの削除時に警告表示があるが、復活を防ぐメカニズムは未実装。\n\n## 対策案\n\n### 除外リスト方式\n\n削除したリポジトリパスをDBに記録し、Sync All時にスキャン対象から除外する。\n\n1. **excluded_repositories テーブル新設**（または worktrees テーブルにフラグ追加）\n   - `repository_path` と `excluded_at` を記録\n2. **syncWorktreesToDB() 修正**\n   - スキャン前に除外リストを取得\n   - 除外リストに含まれるリポジトリパスをスキャン対象から除外\n3. **DELETE /api/repositories 修正**\n   - リポジトリ削除時に除外リストへ追加\n\n## 実装タスク\n\n- [ ] DBマイグレーション: 除外リスト用テーブル（または既存テーブルへのカラム追加）\n- [ ] `src/lib/db.ts`: 除外リスト操作関数（追加・取得・削除）\n- [ ] `src/lib/worktrees.ts`: `syncWorktreesToDB()`に除外リスト参照ロジック追加\n- [ ] `src/app/api/repositories/route.ts`: DELETE時に除外リストへ記録\n- [ ] ユニットテスト: 除外リスト方式の動作検証（複数リポジトリ削除+Sync Allシナリオ）\n- [ ] 既存テスト: `worktrees-sync.test.ts`に除外リスト連携テスト追加\n\n## 受入条件\n\n- [ ] UIで削除したリポジトリがSync Allで復活しないこと\n- [ ] 環境変数に設定されたリポジトリでも除外が有効であること\n- [ ] 複数リポジトリの一部削除→Sync Allで未削除リポジトリは正常同期されること\n- [ ] ユニットテストが追加されていること（複数リポジトリ削除+Sync Allシナリオ）\n- [ ] 既存テストがすべてパスすること\n\n## 影響範囲\n\n### 変更対象ファイル\n\n| ファイル | 変更内容 |\n|---------|---------|\n| `src/lib/db-migrations.ts` | 除外リスト用テーブル/カラムのマイグレーション追加 |\n| `src/lib/db.ts` | 除外リスト操作関数（追加・取得）追加 |\n| `src/lib/worktrees.ts` | `syncWorktreesToDB()`に除外リスト参照ロジック追加 |\n| `src/app/api/repositories/route.ts` | DELETE時に除外リストへ記録 |\n| `src/lib/__tests__/worktrees-sync.test.ts` | 除外リスト連携テスト追加 |\n\n### 関連コンポーネント\n\n- `src/components/worktree/WorktreeList.tsx` - 削除確認ダイアログ（既存の警告メッセージ更新の可能性）\n- `src/app/api/repositories/sync/route.ts` - Sync All APIエンドポイント\n- `src/lib/db-repository.ts` - リポジトリDB操作関数群","title":"トップ画面にて登録済みのリポジトリを削除してもsyncallで復活する"}