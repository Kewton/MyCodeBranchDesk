{
  "issue_number": 163,
  "focus_area": "セキュリティ",
  "stage": "Stage 4 - セキュリティレビュー",
  "status": "conditionally_approved",
  "score": 4,
  "findings": {
    "must_fix": [
      {
        "id": "SEC-MF-001",
        "category": "A03:2021 Injection",
        "title": "printf '%s' の引数内での % 文字のエスケープ不要理由の明記",
        "severity": "low",
        "description": "設計書4.1項のエスケープ処理で $, \", \\, ` の4種をエスケープしているが、% 文字のエスケープ方針が記載されていない。技術的には printf '%s' の引数として渡されるためフォーマット指定子として解釈されることはなく、リスクは極めて低い。しかしレビュー担当者が見落としでないことを確認できるよう、設計書に不要理由を明記すべき。",
        "recommendation": "設計書SEC-001に「%文字はprintf '%s'の引数として渡されるためフォーマット指定子として解釈されず、エスケープ不要」と注記を追加する。"
      }
    ],
    "should_fix": [
      {
        "id": "SEC-SF-001",
        "category": "A03:2021 Injection",
        "title": "制御文字（\\x01-\\x1f）のフィルタリング方針不足",
        "severity": "low",
        "description": "SEC-004でNULバイト（\\0）の除去は明記されているが、その他の制御文字（\\x01-\\x1f, \\x7f）について方針が明記されていない。特に \\r（CR, 0x0D）はターミナル上で行頭復帰を引き起こし表示を改竄する可能性がある（Terminal Injection類似）。\\x08（Backspace）も表示上の文字上書きに使用される可能性がある。ただし、ユーザーが意図的にCLIツールに制御文字を含むメッセージを送信するケースは通常運用で想定されず、リスクは低い。",
        "recommendation": "NUL以外の危険な制御文字（最低限 \\r, \\x08, \\x7f）も除去するか、設計書に「ユーザー入力メッセージに制御文字（改行を除く）が含まれることは想定外であり、除去対象は\\0のみとする」旨を明記する。"
      },
      {
        "id": "SEC-SF-002",
        "category": "A04:2021 Insecure Design",
        "title": "セッション名の安全性前提の明記",
        "severity": "low",
        "description": "sendTextViaBuffer()ではバッファ名のサニタイズ（SEC-002）が行われるが、tmux paste-buffer -t \"${sessionName}\" のセッション名に対するインジェクション対策の記載がない。既存のsendKeys()（tmux.ts 216行目）でも同じ -t \"${sessionName}\" パターンを使用しており、新規リスクの追加はない。sessionNameはgetSessionName()で 'mcbd-{cliToolId}-{worktreeId}' として生成され、worktreeIdはDB由来のUUID形式であるため、ダブルクォートを含む可能性は極めて低い。ただし、この安全性前提を設計書に明記すべき。",
        "recommendation": "設計書SEC-001またはSEC-002に「sessionNameはgetSessionName()経由で生成されるDB由来のworktreeIdを使用し、シェル特殊文字を含まない前提。既存sendKeys()と同一のリスクレベル」と注記する。"
      },
      {
        "id": "SEC-SF-003",
        "category": "A04:2021 Insecure Design",
        "title": "プロセスクラッシュ時のバッファ残留リスクの明記",
        "severity": "low",
        "description": "SEC-003でpaste-buffer -dによる正常時の自動削除とエラー時のdelete-bufferフォールバックが記載されているが、load-buffer成功後にNode.jsプロセスがクラッシュした場合、paste-bufferもdelete-bufferも実行されずバッファが残留する。tmuxバッファはtmuxサーバープロセスのメモリ上に存在し、tmuxサーバーが再起動されるまで残留する。メッセージ内容はCLIツールへの指示であり機密情報リスクは低いが、シナリオを明記すべき。",
        "recommendation": "設計書SEC-003に「プロセスクラッシュ時のバッファ残留リスク」シナリオを追加し、「メッセージ内容はCLIツールへの指示であり機密情報リスクは低い。tmuxサーバー再起動またはtmux delete-buffer手動実行で解消可能」と注記する。"
      }
    ],
    "consider": [
      {
        "id": "SEC-CS-001",
        "category": "A03:2021 Injection",
        "title": "execFile()/spawn方式への移行による根本的インジェクション対策",
        "severity": "info",
        "description": "設計書4.3項（SF-001）でexecFile()方式への改善可能性が既に言及されている。execFile()またはspawn()でstdinパイプを使用すれば、シェルを経由しないためエスケープ処理が不要になり、SEC-001のコマンドインジェクション対策が根本的に解決される。現在の設計ではexecAsync()（内部でexec()を使用、shell: trueがデフォルト）経由のためシェルインタープリタが介在する。この点は設計書で適切に認識・記載されている。",
        "recommendation": "現行設計の範囲では対応不要。将来Issueとして別途追跡する。"
      },
      {
        "id": "SEC-CS-002",
        "category": "A04:2021 Insecure Design",
        "title": "バッファ名の並行アクセスによるレースコンディション",
        "severity": "info",
        "description": "CS-003で既に認識されている。同一セッションに対して並行してsendTextViaBuffer()が呼ばれた場合、同じバッファ名が使用されレースコンディションが発生する。セキュリティ観点では、攻撃者がタイミングを狙ってバッファ内容を差し替えるシナリオは現行のアーキテクチャ（ローカルサーバー）では非現実的。",
        "recommendation": "現行設計の範囲では対応不要。CS-003として適切に管理されている。"
      },
      {
        "id": "SEC-CS-003",
        "category": "A03:2021 Injection",
        "title": "シングルクォートのエスケープ不要確認",
        "severity": "info",
        "description": "設計書ではprintf '%s' \"${escapedText}\"のようにダブルクォート内にエスケープ済みテキストを配置する。シングルクォートはダブルクォート内では特別な意味を持たないため、エスケープは不要。この判断は正しい。",
        "recommendation": "対応不要。"
      }
    ]
  },
  "security_checklist": {
    "owasp_top_10": {
      "A01_broken_access_control": {
        "status": "not_applicable",
        "note": "sendTextViaBuffer()はサーバー内部関数。APIアクセス制御は既存のルートハンドラで担保。"
      },
      "A02_cryptographic_failures": {
        "status": "not_applicable",
        "note": "暗号化関連の処理なし。"
      },
      "A03_injection": {
        "status": "pass_with_notes",
        "note": "4種エスケープ（\\, $, \", `）+NULバイト除去でシェルインジェクション対策。バッファ名サニタイズ（SEC-002）でバッファ名インジェクション対策。制御文字フィルタリング方針の明記（SEC-SF-001）と%文字の注記（SEC-MF-001）を推奨。"
      },
      "A04_insecure_design": {
        "status": "pass_with_notes",
        "note": "バッファ経由方式は適切な設計。セッション名の前提条件の明記（SEC-SF-002）とバッファ残留シナリオの明記（SEC-SF-003）を推奨。"
      },
      "A05_security_misconfiguration": {
        "status": "pass",
        "note": "tmuxバッファの-dフラグによる自動削除、エラー時のクリーンアップが適切に設計されている。"
      },
      "A06_vulnerable_components": {
        "status": "not_applicable",
        "note": "外部ライブラリの新規追加なし。"
      },
      "A07_auth_failures": {
        "status": "not_applicable",
        "note": "認証関連の変更なし。"
      },
      "A08_data_integrity": {
        "status": "pass",
        "note": "バッファ経由のデータ完全性はtmuxが保証。エスケープ処理の順序が適切に設計されている（\\を最初にエスケープして二重エスケープ防止）。"
      },
      "A09_logging_monitoring": {
        "status": "pass",
        "note": "既存のconsole.logによるメッセージ送信ログが維持される。"
      },
      "A10_ssrf": {
        "status": "not_applicable",
        "note": "サーバーサイドリクエストの変更なし。"
      }
    },
    "specific_checks": {
      "escape_completeness": {
        "status": "pass",
        "detail": "ダブルクォート内で危険な4文字（\\, $, \", `）のエスケープが正しい順序で定義されている。バックスラッシュを最初にエスケープすることで二重エスケープを防止。シングルクォートはダブルクォート内で特別な意味を持たないため不要。改行（\\n）はprintf '%s'の引数としてそのまま渡され、パイプ経由でtmux load-bufferのstdinに入力されるため正しく処理される。タブ（\\t）もprintf '%s'では特殊解釈されない（%bではなく%s指定のため）。"
      },
      "buffer_name_injection": {
        "status": "pass",
        "detail": "[^a-zA-Z0-9_-] を _ に置換。cm- プレフィックスで他バッファとの衝突回避。tmux バッファ名として安全な文字セットのみ許可。十分なサニタイズ。"
      },
      "session_name_injection": {
        "status": "pass_with_notes",
        "detail": "既存sendKeys()と同一の -t \"${sessionName}\" パターン。sessionNameはgetSessionName()でDB由来のworktreeIdから生成。新規リスク追加なし。sessionNameの安全性前提を設計書に明記推奨（SEC-SF-002）。"
      },
      "nul_byte_handling": {
        "status": "pass_with_notes",
        "detail": "NULバイト除去は適切。NUL除去後の空文字列ケースはテスト戦略8.1項のエッジケースでカバー。NUL以外の制御文字については方針未記載（SEC-SF-001）。"
      },
      "buffer_leak_prevention": {
        "status": "pass_with_notes",
        "detail": "paste-buffer -dで正常時自動削除、エラー時delete-bufferフォールバック。プロセスクラッシュ時の残留リスクあり（SEC-SF-003）だが影響は限定的。"
      },
      "percent_in_printf": {
        "status": "pass",
        "detail": "printf '%s' のフォーマット指定子は '%s' で固定されハードコード。ユーザー入力はその引数として渡されるため、入力内の%文字がフォーマット指定子として解釈されることはない。設計書への注記推奨（SEC-MF-001）。"
      },
      "newline_handling": {
        "status": "pass",
        "detail": "改行（\\n）はprintf '%s'の引数内でリテラルな改行としてそのまま渡される。%sフォーマットは\\nを特殊解釈しない（%bとは異なる）。パイプ経由でtmux load-bufferのstdinに入力されるため、改行を含むテキストが正しくバッファにロードされる。"
      },
      "tab_and_cr_handling": {
        "status": "pass_with_notes",
        "detail": "タブ（\\t）はprintf '%s'では特殊解釈されず、リテラルなタブ文字としてバッファに格納される。CR（\\r）も同様にリテラルとして渡されるが、ターミナル上での表示改竄リスクあり（SEC-SF-001参照）。"
      },
      "existing_sendkeys_comparison": {
        "status": "informational",
        "detail": "既存sendKeys()はシングルクォートエスケープ（' → '\\''）を行い、tmux send-keys -t \"${sessionName}\" '${escapedKeys}' C-m 形式で実行。sendTextViaBuffer()はダブルクォートエスケープ（\\, $, \", `）を行い、printf '%s' \"${escapedText}\" | tmux load-buffer 形式で実行。エスケープ方式は異なるが、両者とも各クォーティングコンテキストに適切な文字セットをエスケープしている。"
      }
    }
  },
  "risk_assessment": {
    "technical": "low",
    "security": "low",
    "operational": "low"
  },
  "reviewed_files": [
    "dev-reports/design/issue-163-multiline-message-buffer-design-policy.md",
    "src/lib/tmux.ts",
    "src/lib/claude-session.ts",
    "src/lib/cli-tools/codex.ts",
    "src/lib/cli-tools/gemini.ts",
    "src/lib/cli-tools/claude.ts",
    "src/lib/cli-patterns.ts",
    "src/lib/auto-yes-manager.ts",
    "src/app/api/worktrees/[id]/respond/route.ts",
    "src/app/api/worktrees/[id]/prompt-response/route.ts",
    "src/app/api/worktrees/[id]/terminal/route.ts"
  ],
  "timestamp": "2026-02-06T19:00:00+09:00"
}
