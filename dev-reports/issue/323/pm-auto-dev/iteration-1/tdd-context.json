{
  "issue_number": 323,
  "title": "auto-yes-manager.ts pollAutoYes() リファクタリング",
  "acceptance_criteria": [
    "既存テスト（tests/unit/lib/auto-yes-manager.test.ts）が全てパスすること",
    "pollAutoYes()が4-5個の単一責務関数に分割されていること",
    "停止条件チェックロジックが専用関数（processStopConditionDelta）に抽出されていること",
    "分割関数の命名が既存関数と衝突しないこと（特に既存checkStopCondition()との区別）",
    "pollerState存在確認の重複が解消されていること（getPollerState()ヘルパー）",
    "機能変更がないこと（外部インターフェースは維持）",
    "分割された各関数（validatePollingContext, captureAndCleanOutput, processStopConditionDelta, detectAndRespondToPrompt）に対する個別テストが追加されていること",
    "分割関数の個別テストはタイマー非依存（直接関数呼び出し）で記述すること",
    "分割関数はpollerStateを引数として受け取る設計であること",
    "CLAUDE.mdのauto-yes-manager.tsモジュール説明が更新されていること",
    "docs/implementation-history.mdにIssue #323のエントリが追加されていること"
  ],
  "implementation_tasks": [
    "Task 1.1: テストヘルパー createTestPollerState() をテストファイルに追加",
    "Task 1.2: getPollerState() プライベートgetterをauto-yes-manager.tsに追加",
    "Task 1.3: validatePollingContext(worktreeId, pollerState) を追加（@internal export）",
    "Task 1.4: captureAndCleanOutput(worktreeId, cliToolId) を追加（@internal export）",
    "Task 1.5: processStopConditionDelta(worktreeId, pollerState, cleanOutput) を追加（@internal export）",
    "Task 1.6: detectAndRespondToPrompt(worktreeId, pollerState, cliToolId, cleanOutput) を追加（@internal export）",
    "Task 1.7: pollAutoYes() をオーケストレーター（~30行）に置き換え",
    "Task 1.8: 6箇所のautoYesPollerStates.get()をgetPollerState()に置換",
    "Task 2.1: validatePollingContext() 個別テスト追加（タイマー非依存）",
    "Task 2.2: captureAndCleanOutput() 個別テスト追加（タイマー非依存）",
    "Task 2.3: processStopConditionDelta() 個別テスト追加（タイマー非依存）",
    "Task 2.4: detectAndRespondToPrompt() 個別テスト追加（タイマー非依存）",
    "Task 2.5: 既存テスト全パス確認"
  ],
  "design_policy_path": "dev-reports/design/issue-323-auto-yes-manager-refactoring-design-policy.md",
  "work_plan_path": "dev-reports/issue/323/work-plan.md",
  "target_files": [
    "src/lib/auto-yes-manager.ts",
    "tests/unit/lib/auto-yes-manager.test.ts"
  ],
  "target_coverage": 80,
  "key_constraints": [
    "機能変更なし（外部から見える動作を変えない）",
    "既存のcheckStopCondition()（L409）は変更しない",
    "pollAutoYes()はprivateのまま（exportしない）",
    "新規関数はすべて@internal exportとしてテスト専用公開",
    "worktreeId検証（isValidWorktreeId）はstartAutoYesPolling()側で実施済み（各分割関数では再検証しない）"
  ]
}
