{
  "issue_number": 190,
  "focus_area": "影響範囲",
  "stage": 3,
  "stage_name": "影響分析レビュー",
  "status": "conditionally_approved",
  "score": 4,
  "findings": {
    "must_fix": [
      {
        "id": "MF-I01",
        "category": "テストカバレッジ",
        "title": "既存統合テスト api-repository-delete.test.ts の更新が設計書に記載されていない",
        "description": "tests/integration/api-repository-delete.test.ts は DELETE /api/repositories のテストを行っているが、disableRepository() の追加により既存テストの期待値が変わる可能性がある（404テストケースで disableRepository が先に呼ばれる等）。変更対象ファイル一覧（Section 11）にも既存テストファイルの更新が含まれていない。",
        "affected_files": ["tests/integration/api-repository-delete.test.ts"],
        "risk": "高",
        "recommendation": "既存テスト api-repository-delete.test.ts の「should return 404 if repository has no worktrees」テストケースは、disableRepository() がworktreeIdsチェック前に呼ばれるようになるため、repositories テーブルに enabled=0 のレコードが残る副作用を検証する必要がある。変更対象ファイル一覧とテスト方針にこのファイルの更新を明記すべき。"
      }
    ],
    "should_fix": [
      {
        "id": "SF-I01",
        "category": "間接影響",
        "title": "RepositoryManager.tsx の Sync All ボタンの挙動変更に関する影響記述が不足",
        "description": "RepositoryManager.tsx は repositoryApi.sync() を呼び出す「Sync All」ボタンを持つ。sync/route.ts の変更により除外リポジトリがスキップされるため、レスポンスの repositoryCount と worktreeCount が変わる。ユーザーに表示される成功メッセージ「Successfully synced X worktree(s) from Y repository/repositories」の数値が変わるが、設計書にはこの UI 側の影響分析が記載されていない。",
        "affected_files": ["src/components/repository/RepositoryManager.tsx"],
        "risk": "低",
        "recommendation": "影響範囲として RepositoryManager.tsx を認識し、Sync All 後の表示メッセージが除外リポジトリ分だけ減ることをドキュメントに記載すべき。機能的には問題ないが、ユーザーの混乱を避けるため認識が必要。"
      },
      {
        "id": "SF-I02",
        "category": "間接影響",
        "title": "scan/route.ts 経由のリポジトリ追加と enabled=0 の関係",
        "description": "scan/route.ts は個別リポジトリの追加を行うが、repositories テーブルには登録しない（worktrees テーブルのみに upsert）。もし過去に除外された（enabled=0）リポジトリと同じパスの worktree を scan/route.ts で追加した場合、次回の Sync All で除外フィルタにより削除される可能性がある。設計書 Section 15 でスコープ外としているが、ユーザー操作のシナリオとして回帰リスクがある。",
        "affected_files": ["src/app/api/repositories/scan/route.ts"],
        "risk": "中",
        "recommendation": "scan/route.ts 経由の追加時に repositories テーブルの enabled 状態を確認し、enabled=0 の場合は警告を返すか、自動的に enabled=1 に復帰させるなど、ユーザーの意図と矛盾しない挙動を検討すべき。最低限、この回帰シナリオをフォローアップIssueに明示的に記載すべき。"
      },
      {
        "id": "SF-I03",
        "category": "テストカバレッジ",
        "title": "clone-manager.ts の onCloneSuccess() との相互作用テストが不足",
        "description": "clone-manager.ts の onCloneSuccess() は createRepository() を呼び出してリポジトリを登録する。もし同じパスのリポジトリが enabled=0 で登録済みの場合、repositories.path の UNIQUE 制約で INSERT が失敗する。設計書 Section 3 に記述はあるが、テスト方針にこのシナリオが含まれていない。",
        "affected_files": ["src/lib/clone-manager.ts"],
        "risk": "中",
        "recommendation": "clone-manager.ts のテストに「enabled=0 のリポジトリと同じパスへのクローン」シナリオを追加するか、フォローアップIssueとして明確に切り出すべき。"
      },
      {
        "id": "SF-I04",
        "category": "パス不整合リスク",
        "title": "getRepositoryPaths() と repositories テーブルのパス表現の不一致リスク",
        "description": "getRepositoryPaths() は process.env.WORKTREE_REPOS から取得し .trim() のみ適用する。一方、ensureEnvRepositoriesRegistered() は resolveRepositoryPath() (path.resolve()) で正規化してから repositories テーブルに格納する。filterExcludedPaths() も resolveRepositoryPath() で正規化して比較するため、正規化前後のパス不一致は原理的に防がれている。ただし、scanWorktrees() 内部でも path.resolve(rootDir) を行うため、worktrees テーブルの repositoryPath と repositories テーブルの path が一致しないケースがありうる（例: 末尾スラッシュ付きで環境変数に設定された場合）。",
        "affected_files": ["src/lib/worktrees.ts", "src/lib/db-repository.ts"],
        "risk": "低",
        "recommendation": "resolveRepositoryPath() による正規化で多くのケースは防がれるが、worktrees.repositoryPath と repositories.path の整合性確認テストを追加すると安全性が向上する。"
      },
      {
        "id": "SF-I05",
        "category": "UI影響",
        "title": "NEXT_PUBLIC_WORKTREE_REPOS 環境変数が next.config.js に未設定",
        "description": "WorktreeList.tsx の isInEnvVar() は process.env.NEXT_PUBLIC_WORKTREE_REPOS を参照しているが、next.config.js の env ブロックには NEXT_PUBLIC_APP_VERSION のみが設定されており、NEXT_PUBLIC_WORKTREE_REPOS は設定されていない。そのため isInEnvVar() は常に false を返す可能性が高い。設計書で isInEnvVar() の廃止を検討（C-C03）しているが、現時点で既にこの関数が正常に動作していない可能性がある。",
        "affected_files": ["src/components/worktree/WorktreeList.tsx", "next.config.js"],
        "risk": "低",
        "recommendation": "isInEnvVar() の現状の動作を確認し、既に機能していない場合は廃止の判断がより明確になる。設計書の C-C03 方針は適切だが、現状の動作実態を Implementation Note として追記すべき。"
      }
    ],
    "consider": [
      {
        "id": "C-I01",
        "category": "将来影響",
        "title": "repositories テーブルのレコード蓄積",
        "description": "disableRepository() は既存レコードが無い場合も enabled=0 で新規登録するため、存在しないパスのリポジトリでもレコードが蓄積される。長期運用時にテーブルサイズが増加する可能性がある。",
        "recommendation": "現時点では問題にならないが、将来的にクリーンアップ機能（一定期間以上 enabled=0 のレコードを削除）を検討してもよい。"
      },
      {
        "id": "C-I02",
        "category": "将来影響",
        "title": "WebSocket の repository_deleted イベントと除外リストの同期",
        "description": "除外リポジトリ一覧セクションを WorktreeList.tsx に追加する際、repository_deleted イベント受信時に除外リポジトリ一覧も再取得する必要がある可能性がある。",
        "recommendation": "除外リポジトリ一覧の更新トリガーを実装時に検討すること。"
      },
      {
        "id": "C-I03",
        "category": "後方互換性",
        "title": "DELETE /api/repositories のレスポンス形式維持",
        "description": "設計書では DELETE API のレスポンス形式は変更しないとしており、後方互換性は維持される。ただし、worktreeIds=0 で 404 を返しつつも DB 書き込みが発生するという副作用の変更は、API を利用する外部クライアントがある場合にセマンティクスの変更となる。",
        "recommendation": "現時点では CommandMate は単一アプリケーションであり外部 API クライアントは存在しないため問題ない。将来 API を公開する場合はドキュメントに副作用を明記すること。"
      }
    ]
  },
  "risk_assessment": {
    "technical": "medium",
    "security": "low",
    "operational": "low"
  },
  "impact_analysis": {
    "direct_changes": [
      {
        "file": "src/lib/db-repository.ts",
        "change": "7 new functions added (resolveRepositoryPath, ensureEnvRepositoriesRegistered, filterExcludedPaths, disableRepository, getExcludedRepositoryPaths, getExcludedRepositories, restoreRepository), getRepositoryByPath internal enhancement",
        "risk": "低 - 既存関数のシグネチャ変更なし、純粋な機能追加"
      },
      {
        "file": "src/app/api/repositories/route.ts",
        "change": "DELETE handler に disableRepository() 呼び出し追加、新規import追加",
        "risk": "中 - 制御フロー変更（disableRepository を worktreeIds チェック前に実行）。既存テストへの影響あり"
      },
      {
        "file": "src/app/api/repositories/sync/route.ts",
        "change": "ensureEnvRepositoriesRegistered() + filterExcludedPaths() 呼び出し追加、新規import追加",
        "risk": "中 - Sync All のコア動作変更。除外リポジトリがスキップされるようになる"
      },
      {
        "file": "src/app/api/repositories/excluded/route.ts",
        "change": "新規ファイル - GET handler",
        "risk": "低 - 新規エンドポイント、既存機能への影響なし"
      },
      {
        "file": "src/app/api/repositories/restore/route.ts",
        "change": "新規ファイル - PUT handler",
        "risk": "低 - 新規エンドポイント。scanWorktrees + syncWorktreesToDB の呼び出しによるパフォーマンス影響のみ"
      },
      {
        "file": "src/components/worktree/WorktreeList.tsx",
        "change": "警告メッセージ更新、isInEnvVar() 廃止、除外リポジトリ一覧セクション追加",
        "risk": "低 - UI変更のみ。新規state追加と API呼び出し追加"
      },
      {
        "file": "src/lib/api-client.ts",
        "change": "repositoryApi に getExcluded(), restore() メソッド追加",
        "risk": "低 - 純粋な機能追加、既存メソッドへの影響なし"
      }
    ],
    "indirect_impacts": [
      {
        "file": "src/components/repository/RepositoryManager.tsx",
        "impact": "Sync All の結果メッセージ（worktreeCount, repositoryCount）が除外分だけ減少",
        "risk": "低"
      },
      {
        "file": "src/app/api/repositories/scan/route.ts",
        "impact": "scan 経由で追加された worktree が、同パスの enabled=0 リポジトリがある場合に次回 Sync All で消失する可能性",
        "risk": "中"
      },
      {
        "file": "src/lib/clone-manager.ts",
        "impact": "onCloneSuccess() の createRepository() が enabled=0 の同パスレコード存在時に UNIQUE 制約違反",
        "risk": "中"
      },
      {
        "file": "tests/integration/api-repository-delete.test.ts",
        "impact": "DELETE API の制御フロー変更により既存テストケースの期待値が変わる可能性",
        "risk": "高"
      },
      {
        "file": "tests/unit/db-repository-delete.test.ts",
        "impact": "getWorktreeIdsByRepository 単体テストは影響なし（関数シグネチャ変更なし）",
        "risk": "低"
      }
    ],
    "no_impact": [
      "src/lib/db.ts - 呼び出される関数(getWorktreeIdsByRepository, deleteRepositoryWorktrees)のシグネチャ変更なし",
      "src/lib/worktrees.ts - getRepositoryPaths(), scanMultipleRepositories(), syncWorktreesToDB() のシグネチャ変更なし",
      "src/lib/session-cleanup.ts - cleanupMultipleWorktrees() のシグネチャ変更なし",
      "src/lib/ws-server.ts - cleanupRooms(), broadcastMessage() のシグネチャ変更なし",
      "src/app/api/repositories/clone/route.ts - クローンAPI は本変更の影響を受けない"
    ]
  },
  "reviewed_files": [
    "dev-reports/design/issue-190-repository-exclusion-on-sync-design-policy.md",
    "src/lib/db-repository.ts",
    "src/app/api/repositories/route.ts",
    "src/app/api/repositories/sync/route.ts",
    "src/app/api/repositories/scan/route.ts",
    "src/components/worktree/WorktreeList.tsx",
    "src/components/repository/RepositoryManager.tsx",
    "src/lib/api-client.ts",
    "src/lib/worktrees.ts",
    "src/lib/clone-manager.ts",
    "src/lib/db.ts",
    "src/lib/session-cleanup.ts",
    "next.config.js",
    "tests/integration/api-repository-delete.test.ts",
    "tests/unit/db-repository-delete.test.ts"
  ],
  "timestamp": "2026-02-08T12:00:00Z"
}
