# Architecture Review: Issue #61 - Auto Yesモード

**レビュー日**: 2026-01-27
**対象**: `dev-reports/design/issue-61-auto-yes-mode-design-policy.md`
**レビュアー**: Claude Code (Architecture Review)

---

## 1. 設計原則の遵守確認

### SOLID原則チェック
- [x] **Single Responsibility**: `auto-yes-manager.ts`（状態管理）、`auto-yes-resolver.ts`（応答ルール）、`AutoYesToggle.tsx`（UI）が適切に分離
- [x] **Open/Closed**: `resolveAutoAnswer`は新しいプロンプト種別を追加しやすい構造
- [x] **Liskov Substitution**: 該当なし（継承関係なし）
- [x] **Interface Segregation**: API・コンポーネント・ロジックが明確に分離
- [x] **Dependency Inversion**: フロントエンドはAPI経由でサーバー状態にアクセスし、直接依存しない

### その他の原則
- [x] **KISS**: インメモリMapによるシンプルな状態管理、既存APIの再利用
- [x] **YAGNI**: 延長機能を意図的に除外、必要最小限の安全装置
- [x] **DRY**: 既存の`/prompt-response` APIと`fetchCurrentOutput()`ポーリングを再利用

---

## 2. アーキテクチャ評価

### 構造的品質

| 評価項目 | スコア(1-5) | コメント |
|---------|------------|----------|
| モジュール性 | 5 | 新規4ファイル・変更2ファイルで影響範囲が明確 |
| 結合度 | 4 | 既存APIを再利用する設計で低い。`current-output`への状態付加のみやや結合 |
| 凝集度 | 5 | 各モジュールの責務が明確 |
| 拡張性 | 4 | `resolveAutoAnswer`に新ルール追加可能 |
| 保守性 | 4 | シンプルな設計で理解しやすい |

### パフォーマンス観点
- **ポーリング負荷**: `current-output` APIにMap参照（O(1)）を追加するのみ。影響は無視できる
- **自動応答レイテンシ**: 最大2秒（ポーリング間隔）の遅延。実用上は許容範囲

---

## 3. セキュリティレビュー

### 該当するOWASP項目
- [x] **アクセス制御**: auto-yes APIにworktreeIdの検証あり。認証なし（既存APIと同等、ローカルツールのため許容）
- [x] **入力バリデーション**: POST `/auto-yes` は `{ enabled: boolean }` のみで攻撃面が小さい

### auto-yes固有の安全設計
- [x] 1時間タイムアウト: 適切
- [x] テキスト入力スキップ: 任意コマンド実行を防ぐ重要な安全策
- [x] サーバー再起動リセット: フェイルセーフとして機能
- [x] 二重応答防止: `lastAutoRespondedRef`による設計（設計書に記載済み）

---

## 4. 既存システムとの整合性

### 統合ポイント

| ポイント | 評価 | コメント |
|---------|------|---------|
| `/current-output` への付加 | 適切 | ポーリング効率化として合理的。既存クライアントは追加フィールドを無視するだけ |
| `/prompt-response` の再利用 | 適切 | 既存フローとの一貫性を維持 |
| `detectPrompt()` の活用 | 適切 | 変更不要 |
| `WorktreeDetailRefactored` の変更 | 要注意 | 下記6.2参照 |

### 技術スタックの適合性
- Next.js API Routes + インメモリMap: ローカルdev server前提のため問題なし
- React useRef: 二重応答防止に適切

---

## 5. リスク評価

| リスク種別 | 内容 | 影響度 | 発生確率 | 対策優先度 |
|-----------|------|-------|---------|-----------|
| 技術的 | 二重応答防止が`question`文字列の一致のみに依存。同一questionで異なるコンテキストのプロンプトが来ると応答漏れ | 中 | 低 | 低 |
| 技術的 | タブが閉じているとauto-yesが動作しない | 低 | 中 | 低（設計書に明記済み） |
| 運用 | auto-yesがONのまま意図しない操作を承認 | 高 | 低 | 中（タイムアウト・通知で軽減済み） |
| 技術的 | Next.js HMRでインメモリMapがリセットされフロントエンドと不整合 | 低 | 中 | 低（GETで状態再取得するため自己修復） |

---

## 6. 改善提案

### 必須改善項目（Must Fix）

なし。設計に致命的な問題は見当たらない。二重応答防止も設計書のセクション3.5で適切に考慮されている。

### 推奨改善項目（Should Fix）

#### 6.1 POST `/auto-yes` のバリデーション強化
- `enabled`が`boolean`であることの型チェックを明示的に行う
- 不正なworktreeIdの場合の404レスポンスを設計書に明記

#### 6.2 `fetchCurrentOutput`内のauto-yes判定をカスタムフックに抽出
- `WorktreeDetailRefactored`の肥大化を防ぐため、`useAutoYes(worktreeId)` のようなカスタムフックへの分離を推奨
- ポーリング結果への密結合があるためコスト対効果は要検討だが、テスタビリティ向上の観点から推奨

#### 6.3 型定義ファイルの配置先
- 設計書では`src/types/api.ts`を新規作成とあるが、既存の`src/types/models.ts`に追加する案も検討すべき
- 型定義ファイルの分散を最小限に抑えるため

### 検討事項（Consider）

#### 6.4 自動応答ログ
- 現設計ではDB保存しない方針だが、デバッグ用に`console.info`レベルのサーバーログ出力を検討
- 「何が自動応答されたか」のトレーサビリティ向上

#### 6.5 二重応答防止の複合キー
- `question`文字列だけでなく`type`も含めた複合キー（`${type}:${question}`）を検討
- 同一questionテキストで異なるプロンプト種別が出現するエッジケースへの対応

---

## 7. ベストプラクティスとの比較

### 既存パターンとの整合性

| 観点 | 既存パターン | 設計書の方針 | 評価 |
|------|------------|------------|------|
| API設計 | RESTful `/api/worktrees/[id]/xxx` | 同一パターン踏襲 | 適合 |
| 状態管理 | DB（worktrees, session_states） | インメモリMap | 妥当（一時的状態のため） |
| コンポーネント配置 | `src/components/worktree/` | 同一ディレクトリ | 適合 |
| ビジネスロジック | `src/lib/` | 同一ディレクトリ | 適合 |

### 代替アーキテクチャ案

- **サーバーサイド自動応答**（設計書で却下済み）: 既存アーキテクチャとの一貫性を優先した判断は妥当
- **WebSocket/SSE**: 大幅な変更が必要でYAGNIに反する。現時点では不要

---

## 8. 総合評価

### レビューサマリ

- **全体評価**: ⭐⭐⭐⭐☆（4/5）
- **強み**:
  - 既存アーキテクチャとの高い整合性（既存API・ポーリングフローの再利用）
  - 安全設計が充実（タイムアウト、テキスト入力スキップ、二重応答防止、カウントダウン表示）
  - モジュール分割が明確で責任範囲がはっきりしている
  - 設計判断の根拠と代替案が明確に文書化されている
- **弱み**:
  - `WorktreeDetailRefactored`への直接的なロジック追加による肥大化リスク

### 承認判定

- [x] **承認（Approved）** — 2026-01-27 条件対応完了

#### 対応済み条件
1. ~~POST `/auto-yes` APIにリクエストバリデーション~~ → 設計書セクション4.1に400/404エラーレスポンスおよびバリデーション仕様を追記
2. ~~型定義の配置先~~ → 既存の`src/types/models.ts`に集約する方針に確定

#### 対応済み推奨事項
3. `fetchCurrentOutput`内のauto-yes判定を`useAutoYes`カスタムフックに抽出 → 設計書セクション5.2に追記
4. 二重応答防止の複合キー（`${type}:${question}`） → 設計書セクション3.5に反映

#### 次のステップ
1. TDD実装の開始（`auto-yes-manager.ts` → `auto-yes-resolver.ts` → `useAutoYes` → API → コンポーネント の順序を推奨）
2. 検討事項（自動応答ログ）は実装時に判断
