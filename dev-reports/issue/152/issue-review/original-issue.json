{"body":"## 概要\n\nブランチを選択し初回のメッセージを入力したものの、Claude Codeに送信されていない。\n\n## スクリーンショット\n\n<img width=\"1920\" height=\"1080\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/14a90a8c-fa4c-4ed9-99c2-3a8df45bfa07\" />\n\n---\n\n## 技術調査結果\n\n### 再現条件（推定）\n\n1. 新しいWorktreeを選択（セッション未起動状態）\n2. メッセージを入力して送信\n3. バックエンドでセッション起動とメッセージ送信が連続実行\n4. **Claude CLIが完全に初期化される前にメッセージが送信される**\n\n### 問題箇所の特定\n\n**`src/lib/claude-session.ts` の `startClaudeSession()` 関数（165-225行目）**\n\n```typescript\n// Claude CLI初期化待ち（最大10秒）\nwhile (Date.now() - startTime < maxWaitTime) {\n  await new Promise((resolve) => setTimeout(resolve, pollInterval));\n  \n  try {\n    const output = await capturePane(sessionName, { startLine: -50 });\n    // Claude is ready when we see the prompt (> ) or separator line\n    if (/^>\\s*$/m.test(output) || /^─{10,}$/m.test(output)) {\n      console.log(`✓ Claude initialized in ${Date.now() - startTime}ms`);\n      break;  // ← ここで抜ける\n    }\n  } catch {\n    // Ignore capture errors during initialization\n  }\n}\n// ← maxWaitTimeを超えても、エラーなしで続行する\nconsole.log(`✓ Started Claude session: ${sessionName}`);\n```\n\n**問題点:**\n1. `maxWaitTime`（10秒）を超えた場合でもエラーにならず、セッションが「起動済み」として扱われる\n2. プロンプト検出パターン（`/^>\\s*$/m` または `/^─{10,}$/m`）がClaude CLIの全ての初期化状態をカバーしていない可能性\n3. `break`後に追加の待機時間がない（Claudeがプロンプト表示直後にメッセージ受付可能とは限らない）\n\n**`src/app/api/worktrees/[id]/send/route.ts`（94-124行目）**\n\n```typescript\n// Check if CLI tool session is running\nconst running = await cliTool.isRunning(params.id);\n\n// Start CLI tool session if not running\nif (!running) {\n  try {\n    await cliTool.startSession(params.id, worktree.path);\n    // ... git status保存処理 ...\n  } catch (error: unknown) {\n    // エラーハンドリング\n  }\n}\n\n// ← セッション起動直後にメッセージ送信\nawait cliTool.sendMessage(params.id, body.content);\n```\n\n**問題点:**\n1. `startSession()`が正常終了しても、Claudeが実際にメッセージを受け付ける状態かどうかは保証されない\n2. セッション起動とメッセージ送信の間に追加の検証がない\n\n### 発生シナリオ\n\n```\n[User] ブランチ選択 + 初回メッセージ送信\n    ↓\n[Server] isRunning() → false\n    ↓\n[Server] startClaudeSession() 開始\n    ↓\n[tmux] claude コマンド実行\n    ↓\n[Server] プロンプト検出ループ開始\n    ↓\n[Server] 10秒以内にプロンプト検出できず (or 検出パターン不一致)\n    ↓\n[Server] ループ終了、startClaudeSession() 正常終了\n    ↓\n[Server] sendMessageToClaude() 実行\n    ↓\n[tmux] メッセージ + Enter送信\n    ↓\n[Claude] まだ初期化中、メッセージが無視される ← ここで問題発生\n```\n\n### 影響範囲\n\n- **発生条件**: 新規セッション起動 + 初回メッセージ送信\n- **影響コンポーネント**:\n  - `src/lib/claude-session.ts`\n  - `src/app/api/worktrees/[id]/send/route.ts`\n- **UI側**: MessageInput, WorktreeDetailRefactored\n\n---\n\n## 推奨される改善策\n\n### 案1: プロンプト検出の強化（推奨）\n\n```typescript\n// startClaudeSession() 改善案\nconst maxWaitTime = 15000; // 10秒 → 15秒に延長\nconst pollInterval = 300;  // 500ms → 300msに短縮\n\nwhile (Date.now() - startTime < maxWaitTime) {\n  await new Promise((resolve) => setTimeout(resolve, pollInterval));\n  \n  const output = await capturePane(sessionName, { startLine: -50 });\n  // より厳密なプロンプト検出\n  if (/^>\\s*$/m.test(output) && output.includes('Claude')) {\n    // プロンプト検出後、追加の安定待機\n    await new Promise((resolve) => setTimeout(resolve, 500));\n    console.log(`✓ Claude initialized in ${Date.now() - startTime}ms`);\n    return; // 正常終了\n  }\n}\n\n// タイムアウト時はエラーとして扱う\nthrow new Error('Claude initialization timeout (15s)');\n```\n\n### 案2: 送信前の準備確認\n\n```typescript\n// sendMessageToClaude() 改善案\nexport async function sendMessageToClaude(\n  worktreeId: string,\n  message: string\n): Promise<void> {\n  const sessionName = getSessionName(worktreeId);\n  \n  // セッション存在確認\n  const exists = await hasSession(sessionName);\n  if (!exists) {\n    throw new Error(`Claude session ${sessionName} does not exist`);\n  }\n  \n  // 送信前にプロンプト状態を確認\n  const output = await capturePane(sessionName, { startLine: -10 });\n  if (!/^>\\s*$/m.test(output)) {\n    // プロンプトが表示されるまで待機（最大5秒）\n    await waitForPrompt(sessionName, 5000);\n  }\n  \n  // メッセージ送信\n  await sendKeys(sessionName, message, false);\n  // ...\n}\n```\n\n### 案3: リトライ機構の追加\n\n```typescript\n// send/route.ts 改善案\nconst MAX_RETRIES = 3;\nconst RETRY_DELAY_MS = 1000;\n\nfor (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {\n  try {\n    await cliTool.sendMessage(params.id, body.content);\n    break; // 成功\n  } catch (error) {\n    if (attempt === MAX_RETRIES) throw error;\n    console.warn(`Send message attempt ${attempt} failed, retrying...`);\n    await new Promise(r => setTimeout(r, RETRY_DELAY_MS));\n  }\n}\n```\n\n---\n\n## 受け入れ条件\n\n- [ ] 新規セッション起動後の初回メッセージが確実にClaude CLIに送信されること\n- [ ] セッション初期化タイムアウト時に適切なエラーメッセージが表示されること\n- [ ] UIにローディング状態が正しく表示されること\n- [ ] 2回目以降のメッセージ送信に影響がないこと\n\n## テスト手順\n\n1. 未起動のWorktreeを選択\n2. メッセージを入力して送信\n3. Claudeが応答することを確認\n4. サーバーログで `✓ Started Claude session` → `✓ Sent message to Claude session` の順序を確認","title":"セッション一発目のメッセージが送信されない"}
