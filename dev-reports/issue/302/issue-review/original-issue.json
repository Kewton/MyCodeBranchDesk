{"body":"## 概要\n\nワークツリーのファイル管理機能において、mp4ファイルのアップロードとブラウザ内再生（プレビュー）を可能にする。現在はアップロード可能なファイル形式に動画が含まれておらず、mp4ファイルを保存・閲覧できない。\n\n## 背景・課題\n\n開発中のアプリケーションのデモ動画をワークツリー内に保存・管理したいが、現在の`UPLOADABLE_EXTENSIONS`にmp4が含まれていないためアップロードできない。デモ動画をプロジェクトディレクトリに手動でコピーする必要があり、CommandMateのUI上で一元管理できていない。\n\n## 提案する解決策\n\n既存のアップロード・ファイル表示パイプラインを拡張し、mp4形式をサポートする。\n\n### 主要な変更点\n\n- `UPLOADABLE_EXTENSIONS`にmp4のバリデータを追加（MIME: `video/mp4`、magic bytes検証）\n- `FileContent`型に`isVideo`フラグを追加\n- ファイル表示API（GET `/api/worktrees/[id]/files/[...path]`）に動画ファイル判定ロジックを追加\n- `VideoViewer`コンポーネントを新規作成（HTML5 `<video>`タグ、コントロール付き）\n- `FileViewer`コンポーネントに動画表示の分岐を追加\n\n### 設計方針\n\n- ファイルサイズ上限は15MB（mp4専用の上限。既存の画像等は5MBのまま）。デモ動画を想定\n- Base64 data URI方式で配信（15MB以下なのでストリーミング不要）\n- mp4のみ対応（webm, mov等は対象外）\n- `ImageViewer`と同じパターンで`VideoViewer`を実装（統一性のある設計）\n\n## 実装タスク\n\n- [ ] `src/config/uploadable-extensions.ts` にmp4バリデータを追加（maxFileSize: 15MB）\n- [ ] 動画判定用ユーティリティを作成（`isVideoExtension()`、magic bytes検証）\n- [ ] `src/types/models.ts` の`FileContent`インターフェースに`isVideo`フラグを追加\n- [ ] `src/app/api/worktrees/[id]/files/[...path]/route.ts` に動画ファイル表示ロジックを追加\n- [ ] `src/components/worktree/VideoViewer.tsx` を新規作成\n- [ ] `src/components/worktree/FileViewer.tsx` に動画表示分岐を追加\n- [ ] ユニットテスト・結合テストを追加\n\n## 受入条件\n\n- [ ] mp4ファイルをUIからアップロードできること\n- [ ] アップロードしたmp4ファイルがファイルツリーに表示されること\n- [ ] mp4ファイルをクリックするとブラウザ内で再生（プレビュー）できること（再生/停止コントロール付き）\n- [ ] 15MBを超えるmp4ファイルのアップロードが拒否されること\n- [ ] 不正なファイル（拡張子をmp4に偽装した非動画ファイル）がmagic bytes検証で拒否されること\n- [ ] 既存のアップロード機能（画像、テキスト等）に影響がないこと\n- [ ] 全既存テストがパスすること\n\n## 影響範囲\n\n### 変更対象ファイル\n\n| ファイル | 変更内容 |\n|---------|---------|\n| `src/config/uploadable-extensions.ts` | mp4バリデータ追加（15MB上限） |\n| `src/types/models.ts` | `FileContent`に`isVideo`フラグ追加 |\n| `src/app/api/worktrees/[id]/files/[...path]/route.ts` | 動画ファイル判定・Base64変換ロジック追加 |\n| `src/components/worktree/VideoViewer.tsx` | **新規作成** - HTML5動画プレーヤー |\n| `src/components/worktree/FileViewer.tsx` | 動画表示分岐追加 |\n\n### 新規作成ファイル（候補）\n\n| ファイル | 内容 |\n|---------|------|\n| `src/config/video-extensions.ts` | 動画拡張子定義・magic bytes・MIME定義 |\n| `src/components/worktree/VideoViewer.tsx` | 動画再生コンポーネント |\n\n### 関連コンポーネント（変更不要だが影響確認が必要）\n\n- `src/config/binary-extensions.ts` - mp4は既に登録済み（変更不要）\n- `src/components/worktree/WorktreeDetailRefactored.tsx` - アップロードUIは`UPLOADABLE_EXTENSIONS`を動的参照しているため自動対応\n- `src/lib/file-search.ts` - バイナリ除外リストにmp4が既に含まれている（変更不要）","title":"mp4ファイルをアップロード可能にしたい"}
