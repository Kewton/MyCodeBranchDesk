{"body":"## 概要\n\n`npm install -g commandmate`を実行してv0.1.9からv0.1.10にバージョンアップを実施したところ、登録していたリポジトリ情報が初期化した。\n\n## 再現手順\n\n1. `npm install -g commandmate@0.1.9` でインストール\n2. `commandmate init` で初期化\n3. `commandmate start` でサーバー起動、リポジトリを登録\n4. `npm install -g commandmate@0.1.10` でアップグレード\n5. `commandmate start` でサーバー起動\n6. 登録していたリポジトリ情報が消失\n\n## 根本原因\n\n### 1. DBパス解決ロジックの不整合\n\n**`src/lib/db-instance.ts:25`**\n```typescript\nconst dbPath = process.env.DATABASE_PATH || \n    path.join(process.cwd(), 'data', 'db.sqlite');\n```\n\n- `process.cwd()` をフォールバックとして使用\n- グローバルインストールでは `process.cwd()` はコマンド実行ディレクトリ（予測不能）\n\n**`src/lib/env.ts:169-171`**\n```typescript\nconst databasePath = getEnvByKey('CM_DB_PATH')\n    || process.env.DATABASE_PATH\n    || path.join(process.cwd(), 'data', 'cm.db');\n```\n\n- 同様に `process.cwd()` にフォールバック\n- ファイル名が `cm.db`（db-instance.ts は `db.sqlite`）で不一致\n\n### 2. CLIデフォルト値が相対パス\n\n**`src/cli/utils/env-setup.ts:31`**\n```typescript\nexport const ENV_DEFAULTS = {\n  CM_DB_PATH: './data/cm.db',  // 相対パス\n  // ...\n};\n```\n\n### 3. サーバーが.envの値を適切に使用していない\n\n```typescript\n// server.ts:72\nconst db = getDbInstance();  // CM_DB_PATHを参照しない\n\n// start.ts:93でenvはロードされるが、getDbInstance()は独自のフォールバックを使用\nconst envResult = dotenvConfig({ path: envPath });\n```\n\n## データ消失のメカニズム\n\n```\nStep 1: npm install -g commandmate@0.1.9\n  └─ インストール先: /usr/local/lib/node_modules/commandmate/\n\nStep 2: commandmate init\n  └─ ~/.commandmate/.env 作成（CM_DB_PATH=./data/cm.db）\n  └─ DB作成場所: process.cwd() に依存（予測不能）\n\nStep 3: npm install -g commandmate@0.1.10（アップグレード）\n  └─ 新しいインストール先: /usr/local/lib/node_modules/commandmate-v0.1.10/\n  └─ ~/.commandmate/.env は保持（相対パスのまま）\n  └─ 相対パスが新しい場所を指す → 新しい空のDBが作成される\n  └─ 全リポジトリ情報が消失\n```\n\n## 修正方針\n\n### 必須修正\n\n1. **`src/lib/db-instance.ts` の修正**\n   - `CM_DB_PATH` 環境変数を正しく読み込む\n   - グローバルインストール時: `~/.commandmate/data/cm.db`（絶対パス）\n   - ローカルインストール時: 設定されたパスまたは `<cwd>/data/cm.db`（絶対パス）\n   - `env.ts` の `getEnv()` を使用してパス解決\n\n2. **ファイル名の統一**: `cm.db` に統一\n\n3. **CLIデフォルト値の修正**（`src/cli/utils/env-setup.ts`）\n   - グローバルインストール: `~/.commandmate/data/cm.db`（絶対パス）\n   - ローカルインストール: `./.commandmate/data/cm.db`（絶対パス）\n\n4. **`process.cwd()` の使用禁止**\n   - グローバルインストール時は `getConfigDir()` を使用\n\n### 推奨修正\n\n5. **マイグレーションロジック追加**\n   - アップグレード時に旧DBの場所を検出し、データを移行\n\n## 影響範囲\n\n- グローバルインストールユーザー全員\n- バージョンアップ時のデータ永続性\n\n## 関連ファイル\n\n- `src/lib/db-instance.ts` - DBインスタンス管理\n- `src/lib/env.ts` - 環境変数管理\n- `src/cli/utils/env-setup.ts` - CLI環境設定\n- `src/cli/commands/init.ts` - initコマンド\n- `server.ts` - サーバーエントリポイント\n- `src/cli/commands/start.ts` - startコマンド\n\n## 備考\n\nローカル開発環境では `process.cwd()` が一貫しているため、この問題は発生しにくい。グローバルインストール特有の問題。","title":"バージョンアップ時にDBクリア"}
