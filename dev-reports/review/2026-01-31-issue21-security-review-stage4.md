# Issue #21 セキュリティレビュー (Stage 4)

**レビュー日**: 2026-01-31
**対象設計書**: `dev-reports/design/issue-21-file-search-design-policy.md`
**レビュー観点**: OWASP Top 10準拠

---

## 1. レビュー結果サマリ

| カテゴリ | 件数 |
|---------|------|
| Must Fix | 1件 |
| Should Fix | 3件 |
| Nice to Have | 2件 |
| Positive Feedback | 8件 |

---

## 2. Must Fix (対応必須)

### SEC-MF-001: 検索クエリの正規表現インジェクション対策が不十分

| 項目 | 内容 |
|------|------|
| カテゴリ | A03: インジェクション |
| 深刻度 | High |
| 該当箇所 | セクション4.2.3, 5.3 |

**問題点**:

設計書ではescapeRegExp関数を使用してXSS対策を行っているが、ファイル内容検索のサーバーサイドで検索クエリを正規表現としてそのまま使用する場合、ReDoS（Regular Expression Denial of Service）攻撃のリスクがある。

**現状の設計**:

escapeRegExp関数はクライアントサイドのハイライト表示用に設計されている。サーバーサイドのsearchFileContents関数での検索クエリの取り扱いが明確でない。

**推奨対応**:

1. サーバーサイド検索では正規表現を使用せず、単純な文字列マッチング（indexOf, includes）を使用する
2. または、検索クエリに対してescapeRegExpを適用した後に正規表現検索を行う
3. ReDoS対策として、正規表現の実行時間を監視し、タイムアウト（5秒）と組み合わせる

---

## 3. Should Fix (対応推奨)

### SEC-SF-001: 検索結果のファイルパス露出

| 項目 | 内容 |
|------|------|
| カテゴリ | A01: アクセス制御の不備 |
| 深刻度 | Medium |
| 該当箇所 | セクション4.3.1, 4.4.1 SearchResultItem |

**問題点**:

検索結果レスポンスにfilePathが含まれるが、worktreeのルートパスからの相対パスであることを明確にし、絶対パスが露出しないことを保証する必要がある。

**推奨対応**:

1. SearchResultItemのfilePath仕様に「worktreeルートからの相対パス」と明記
2. 実装時にpath.relative()を使用して相対パスを返却することを保証
3. 既存の`/api/worktrees/:id/files/route.ts`パターン（SEC-SF-002: Error responses without absolute paths）に準拠

---

### SEC-SF-002: 検索結果のコンテンツ行に対するサニタイズ方針が未定義

| 項目 | 内容 |
|------|------|
| カテゴリ | A04: 安全でない設計 |
| 深刻度 | Medium |
| 該当箇所 | セクション4.4.1 SearchResultItem.matches |

**問題点**:

検索結果のmatchesに含まれるcontent（マッチした行の内容）がそのまま返却されるが、機密情報を含む可能性がある行の取り扱いが未定義。

**推奨対応**:

1. マッチした行の長さを制限（例: 500文字でトランケート）してログ等での露出を抑制
2. レスポンスには行番号とマッチ位置のみを返し、content表示はクライアントが個別にファイル読み込みAPIを呼び出す設計も検討
3. 現状の設計を維持する場合は、検索結果のセキュリティに関する注意事項をドキュメントに記載

---

### SEC-SF-003: 検索API呼び出しのログ記録が未定義

| 項目 | 内容 |
|------|------|
| カテゴリ | A09: セキュリティログと監視の失敗 |
| 深刻度 | Medium |
| 該当箇所 | セクション4.3.1, 7.1 |

**問題点**:

検索APIへのリクエストログ（クエリ内容、実行時間、結果件数）の記録方針が設計書に記載されていない。セキュリティ監査やDoS検出に必要。

**推奨対応**:

1. 検索API呼び出し時に以下を記録: worktreeId, クエリハッシュ（プライバシー保護）, executionTimeMs, resultCount, truncated
2. 既存の`logger.ts`（createLogger）を使用し、module='api-search'で構造化ログを出力
3. クエリ内容自体はプライバシー保護のためハッシュ化またはログ出力しない

---

## 4. Nice to Have (対応見送り可)

### SEC-NTH-001: レート制限の設計追加

| 項目 | 内容 |
|------|------|
| カテゴリ | A05: セキュリティ設定のミス |
| 深刻度 | Low |

**概要**:

検索APIはCPU・I/O負荷が高い操作のため、レート制限の設計があると理想的。ただし、タイムアウト5秒・結果100件制限でDoS対策は一定レベル実施済み。

**見送り理由**:

YAGNIに従い、現時点では対応見送りで問題なし。将来的にNext.js middleware層でレート制限を検討。

---

### SEC-NTH-002: 検索キーワードの一時的なメモリ保持

| 項目 | 内容 |
|------|------|
| カテゴリ | A02: 暗号化の失敗 |
| 深刻度 | Low |

**概要**:

検索クエリがサーバーメモリに一時的に保持されるが、ローカル開発ツールとしての用途では許容範囲。

**見送り理由**:

現時点では対応不要。将来的にセキュリティ要件が高まった場合に検討。

---

## 5. Positive Feedback (評価ポイント)

| ID | カテゴリ | 評価内容 |
|----|---------|----------|
| SEC-POS-001 | A03: インジェクション | **パストラバーサル対策が適切** - 既存のisPathSafe()関数を再利用し、null byte injection、URL encoding、相対パス(..)すべてに対応 |
| SEC-POS-002 | A03: インジェクション | **XSS対策が適切** - Reactの自動エスケープを活用し、dangerouslySetInnerHTMLを使用しない方針 |
| SEC-POS-003 | A04: 安全でない設計 | **機密ファイル除外パターンが網羅的** - EXCLUDED_PATTERNSにより.git, .env, *.pem, *.key等を除外 |
| SEC-POS-004 | A04: 安全でない設計 | **タイムアウト・制限値によるDoS対策** - 5秒タイムアウト、100件制限、1MB制限、10階層制限 |
| SEC-POS-005 | A07: 認証の失敗 | **既存認証ミドルウェアの自動適用** - /api/*パターンでBearer認証が自動適用 |
| SEC-POS-006 | A08: 整合性障害 | **入力バリデーションが適切** - validateSearchQueryで空文字・最大長チェック |
| SEC-POS-007 | A06: 脆弱コンポーネント | **外部ライブラリ追加なし** - 脆弱性リスクの追加なし |
| SEC-POS-008 | A04: 安全でない設計 | **バイナリファイル除外による安全性** - BINARY_EXTENSIONSとisBinaryContent()で保護 |

---

## 6. OWASP Top 10 コンプライアンスサマリ

| OWASP項目 | ステータス | 備考 |
|-----------|-----------|------|
| A01: アクセス制御の不備 | Pass (推奨あり) | パストラバーサル対策済み。パス露出に推奨事項 |
| A02: 暗号化の失敗 | Pass | スコープ外。検索キーワード保持は許容範囲 |
| A03: インジェクション | **要対応** | パストラバーサル・XSS良好。ReDoS対策必要 |
| A04: 安全でない設計 | Pass (推奨あり) | 機密ファイル除外・タイムアウト良好。コンテンツ長制限推奨 |
| A05: セキュリティ設定ミス | Pass | 既存パターン準拠。レート制限は将来検討 |
| A06: 脆弱コンポーネント | Pass | 外部ライブラリ追加なし |
| A07: 認証の失敗 | Pass | middleware.ts認証自動適用 |
| A08: 整合性障害 | Pass | 入力バリデーション適切 |
| A09: ログ・監視の失敗 | **要対応** | エラーログ設計済み。アクセスログ追加推奨 |
| A10: SSRF | 該当なし | 内部ファイルのみアクセス |

---

## 7. 推奨対応サマリ

1. **SEC-MF-001**: サーバーサイド検索でのReDoS対策を実装（文字列マッチングまたはescapeRegExp適用）
2. **SEC-SF-001**: SearchResultItemのfilePathを相対パスと明記し、実装で保証
3. **SEC-SF-002**: 検索結果のcontent行長を制限（500文字推奨）
4. **SEC-SF-003**: 検索APIアクセスログを構造化ログで記録

---

## 8. 結論

設計方針書はOWASP Top 10の主要な観点でセキュリティ対策が適切に設計されている。特に以下の点が優れている:

- パストラバーサル対策（isPathSafe）
- XSS対策（React自動エスケープ）
- 機密ファイル除外（EXCLUDED_PATTERNS）
- DoS対策（タイムアウト・制限値）
- 認証（middleware自動適用）

**Must Fix 1件**（ReDoS対策）は実装時に対応必須。**Should Fix 3件**（パス露出、コンテンツ長制限、アクセスログ）は実装時に考慮推奨。

全体的にセキュアな設計であり、指摘事項対応後に実装可能。

---

## 9. 次のアクション

1. SEC-MF-001のReDoS対策を設計書に反映
2. 実装フェーズへ移行

---

## 10. レビュー成果物

| ファイル | パス |
|---------|------|
| レビュー結果JSON | `dev-reports/issue/21/multi-stage-design-review/stage4-review-result.json` |
| レビューレポート | `dev-reports/review/2026-01-31-issue21-security-review-stage4.md` |
