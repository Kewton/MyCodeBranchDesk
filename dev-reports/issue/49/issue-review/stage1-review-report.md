# Issue #49 レビューレポート

**レビュー日**: 2026-01-30
**フォーカス**: 通常レビュー
**イテレーション**: 1回目

---

## サマリー

| カテゴリ | 件数 |
|---------|------|
| Must Fix | 2 |
| Should Fix | 4 |
| Nice to Have | 3 |

---

## Must Fix（必須対応）

### MF-1: API設計が既存エンドポイント構造と矛盾している

**カテゴリ**: 整合性
**場所**: ## 技術仕様 > API設計（案）セクション

**問題**:
Issueで提案されているAPI設計（`/api/files`）が、既存のAPIエンドポイント構造（`/api/worktrees/:id/files/...`）と矛盾しています。

**証拠**:
- 既存実装: `/api/worktrees/:id/files/[...path]/route.ts` (GETのみ)
- Issue提案: `/api/files` (worktreeId非依存の独立エンドポイント)

既存APIはworktree単位でスコープされていますが、提案ではworktree外のグローバルエンドポイントになっています。これにより、受け入れ条件の「worktree外へのアクセスが禁止されている」を実現するための認可ロジックが複雑化します。

**推奨対応**:
既存の `/api/worktrees/:id/files/...` パスパターンに合わせ、以下の構造を検討してください：

| エンドポイント | メソッド | 説明 |
|---------------|----------|------|
| `/api/worktrees/:id/files` | GET | ファイルツリー取得（既存`/tree`と統合検討） |
| `/api/worktrees/:id/files/:path` | POST | ファイル/ディレクトリ作成 |
| `/api/worktrees/:id/files/:path` | PUT | ファイル内容更新、リネーム |
| `/api/worktrees/:id/files/:path` | DELETE | ファイル/ディレクトリ削除 |

---

### MF-2: ファイル内容取得APIの設計が欠落している

**カテゴリ**: 完全性
**場所**: ## 技術仕様 > API設計（案）セクション

**問題**:
`/api/files/content GET` エンドポイントについて、worktreeIdとpathの指定方法が未定義です。

**証拠**:
Issue提案では `/api/files/content GET` と記載がありますが、パラメータ仕様が欠落しています。既存の `/api/worktrees/:id/files/:path` では、パスパラメータでworktreeIdとファイルパスを指定しています。

**推奨対応**:
以下のいずれかの形式でパラメータ仕様を追記してください：

1. パスパラメータ形式: `/api/worktrees/:id/files/:path` (既存と統一)
2. クエリパラメータ形式: `/api/files/content?worktreeId=xxx&path=yyy`

---

## Should Fix（推奨対応）

### SF-1: マークダウンレンダリングに使用するライブラリが未指定

**カテゴリ**: 明確性
**場所**: ## エディタ・ビューワー セクション

**問題**:
「マークダウンレンダリング表示」と記載がありますが、使用するライブラリが指定されていません。

**推奨対応**:
プレビュー機能で使用するライブラリを指定してください：

- `react-markdown` + `remark-gfm`: GitHub Flavored Markdownサポート
- `marked` + `DOMPurify`: 高速レンダリング + XSS対策
- `@uiw/react-markdown-preview`: エディタ統合向け

プロジェクトの `package.json` を確認し、既存の依存関係との整合性を確認することを推奨します。

---

### SF-2: 既存FileViewerコンポーネントとの関係性が不明確

**カテゴリ**: 技術的妥当性
**場所**: ## UI配置 セクション

**問題**:
既存の `FileViewer.tsx` はモーダル形式ですが、Issueでは「mdファイル選択時にエディタ/プレビューパネルを表示」と記載しており、異なるUI構造が想定されています。

**証拠**:
```tsx
// 既存 FileViewer.tsx（モーダル形式）
<Modal isOpen={isOpen} onClose={onClose} title={filePath} size="xl">
  {/* 内容 */}
</Modal>
```

**推奨対応**:
以下のいずれかを明確にしてください：

1. 既存FileViewerを廃止し、新規インラインパネルコンポーネントを作成
2. 既存FileViewerをモーダル/インライン両対応にリファクタリング
3. 新規MarkdownEditorコンポーネントを作成し、FileViewerはそのまま維持

---

### SF-3: ファイル保存のトリガーと保存確認UIが未定義

**カテゴリ**: 明確性
**場所**: ## 受け入れ条件 セクション

**問題**:
「エディタでmdファイルを編集・保存できる」とありますが、保存の操作方法が未定義です。

**推奨対応**:
以下を明記してください：

| 項目 | 推奨仕様 |
|------|---------|
| 保存トリガー | 保存ボタン + Ctrl+S ショートカット |
| 自動保存 | オプションで有効化可能（デフォルトはオフ） |
| 未保存警告 | 変更がある状態でタブ移動/ページ離脱時に確認ダイアログ |
| 保存成功表示 | トースト通知またはステータスバー表示 |

---

### SF-4: エラーハンドリング仕様の欠落

**カテゴリ**: 完全性
**場所**: ## 技術仕様 セクション

**問題**:
ファイル操作失敗時のエラー処理が記載されていません。

**証拠**:
Issue #71では以下のような詳細なエラーカテゴリが定義されていますが、本Issueにはエラー処理の記載がありません：
- `validation`: バリデーションエラー
- `filesystem`: ファイルシステムエラー（権限、ディスク容量等）
- `system`: 内部エラー

**推奨対応**:
以下のエラーケースと対応UIを追記してください：

| エラーケース | 対応 |
|-------------|------|
| 権限エラー（EACCES） | 「書き込み権限がありません」メッセージ表示 |
| ファイル競合（他プロセスで変更） | 「ファイルが更新されています。再読み込みしますか？」ダイアログ |
| ディスク容量不足 | 「ディスク容量が不足しています」エラー表示 |
| ファイル名重複（作成時） | 「同名のファイルが存在します」エラー表示 |

---

## Nice to Have（あれば良い）

### NTH-1: 既存FileTreeViewコンポーネントへの変更影響が未記載

**カテゴリ**: 完全性
**場所**: Issue本文

**問題**:
`src/components/worktree/FileTreeView.tsx` への変更点が明記されていません。

**推奨対応**:
以下の変更点を追記してください：
- 右クリックメニュー（コンテキストメニュー）の追加
- 新規作成ボタン/アイコンの追加
- リネームのインライン編集UI

---

### NTH-2: md以外のファイル表示ポリシーが曖昧

**カテゴリ**: 技術的妥当性
**場所**: ## 受け入れ条件 セクション

**問題**:
「md以外のファイルは編集不可（表示のみ or 非表示）」と記載がありますが、括弧内が未決定です。

**推奨対応**:
以下のいずれかに確定してください：

1. **表示のみ**: 全ファイルをツリーに表示し、md以外はクリック時に読み取り専用ビューワーで表示
2. **非表示**: mdファイルのみをツリーに表示

推奨は「表示のみ」です。理由：ユーザーがコードファイルの内容を確認したい場合があるため。

---

### NTH-3: キーボードショートカットの仕様がない

**カテゴリ**: 完全性
**場所**: ## エディタ・ビューワー セクション

**問題**:
エディタ操作のキーボードショートカットが定義されていません。

**推奨対応**:
以下の基本ショートカットを検討・記載してください：

| ショートカット | 操作 |
|---------------|------|
| Ctrl+S / Cmd+S | 保存 |
| Escape | エディタを閉じる |
| Ctrl+Shift+P / Cmd+Shift+P | プレビュー切り替え |
| Ctrl+N / Cmd+N | 新規ファイル作成 |

---

## 参照ファイル

### コード

| ファイル | 関連性 |
|---------|--------|
| `/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/components/worktree/FileTreeView.tsx` | 既存のファイルツリー表示コンポーネント |
| `/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/components/worktree/FileViewer.tsx` | 既存のファイル内容表示コンポーネント（モーダル形式） |
| `/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/app/api/worktrees/[id]/files/[...path]/route.ts` | 既存のファイル内容取得API（GETのみ） |
| `/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/src/components/worktree/LeftPaneTabSwitcher.tsx` | Filesタブの切り替えUIコンポーネント |

### ドキュメント

| ファイル | 関連性 |
|---------|--------|
| `/Users/maenokota/share/work/github_kewton/MyCodeBranchDesk/docs/architecture.md` | APIエンドポイント設計の既存パターン参照 |

---

## 結論

Issue #49は機能要件・受け入れ条件が概ね明確に記載されていますが、既存のAPIエンドポイント構造との整合性に課題があります。特にMF-1（API設計の整合性）については、実装前に解決が必要です。

また、技術詳細（使用ライブラリ、エラーハンドリング、既存コンポーネントとの関係性）を追記することで、実装時の手戻りを防止できます。
