{"body":"## 概要\n\n`/worktree-cleanup` スキル実行時、Worktreeディレクトリから `npm run dev` で起動したサーバーを検出・停止できず、サーバーが不安定になる問題。\n\n## 再現手順\n\n1. `/worktree-setup 123` でWorktree環境を作成\n2. Worktreeディレクトリで `npm run dev` を実行（ポート3000）\n3. `/worktree-cleanup 123` を実行\n4. サーバーが `ENOENT` エラーを連発\n\n## 発生するエラー\n\n```\nError: ENOENT: no such file or directory, scandir \n'/Users/.../commandmate-issue-123/src/app'\n```\n\n## 根本原因\n\n- `npm run dev` で直接起動したサーバーはPIDファイル（`~/.commandmate/pids/{issueNo}.pid`）を作成しない\n- クリーンアップスクリプトはPIDファイルのみを確認するため、稼働中のサーバーを検出できない\n- Worktreeディレクトリが削除されると、Next.jsファイルウォッチャーが `src/app` をスキャンできずエラー発生\n\n## 期待される動作\n\nWorktreeから起動中のサーバー（ポート使用中）を検出し、ディレクトリ削除前に停止する。\n\n---\n\n## 検出対象ポート\n\n| パターン | ポート | 起動方法 |\n|---------|--------|---------|\n| デフォルト | 3000 | `npm run dev` |\n| Issue専用（規約） | 3{issueNo} (例: 3123) | `commandmate start --issue` |\n| 自動割り当て | 3001-3100 | `commandmate start --auto-port` |\n\n---\n\n## 推奨される改善策\n\n### Phase 2改善案: ポートとプロセスの作業ディレクトリを確認\n\n```bash\nWORKTREE_DIR=\"../commandmate-issue-${ISSUE_NO}\"\nWORKTREE_ABS=$(cd \"$WORKTREE_DIR\" 2>/dev/null && pwd)\n\n# チェック対象ポート（デフォルト + Issue専用）\nPORTS_TO_CHECK=(3000)\n# Issue専用ポート（例: Issue #123 → 3123）\nif [ ${#ISSUE_NO} -le 3 ]; then\n  PORTS_TO_CHECK+=(\"3${ISSUE_NO}\")\nfi\n\nstop_server_by_port() {\n  local PORT=$1\n  local PID=$(lsof -ti:$PORT 2>/dev/null | head -1)\n  \n  if [ -z \"$PID\" ]; then\n    return 1\n  fi\n  \n  # cwdを取得（OS判定）\n  if [[ \"$(uname)\" == \"Darwin\" ]]; then\n    PROC_CWD=$(lsof -p \"$PID\" 2>/dev/null | grep cwd | awk '{print $NF}')\n  else\n    PROC_CWD=$(readlink -f /proc/$PID/cwd 2>/dev/null)\n  fi\n  \n  # Worktreeディレクトリからの起動か確認\n  if [[ -n \"$WORKTREE_ABS\" && \"$PROC_CWD\" == \"$WORKTREE_ABS\"* ]]; then\n    echo \"⚠️  Found server running from worktree on port $PORT (PID: $PID)\"\n    echo \"   CWD: $PROC_CWD\"\n    read -p \"   Stop this server? [Y/n] \" -n 1 -r\n    echo\n    if [[ ! $REPLY =~ ^[Nn]$ ]]; then\n      echo \"   Stopping server (SIGTERM)...\"\n      kill \"$PID\" 2>/dev/null\n      sleep 3\n      if kill -0 \"$PID\" 2>/dev/null; then\n        echo \"   Server did not stop, sending SIGKILL...\"\n        kill -9 \"$PID\" 2>/dev/null\n      fi\n      echo \"   ✅ Server stopped\"\n    fi\n  fi\n}\n\n# 既存のPIDファイル確認（commandmate startで起動した場合）\nPID_FILE=~/.commandmate/pids/${ISSUE_NO}.pid\nif [ -f \"$PID_FILE\" ]; then\n  PID=$(cat \"$PID_FILE\")\n  if kill -0 \"$PID\" 2>/dev/null; then\n    echo \"Stopping server for Issue #${ISSUE_NO} (PID: $PID)...\"\n    kill \"$PID\"\n    sleep 2\n    kill -0 \"$PID\" 2>/dev/null && kill -9 \"$PID\"\n  fi\n  rm -f \"$PID_FILE\"\nfi\n\n# ポートベースの検出（npm run devで起動した場合）\nif [ -n \"$WORKTREE_ABS\" ]; then\n  for PORT in \"${PORTS_TO_CHECK[@]}\"; do\n    stop_server_by_port \"$PORT\"\n  done\nfi\n```\n\n---\n\n## エッジケース\n\n| ケース | 期待動作 |\n|--------|---------|\n| 複数ポートで同一Worktreeからサーバー起動 | 全サーバーを検出・停止 |\n| サーバーがハングしてSIGTERMで停止不可 | 3秒待機後SIGKILLで強制終了 |\n| Worktreeディレクトリが既に削除済み | スキップ（エラーにしない） |\n| ポート検出でlsofがインストールされていない | 警告を表示し、手動停止を促す |\n| 無関係なプロセスがポート使用中 | cwd検証により誤停止を防止 |\n\n---\n\n## 影響範囲\n\n- `/worktree-cleanup` スキル（`.claude/commands/worktree-cleanup.md`）\n- 関連: `/worktree-setup` スキル\n\n---\n\n## セキュリティ考慮事項\n\n| ID | 対策 | 説明 |\n|----|------|------|\n| SEC-001 | Issue番号検証 | 正の整数、1-999999範囲（コマンドインジェクション防止） |\n| SEC-002 | パス検証 | `~/.commandmate/`内のみ許可 |\n| SEC-003 | cwd検証 | プロセス停止前にWorktreeパスとマッチング（誤停止防止） |\n| SEC-004 | 権限制限 | kill対象は現在ユーザーのプロセスのみ（権限昇格なし） |\n| SEC-005 | インジェクション防止 | ポート番号は整数検証済み |\n\n---\n\n## 受け入れ条件\n\n- [ ] Worktreeから `npm run dev` で起動したサーバーを検出できること\n- [ ] Worktree削除前にサーバーが停止されること\n- [ ] Issue専用ポート（3{issueNo}形式）も検出対象に含まれること\n- [ ] サーバー停止時にユーザーへ通知されること\n- [ ] macOS/Linux両環境で動作すること\n- [ ] 無関係なプロセス（他のWorktree/プロジェクト）を誤停止しないこと\n- [ ] Graceful shutdown（SIGTERM）を試行後、必要に応じてSIGKILLを使用すること\n- [ ] lsofが利用不可の場合、警告メッセージを表示すること\n\n---\n\n## テスト計画\n\n### 手動テスト\n\n1. **基本動作確認**\n   - `/worktree-setup 999` → `cd ../commandmate-issue-999 && npm run dev` → `/worktree-cleanup 999`\n   - サーバーが検出・停止され、Worktreeが正常に削除されること\n\n2. **Issue専用ポート確認**\n   - `commandmate start --issue 123 --port 3123` → `/worktree-cleanup 123`\n   - 両方のサーバー（PIDファイル + ポート検出）が停止されること\n\n3. **誤停止防止確認**\n   - メインリポジトリで `npm run dev`（ポート3000）→ `/worktree-cleanup 123`\n   - メインリポジトリのサーバーは停止されないこと\n\n4. **Linux環境確認**\n   - Docker等でLinux環境を用意し、同様のテストを実施","title":"fix: worktree-cleanup がWorktreeから起動中のサーバーを検出できない"}
