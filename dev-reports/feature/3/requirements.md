# Issue #4: 複数SWE CLI対応 - 要件定義

## 概要
現在、MyCodeBranchDeskはClaude Code CLIのみをサポートしていますが、複数のSWE（Software Engineering）CLIツールに対応し、ユーザーが用途に応じて最適なツールを選択できるようにします。

## 背景・目的
- 各SWE CLIツールには、それぞれ得意とするタスクや特性があります
- ユーザーがタスクの性質に応じて、最適なツールを選択できるようにすることで、開発効率を向上させます
- 将来的な拡張性を考慮し、新しいSWE CLIツールにも容易に対応できるアーキテクチャを設計します

## 対応するSWE CLIツール

### 1. Claude Code (既存)
- 現在サポート中
- 汎用的なソフトウェア開発タスクに対応

### 2. Codex CLI (新規)
- OpenAIのCodexを使用したCLIツール
- 特定のタスクに強みを持つ

### 3. Gemini CLI (新規)
- GoogleのGeminiを使用したCLIツール
- 特定のタスクに強みを持つ

## 機能要件

### 1. CLIツール選択機能
- **FR-1.1**: Worktreeごとに使用するSWE CLIツールを選択できる
- **FR-1.2**: デフォルトのCLIツールを設定できる（グローバル設定）
- **FR-1.3**: 選択したCLIツールが視覚的に識別できる（アイコンやバッジ表示）

### 2. CLIツール抽象化レイヤー
- **FR-2.1**: 各CLIツールの共通インターフェースを定義
- **FR-2.2**: CLIツール固有の実装を分離
- **FR-2.3**: CLIツールの切り替えが容易に行える

### 3. セッション管理
- **FR-3.1**: 各CLIツールごとに独立したtmuxセッションを管理
- **FR-3.2**: セッション名にCLIツール識別子を含める（例: `mcbd-claude-feature-foo`, `mcbd-codex-feature-foo`）
- **FR-3.3**: CLIツールの実行状態を追跡・表示

### 4. メッセージ送受信
- **FR-4.1**: 各CLIツールに対してメッセージを送信できる
- **FR-4.2**: 各CLIツールからのレスポンスを統一的に処理
- **FR-4.3**: CLIツール固有のプロンプト形式に対応

### 5. UI/UX
- **FR-5.1**: Worktreeカードに使用中のCLIツールを表示
- **FR-5.2**: Worktree詳細画面でCLIツールを切り替え可能
- **FR-5.3**: CLIツール選択時に、そのツールの特性や推奨用途を表示

### 6. 設定管理
- **FR-6.1**: 各CLIツールのインストール状態を確認
- **FR-6.2**: 各CLIツールの設定（パス、オプション等）を管理
- **FR-6.3**: CLIツールごとの環境変数設定

## 非機能要件

### 1. パフォーマンス
- **NFR-1.1**: CLIツールの切り替えは5秒以内に完了する
- **NFR-1.2**: 複数のCLIツールが同時に実行中でも、システムが安定動作する

### 2. 拡張性
- **NFR-2.1**: 新しいSWE CLIツールの追加が容易である
- **NFR-2.2**: プラグイン形式でCLIツールを追加できる設計

### 3. 互換性
- **NFR-3.1**: 既存のClaude Code利用環境との後方互換性を維持
- **NFR-3.2**: 既存のWorktreeデータやメッセージ履歴は引き続き利用可能

### 4. 可用性
- **NFR-4.1**: あるCLIツールが利用不可でも、他のツールは正常に動作する
- **NFR-4.2**: CLIツールの不具合時に適切なエラーメッセージを表示

## データモデル変更

### Worktreeモデル拡張
```typescript
export interface Worktree {
  // ... 既存フィールド

  /** 使用するSWE CLIツール (claude, codex, gemini) */
  swe_cli?: 'claude' | 'codex' | 'gemini';
}
```

### 新規: CLIToolConfigモデル
```typescript
export interface CLIToolConfig {
  /** CLIツールID */
  id: string;
  /** 表示名 */
  name: string;
  /** コマンド名 */
  command: string;
  /** インストール確認コマンド */
  checkCommand: string;
  /** 有効/無効 */
  enabled: boolean;
  /** アイコンまたは識別子 */
  icon?: string;
  /** 説明 */
  description?: string;
}
```

## 実装フェーズ

### Phase 1: 基盤整備（第1週）
1. CLIツール抽象化レイヤーの設計・実装
2. データベーススキーマの拡張（worktreesテーブルにswe_cliカラム追加）
3. 既存コードのリファクタリング（Claude Code依存部分の分離）

### Phase 2: Codex CLI対応（第2週）
1. Codex CLIインターフェース実装
2. Codex用セッション管理
3. Codex用メッセージ送受信

### Phase 3: Gemini CLI対応（第3週）
1. Gemini CLIインターフェース実装
2. Gemini用セッション管理
3. Gemini用メッセージ送受信

### Phase 4: UI/UX実装（第4週）
1. CLIツール選択UI
2. CLIツール表示・切り替え機能
3. 設定画面

### Phase 5: テスト・調整（第5週）
1. 統合テスト
2. パフォーマンステスト
3. バグ修正・調整

## 技術的課題と検討事項

### 1. CLIツールの互換性
- **課題**: 各CLIツールのコマンド形式、オプション、レスポンス形式が異なる
- **検討**: アダプターパターンを使用して、各CLIツールの差異を吸収

### 2. セッション管理
- **課題**: 複数のCLIツールが同時に実行される可能性
- **検討**: セッション名の命名規則を明確化（`mcbd-{cli_tool}-{worktree_id}`）

### 3. エラーハンドリング
- **課題**: CLIツールごとにエラー形式が異なる
- **検討**: 統一的なエラーハンドリング機構を実装

### 4. 設定管理
- **課題**: 各CLIツールの設定方法が異なる
- **検討**: 設定ファイル形式の統一、または各ツール用の設定インターフェース

## 成功基準

1. ユーザーがWorktreeごとにClaude Code、Codex CLI、Gemini CLIを選択できる
2. 選択したCLIツールで正常にメッセージの送受信ができる
3. CLIツールを切り替えても、既存のメッセージ履歴が保持される
4. 新しいSWE CLIツールを追加する際の実装時間が2日以内
5. 既存のClaude Code利用環境で問題なく動作する

## リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| Codex CLI、Gemini CLIのAPIやコマンド仕様が不明確 | 高 | 事前調査を実施、必要に応じてモックを使用 |
| 既存機能への影響 | 中 | 段階的な実装、十分なテスト |
| パフォーマンス低下 | 中 | プロファイリング、最適化 |
| CLIツールのインストール・設定が複雑 | 低 | 詳細なドキュメント作成、セットアップスクリプト提供 |

## 参考資料
- Issue #4: https://github.com/Kewton/MyCodeBranchDesk/issues/4
- Claude Code: https://claude.com/claude-code
- Codex CLI: （調査が必要）
- Gemini CLI: （調査が必要）

## 備考
- 実装前に、Codex CLIとGemini CLIの実際の動作確認が必要
- 各CLIツールのライセンス、利用規約を確認
- 将来的には、カスタムCLIツールの追加もサポートできる設計が望ましい
