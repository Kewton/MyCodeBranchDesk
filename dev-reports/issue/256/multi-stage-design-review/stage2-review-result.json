{
  "issue_number": 256,
  "focus_area": "整合性",
  "stage": 2,
  "stage_name": "整合性レビュー",
  "status": "needs_major_changes",
  "score": 2,
  "findings": {
    "must_fix": [
      {
        "id": "MF-S2-001",
        "title": "isQuestionLikeLine() Pattern 2（行内?チェック）が未実装",
        "description": "設計方針書 5.2 では isQuestionLikeLine() に Pattern 2（行内 ? / ？ チェック: line.includes('?') || line.includes('？')）を追加すると記載されているが、現在の実装（prompt-detector.ts L315-332）には Pattern 1（endsWith チェック）と Pattern 2（colon + keyword、設計書では Pattern 3 に番号変更予定）のみが存在し、行内 ? チェックが存在しない。",
        "design_section": "5.2 パターンA対応: 行内の ?/？ チェック",
        "source_location": "src/lib/prompt-detector.ts L315-332 (isQuestionLikeLine)",
        "severity": "high"
      },
      {
        "id": "MF-S2-002",
        "title": "findQuestionLineInRange() 関数が未実装",
        "description": "設計方針書 5.3 では SEC-001b ガード内の上方走査ロジックを独立関数 findQuestionLineInRange() として抽出すると記載されているが（SF-003対応）、現在のコードベースにこの関数は存在しない。grep の結果も一致なし。",
        "design_section": "5.3 パターンB対応: SEC-001bガード内の上方走査 / [SF-003対応]",
        "source_location": "src/lib/prompt-detector.ts - 関数が存在しない",
        "severity": "high"
      },
      {
        "id": "MF-S2-003",
        "title": "QUESTION_SCAN_RANGE 定数が未実装",
        "description": "設計方針書 5.3 では QUESTION_SCAN_RANGE = 3 定数（SF-002ガイドライン付きJSDoc含む）を定義すると記載されているが、現在のコードベースにこの定数は存在しない。",
        "design_section": "5.3 設計定数",
        "source_location": "src/lib/prompt-detector.ts - 定数が存在しない",
        "severity": "high"
      },
      {
        "id": "MF-S2-004",
        "title": "SEC-001b ガードの上方走査ロジックが未実装",
        "description": "設計方針書 5.3 では SEC-001b ガード内で isQuestionLikeLine() 失敗時に findQuestionLineInRange() を呼び出す上方走査を実装すると記載されているが、現在の実装（prompt-detector.ts L514-529）は単純に isQuestionLikeLine() が false なら即座に noPromptResult() を返す。上方走査のフォールバックが存在しない。",
        "design_section": "5.3 SEC-001bガードの更新",
        "source_location": "src/lib/prompt-detector.ts L522-528 (SEC-001b guard)",
        "severity": "high"
      },
      {
        "id": "MF-S2-005",
        "title": "Pass 2 逆スキャンループ内の isQuestionLikeLine() 先行チェックが未実装（MF-001対応）",
        "description": "設計方針書 5.5 [MF-001対応] では、Pass 2 逆スキャンループの non-option line handling 部分で、isContinuationLine() の手前に isQuestionLikeLine() チェックを追加し、質問行が continuation line として誤分類されるのを防ぐと記載されている。現在の実装（L482-495）では isContinuationLine() のみが呼ばれており、isQuestionLikeLine() の先行チェックがない。",
        "design_section": "5.5 [MF-001対応] isContinuationLine() との相互作用",
        "source_location": "src/lib/prompt-detector.ts L482-495 (Pass 2 non-option line handling)",
        "severity": "high"
      },
      {
        "id": "MF-S2-006",
        "title": "設計方針書記載の全新規テストケースが未実装",
        "description": "設計方針書 9.1 に記載された新規テストケース（T-256-A1~A3, T-256-B1~B2, T-256-FP1~FP2, T-256-CL1, T-256-FQ1~FQ4, T-256-BC1~BC3）が全て未実装。テストファイル内に 'T-256' や 'T256' の文字列は存在しない。",
        "design_section": "9. テスト設計",
        "source_location": "tests/unit/prompt-detector.test.ts - テストケースが存在しない",
        "severity": "high"
      }
    ],
    "should_fix": [],
    "consider": [
      {
        "id": "C-S2-001",
        "title": "isContinuationLine() のコードは現時点で設計方針書と整合的（変更不要）",
        "description": "設計方針書 5.5 の MF-001 対応では isContinuationLine() のコードを一切変更しないと明記されている。現在の実装はこの要件に適合している。実装時にこの制約が維持されることを確認する必要がある。",
        "design_section": "5.5 MF-001対応",
        "source_location": "src/lib/prompt-detector.ts L381-395 (isContinuationLine)"
      },
      {
        "id": "C-S2-002",
        "title": "影響範囲ファイルの確認 - 現時点で変更不要の整合性は確認済み",
        "description": "設計方針書 11 章の「変更不要だが影響確認必要なファイル」（auto-yes-manager.ts, auto-yes-resolver.ts, response-poller.ts, status-detector.ts, current-output/route.ts, prompt-response/route.ts）は全て detectPrompt() を呼び出す側であり、detectPrompt() の内部改善のみで外部インターフェースに変更がないため、実装後も変更不要であることが確認できる。",
        "design_section": "11. 変更対象ファイル一覧",
        "source_location": "各影響範囲ファイル"
      }
    ]
  },
  "risk_assessment": {
    "technical": "high",
    "security": "medium",
    "operational": "low"
  },
  "reviewed_files": [
    "src/lib/prompt-detector.ts",
    "tests/unit/prompt-detector.test.ts",
    "src/lib/auto-yes-manager.ts",
    "src/lib/response-poller.ts",
    "src/lib/status-detector.ts",
    "dev-reports/design/issue-256-multiple-choice-prompt-detection-design-policy.md"
  ],
  "consistency_matrix": {
    "total_design_items": 10,
    "implemented": 0,
    "partially_implemented": 0,
    "not_implemented": 10,
    "items": [
      {
        "design_item": "isQuestionLikeLine() Pattern 2 (行内?チェック)",
        "design_section": "5.2",
        "status": "not_implemented",
        "gap": "Pattern 2 が存在しない"
      },
      {
        "design_item": "QUESTION_SCAN_RANGE 定数",
        "design_section": "5.3",
        "status": "not_implemented",
        "gap": "定数が存在しない"
      },
      {
        "design_item": "findQuestionLineInRange() 関数",
        "design_section": "5.3",
        "status": "not_implemented",
        "gap": "関数が存在しない"
      },
      {
        "design_item": "SEC-001b 上方走査ロジック",
        "design_section": "5.3",
        "status": "not_implemented",
        "gap": "上方走査フォールバックが存在しない"
      },
      {
        "design_item": "Pass 2 isQuestionLikeLine() 先行チェック (MF-001)",
        "design_section": "5.5",
        "status": "not_implemented",
        "gap": "先行チェックが存在しない"
      },
      {
        "design_item": "isContinuationLine() 変更なし (MF-001)",
        "design_section": "5.5",
        "status": "not_implemented",
        "gap": "変更なしの制約は現時点で適合（実装前の状態）"
      },
      {
        "design_item": "T-256-A1~A3 テストケース (パターンA)",
        "design_section": "9.1",
        "status": "not_implemented",
        "gap": "テストが存在しない"
      },
      {
        "design_item": "T-256-B1~B2 テストケース (パターンB)",
        "design_section": "9.1",
        "status": "not_implemented",
        "gap": "テストが存在しない"
      },
      {
        "design_item": "T-256-FP1~FP2, CL1 テストケース (FP防止, CL相互作用)",
        "design_section": "9.1",
        "status": "not_implemented",
        "gap": "テストが存在しない"
      },
      {
        "design_item": "T-256-FQ1~FQ4, BC1~BC3 テストケース (単体, 境界)",
        "design_section": "9.1",
        "status": "not_implemented",
        "gap": "テストが存在しない"
      }
    ]
  },
  "timestamp": "2026-02-13T17:10:00+09:00"
}
