{
  "issue_number": 94,
  "stage": 4,
  "stage_name": "セキュリティレビュー",
  "applied_at": "2026-01-30T00:00:00Z",
  "target_file": "dev-reports/design/issue-94-file-upload-design-policy.md",
  "applied_items": [
    {
      "id": "SEC-001",
      "severity": "must_fix",
      "category": "MIMEタイプ検証",
      "owasp_category": "A04:2021 - Insecure Design",
      "changes": [
        "MagicBytesDefinition インターフェースを追加（セクション3.2）",
        "UploadableExtensionValidator に magicBytes プロパティを追加",
        "validateMagicBytes() 関数を追加（セクション3.2）",
        "画像形式のマジックバイト定義を追加（PNG, JPEG, GIF, WebP）",
        "セクション4.3 にマジックバイト検証の説明を追加",
        "データフロー（セクション2.2）にマジックバイト検証ステップを追加",
        "エラーコード INVALID_MAGIC_BYTES を追加（セクション3.1）",
        "テストケースを追加（セクション7.1, 7.2）",
        "実装チェックリストに追加（Phase 1, 3, 5）"
      ]
    },
    {
      "id": "SEC-002",
      "severity": "must_fix",
      "category": "SVGファイル",
      "owasp_category": "A03:2021 - Injection",
      "changes": [
        "UPLOADABLE_EXTENSION_VALIDATORS から SVG を除外（コメントアウトで理由記載）",
        "セクション4.4 にSVG除外の理由と将来的な対応方針を追加",
        "テストケースを追加（.svg が拒否されることを確認）",
        "セクション3.2 に [SEC-002] コメントを追加"
      ]
    },
    {
      "id": "SEC-003",
      "severity": "should_fix",
      "category": "DoS攻撃耐性",
      "owasp_category": "A05:2021 - Security Misconfiguration",
      "changes": [
        "セクション4.5 に DoS攻撃耐性強化の軽減策を追加",
        "route segment config の設定例を追加",
        "将来的改善案としてレートリミット導入を記載",
        "実装チェックリストに route segment config 検討を追加"
      ]
    },
    {
      "id": "SEC-004",
      "severity": "should_fix",
      "category": "ファイル名検証",
      "owasp_category": "A03:2021 - Injection",
      "changes": [
        "セクション4.2 の isValidNewName() を大幅に拡張",
        "全制御文字（ASCII 0x00-0x1F）チェックを追加",
        "OS固有の禁止文字（<>:\"|?*）チェックを追加",
        "先頭/末尾のスペース・ドットチェックを追加",
        "CONTROL_CHARS と OS_FORBIDDEN_CHARS 定数を追加",
        "エラーコード INVALID_FILENAME を追加（セクション3.1）",
        "テストケースを追加（セクション7.1, 7.2）",
        "実装チェックリストに追加（Phase 1, 3, 5）"
      ]
    },
    {
      "id": "SEC-005",
      "severity": "should_fix",
      "category": "エラーメッセージ",
      "owasp_category": "A01:2021 - Broken Access Control",
      "changes": [
        "セクション4.7 を新規追加（エラーメッセージのセキュリティ）",
        "セクション5.2 のエラーメッセージから具体的な拡張子情報を除去",
        "セクション3.1 のレスポンス定義にコメント追加",
        "セクション5.1 にクライアント側検証の位置づけを明記",
        "実装チェックリストに追加（Phase 1, 3）"
      ]
    },
    {
      "id": "SEC-006",
      "severity": "should_fix",
      "category": "YAMLファイル",
      "owasp_category": "A03:2021 - Injection",
      "changes": [
        "セクション4.6 を新規追加（構造化ファイルの検証）",
        "isYamlSafe() 関数を追加（セクション3.2）",
        "危険なYAMLタグのパターンリストを定義",
        "テストケースを追加（セクション7.1, 7.2）",
        "実装チェックリストに追加（Phase 1, 3, 5）"
      ]
    },
    {
      "id": "SEC-007",
      "severity": "should_fix",
      "category": "JSONファイル",
      "owasp_category": "A08:2021 - Software and Data Integrity Failures",
      "changes": [
        "セクション4.6 に JSON構文検証を追加",
        "isJsonValid() 関数を追加（セクション3.2）",
        "テストケースを追加（セクション7.1, 7.2）",
        "実装チェックリストに追加（Phase 1, 3, 5）"
      ]
    }
  ],
  "skipped_items": [
    {
      "id": "SEC-008",
      "severity": "nice_to_have",
      "category": "アクセス制御",
      "reason": "nice_to_have のため初期実装ではスキップ。既存のCM_AUTH_TOKENによる認証が適用されており、追加の認可設計は将来課題とする"
    },
    {
      "id": "SEC-009",
      "severity": "nice_to_have",
      "category": "ログ・監査",
      "reason": "nice_to_have のため初期実装ではスキップ。ログ出力設計は将来課題とする"
    },
    {
      "id": "SEC-010",
      "severity": "nice_to_have",
      "category": "ファイル整合性",
      "reason": "nice_to_have のため初期実装ではスキップ。チェックサム検証は将来課題とする"
    },
    {
      "id": "SEC-011",
      "severity": "nice_to_have",
      "category": "拡張子偽装",
      "reason": "nice_to_have のため初期実装ではスキップ。SEC-001のマジックバイト検証で基本的な対策は実施済み"
    }
  ],
  "changes_made": {
    "summary": "Stage 4 セキュリティレビューの must_fix 2件と should_fix 5件を設計方針書に反映",
    "sections_updated": [
      "1.2 スコープ（マジックバイト検証を追加）",
      "2.1 システム構成図（magic-bytes検証、validateMagicBytes()を追加）",
      "2.2 データフロー（マジックバイト検証ステップ、ファイル名検証を追加）",
      "3.1 新規APIエンドポイント（エラーコード追加、エラーメッセージ修正）",
      "3.2 新規設定ファイル（MagicBytesDefinition, validateMagicBytes, isYamlSafe, isJsonValid追加、SVG除外）",
      "4.2 ファイル名検証（SEC-004対応で大幅拡張）",
      "4.3 MIMEタイプ検証（マジックバイト検証の説明追加）",
      "4.4 拡張子検証方針（SVG除外の詳細説明追加）",
      "4.5 ファイルサイズ制限（DoS攻撃耐性強化を追加）",
      "4.6 構造化ファイルの検証（新規セクション: YAML, JSON検証）",
      "4.7 エラーメッセージのセキュリティ（新規セクション）",
      "5.2 サーバー側エラー（エラーメッセージ修正、新エラーコード追加）",
      "7.1 単体テスト（マジックバイト、YAML、JSON、ファイル名検証テスト追加）",
      "7.2 結合テスト（セキュリティ関連テストケース追加）",
      "8.1 新規作成ファイル（説明更新）",
      "8.2 変更ファイル（新エラーコード追加）",
      "9.1 外部依存（マジックバイト検証の説明追加）",
      "9.2 内部依存（マジックバイト検証の依存関係追加）",
      "11.4 Stage 4 レビュー指摘事項の反映サマリー（新規セクション）",
      "12 実装チェックリスト（セキュリティ関連項目追加）"
    ],
    "new_sections": [
      "4.6 構造化ファイルの検証",
      "4.7 エラーメッセージのセキュリティ",
      "11.4 Stage 4 (セキュリティレビュー)"
    ],
    "new_interfaces": [
      "MagicBytesDefinition"
    ],
    "new_functions": [
      "validateMagicBytes()",
      "isYamlSafe()",
      "isJsonValid()"
    ],
    "new_error_codes": [
      "INVALID_MAGIC_BYTES",
      "INVALID_FILENAME",
      "INVALID_FILE_CONTENT"
    ],
    "removed_from_allowlist": [
      ".svg"
    ]
  },
  "validation": {
    "must_fix_applied": 2,
    "must_fix_total": 2,
    "should_fix_applied": 5,
    "should_fix_total": 5,
    "nice_to_have_skipped": 4
  }
}
