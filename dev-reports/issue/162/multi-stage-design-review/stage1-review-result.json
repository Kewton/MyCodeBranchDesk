{
  "issue_number": 162,
  "focus_area": "設計原則",
  "stage": 1,
  "stage_name": "通常レビュー",
  "status": "conditionally_approved",
  "score": 4,
  "findings": {
    "must_fix": [
      {
        "id": "MF-001",
        "principle": "DRY",
        "title": "moveFileOrDirectory() と renameFileOrDirectory() のコード重複",
        "description": "設計書の moveFileOrDirectory() はパス検証、存在チェック、isPathSafe()呼び出し、エラーハンドリングなど renameFileOrDirectory() と大幅に重複するロジックを持つ。共通バリデーションロジックを内部ヘルパー関数に抽出すべき。",
        "location": "src/lib/file-operations.ts",
        "recommendation": "validateFileOperation(worktreeRoot, sourcePath) のような内部ヘルパー関数を作成し、パス検証・存在チェック・パーミッションエラーハンドリングの共通処理を抽出する。moveFileOrDirectory() と renameFileOrDirectory() の両方からこのヘルパーを呼び出す。",
        "severity": "medium"
      },
      {
        "id": "MF-002",
        "principle": "SRP / KISS",
        "title": "WorktreeDetailRefactored への handleMove 追加による肥大化",
        "description": "WorktreeDetailRefactored.tsx は既に2100行を超える巨大コンポーネントである。handleMove と MoveDialog の状態管理を追加すると、さらに肥大化しSRP違反が深刻化する。設計書は既存パターンに従って直接追加する方針だが、この既存パターン自体が問題。",
        "location": "src/components/worktree/WorktreeDetailRefactored.tsx",
        "recommendation": "ファイル操作ハンドラー群(handleNewFile, handleNewDirectory, handleRename, handleDelete, handleUpload, handleMove)をカスタムフック useFileOperations(worktreeId) に抽出する。これは既存の肥大化問題の解決にもなるが、少なくとも新規追加の handleMove はこのフック経由で追加すべき。",
        "severity": "medium"
      }
    ],
    "should_fix": [
      {
        "id": "SF-001",
        "principle": "DRY",
        "title": "formatRelativeTime() が FileTreeView 内に定義される設計",
        "description": "設計書では formatRelativeTime() を FileTreeView.tsx 内のヘルパーとして追加する方針だが、既に src/lib/date-locale.ts が存在し日付関連ユーティリティの配置先として適切。コンポーネント内にビジネスロジック的な関数を配置するとテスタビリティが低下する。",
        "location": "src/components/worktree/FileTreeView.tsx",
        "recommendation": "formatRelativeTime() を src/lib/date-utils.ts (新規) または既存の src/lib/date-locale.ts に配置し、FileTreeView からインポートする。ユニットテストも容易になる。",
        "severity": "low"
      },
      {
        "id": "SF-002",
        "principle": "KISS",
        "title": "MoveDialog のディレクトリツリー取得が tree API を再利用する設計の複雑さ",
        "description": "MoveDialog は既存の tree API を利用してディレクトリ一覧を取得し、ディレクトリのみフィルタして表示する。しかし tree API はファイルも含む全エントリを返すため、クライアント側フィルタリングが必要になる。ディレクトリ数が多い場合のUXも考慮が必要。",
        "location": "src/components/worktree/MoveDialog.tsx",
        "recommendation": "tree API にクエリパラメータ ?type=directory を追加してサーバー側フィルタリングをサポートすることを検討する。ただし、YAGNI観点では現行設計(クライアント側フィルタ)でも許容範囲。初回実装はクライアント側フィルタで進め、パフォーマンス問題が発生した場合にサーバー側フィルタを追加する。",
        "severity": "low"
      },
      {
        "id": "SF-003",
        "principle": "OCP (Open/Closed)",
        "title": "PATCH ハンドラーの action 分岐が if/else チェーンになる可能性",
        "description": "現在の PATCH ハンドラーは action === 'rename' のみを処理する。action === 'move' を追加すると if-else チェーンになり、将来さらにアクションが追加された場合にOCP違反となる。",
        "location": "src/app/api/worktrees/[id]/files/[...path]/route.ts",
        "recommendation": "アクションハンドラーマップ (Record<string, handler>) を導入してディスパッチパターンにする。例: const ACTION_HANDLERS: Record<string, (worktree, path, body) => Promise<Result>> = { rename: handleRename, move: handleMove }; ただし現時点では2アクションのみなのでswitch文でも許容範囲。3つ目のアクション追加時にリファクタリングする方針でも良い。",
        "severity": "low"
      },
      {
        "id": "SF-004",
        "principle": "DRY",
        "title": "i18n キーの名前空間配置",
        "description": "設計書では fileTree キーを common.json に追加する方針だが、既存の common.json は汎用的なキー(cancel, confirm, delete等)を格納する名前空間。ファイル操作固有のキーは別の名前空間(例: worktree.json の fileTree セクション)に配置する方が一貫性がある。",
        "location": "locales/en/common.json, locales/ja/common.json",
        "recommendation": "fileTree 関連のキーを locales/en/worktree.json と locales/ja/worktree.json に配置する。既存の worktree.json が worktree 機能の翻訳を担当しているため、そこに fileTree セクションを追加する方が一貫性がある。",
        "severity": "low"
      }
    ],
    "consider": [
      {
        "id": "CO-001",
        "principle": "YAGNI",
        "title": "mtime フィールドの必要性",
        "description": "設計書では TreeItem に birthtime と mtime の両方を追加するが、UI表示で使用されるのは birthtime(作成時刻)のみ。mtime は設計書の表示フォーマット例にも登場しない。YAGNI原則に従えば、現時点で使用しない mtime の追加は不要。",
        "location": "src/types/models.ts, src/lib/file-tree.ts",
        "recommendation": "初回実装では birthtime のみを追加する。mtime が必要になった時点(例: ソート機能追加時)に追加する。ただし、lstat() から取得するデータなので追加コストは極めて低く、将来の拡張性を考慮して mtime も含める判断も合理的。"
      },
      {
        "id": "CO-002",
        "principle": "KISS",
        "title": "ツールチップによる正確な日時表示の将来対応",
        "description": "設計書の Section 8 で「正確な日時が不明(ツールチップで補完可能だが今回は未実装)」と記載。相対時間のみの表示はUX上十分だが、ツールチップ実装が将来必要になる可能性がある場合、title 属性に ISO 文字列を設定する最小実装を検討。",
        "location": "src/components/worktree/FileTreeView.tsx",
        "recommendation": "TreeNode で時刻表示する span 要素に title={item.birthtime} を設定するだけでブラウザネイティブのツールチップが表示される。コスト極小で将来の改善が不要になる可能性がある。"
      },
      {
        "id": "CO-003",
        "principle": "ISP (Interface Segregation)",
        "title": "MoveDialogProps の sourceType パラメータ",
        "description": "MoveDialogProps に sourceType: 'file' | 'directory' が含まれるが、設計書の記述からはこの情報がダイアログの動作にどう影響するかが不明確。ダイアログの表示テキストを変えるだけなら i18n キーで対応可能であり、Props として公開する必要性が低い。",
        "location": "src/components/worktree/MoveDialog.tsx",
        "recommendation": "sourceType が MoveDialog の動作(バリデーション等)に影響するならそのまま維持。表示テキストのみに影響するなら、sourcePath からの推論(ディレクトリなら / で終わるなど)で代替可能か検討する。"
      }
    ],
    "compliant": [
      {
        "id": "CP-001",
        "principle": "SRP",
        "title": "MoveDialog を独立コンポーネントとして設計",
        "description": "移動先ディレクトリ選択を MoveDialog として分離する設計は SRP に準拠。既存の Modal コンポーネントを再利用する点も良い。"
      },
      {
        "id": "CP-002",
        "principle": "DRY",
        "title": "既存の copyToClipboard() 再利用",
        "description": "ファイル内容コピー機能で既存の clipboard-utils.ts の copyToClipboard() を再利用する設計は DRY 原則に完全準拠。ANSI エスケープコード除去も既存実装でカバー済み。"
      },
      {
        "id": "CP-003",
        "principle": "DRY",
        "title": "createErrorResult() の共通利用",
        "description": "moveFileOrDirectory() が既存の createErrorResult() を利用する設計は DRY に準拠。"
      },
      {
        "id": "CP-004",
        "principle": "KISS",
        "title": "fs.rename() による移動実装",
        "description": "Node.js の fs.rename() を使用した移動は最もシンプルな実装。Worktree 内移動のみのスコープでは異なるファイルシステム間の移動を考慮する必要がなく、KISS に準拠。"
      },
      {
        "id": "CP-005",
        "principle": "Security Design",
        "title": "MOVE_INTO_SELF エラーコードの追加",
        "description": "ディレクトリを自身の子ディレクトリに移動する操作を防止するエラーコードの追加は、セキュリティ設計として適切。"
      },
      {
        "id": "CP-006",
        "principle": "Backward Compatibility",
        "title": "TreeItem の birthtime/mtime をオプショナルフィールドとして追加",
        "description": "COMPAT-001 として明示されている通り、オプショナルフィールドとしての追加は後方互換性を維持する適切な設計。"
      },
      {
        "id": "CP-007",
        "principle": "DRY / Consistency",
        "title": "既存の ERROR_CODE_TO_HTTP_STATUS マップへの追加",
        "description": "MOVE_SAME_PATH と MOVE_INTO_SELF のHTTPステータスマッピングを既存の集中管理マップに追加する設計は、既存パターンに準拠しDRYに適合。"
      },
      {
        "id": "CP-008",
        "principle": "Consistency",
        "title": "既存の PATCH API パターンへの統合",
        "description": "PATCH ハンドラーに新しい action を追加する設計は、既存の rename アクションと同じパターンに従っており、コードベースの一貫性を維持。"
      }
    ]
  },
  "risk_assessment": {
    "technical": "low",
    "security": "low",
    "operational": "low"
  },
  "reviewed_files": [
    "dev-reports/design/issue-162-file-enhancement-design-policy.md",
    "src/lib/file-operations.ts",
    "src/lib/file-tree.ts",
    "src/types/models.ts",
    "src/lib/clipboard-utils.ts",
    "src/lib/path-validator.ts",
    "src/config/file-operations.ts",
    "src/components/worktree/FileViewer.tsx",
    "src/components/worktree/FileTreeView.tsx",
    "src/components/worktree/ContextMenu.tsx",
    "src/components/worktree/WorktreeDetailRefactored.tsx",
    "src/app/api/worktrees/[id]/files/[...path]/route.ts"
  ],
  "timestamp": "2026-02-15T00:00:00Z"
}
