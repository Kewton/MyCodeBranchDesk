{
  "bug_id": "287-bug3",
  "bug_description": "detectMultipleChoicePrompt() Pass 2 逆方向スキャンに ❯ (U+276F) バリアを追加。collectedOptions === 0 かつ行が ❯ で始まる場合にスキャンを停止し、過去の会話テキストの番号付きリスト誤検出を防止する。",
  "selected_actions": [
    {
      "action_id": "1",
      "title": "Pass 2 に ❯ バリア追加",
      "description": "src/lib/prompt-detector.ts の detectMultipleChoicePrompt() L651-701 Pass 2 ループ内、NORMAL_OPTION_PATTERN チェック後に以下を追加: if (collectedOptions.length === 0 && line の先頭が U+276F) → return noPromptResult(output)。DEFAULT_OPTION_PATTERN でマッチ済みの ❯+オプション行は先に処理されるため影響なし。",
      "files_to_modify": [
        "src/lib/prompt-detector.ts"
      ],
      "implementation_detail": {
        "location": "detectMultipleChoicePrompt() L651-701, Pass 2 ループ内、L670 の normalMatch チェック後",
        "code_change": "NORMAL_OPTION_PATTERN チェック後、既存の non-option line handling (L673) の前に、❯ バリアチェックを挿入",
        "pattern": "line.startsWith('\\u276F') — trimmed line が ❯ で始まるかチェック。DEFAULT_OPTION_PATTERN でキャッチされなかった ❯ 行はアイドルプロンプトまたはユーザー入力。"
      }
    }
  ],
  "target_coverage": 80,
  "test_scenarios": [
    "過去の会話テキスト（❯ 入力行の前に番号付きリスト）→ 誤検出されないこと (requireDefault=false)",
    "過去の会話テキスト（❯ アイドルプロンプトの前に番号付きリスト）→ 誤検出されないこと (requireDefault=false)",
    "アクティブ prompt（❯ 1. Yes / 2. No）→ 正常検出 (requireDefault=true)",
    "アクティブ prompt（requireDefault=false、❯ なしオプション）→ 正常検出",
    "既存テスト全パス"
  ]
}
