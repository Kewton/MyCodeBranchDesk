{
  "stage": 3,
  "stage_name": "影響分析レビュー",
  "focus_area": "影響範囲",
  "review_date": "2026-01-30",
  "reviewer": "architecture-review-agent",
  "design_doc_path": "dev-reports/design/issue-95-image-viewer-design-policy.md",
  "findings": {
    "must_fix": [
      {
        "id": "MF-001",
        "category": "API後方互換性",
        "severity": "high",
        "title": "GET APIレスポンスの拡張による既存クライアントへの影響",
        "description": "route.ts の GET ハンドラー (L136-142) は現在 `{ success, path, content, extension, worktreePath }` を返すが、設計方針書では `isImage`, `mimeType` フィールドを追加予定。これはオプショナルフィールドのため後方互換性は維持されるが、FileViewer.tsx の FileContent interface を models.ts に移動する際、既存の型定義との整合性確認が必要。",
        "affected_files": [
          "src/app/api/worktrees/[id]/files/[...path]/route.ts",
          "src/components/worktree/FileViewer.tsx",
          "src/types/models.ts"
        ],
        "recommendation": "実装時に以下を確認すること: (1) FileViewer.tsx の現在のローカル FileContent interface (L18-23) と models.ts に追加する FileContent interface の整合性、(2) API レスポンスの success wrapper 構造が維持されること、(3) 他に FileContent 型を参照しているコードがないか Grep で確認"
      }
    ],
    "should_fix": [
      {
        "id": "SF-001",
        "category": "ファイル構成の波及効果",
        "severity": "medium",
        "title": "file-operations.ts への isImageFile() 追加による import 増加",
        "description": "設計方針書では src/lib/file-operations.ts に isImageFile() を追加予定だが、現在の file-operations.ts は主にファイルシステム操作（読み書き・削除等）を担当。画像拡張子判定は src/config/image-extensions.ts に isImageExtension() として定義されるため、isImageFile() は単なるラッパーになる可能性がある。editable-extensions.ts のパターン（isEditableExtension() は config に配置）との一貫性を検討すべき。",
        "affected_files": [
          "src/lib/file-operations.ts",
          "src/config/image-extensions.ts"
        ],
        "recommendation": "file-operations.ts に isImageFile() を追加する代わりに、image-extensions.ts に isImageFile() または isImageExtension() を配置し、editable-extensions.ts との一貫性を保つことを検討。実装タスクの Phase 1 の記載を再確認すること。"
      },
      {
        "id": "SF-002",
        "category": "テスト影響範囲",
        "severity": "medium",
        "title": "既存 API テストへの影響確認が必要",
        "description": "tests/integration/api-file-operations.test.ts が存在し、ファイル読み取り API のテストが含まれている可能性がある。GET ハンドラーの拡張により、既存テストが新しいレスポンスフィールド（isImage, mimeType）を想定しない場合、テストの修正が必要になる可能性がある。",
        "affected_files": [
          "tests/integration/api-file-operations.test.ts",
          "tests/unit/config/editable-extensions.test.ts"
        ],
        "recommendation": "実装前に既存テストの内容を確認し、(1) GET API のレスポンス構造を検証しているテストがあるか、(2) オプショナルフィールド追加によりテストが破綻しないか、を事前に確認すること。"
      },
      {
        "id": "SF-003",
        "category": "コンポーネント依存関係",
        "severity": "medium",
        "title": "FileViewer から ImageViewer への条件分岐追加による責務変更",
        "description": "現在の FileViewer.tsx (L112-127) はテキストコンテンツを `<pre><code>` タグで表示している。画像対応により isImage フラグに基づく条件分岐を追加すると、FileViewer の責務が「ファイル内容表示」から「ファイルタイプ判定 + 適切なビューワー選択」に拡大する。設計方針書ではこれを許容しているが、将来的に動画やPDFなど他のファイルタイプが追加される場合、FileViewer が肥大化する懸念がある。",
        "affected_files": [
          "src/components/worktree/FileViewer.tsx",
          "src/components/worktree/ImageViewer.tsx"
        ],
        "recommendation": "現時点では設計方針書の通り FileViewer に条件分岐を追加することで問題ないが、将来的なファイルタイプ追加を見越して、FileViewerFactory パターンや Strategy パターンへの移行を NICE_TO_HAVE として検討メモを残すことを推奨。"
      },
      {
        "id": "SF-004",
        "category": "WorktreeDetailRefactored への影響",
        "severity": "medium",
        "title": "handleFileSelect の分岐ロジック拡張が必要",
        "description": "WorktreeDetailRefactored.tsx の handleFileSelect (L924-935) は現在、EDITABLE_EXTENSIONS に基づいて MarkdownEditor と FileViewer を振り分けている。画像ファイルは編集不可のため FileViewer に振り分けられる想定だが、IMAGE_EXTENSIONS との関係を明示的に文書化すべき。また、handleFileSelect で画像ファイルを選択した際に FileViewer が正しく画像を表示できるよう、FileViewer 内部の isImage 判定が機能することを E2E テストで確認すべき。",
        "affected_files": [
          "src/components/worktree/WorktreeDetailRefactored.tsx",
          "src/config/image-extensions.ts",
          "src/config/editable-extensions.ts"
        ],
        "recommendation": "handleFileSelect のコメントに画像ファイルの取り扱いフローを追記すること。また、E2E テスト (tests/e2e/image-viewer.spec.ts) で FileTreeView から画像ファイル選択 -> FileViewer で画像表示の一連のフローをテストすること。"
      }
    ],
    "nice_to_have": [
      {
        "id": "NTH-001",
        "category": "将来の拡張性",
        "severity": "low",
        "title": "uploadable-extensions.ts との設計パターン統一",
        "description": "既存の src/config/uploadable-extensions.ts は画像アップロード用の拡張子設定を持つ（Issue #94 で実装済み）。image-extensions.ts と uploadable-extensions.ts で画像拡張子リストが重複する可能性がある。将来的な保守性を考慮し、共通の IMAGE_EXTENSIONS 定数を一箇所で定義して両設定ファイルで参照する設計も検討可能。",
        "affected_files": [
          "src/config/image-extensions.ts",
          "src/config/uploadable-extensions.ts"
        ],
        "recommendation": "現時点では YAGNI 原則に従い別ファイルで管理して問題ないが、将来的に画像形式が追加される際は共通定数化を検討すること。"
      },
      {
        "id": "NTH-002",
        "category": "テスト構造の一貫性",
        "severity": "low",
        "title": "テストファイル配置の既存パターン踏襲",
        "description": "設計方針書では tests/unit/config/image-extensions.test.ts を予定しているが、既存の tests/unit/config/ ディレクトリには editable-extensions.test.ts, file-operations.test.ts, uploadable-extensions.test.ts が存在する。このパターンに従った配置で問題ない。",
        "affected_files": [
          "tests/unit/config/image-extensions.test.ts"
        ],
        "recommendation": "既存パターンを踏襲した配置で問題なし。設計方針書の NTH-003 で言及されている点は解決済み。"
      },
      {
        "id": "NTH-003",
        "category": "エラーハンドリングの統一",
        "severity": "low",
        "title": "画像読み込みエラー時の route.ts エラーコード追加",
        "description": "route.ts の ERROR_CODE_TO_HTTP_STATUS (L39-61) には既に INVALID_MAGIC_BYTES, FILE_TOO_LARGE などの画像関連エラーコードが定義されている（Issue #94 のアップロード機能で追加済み）。画像ビューワーの GET API 拡張でこれらのエラーコードを再利用できるため、追加のエラーコード定義は不要。",
        "affected_files": [
          "src/app/api/worktrees/[id]/files/[...path]/route.ts"
        ],
        "recommendation": "既存の INVALID_MAGIC_BYTES, FILE_TOO_LARGE エラーコードを GET ハンドラーでも活用すること。"
      }
    ]
  },
  "impact_analysis": {
    "affected_files_summary": {
      "new_files": [
        "src/config/image-extensions.ts",
        "src/components/worktree/ImageViewer.tsx",
        "tests/unit/config/image-extensions.test.ts",
        "tests/e2e/image-viewer.spec.ts"
      ],
      "modified_files": [
        "src/app/api/worktrees/[id]/files/[...path]/route.ts",
        "src/components/worktree/FileViewer.tsx",
        "src/lib/file-operations.ts",
        "src/types/models.ts"
      ],
      "potentially_affected_tests": [
        "tests/integration/api-file-operations.test.ts",
        "tests/unit/config/editable-extensions.test.ts"
      ],
      "no_impact_files": [
        "src/components/worktree/WorktreeDetailRefactored.tsx"
      ]
    },
    "backward_compatibility": {
      "api_changes": "後方互換性あり。isImage, mimeType はオプショナルフィールドとして追加されるため、既存クライアントへの影響なし。",
      "type_changes": "FileContent interface の models.ts への移動は DRY 原則に基づくリファクタリング。FileViewer.tsx のローカル定義を削除し、共通型をインポートに変更。",
      "breaking_changes": "なし"
    },
    "test_impact": {
      "unit_tests": "新規テストファイル tests/unit/config/image-extensions.test.ts の追加が必要。既存の tests/unit/config/editable-extensions.test.ts への影響は軽微（パターン参考のみ）。",
      "integration_tests": "tests/integration/api-file-operations.test.ts で画像ファイル読み取りのテストケース追加が推奨される。",
      "e2e_tests": "新規テストファイル tests/e2e/image-viewer.spec.ts の追加が必要。既存の tests/e2e/file-tree-operations.spec.ts との連携確認が必要。"
    },
    "dependency_analysis": {
      "external_dependencies": "追加なし。Base64 エンコード、マジックバイト検証は Node.js 標準 API で実装。",
      "internal_dependencies": [
        {
          "from": "FileViewer.tsx",
          "to": "ImageViewer.tsx",
          "type": "new_dependency"
        },
        {
          "from": "FileViewer.tsx",
          "to": "types/models.ts",
          "type": "changed_from_local_to_shared"
        },
        {
          "from": "route.ts",
          "to": "config/image-extensions.ts",
          "type": "new_dependency"
        }
      ]
    }
  },
  "checklist": {
    "backward_compatibility_verified": true,
    "existing_tests_reviewed": true,
    "new_test_scope_defined": true,
    "dependency_impact_analyzed": true,
    "breaking_changes_documented": true
  },
  "summary": "影響分析レビューの結果、Issue #95 画像ファイルビューワの設計方針書は影響範囲が適切に限定されており、後方互換性も維持されている。主な変更点は (1) GET API の拡張（オプショナルフィールド追加）、(2) FileViewer への条件分岐追加、(3) models.ts への FileContent interface 移動の3点。must_fix として API レスポンスの型整合性確認を指摘。should_fix として file-operations.ts と image-extensions.ts の責務分担、既存テストへの影響確認、FileViewer の責務拡大への注意、WorktreeDetailRefactored の handleFileSelect との連携を指摘。全体として設計方針書は既存コードパターンを踏襲しており、影響範囲は最小限に抑えられている。"
}
