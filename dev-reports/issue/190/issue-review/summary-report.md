# Issue #190 マルチステージレビュー完了報告

## レビュー日時
- 開始: 2026-02-08
- 完了: 2026-02-08

## 仮説検証結果（Phase 0.5）

| # | 仮説/主張 | 判定 |
|---|----------|------|
| 1 | `syncWorktreesToDB()`は環境変数パスを毎回スキャン・upsertする | Confirmed |
| 2 | 削除されたリポジトリを記録・除外する仕組みがない | Confirmed |
| 3 | `WorktreeList.tsx`に環境変数設定リポジトリの削除時警告がある | Confirmed |
| 4 | 削除時にDBからworktreesが物理削除される | Confirmed |

全仮説が確認済み。根本原因の分析は正確。

## ステージ別結果

| Stage | レビュー種別 | 指摘数 | 対応数 | ステータス |
|-------|------------|-------|-------|----------|
| 1 | 通常レビュー（1回目） | 7 | - | ✅ |
| 2 | 指摘事項反映（1回目） | - | 7 | ✅ |
| 3 | 影響範囲レビュー（1回目） | 7 | - | ✅ |
| 4 | 指摘事項反映（1回目） | - | 7 | ✅ |
| 5 | 通常レビュー（2回目） | 6 | - | ✅ |
| 6 | 指摘事項反映（2回目） | - | 6 | ✅ |
| 7 | 影響範囲レビュー（2回目） | 5 | - | ✅ |
| 8 | 指摘事項反映（2回目） | - | 5 | ✅ |

## 統計

- **総指摘数**: 25件
- **対応完了**: 25件
- **スキップ**: 0件

### 重要度別内訳

| イテレーション | Must Fix | Should Fix | Nice to Have |
|--------------|----------|------------|-------------|
| 1回目 通常 | 2 | 3 | 2 |
| 1回目 影響範囲 | 2 | 3 | 2 |
| 2回目 通常 | 1 | 3 | 2 |
| 2回目 影響範囲 | 0 | 2 | 3 |
| **合計** | **5** | **11** | **9** |

## 主な改善点

1. **設計方針の確定**: `excluded_repositories` テーブル新設案を廃止し、既存の `repositories.enabled` カラム活用方式に一本化
2. **復活機能の定義**: 除外リポジトリの一覧表示と再登録（復活）のUI/APIフローを明確化
3. **影響範囲の網羅化**: 変更対象ファイルを5→9+ファイルに拡充、sync/route.ts・scan/route.ts・clone-manager.ts等の間接影響を追加
4. **テスト計画の充実**: テスト項目を3→13+項目に大幅拡充（冪等性、パス正規化、エラーハンドリング、E2E等）
5. **パス正規化方針の明確化**: `getRepositoryPaths()` と `scanWorktrees()` のパス形式差異への対処を明記
6. **破壊的変更の分析**: DELETE APIの挙動変化（一時的な削除→永続的な除外）を明文化
7. **API設計の統一**: 復活APIをボディベース方式に変更し既存APIと統一
8. **依存関係の可視化**: worktrees.ts→db-repository.ts等の新規依存を明示

## Issue差分サマリー

### 追加されたセクション
- 再現手順パターン2（CM_ROOT_DIR設定時）
- 対策案: 実装方針1〜7（詳細な実装ガイドライン）
- 対策案: 除外解除（復活）機能
- 影響範囲: 依存関係の変更テーブル
- 影響範囲: 破壊的変更分析テーブル
- 技術的留意事項セクション
- 拡充されたテスト計画（13+項目）

### 修正されたセクション
- 対策案: テーブル新設→既存カラム活用方式に変更
- 変更対象ファイル: 5→9+ファイルに拡充
- 実装タスク: カテゴリ分け（コア機能/復活UI・API/テスト）
- 受入条件: パス正規化、復活機能、エラーハンドリング等を追加
- 関連コンポーネント: scan/route.ts, clone-manager.ts, api-client.ts等を追加

## 次のアクション

- [ ] Issueの最終確認
- [ ] 実装開始（/tdd-impl または /pm-auto-dev）

## 関連ファイル

- 元のIssue: `dev-reports/issue/190/issue-review/original-issue.json`
- 仮説検証: `dev-reports/issue/190/issue-review/hypothesis-verification.md`
- レビュー結果: `dev-reports/issue/190/issue-review/stage{1,3,5,7}-review-result.json`
- 反映結果: `dev-reports/issue/190/issue-review/stage{2,4,6,8}-apply-result.json`

---

*Generated by multi-stage-issue-review command*
