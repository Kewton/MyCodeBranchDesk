{
  "stage": 3,
  "stage_name": "影響範囲レビュー（1回目）",
  "issue_number": 49,
  "review_date": "2026-01-30",
  "findings": {
    "must_fix": [
      {
        "id": "MF-1",
        "category": "影響ファイル",
        "issue": "既存API route.tsへのHTTPメソッド追加による破壊的変更リスク",
        "location": "技術仕様 > API設計 セクション",
        "recommendation": "既存GET APIの動作が変わらないことを明記。PUT/POST/DELETE/PATCHメソッド追加時の既存クライアントへの影響がないことを確認するテストケースをIssueに追加",
        "evidence": "現在 `src/app/api/worktrees/[id]/files/[...path]/route.ts` はGETのみ実装。同一ファイルにPUT/POST/DELETE/PATCHを追加するか、別ファイルにするかの方針が未定義"
      },
      {
        "id": "MF-2",
        "category": "依存関係",
        "issue": "FileTreeViewコンポーネントへの右クリックメニュー追加による大幅な変更",
        "location": "技術仕様 > 既存コンポーネントとの関係 セクション",
        "recommendation": "FileTreeView.tsx (465行) の変更範囲を具体化。TreeNodeコンポーネントへのcontextmenuイベント追加、状態管理の追加など、変更ポイントを明記",
        "evidence": "現在のFileTreeViewはonFileSelectコールバックのみ。右クリックメニュー実装にはcontextmenu、MenuコンポーネントUI、操作別ハンドラーの追加が必要"
      }
    ],
    "should_fix": [
      {
        "id": "SF-1",
        "category": "テスト範囲",
        "issue": "テスト対象・テスト計画の記載がない",
        "location": "Issue全体",
        "recommendation": "以下のテスト計画を受け入れ条件または別セクションに追加: (1) API新規メソッドのユニットテスト (2) FileTreeView右クリックメニューのコンポーネントテスト (3) MarkdownEditorのコンポーネントテスト (4) E2Eテスト（ファイル作成→編集→保存の一連フロー）",
        "evidence": "既存テストファイル tests/integration/api-file-tree.test.ts, tests/unit/lib/file-tree.test.ts が存在。これらの拡張が必要"
      },
      {
        "id": "SF-2",
        "category": "移行考慮",
        "issue": "WorktreeDetailRefactoredへの影響が未評価",
        "location": "技術仕様 > 既存コンポーネントとの関係 セクション",
        "recommendation": "WorktreeDetailRefactored.tsx (約1300行) がFileTreeView, FileViewerを使用している。MarkdownEditorへの切り替えロジック（mdファイル選択時の分岐）の追加箇所を明記",
        "evidence": "WorktreeDetailRefactored.tsx L751, L1150でFileTreeViewを使用、L891-901でファイル選択ハンドラーを定義。mdファイル判定ロジックの追加が必要"
      },
      {
        "id": "SF-3",
        "category": "パフォーマンス",
        "issue": "大きなmdファイル編集時のパフォーマンス考慮が未記載",
        "location": "機能要件 > エディタ・ビューワー セクション",
        "recommendation": "ファイルサイズ上限（例: MAX_FILE_SIZE_PREVIEW = 1MB を流用）や、大きなファイルでの遅延ロード・警告表示の仕様を追加",
        "evidence": "src/lib/file-tree.ts で LIMITS.MAX_FILE_SIZE_PREVIEW = 1MB が定義されている"
      },
      {
        "id": "SF-4",
        "category": "ドキュメント更新",
        "issue": "CLAUDE.md への機能追記が必要",
        "location": "Issue全体",
        "recommendation": "実装完了後、CLAUDE.md の「最近の実装機能」セクションおよび「主要機能モジュール」セクションにMarkdownEditor, 新規APIエンドポイントを追記する旨を明記",
        "evidence": "CLAUDE.md に主要機能モジュール一覧が存在"
      }
    ],
    "nice_to_have": [
      {
        "id": "NTH-1",
        "category": "完全性",
        "issue": "LeftPaneTabSwitcherへの影響が未記載",
        "location": "技術仕様 > 既存コンポーネントとの関係 セクション",
        "recommendation": "LeftPaneTabSwitcher.tsx は現在 'history' | 'files' | 'memo' の3タブ。Filesタブ選択時のパネル切り替えロジックの具体的な変更内容を記載",
        "evidence": "LeftPaneTabSwitcher.tsx L19で型定義、L101-105でTABS配列定義"
      },
      {
        "id": "NTH-2",
        "category": "完全性",
        "issue": "新規依存ライブラリの追加確認が未記載",
        "location": "技術仕様 セクション",
        "recommendation": "react-markdown, remark-gfmは既にpackage.jsonに存在することを確認。追加の依存関係が不要であることを明記すると安心",
        "evidence": "package.json L34-36で react-markdown ^10.1.0, remark-gfm ^4.0.1 が既に依存関係に含まれている"
      },
      {
        "id": "NTH-3",
        "category": "完全性",
        "issue": "MessageList.tsxでのMarkdown表示との整合性",
        "location": "技術仕様 > 既存コンポーネントとの関係 セクション",
        "recommendation": "MessageList.tsx (L14-15) で既にreact-markdown + remarkGfmを使用。MarkdownEditorでも同じスタイリングを適用することで一貫性を保つことを推奨",
        "evidence": "src/components/worktree/MessageList.tsx でReactMarkdown, remarkGfmをインポートして使用中"
      }
    ]
  },
  "impact_analysis": {
    "affected_files": [
      {
        "file": "src/app/api/worktrees/[id]/files/[...path]/route.ts",
        "change_type": "major_modification",
        "description": "PUT, POST, DELETE, PATCHメソッドの追加。既存GETメソッドは変更なし"
      },
      {
        "file": "src/components/worktree/FileTreeView.tsx",
        "change_type": "major_modification",
        "description": "右クリックメニュー機能追加。TreeNodeへのcontextmenu、新規Menu UIコンポーネント"
      },
      {
        "file": "src/components/worktree/MarkdownEditor.tsx",
        "change_type": "new_file",
        "description": "新規作成。マークダウンエディタ + プレビュー + 表示モード切替"
      },
      {
        "file": "src/components/worktree/WorktreeDetailRefactored.tsx",
        "change_type": "minor_modification",
        "description": "mdファイル選択時のMarkdownEditor表示ロジック追加"
      },
      {
        "file": "src/components/worktree/LeftPaneTabSwitcher.tsx",
        "change_type": "minor_modification",
        "description": "Filesタブ選択時のパネル切り替えロジック追加（必要に応じて）"
      },
      {
        "file": "src/lib/path-validator.ts",
        "change_type": "no_change",
        "description": "既存のパストラバーサル対策をそのまま活用"
      },
      {
        "file": "src/lib/file-tree.ts",
        "change_type": "minor_modification",
        "description": "ファイル書き込み・削除用の新規関数追加の可能性"
      },
      {
        "file": "tests/integration/api-file-tree.test.ts",
        "change_type": "major_modification",
        "description": "PUT, POST, DELETE, PATCHメソッドのテスト追加"
      },
      {
        "file": "tests/unit/lib/file-tree.test.ts",
        "change_type": "minor_modification",
        "description": "新規関数のユニットテスト追加"
      }
    ],
    "affected_apis": [
      {
        "endpoint": "PUT /api/worktrees/:id/files/:path",
        "type": "new",
        "description": "ファイル内容更新"
      },
      {
        "endpoint": "POST /api/worktrees/:id/files/:path",
        "type": "new",
        "description": "ファイル/ディレクトリ作成"
      },
      {
        "endpoint": "DELETE /api/worktrees/:id/files/:path",
        "type": "new",
        "description": "ファイル/ディレクトリ削除"
      },
      {
        "endpoint": "PATCH /api/worktrees/:id/files/:path/rename",
        "type": "new",
        "description": "リネーム"
      },
      {
        "endpoint": "GET /api/worktrees/:id/files/:path",
        "type": "existing",
        "description": "変更なし（後方互換性維持）"
      }
    ],
    "affected_components": [
      {
        "component": "FileTreeView",
        "type": "major_modification",
        "description": "右クリックメニュー追加、新規操作ハンドラー追加"
      },
      {
        "component": "FileViewer",
        "type": "no_change",
        "description": "モーダル形式を維持、mdファイル以外の表示に継続使用"
      },
      {
        "component": "MarkdownEditor",
        "type": "new",
        "description": "新規コンポーネント作成"
      },
      {
        "component": "WorktreeDetailRefactored",
        "type": "minor_modification",
        "description": "mdファイル選択時の表示ロジック追加"
      },
      {
        "component": "LeftPaneTabSwitcher",
        "type": "potential_modification",
        "description": "Filesタブのパネル切り替え（必要に応じて）"
      }
    ],
    "breaking_changes": [],
    "security_considerations": [
      {
        "item": "パストラバーサル対策",
        "status": "covered",
        "description": "既存のisPathSafe関数とvalidateWorktreePath関数を活用"
      },
      {
        "item": "md拡張子制限",
        "status": "covered",
        "description": "編集可能ファイルをmd拡張子のみに制限することでセキュリティ向上"
      },
      {
        "item": "worktreeスコープ制限",
        "status": "covered",
        "description": "APIがworktreeスコープ内のみアクセス可能"
      }
    ],
    "performance_considerations": [
      {
        "item": "大きなmdファイルの編集",
        "risk": "medium",
        "recommendation": "ファイルサイズ上限の設定と警告表示の追加を推奨"
      },
      {
        "item": "リアルタイムプレビュー",
        "risk": "low",
        "recommendation": "デバウンス処理による入力遅延の軽減を検討"
      }
    ]
  },
  "summary": "Issue #49は既存のFilesタブを拡張してマークダウンエディタ機能を追加する中規模の機能追加です。影響範囲として、APIルートへの4つの新規HTTPメソッド追加、FileTreeViewへの右クリックメニュー追加、新規MarkdownEditorコンポーネント作成が主要な変更点です。セキュリティ面では既存のパストラバーサル対策とworktreeスコープ制限を活用でき、破壊的変更はありません。ただし、テスト計画の追加、WorktreeDetailRefactoredへの影響の具体化、大きなファイル編集時のパフォーマンス考慮の追記を推奨します。react-markdown/remark-gfmは既に依存関係に含まれており、追加のライブラリインストールは不要です。"
}
