# Issue #96 アーキテクチャレビュー Stage 2: 整合性レビュー

**日付**: 2026-01-31
**対象Issue**: #96 npm installからセットアップ可能にする
**レビュー種別**: 整合性レビュー（設計書 vs 既存実装）
**設計書**: `dev-reports/design/issue-96-npm-cli-design-policy.md`

---

## 1. レビュー概要

Issue #96の設計方針書と既存実装（`src/lib/env.ts`、`server.ts`、シェルスクリプト群、`package.json`）との整合性を検証した。

### 検証対象ファイル

| ファイル | 役割 |
|---------|------|
| `src/lib/env.ts` | 環境変数取得・バリデーション |
| `server.ts` | Next.jsカスタムサーバー |
| `scripts/preflight-check.sh` | 依存関係チェック |
| `scripts/setup-env.sh` | .env生成スクリプト |
| `package.json` | パッケージ設定 |

---

## 2. Must Fix（必須修正）

### MF-1: server.tsが旧環境変数を直接参照している

**重要度**: High

**問題箇所**: `server.ts:43-44`

```typescript
// 現在のコード（問題）
const hostname = process.env.MCBD_BIND || '127.0.0.1';
const port = parseInt(process.env.MCBD_PORT || process.env.PORT || '3000', 10);
```

**設計書の記載**: 11.1節「server.ts の修正」

> この修正はCLI実装前に完了する必要がある。

**期待されるコード**:

```typescript
import { getEnvByKey } from './src/lib/env';
const hostname = getEnvByKey('CM_BIND') || '127.0.0.1';
const port = parseInt(getEnvByKey('CM_PORT') || '3000', 10);
```

**影響**: CLI実装時に環境変数の一貫性が失われる。`getEnvByKey`を使用することで、新名称（CM_*）と旧名称（MCBD_*）のフォールバックが自動的に適用される。

---

### MF-2: データベースファイル名の不一致

**重要度**: High

**問題箇所**: 複数ファイル間の値不一致

| ソース | 値 |
|--------|-----|
| `src/lib/env.ts:170-171` | `./data/db.sqlite` |
| `scripts/setup-env.sh:26` | `./data/cm.db` |
| 設計書 17.1節 | `./data/cm.db` |

**問題**: 設計書とシェルスクリプトは`cm.db`で一致しているが、`env.ts`は`db.sqlite`を使用している。

**推奨対応**: `env.ts`のデフォルト値を`cm.db`に統一する。これにより、設計書17.1節で計画されている`src/config/defaults.ts`との整合性も確保される。

```typescript
// env.ts 修正後
const databasePath = getEnvByKey('CM_DB_PATH')
  || process.env.DATABASE_PATH
  || path.join(process.cwd(), 'data', 'cm.db');  // db.sqlite -> cm.db
```

---

## 3. Should Fix（推奨修正）

### SF-1: src/config/defaults.tsの作成タイミング明確化

設計書17章で`src/config/defaults.ts`を新規作成する計画があるが、既存の`src/lib/env.ts`との整合性をどのように取るかが不明確。

**推奨**: 17.2節の「既存src/lib/env.tsの修正」を実装タスクリストに明示的に含める。

### SF-2: EnvConfig型とEnv型の関係性明確化

設計書4.3.2の`EnvConfig`型と既存`env.ts`の`Env`型は類似しているが完全同一ではない。

| 型 | CM_LOG_LEVEL | CM_LOG_FORMAT |
|----|--------------|---------------|
| EnvConfig（設計書） | 含む | 含む |
| Env（env.ts） | 含まない | 含まない |
| LogConfig（env.ts） | 含む | 含む |

**推奨**: EnvConfig型定義時に既存型との関係性を設計書に明記する。

### SF-3: シェルスクリプトの機能網羅性確認

`setup-env.sh`の以下の機能がTypeScript移植で再現されることを確認する必要がある。

- 既存.envのバックアップ（`backup_env`関数）
- 外部アクセス時のトークン自動生成（`generate_token`関数）
- 非対話モード（`--yes`オプション）
- 対話形式の入力プロンプト

---

## 4. Nice to Have（改善提案）

### NTH-1: openssl依存の残存

設計書7.1節で「openssl依存からの脱却」を謳っているが、`preflight-check.sh`ではopensslが必須依存として残っている。CLI実装後のシェルスクリプト非推奨化に伴い、optionalへの変更を検討。

### NTH-2: private: falseへの変更タイミング

`package.json`の`private: false`への変更タイミングをnpm publish workflowセクションに追記すると良い。

### NTH-3: WORKTREE_REPOS環境変数の扱い

`server.ts:79`で参照される`WORKTREE_REPOS`環境変数について、設計書に言及がない。既存ユーザー向けの互換性対応として検討。

---

## 5. 検証済み項目（一致確認）

以下の項目は設計書と既存実装で一貫性が確認された。

| 項目 | 設計書 | 実装 | 状態 |
|------|--------|------|------|
| ポートデフォルト値 | 3000 | env.ts, setup-env.sh共に3000 | 一致 |
| バインドアドレス | 127.0.0.1 | env.ts, setup-env.sh共に127.0.0.1 | 一致 |
| ログレベル | info | env.ts, setup-env.sh共にinfo | 一致 |
| ログフォーマット | text | env.ts, setup-env.sh共にtext | 一致 |
| 依存関係チェック | Node.js v20+, npm, tmux, git, openssl, Claude CLI(optional) | preflight-check.shと一致 | 一致 |
| 環境変数マッピング | CM_* -> MCBD_* | env.ts ENV_MAPPING | 一致 |
| バインドアドレス検証 | 127.0.0.1, 0.0.0.0, localhost | env.ts:182-184 | 一致 |
| 外部公開時トークン必須 | 0.0.0.0時必須 | env.ts:187-189 | 一致 |

---

## 6. 結論

### 優先対応事項

1. **MF-1**: `server.ts`の環境変数参照を`getEnvByKey()`に変更（CLI実装前に必須）
2. **MF-2**: `env.ts`のデータベースファイル名を`cm.db`に統一

### レビュー結果サマリー

| カテゴリ | 件数 |
|---------|------|
| Must Fix | 2件 |
| Should Fix | 3件 |
| Nice to Have | 3件 |
| 検証済み（一致） | 8項目 |

設計書と既存実装の基本的な方向性は整合しているが、server.tsの環境変数参照方法とデータベースファイル名の不一致は、CLI実装前に解決が必要である。

---

*Generated by architecture-review-agent*
