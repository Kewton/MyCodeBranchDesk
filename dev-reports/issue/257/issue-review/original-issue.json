{"body":"## 概要\n\nVSCodeのようにアプリケーションの新しいバージョンが利用可能な場合、Infoタブ/モーダル内でユーザーに通知し、GitHub Releasesページへのリンクからアップデートできるようにする。\n\n## 背景・課題\n\n- 現在、CommandMateにはバージョン表示機能はあるが（Infoタブに`v0.2.3`等を表示）、新しいバージョンが公開されているかどうかを確認する手段がない\n- ユーザーは手動でGitHub ReleasesやnpmをチェックしないとアップデートのVSCodeのようにアプリ内で新バージョンの存在を通知することで、ユーザーが常に最新バージョンを利用できるようにしたい\n\n## 提案する解決策\n\nGitHub Releases APIを使用して最新バージョンを取得し、現在のバージョンと比較。新しいバージョンが存在する場合、既存のInfoタブ/モーダル内にアップデート通知を表示する。\n\n### 主要な変更点\n\n- GitHub Releases APIから最新バージョン情報を取得するバックエンドAPIエンドポイントを追加\n- 既存のInfoタブ/モーダル内のバージョン表示を拡張し、更新があればinfo通知とGitHub Releasesページへのリンクを表示\n- セマンティックバージョニングによるバージョン比較ロジックを実装\n\n## インストール方式別のアップデート方法\n\nCommandMateには2つのインストール方式があり、通知内容をインストール方式に応じて出し分ける必要がある。\n\n### 判定方法\n\n| 判定対象 | 判定方法 | ファイル |\n|---------|---------|---------|\n| 開発/本番モード | `process.env.NODE_ENV !== 'production'` | `server.ts:46` |\n| インストール方式 | `isGlobalInstall()` - `__dirname`がnode_modules配下か | `src/cli/utils/install-context.ts` |\n\n### インストール方式別の起動とアップデート\n\n| 項目 | グローバルnpmインストール（本番向け） | Gitクローン（開発向け） |\n|------|--------------------------------------|------------------------|\n| **インストール** | `npm install -g commandmate` | `git clone` + `npm install` |\n| **起動** | `commandmate start --daemon` | `npm run dev` or `./scripts/build-and-start.sh` |\n| **NODE_ENV** | `production`（`commandmate start`時） | 未設定=development（`npm run dev`時） |\n| **アップデート** | `npm install -g commandmate@latest` | `git pull` + `npm install` + `npm run build:all` |\n| **通知に表示すべき情報** | npmコマンド + Releasesリンク | Releasesリンク |\n\n### 通知UI出し分け\n\n- **グローバルインストール時**: 「`npm install -g commandmate@latest` で更新できます」+ Releasesリンク\n- **Gitクローン時**: 「GitHub Releasesで新しいバージョンが利用可能です」+ Releasesリンク\n- **判定不可の場合**: Releasesリンクのみ表示（フォールバック）\n\n> **注**: WebUI側では`isGlobalInstall()`はサーバーサイドのみ利用可能なため、`/api/app/update-check`のレスポンスにインストール方式情報を含める設計とする。\n\n## データベースの安全性\n\nアップデート時にデータベースが初期化（データ消失）しないことを保証する設計になっている。\n\n### マイグレーションシステム\n\n- サーバー起動時に `runMigrations()` が自動実行される（`db-instance.ts:46`）\n- `schema_version` テーブルで現在のバージョンを管理（現在: v16）\n- 未適用のマイグレーションのみ増分適用（`ALTER TABLE ADD COLUMN`等）\n- 既存データは常に保持される\n\n### アップデート時のDB動作\n\n| シナリオ | DB動作 | データ |\n|---------|--------|--------|\n| `npm install -g commandmate@latest` | マイグレーション自動適用 | **保持** |\n| `git pull` + サーバー再起動 | マイグレーション自動適用 | **保持** |\n| `npm run db:init` (`build-and-start.sh`含む) | `CREATE TABLE IF NOT EXISTS` のため既存DBスキップ | **保持** |\n| `npm run db:reset`（手動実行のみ） | DBファイル削除+再作成 | **消失** |\n\n### 通知への反映\n\nアップデート通知に「データベースのデータは保持されます」と案内することで、ユーザーが安心してアップデートできるようにする。\n\n## 実装タスク\n\n- [ ] `src/lib/version-checker.ts` を新規作成（GitHub Releases API呼び出し、semver比較）\n- [ ] `GET /api/app/update-check` APIエンドポイントを新規作成（インストール方式情報を含む）\n- [ ] `WorktreeDetailRefactored.tsx` のInfoModal/MobileInfoContentにアップデート通知UIを追加\n- [ ] インストール方式に応じた通知メッセージの出し分けを実装\n- [ ] バージョン表示の横に「新しいバージョンがあります」メッセージとReleasesリンクを追加\n- [ ] APIレート制限対策（キャッシュ、チェック間隔の制御）\n- [ ] ユニットテストの追加\n\n## 受入条件\n\n- [ ] 新しいバージョンがGitHub Releasesに公開されている場合、Infoタブ/モーダルにinfo通知が表示される\n- [ ] 通知からGitHub Releasesページへのリンクが機能する\n- [ ] インストール方式（npm/git）に応じた適切なアップデート案内が表示される\n- [ ] 最新バージョンを使用している場合は通知が表示されない\n- [ ] GitHub APIへのアクセス失敗時にエラーが表示されず、静かに失敗する\n- [ ] アップデートによりデータベースが初期化されないことが確認できる\n- [ ] 既存テストがすべてパスする\n\n## 影響範囲\n\n### 変更対象ファイル\n\n| ファイル | 変更内容 |\n|---------|---------|\n| `src/components/worktree/WorktreeDetailRefactored.tsx` | InfoModal/MobileInfoContent内にアップデート通知UI追加 |\n| `src/lib/version-checker.ts` | 新規: GitHub Releases API呼び出し、semver比較ロジック |\n| `src/app/api/app/update-check/route.ts` | 新規: アップデートチェックAPIエンドポイント（インストール方式情報含む） |\n\n### 関連コンポーネント\n\n- `next.config.js` - `NEXT_PUBLIC_APP_VERSION` 環境変数（既存、変更不要）\n- `src/components/common/Toast.tsx` - info通知（既存、活用可能）\n- `src/cli/utils/install-context.ts` - `isGlobalInstall()` インストール方式判定（既存、参照）\n- `src/lib/db-migrations.ts` - マイグレーションシステム（既存、変更不要、安全性の根拠）\n- `src/lib/db-instance.ts` - DB接続時の自動マイグレーション（既存、変更不要）\n- `package.json` - 現在のバージョン情報（既存、変更不要）","title":"バージョンアップを知らせる機能"}
