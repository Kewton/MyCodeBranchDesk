{"body":"## 概要\n\n`npm install -g commandmate` でグローバルインストール後、`commandmate start` 実行時に `tsx: command not found` エラーが発生する問題の根本対策として、`server.ts`をビルド済みJavaScriptに変換する。\n\n## 現状の問題\n\n```bash\n$ commandmate start\n[INFO] Starting server in foreground (production mode)...\n\n> commandmate@0.1.5 start\n> NODE_ENV=production tsx server.ts\n\nsh: tsx: command not found\n```\n\n### 原因\n\n- `package.json`の`start`スクリプトが`tsx server.ts`を使用\n- `tsx`は`devDependencies`にあり、グローバルインストール時に含まれない\n\n### 暫定対応\n\nIssue作成時点では、`tsx`を`dependencies`に移動して対応予定。本Issueは長期的な改善として対応する。\n\n## 対策内容\n\n`server.ts`を事前にJavaScriptにコンパイルし、本番環境では`node dist/server/server.js`で実行する。\n\n### 実装タスク\n\n- [ ] `tsconfig.server.json`を新規作成\n- [ ] `package.json`の`scripts`を更新\n  - `build:server`スクリプト追加\n  - `build:all`に`build:server`を追加\n  - `start`スクリプトを`node dist/server/server.js`に変更\n  - `prepublishOnly`を更新\n- [ ] `package.json`の`files`を更新（`.next/`、`src/`を追加）\n- [ ] ビルド後のパス解決が正しく動作することを検証\n- [ ] グローバルインストールでの動作検証\n- [ ] パッケージサイズの確認と最適化\n\n## 技術的な考慮事項\n\n### tsconfig.server.json（案）\n\n```json\n{\n  \"compilerOptions\": {\n    \"target\": \"ES2022\",\n    \"module\": \"NodeNext\",\n    \"moduleResolution\": \"NodeNext\",\n    \"esModuleInterop\": true,\n    \"strict\": true,\n    \"outDir\": \"dist/server\",\n    \"rootDir\": \".\",\n    \"declaration\": false,\n    \"skipLibCheck\": true\n  },\n  \"include\": [\"server.ts\", \"src/**/*.ts\"],\n  \"exclude\": [\"node_modules\", \"tests\"]\n}\n```\n\n### package.json変更（案）\n\n```json\n{\n  \"scripts\": {\n    \"build:server\": \"tsc --project tsconfig.server.json\",\n    \"build:all\": \"npm run build && npm run build:cli && npm run build:server\",\n    \"start\": \"NODE_ENV=production node dist/server/server.js\",\n    \"prepublishOnly\": \"npm run build:all\"\n  },\n  \"files\": [\n    \"bin/\",\n    \"dist/\",\n    \".next/\",\n    \"public/\",\n    \"src/\",\n    \".env.example\"\n  ]\n}\n```\n\n### 課題\n\n1. **srcディレクトリのimport**: `server.ts`が`src/lib/`のモジュールをimportしているため、ビルド時に含める必要がある\n2. **Next.jsビルド成果物**: `.next/`ディレクトリをパッケージに含める必要があり、サイズが大幅に増加\n3. **パス解決**: ビルド後のディレクトリ構造でパスが正しく解決されるか検証が必要\n\n## 期待される効果\n\n| 項目 | Before | After |\n|------|--------|-------|\n| 実行方式 | `tsx server.ts`（TSランタイム） | `node dist/server/server.js`（ビルド済みJS） |\n| 起動速度 | やや遅い | 高速 |\n| 依存関係 | tsxランタイム必要 | 不要 |\n| 本番運用 | 非標準 | Node.js標準方式 |\n\n## 受け入れ条件\n\n- [ ] `npm install -g commandmate` でインストール後、`commandmate start`が正常に動作する\n- [ ] `tsx`が`devDependencies`のままで動作する\n- [ ] 開発モード（`npm run dev`）が引き続き動作する\n- [ ] 全テストがパスする\n- [ ] パッケージサイズが許容範囲内（目安: 50MB以下）\n\n## 関連\n\n- Issue #96: npm CLIサポート\n- 暫定対応: tsxをdependenciesに移動","title":"perf: server.tsをビルド済みJSに変換してtsxランタイム依存を解消"}
